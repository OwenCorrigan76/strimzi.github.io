<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>Deploying and Upgrading Strimzi</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body id="deploying-book_str" class="book toc2 toc-left">
<div id="header">
<h1>Deploying and Upgrading Strimzi</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#deploy-intro_str">1. Deployment overview</a>
<ul class="sectlevel2">
<li><a href="#deploy-options-scope-str">1.1. Configuring a deployment</a>
<ul class="sectlevel3">
<li><a href="#securing_kafka">1.1.1. Securing Kafka</a></li>
<li><a href="#monitoring_a_deployment">1.1.2. Monitoring a deployment</a></li>
<li><a href="#cpu_and_memory_resource_limits_and_requests">1.1.3. CPU and memory resource limits and requests</a></li>
</ul>
</li>
<li><a href="#assembly-custom-resources-str">1.2. Strimzi custom resources</a>
<ul class="sectlevel3">
<li><a href="#con-custom-resources-example-str">1.2.1. Strimzi custom resource example</a></li>
</ul>
</li>
<li><a href="#con-kafka-bridge-concepts-str">1.3. Using the Kafka Bridge to connect with a Kafka cluster</a></li>
<li><a href="#document-conventions-str">1.4. Document Conventions</a></li>
<li><a href="#additional_resources">1.5. Additional resources</a></li>
</ul>
</li>
<li><a href="#con-strimzi-installation-methods_str">2. Strimzi installation methods</a></li>
<li><a href="#deploy-options_str">3. What is deployed with Strimzi</a>
<ul class="sectlevel2">
<li><a href="#deploy-options-order-str">3.1. Order of deployment</a></li>
</ul>
</li>
<li><a href="#deploy-tasks-prereqs_str">4. Preparing for your Strimzi deployment</a>
<ul class="sectlevel2">
<li><a href="#deploy-prereqs-str">4.1. Deployment prerequisites</a></li>
<li><a href="#downloads-str">4.2. Downloading Strimzi release artifacts</a></li>
<li><a href="#deploy-examples-str">4.3. Example configuration and deployment files</a>
<ul class="sectlevel3">
<li><a href="#example_files_location">4.3.1. Example files location</a></li>
<li><a href="#example_files_provided_with_strimzi">4.3.2. Example files provided with Strimzi</a></li>
</ul>
</li>
<li><a href="#container-images-str">4.4. Pushing container images to your own registry</a></li>
<li><a href="#adding-users-the-strimzi-admin-role-str">4.5. Designating Strimzi administrators</a></li>
<li><a href="#deploy-kubernetes-str">4.6. Installing a local Kubernetes cluster with Minikube</a></li>
</ul>
</li>
<li><a href="#deploy-tasks_str">5. Deploying Strimzi using installation artifacts</a>
<ul class="sectlevel2">
<li><a href="#con-deploy-paths-str">5.1. Basic deployment path</a></li>
<li><a href="#cluster-operator-str">5.2. Deploying the Cluster Operator</a>
<ul class="sectlevel3">
<li><a href="#con-cluster-operator-watch-options-str">5.2.1. Specifying the namespaces the Cluster Operator watches</a></li>
<li><a href="#deploying-cluster-operator-str">5.2.2. Deploying the Cluster Operator to watch a single namespace</a></li>
<li><a href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">5.2.3. Deploying the Cluster Operator to watch multiple namespaces</a></li>
<li><a href="#deploying-cluster-operator-to-watch-whole-cluster-str">5.2.4. Deploying the Cluster Operator to watch all namespaces</a></li>
</ul>
</li>
<li><a href="#kafka-cluster-str">5.3. Deploying Kafka</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-cluster-str">5.3.1. Deploying the Kafka cluster</a></li>
<li><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">5.3.2. Deploying the Topic Operator using the Cluster Operator</a></li>
<li><a href="#deploying-the-user-operator-using-the-cluster-operator-str">5.3.3. Deploying the User Operator using the Cluster Operator</a></li>
</ul>
</li>
<li><a href="#kafka-connect-str">5.4. Deploying Kafka Connect</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-connect-str">5.4.1. Deploying Kafka Connect to your Kubernetes cluster</a></li>
<li><a href="#con-kafka-connect-multiple-instances-str">5.4.2. Configuring Kafka Connect for multiple instances</a></li>
<li><a href="#using-kafka-connect-with-plug-ins-str">5.4.3. Adding connectors</a></li>
</ul>
</li>
<li><a href="#kafka-mirror-maker-str">5.5. Deploying Kafka MirrorMaker</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-mirror-maker-str">5.5.1. Deploying Kafka MirrorMaker to your Kubernetes cluster</a></li>
</ul>
</li>
<li><a href="#kafka-bridge-str">5.6. Deploying Kafka Bridge</a>
<ul class="sectlevel3">
<li><a href="#deploying-kafka-bridge-str">5.6.1. Deploying Kafka Bridge to your Kubernetes cluster</a></li>
<li><a href="#proc-exposing-kafka-bridge-service-local-machine-str">5.6.2. Exposing the Kafka Bridge service to your local machine</a></li>
<li><a href="#con-accessing-kafka-bridge-from-outside-str">5.6.3. Accessing the Kafka Bridge outside of Kubernetes</a></li>
</ul>
</li>
<li><a href="#deploy-standalone-operators_str">5.7. Alternative standalone deployment options for Strimzi operators</a>
<ul class="sectlevel3">
<li><a href="#deploying-the-topic-operator-standalone-str">5.7.1. Deploying the standalone Topic Operator</a></li>
<li><a href="#deploying-the-user-operator-standalone-str">5.7.2. Deploying the standalone User Operator</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#deploying-strimzi-from-operator-hub-str">6. Deploying Strimzi from OperatorHub.io</a></li>
<li><a href="#deploying-cluster-operator-helm-chart-str">7. Deploying Strimzi using Helm</a></li>
<li><a href="#deploy-client-access-str">8. Setting up client access to a Kafka cluster</a>
<ul class="sectlevel2">
<li><a href="#deploying-example-clients-str">8.1. Deploying example clients</a></li>
<li><a href="#configuration-points-listeners-str">8.2. Configuring listeners to connect to Kafka brokers</a></li>
<li><a href="#setup-external-clients-str">8.3. Setting up client access to a Kafka cluster using listeners</a></li>
<li><a href="#proc-accessing-kafka-using-nodeports-str">8.4. Accessing Kafka using node ports</a></li>
<li><a href="#proc-accessing-kafka-using-loadbalancers-str">8.5. Accessing Kafka using loadbalancers</a></li>
<li><a href="#proc-accessing-kafka-using-ingress-str">8.6. Accessing Kafka using an Ingress NGINX Controller for Kubernetes</a></li>
<li><a href="#proc-accessing-kafka-using-routes-str">8.7. Accessing Kafka using OpenShift routes</a></li>
</ul>
</li>
<li><a href="#assembly-securing-access-str">9. Managing secure access to Kafka</a>
<ul class="sectlevel2">
<li><a href="#assembly-securing-kafka-brokers-str">9.1. Security options for Kafka</a>
<ul class="sectlevel3">
<li><a href="#con-securing-kafka-authentication-str">9.1.1. Listener authentication</a></li>
<li><a href="#con-securing-kafka-authorization-str">9.1.2. Kafka authorization</a></li>
</ul>
</li>
<li><a href="#assembly-securing-kafka-clients-str">9.2. Security options for Kafka clients</a>
<ul class="sectlevel3">
<li><a href="#con-securing-client-labels-str">9.2.1. Identifying a Kafka cluster for user handling</a></li>
<li><a href="#con-securing-client-authentication-str">9.2.2. User authentication</a></li>
<li><a href="#con-securing-client-authorization-str">9.2.3. User authorization</a></li>
</ul>
</li>
<li><a href="#assembly-securing-kafka-str">9.3. Securing access to Kafka brokers</a>
<ul class="sectlevel3">
<li><a href="#proc-securing-kafka-str">9.3.1. Securing Kafka brokers</a></li>
<li><a href="#proc-configuring-secure-kafka-user-str">9.3.2. Securing user access to Kafka</a></li>
<li><a href="#proc-restricting-access-to-listeners-using-network-policies-str">9.3.3. Restricting access to Kafka listeners using network policies</a></li>
<li><a href="#proc-installing-certs-per-listener-str">9.3.4. Providing your own Kafka listener certificates for TLS encryption</a></li>
<li><a href="#ref-alternative-subjects-certs-for-listeners-str">9.3.5. Alternative subjects in server certificates for Kafka listeners</a></li>
</ul>
</li>
<li><a href="#assembly-oauth-authentication_str">9.4. Using OAuth 2.0 token-based authentication</a>
<ul class="sectlevel3">
<li><a href="#con-oauth-authentication-flow-str">9.4.1. OAuth 2.0 authentication mechanisms</a></li>
<li><a href="#con-oauth-authentication-broker-str">9.4.2. OAuth 2.0 Kafka broker configuration</a></li>
<li><a href="#str">9.4.3. Session re-authentication for Kafka brokers</a></li>
<li><a href="#con-oauth-authentication-client-str">9.4.4. OAuth 2.0 Kafka client configuration</a></li>
<li><a href="#con-oauth-authentication-client-options-str">9.4.5. OAuth 2.0 client authentication flows</a></li>
<li><a href="#con-oauth-strimzi-config-str">9.4.6. Configuring OAuth 2.0 authentication</a></li>
<li><a href="#con-oauth-server-examples-str">9.4.7. Authorization server examples</a></li>
</ul>
</li>
<li><a href="#assembly-oauth-authorization_str">9.5. Using OAuth 2.0 token-based authorization</a>
<ul class="sectlevel3">
<li><a href="#con-oauth-authorization-mechanism_str">9.5.1. OAuth 2.0 authorization mechanism</a></li>
<li><a href="#proc-oauth-authorization-broker-config-str">9.5.2. Configuring OAuth 2.0 authorization support</a></li>
<li><a href="#assembly-managing-policies-permissions-keycloak_str">9.5.3. Managing policies and permissions in Keycloak Authorization Services</a></li>
<li><a href="#proc-oauth-authorization-keycloak-example_str">9.5.4. Trying Keycloak Authorization Services</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-metrics-str">10. Introducing metrics</a>
<ul class="sectlevel2">
<li><a href="#con-metrics-kafka-exporter-lag-str">10.1. Monitoring consumer lag with Kafka Exporter</a></li>
<li><a href="#con-metrics-cruise-control-str">10.2. Monitoring Cruise Control operations</a>
<ul class="sectlevel3">
<li><a href="#exposing_cruise_control_metrics">10.2.1. Exposing Cruise Control metrics</a></li>
<li><a href="#viewing_cruise_control_metrics">10.2.2. Viewing Cruise Control metrics</a></li>
</ul>
</li>
<li><a href="#assembly-metrics-config-files-str">10.3. Example metrics files</a>
<ul class="sectlevel3">
<li><a href="#ref-metrics-prometheus-metrics-config-str">10.3.1. Example Prometheus metrics configuration</a></li>
<li><a href="#ref-metrics-alertmanager-examples-str">10.3.2. Example Prometheus rules for alert notifications</a></li>
<li><a href="#ref-metrics-dashboards-str">10.3.3. Example Grafana dashboards</a></li>
</ul>
</li>
<li><a href="#assembly-metrics-setup-str">10.4. Using Prometheus with Strimzi</a>
<ul class="sectlevel3">
<li><a href="#proc-metrics-kafka-deploy-options-str">10.4.1. Deploying Prometheus metrics configuration</a></li>
<li><a href="#assembly-metrics-prometheus-str">10.4.2. Setting up Prometheus</a></li>
<li><a href="#proc-metrics-deploying-prometheus-alertmanager-str">10.4.3. Deploying Alertmanager</a></li>
<li><a href="#con-metrics-kafka-mini-kube-str">10.4.4. Using metrics with Minikube</a></li>
</ul>
</li>
<li><a href="#proc-metrics-grafana-dashboard-str">10.5. Enabling the example Grafana dashboards</a></li>
</ul>
</li>
<li><a href="#assembly-distributed-tracing-str">11. Introducing distributed tracing</a>
<ul class="sectlevel2">
<li><a href="#con-overview-tracing-str">11.1. Tracing options</a></li>
<li><a href="#ref-tracing-environment-variables-str">11.2. Environment variables for tracing</a></li>
<li><a href="#assembly-distributed-tracing-procedures-str">11.3. Setting up distributed tracing</a>
<ul class="sectlevel3">
<li><a href="#prerequisites">11.3.1. Prerequisites</a></li>
<li><a href="#proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str">11.3.2. Enabling tracing in MirrorMaker, Kafka Connect, and Kafka Bridge resources</a></li>
<li><a href="#proc-configuring-tracers-kafka-clients-str">11.3.3. Initializing tracing for Kafka clients</a></li>
<li><a href="#proc-instrumenting-producers-consumers-for-opentracing-str">11.3.4. Instrumenting producers and consumers for tracing</a></li>
<li><a href="#proc-instrumenting-kafka-streams-with-tracers-str">11.3.5. Instrumenting Kafka Streams applications for tracing</a></li>
<li><a href="#proc-enabling-tracing-type-str">11.3.6. Introducing a different OpenTelemetry tracing system</a></li>
<li><a href="#ref-tracing-span-names-str">11.3.7. Custom span names</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-upgrade-str">12. Upgrading Strimzi</a>
<ul class="sectlevel2">
<li><a href="#con-upgrade-paths-str">12.1. Strimzi upgrade paths</a>
<ul class="sectlevel3">
<li><a href="#con-upgrade-paths-kafka-versions-str">12.1.1. Supported Kafka versions</a></li>
<li><a href="#con-upgrade-paths-earlier-versions-str">12.1.2. Upgrading from a Strimzi version earlier than 0.22</a></li>
</ul>
</li>
<li><a href="#con-upgrade-sequence-str">12.2. Required upgrade sequence</a></li>
<li><a href="#con-upgrade-cluster-str">12.3. Upgrading Kubernetes with minimal downtime</a>
<ul class="sectlevel3">
<li><a href="#rolling_pods_using_the_strimzi_drain_cleaner">12.3.1. Rolling pods using the Strimzi Drain Cleaner</a></li>
<li><a href="#rolling_pods_manually_while_keeping_topics_available">12.3.2. Rolling pods manually while keeping topics available</a></li>
</ul>
</li>
<li><a href="#assembly-upgrade-cluster-operator-str">12.4. Upgrading the Cluster Operator</a>
<ul class="sectlevel3">
<li><a href="#con-upgrade-cluster-operator-unsupported-kafka-str">12.4.1. Upgrading the Cluster Operator returns Kafka version error</a></li>
<li><a href="#proc-upgrading-the-co-str">12.4.2. Upgrading the Cluster Operator using installation files</a></li>
</ul>
</li>
<li><a href="#assembly-upgrading-kafka-versions-str">12.5. Upgrading Kafka</a>
<ul class="sectlevel3">
<li><a href="#ref-kafka-versions-str">12.5.1. Kafka versions</a></li>
<li><a href="#con-strategies-for-upgrading-clients-str">12.5.2. Strategies for upgrading clients</a></li>
<li><a href="#con-versions-and-images-str">12.5.3. Kafka version and image mappings</a></li>
<li><a href="#proc-upgrading-brokers-newer-kafka-str">12.5.4. Upgrading Kafka brokers and client applications</a></li>
</ul>
</li>
<li><a href="#proc-reenabling-FIPS-mode-str">12.6. Switching to FIPS mode when upgrading Strimzi</a></li>
<li><a href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">12.7. Upgrading consumers to cooperative rebalancing</a></li>
</ul>
</li>
<li><a href="#assembly-downgrade-str">13. Downgrading Strimzi</a>
<ul class="sectlevel2">
<li><a href="#proc-downgrade-cluster-operator-str">13.1. Downgrading the Cluster Operator to a previous version</a></li>
<li><a href="#assembly-downgrade-kafka-versions-str">13.2. Downgrading Kafka</a>
<ul class="sectlevel3">
<li><a href="#con-target-downgrade-version-str">13.2.1. Kafka version compatibility for downgrades</a></li>
<li><a href="#proc-downgrading-brokers-older-kafka-str">13.2.2. Downgrading Kafka brokers and client applications</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#assembly-deploy-restart-events-str">14. Finding information on Kafka restarts</a>
<ul class="sectlevel2">
<li><a href="#ref-operator-restart-events-reasons-str">14.1. Reasons for a restart event</a></li>
<li><a href="#ref-operator-restart-events-fields-str">14.2. Restart event filters</a></li>
<li><a href="#proc-operator-restart-events-str">14.3. Checking Kafka restarts</a></li>
</ul>
</li>
<li><a href="#assembly-uninstalling-str">15. Uninstalling Strimzi</a>
<ul class="sectlevel2">
<li><a href="#uninstalling-str">15.1. Uninstalling Strimzi using the CLI</a></li>
<li><a href="#uninstalling-operator-hub-str">15.2. Uninstalling Strimzi from OperatorHub.io</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="deploy-intro_str"><a class="link" href="#deploy-intro_str">1. Deployment overview</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Strimzi simplifies the process of running <a href="https://kafka.apache.org/" target="_blank" rel="noopener">Apache Kafka</a> in a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>This guide provides instructions on all the options available for deploying and upgrading Strimzi,
describing what is deployed, and the order of deployment required to run Apache Kafka in a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>As well as describing the deployment steps, the guide also provides pre- and post-deployment instructions to prepare for and verify a deployment.
The guide also describes additional deployment options for introducing metrics.</p>
</div>
<div class="paragraph">
<p>Upgrade instructions are provided for Strimzi and Kafka upgrades.</p>
</div>
<div class="paragraph">
<p>Strimzi is designed to work on all types of Kubernetes cluster regardless of distribution,
from public and private clouds to local deployments intended for development.</p>
</div>
<div class="sect2">
<h3 id="deploy-options-scope-str"><a class="link" href="#deploy-options-scope-str">1.1. Configuring a deployment</a></h3>
<div class="paragraph _abstract">
<p>The deployment procedures in this guide are designed to help you set up the initial structure of your deployment.
After setting up the structure, you can use custom resources to configure the deployment to your precise needs.
The deployment procedures use the example installation files provided with Strimzi.
The procedures highlight any important configuration considerations, but they do not describe all the configuration options available.</p>
</div>
<div class="paragraph">
<p>You might want to review the configuration options available for Kafka components before you deploy Strimzi.
For more information on the configuration options, see <a href="./configuring.html" target="_blank" rel="noopener"><em>Configuring Strimzi</em></a>.</p>
</div>
<div class="sect3">
<h4 id="securing_kafka"><a class="link" href="#securing_kafka">1.1.1. Securing Kafka</a></h4>
<div class="paragraph">
<p>On deployment, the Cluster Operator automatically sets up TLS certificates for data encryption and authentication within your cluster.</p>
</div>
<div class="paragraph">
<p>Strimzi provides additional configuration options for <em>encryption</em>, <em>authentication</em> and <em>authorization</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secure data exchange between the Kafka cluster and clients by <a href="#assembly-securing-access-str">managing secure access to Kafka</a>.</p>
</li>
<li>
<p>Configure your deployment to use an authorization server to provide <a href="#assembly-oauth-authentication_str">OAuth 2.0 authentication</a> and <a href="#assembly-oauth-authorization_str">OAuth 2.0 authorization</a>.</p>
</li>
<li>
<p><a href="./configuring.html#security-str" target="_blank" rel="noopener">Secure Kafka using your own certificates</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="monitoring_a_deployment"><a class="link" href="#monitoring_a_deployment">1.1.2. Monitoring a deployment</a></h4>
<div class="paragraph">
<p>Strimzi supports additional deployment options to monitor your deployment.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract metrics and monitor Kafka components by <a href="#assembly-metrics-setup-str">deploying Prometheus and Grafana with your Kafka cluster</a>.</p>
</li>
<li>
<p>Extract additional metrics, particularly related to monitoring consumer lag, by <a href="#proc-metrics-kafka-deploy-options-str">deploying Kafka Exporter with your Kafka cluster</a>.</p>
</li>
<li>
<p>Track messages end-to-end by <a href="#assembly-distributed-tracing-str">setting up distributed tracing</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="cpu_and_memory_resource_limits_and_requests"><a class="link" href="#cpu_and_memory_resource_limits_and_requests">1.1.3. CPU and memory resource limits and requests</a></h4>
<div class="paragraph">
<p>By default, the Strimzi Cluster Operator does not specify requests and limits for CPU and memory resources for any operands it deploys.</p>
</div>
<div class="paragraph">
<p>Having sufficient resources is important for applications like Kafka to be stable and deliver good performance.</p>
</div>
<div class="paragraph">
<p>The right amount of resources you should use depends on the specific requirements and use-cases.</p>
</div>
<div class="paragraph">
<p>You should consider configuring the CPU and memory resources.
You can set resource requests and limits for each container in the <a href="./configuring.html#con-common-configuration-resources-reference">Strimzi custom resources</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-custom-resources-str"><a class="link" href="#assembly-custom-resources-str">1.2. Strimzi custom resources</a></h3>
<div class="paragraph _abstract">
<p>A deployment of Kafka components to a Kubernetes cluster using Strimzi is highly configurable through the application of custom resources.
Custom resources are created as instances of APIs added by Custom resource definitions (CRDs) to extend Kubernetes resources.</p>
</div>
<div class="paragraph">
<p>CRDs act as configuration instructions to describe the custom resources in a Kubernetes cluster,
and are provided with Strimzi for each Kafka component used in a deployment, as well as users and topics.
CRDs and custom resources are defined as YAML files.
Example YAML files are provided with the Strimzi distribution.</p>
</div>
<div class="paragraph">
<p>CRDs also allow Strimzi resources to benefit from native Kubernetes features like CLI accessibility and configuration validation.</p>
</div>
<div class="sect3">
<h4 id="con-custom-resources-example-str"><a class="link" href="#con-custom-resources-example-str">1.2.1. Strimzi custom resource example</a></h4>
<div class="paragraph">
<p>CRDs require a one-time installation in a cluster to define the schemas used to instantiate and manage Strimzi-specific resources.</p>
</div>
<div class="paragraph">
<p>After a new custom resource type is added to your cluster by installing a CRD, you can create instances of the resource based on its specification.</p>
</div>
<div class="paragraph">
<p>Depending on the cluster setup, installation typically requires cluster admin privileges.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Access to manage custom resources is limited to Strimzi administrators.
For more information, see <a href="#adding-users-the-strimzi-admin-role-str">Designating Strimzi administrators</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A CRD defines a new <code>kind</code> of resource, such as <code>kind:Kafka</code>, within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>The Kubernetes API server allows custom resources to be created based on the <code>kind</code> and understands from the CRD how to validate and store the custom resource when it is added to the Kubernetes cluster.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
When CRDs are deleted, custom resources of that type are also deleted. Additionally, the resources created by the custom resource, such as pods and statefulsets are also deleted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each Strimzi-specific custom resource conforms to the schema defined by the CRD for the resource&#8217;s <code>kind</code>.
The custom resources for Strimzi components have common configuration properties, which are defined under <code>spec</code>.</p>
</div>
<div class="paragraph">
<p>To understand the relationship between a CRD and a custom resource, let&#8217;s look at a sample of the CRD for a Kafka topic.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic CRD</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: CustomResourceDefinition
metadata: <b class="conum">(1)</b>
  name: kafkatopics.kafka.strimzi.io
  labels:
    app: strimzi
spec: <b class="conum">(2)</b>
  group: kafka.strimzi.io
  versions:
    v1beta2
  scope: Namespaced
  names:
    # ...
    singular: kafkatopic
    plural: kafkatopics
    shortNames:
    - kt <b class="conum">(3)</b>
  additionalPrinterColumns: <b class="conum">(4)</b>
      # ...
  subresources:
    status: {} <b class="conum">(5)</b>
  validation: <b class="conum">(6)</b>
    openAPIV3Schema:
      properties:
        spec:
          type: object
          properties:
            partitions:
              type: integer
              minimum: 1
            replicas:
              type: integer
              minimum: 1
              maximum: 32767
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The metadata for the topic CRD, its name and a label to identify the CRD.</p>
</li>
<li>
<p>The specification for this CRD, including the group (domain) name, the plural name and the supported schema version, which are used in the URL to access the API of the topic. The other names are used to identify instance resources in the CLI. For example, <code>kubectl get kafkatopic my-topic</code> or <code>kubectl get kafkatopics</code>.</p>
</li>
<li>
<p>The shortname can be used in CLI commands. For example, <code>kubectl get kt</code> can be used as an abbreviation instead of <code>kubectl get kafkatopic</code>.</p>
</li>
<li>
<p>The information presented when using a <code>get</code> command on the custom resource.</p>
</li>
<li>
<p>The current status of the CRD as described in the <a href="./configuring.html#type-Kafka-reference" target="_blank" rel="noopener">schema reference</a> for the resource.</p>
</li>
<li>
<p>openAPIV3Schema validation provides validation for the creation of topic custom resources. For example, a topic requires at least one partition and one replica.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can identify the CRD YAML files supplied with the Strimzi installation files, because the file names contain an index number followed by ‘Crd’.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is a corresponding example of a <code>KafkaTopic</code> custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic custom resource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic <b class="conum">(1)</b>
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster <b class="conum">(2)</b>
spec: <b class="conum">(3)</b>
  partitions: 1
  replicas: 1
  config:
    retention.ms: 7200000
    segment.bytes: 1073741824
status:
  conditions: <b class="conum">(4)</b>
    lastTransitionTime: "2019-08-20T11:37:00.706Z"
    status: "True"
    type: Ready
  observedGeneration: 1
  / ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>kind</code> and <code>apiVersion</code> identify the CRD of which the custom resource is an instance.</p>
</li>
<li>
<p>A label, applicable only to <code>KafkaTopic</code> and <code>KafkaUser</code> resources, that defines the name of the Kafka cluster (which is same as the name of the <code>Kafka</code> resource) to which a topic or user belongs.</p>
</li>
<li>
<p>The spec shows the number of partitions and replicas for the topic as well as the configuration parameters for the topic itself. In this example, the retention period for a message to remain in the topic and the segment file size for the log are specified.</p>
</li>
<li>
<p>Status conditions for the <code>KafkaTopic</code> resource. The <code>type</code> condition changed to <code>Ready</code> at the <code>lastTransitionTime</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Custom resources can be applied to a cluster through the platform CLI.
When the custom resource is created, it uses the same validation as the built-in resources of the Kubernetes API.</p>
</div>
<div class="paragraph">
<p>After a <code>KafkaTopic</code> custom resource is created, the Topic Operator is notified and corresponding Kafka topics are created in Strimzi.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/" target="_blank" rel="noopener">Extend the Kubernetes API with CustomResourceDefinitions</a></p>
</li>
<li>
<p><a href="#deploy-examples-str">Example configuration files provided with Strimzi</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-kafka-bridge-concepts-str"><a class="link" href="#con-kafka-bridge-concepts-str">1.3. Using the Kafka Bridge to connect with a Kafka cluster</a></h3>
<div class="paragraph _abstract">
<p>You can use the Strimzi Kafka Bridge API to create and manage consumers and send and receive records over HTTP rather than the native Kafka protocol.</p>
</div>
<div class="paragraph">
<p>When you set up the Kafka Bridge you configure HTTP access to the Kafka cluster.
You can then use the Kafka Bridge to produce and consume messages from the cluster, as well as performing other operations through its REST interface.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For information on installing and using the Kafka Bridge, see <a href="https://strimzi.io/docs/bridge/latest/" target="_blank" rel="noopener">Using the Strimzi Kafka Bridge</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="document-conventions-str"><a class="link" href="#document-conventions-str">1.4. Document Conventions</a></h3>
<div class="paragraph">
<div class="title">User-replaced values</div>
<p>User-replaced values, also known as <em>replaceables</em>, are shown in <em>italics</em> with angle brackets (&lt; &gt;).
Underscores ( _ ) are used for multi-word values.
If the value refers to code or commands, <code>monospace</code> is also used.</p>
</div>
<div class="paragraph">
<p>For example, in the following code, you will want to replace <code><em>&lt;my_namespace&gt;</em></code> with the name of your namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: <em>&lt;my_namespace&gt;</em>/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</div>
<div class="sect2 _additional-resources">
<h3 id="additional_resources"><a class="link" href="#additional_resources">1.5. Additional resources</a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="./overview.html" target="_blank" rel="noopener">Strimzi Overview</a></p>
</li>
<li>
<p><a href="./configuring.html" target="_blank" rel="noopener">Configuring Strimzi</a></p>
</li>
<li>
<p><a href="https://strimzi.io/docs/bridge/latest/" target="_blank" rel="noopener">Using the Strimzi Kafka Bridge</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="con-strimzi-installation-methods_str"><a class="link" href="#con-strimzi-installation-methods_str">2. Strimzi installation methods</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>You can install Strimzi on Kubernetes 1.19 and later in three ways.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Installation method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#deploy-tasks_str">Installation artifacts (YAML files)</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Download the release artifacts from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
<div class="paragraph">
<p>Download the <code>strimzi-<em>&lt;version&gt;</em>.zip</code> or <code>strimzi-<em>&lt;version&gt;</em>.tar.gz</code> archive file.
The archive file contains installation artifacts and example configuration files.</p>
</div>
<div class="paragraph">
<p>Deploy the YAML installation artifacts to your Kubernetes cluster using <code>kubectl</code>.
You start by deploying the Cluster Operator from <code>install/cluster-operator</code> to a single namespace, multiple namespaces, or all namespaces.</p>
</div>
<div class="paragraph">
<p>You can also use the <code>install/</code> artifacts to deploy the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Strimi administrator roles (<code>strimzi-admin</code>)</p>
</li>
<li>
<p>A standalone Topic Operator (<code>topic-operator</code>)</p>
</li>
<li>
<p>A standalone User Operator (<code>user-operator</code>)</p>
</li>
<li>
<p>Strimzi Drain Cleaner (<code>drain-cleaner</code>)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#deploying-strimzi-from-operator-hub-str">OperatorHub.io</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the <strong>Strimzi Kafka</strong> operator in the OperatorHub.io to deploy the Cluster Operator. You then deploy Strimzi components using custom resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#deploying-cluster-operator-helm-chart-str">Helm chart</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a Helm chart to deploy the Cluster Operator. You then deploy Strimzi components using custom resources.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For the greatest flexibility, choose the installation artifacts method.
The OperatorHub.io method provides a standard configuration and allows you to take advantage of automatic updates.
Helm charts provide a convenient way to manage the installation of applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-options_str"><a class="link" href="#deploy-options_str">3. What is deployed with Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Kafka components are provided for deployment to Kubernetes with the Strimzi distribution.
The Kafka components are generally run as clusters for availability.</p>
</div>
<div class="paragraph">
<p>A typical deployment incorporating Kafka components might include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Kafka</strong> cluster of broker nodes</p>
</li>
<li>
<p><strong>ZooKeeper</strong> cluster of replicated ZooKeeper instances</p>
</li>
<li>
<p><strong>Kafka Connect</strong> cluster for external data connections</p>
</li>
<li>
<p><strong>Kafka MirrorMaker</strong> cluster to mirror the Kafka cluster in a secondary cluster</p>
</li>
<li>
<p><strong>Kafka Exporter</strong> to extract additional Kafka metrics data for monitoring</p>
</li>
<li>
<p><strong>Kafka Bridge</strong> to make HTTP-based requests to the Kafka cluster</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not all of these components are mandatory, though you need Kafka and ZooKeeper as a minimum.
Some components can be deployed without Kafka, such as MirrorMaker or Kafka Connect.</p>
</div>
<div class="sect2">
<h3 id="deploy-options-order-str"><a class="link" href="#deploy-options-order-str">3.1. Order of deployment</a></h3>
<div class="paragraph _abstract">
<p>The required order of deployment to a Kubernetes cluster is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy the Cluster Operator to manage your Kafka cluster</p>
</li>
<li>
<p>Deploy the Kafka cluster with the ZooKeeper cluster, and include the Topic Operator and User Operator in the deployment</p>
</li>
<li>
<p>Optionally deploy:</p>
<div class="ulist">
<ul>
<li>
<p>The Topic Operator and User Operator standalone if you did not deploy them with the Kafka cluster</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
<li>
<p>Components for the monitoring of metrics</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Cluster Operator creates Kubernetes resources for the components,
such as <code>Deployment</code>, <code>Service</code>, and <code>Pod</code> resources.
The names of the Kubernetes resources are appended with the name specified for a component when it&#8217;s deployed.
For example, a Kafka cluster named <code>my-kafka-cluster</code> has a service named <code>my-kafka-cluster-kafka</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-tasks-prereqs_str"><a class="link" href="#deploy-tasks-prereqs_str">4. Preparing for your Strimzi deployment</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section shows how you prepare for a Strimzi deployment, describing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploy-prereqs-str">The prerequisites you need before you can deploy Strimzi</a></p>
</li>
<li>
<p><a href="#downloads-str">How to download the Strimzi release artifacts to use in your deployment</a></p>
</li>
<li>
<p><a href="#container-images-str">How to push the Strimzi container images into you own registry (if required)</a></p>
</li>
<li>
<p><a href="#adding-users-the-strimzi-admin-role-str">How to set up <em>admin</em> roles for configuration of custom resources used in deployment</a></p>
</li>
<li>
<p><a href="#deploy-kubernetes-str"><em>Minikube</em> as an alternative deployment option to Kubernetes</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To run the commands in this guide, your cluster user must have the rights to manage role-based access control (RBAC) and CRDs.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="deploy-prereqs-str"><a class="link" href="#deploy-prereqs-str">4.1. Deployment prerequisites</a></h3>
<div class="paragraph">
<p>To deploy Strimzi, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Kubernetes 1.19 and later cluster.</p>
<div class="paragraph">
<p>If you do not have access to a Kubernetes cluster, you can install Strimzi with <a href="#deploy-kubernetes-str"><em>Minikube</em></a>.</p>
</div>
</li>
<li>
<p>The <code>kubectl</code> command-line tool is installed and configured to connect to the running cluster.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi supports some features that are specific to OpenShift,
where such integration benefits OpenShift users and there is no equivalent implementation using standard Kubernetes.
</td>
</tr>
</table>
</div>
<h4 id="oc_and_kubectl_commands" class="discrete"><code>oc</code> and <code>kubectl</code> commands</h4>
<div class="paragraph">
<p>The <code>oc</code> command functions as an alternative to <code>kubectl</code>.
In almost all cases the example <code>kubectl</code> commands used in this guide can be done using <code>oc</code> simply by replacing the command name (options and arguments remain the same).</p>
</div>
<div class="paragraph">
<p>In other words, instead of using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>your-file</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>when using OpenShift you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc apply -f <em>your-file</em></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As an exception to this general rule, <code>oc</code> uses <code>oc adm</code> subcommands for <em>cluster management</em> functionality,
whereas <code>kubectl</code> does not make this distinction.
For example, the <code>oc</code> equivalent of <code>kubectl taint</code> is <code>oc adm taint</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="downloads-str"><a class="link" href="#downloads-str">4.2. Downloading Strimzi release artifacts</a></h3>
<div class="paragraph _abstract">
<p>To use deployment files to install Strimzi, download and extract the files from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
<div class="paragraph">
<p>Strimzi release artifacts include sample YAML files to help you deploy the components of Strimzi to Kubernetes, perform common operations,
and configure your Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Use <code>kubectl</code> to deploy the Cluster Operator from the <code>install/cluster-operator</code> folder of the downloaded ZIP file.
For more information about deploying and configuring the Cluster Operator, see <a href="#cluster-operator-str">Deploying the Cluster Operator</a>.</p>
</div>
<div class="paragraph">
<p>In addition, if you want to use standalone installations of the Topic and User Operators with a Kafka cluster that is not managed by the Strimzi Cluster Operator, you can deploy them from the <code>install/topic-operator</code> and <code>install/user-operator</code> folders.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Additionally, Strimzi container images are available through the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.
However, we recommend that you use the YAML files provided to deploy Strimzi.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="deploy-examples-str"><a class="link" href="#deploy-examples-str">4.3. Example configuration and deployment files</a></h3>
<div class="paragraph _abstract">
<p>Use the example configuration and deployment files provided with Strimzi to deploy Kafka components with different configurations and monitor your deployment.
Example configuration files for custom resources contain important properties and values, which you can extend with additional supported configuration properties for your own deployment.</p>
</div>
<div class="sect3">
<h4 id="example_files_location"><a class="link" href="#example_files_location">4.3.1. Example files location</a></h4>
<div class="paragraph">
<p>The example files are provided with the downloadable release artifacts from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
<div class="paragraph">
<p>You can also access the example files directly from the
<a href="https://github.com/strimzi/strimzi-kafka-operator/tree/main/examples/" target="_blank" rel="noopener"><code>examples</code> directory</a>.</p>
</div>
<div class="paragraph">
<p>You can download and apply the examples using the <code>kubectl</code> command-line tool.
The examples can serve as a starting point when building your own Kafka component configuration for deployment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you installed Strimzi using the Operator, you can still download the example files and use them to upload configuration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="example_files_provided_with_strimzi"><a class="link" href="#example_files_provided_with_strimzi">4.3.2. Example files provided with Strimzi</a></h4>
<div class="paragraph">
<p>The release artifacts include an <code>examples</code> directory that contains the configuration examples.</p>
</div>
<div class="listingblock">
<div class="title">Examples directory</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">examples
├── user <b class="conum">(1)</b>
├── topic <b class="conum">(2)</b>
├── security <b class="conum">(3)</b>
│   ├── tls-auth
│   ├── scram-sha-512-auth
│   └── keycloak-authorization
├── mirror-maker <b class="conum">(4)</b>
├── metrics <b class="conum">(5)</b>
├── kafka <b class="conum">(6)</b>
├── cruise-control <b class="conum">(7)</b>
├── connect <b class="conum">(8)</b>
└── bridge <b class="conum">(9)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>KafkaUser</code> custom resource configuration, which is managed by the User Operator.</p>
</li>
<li>
<p><code>KafkaTopic</code> custom resource configuration, which is managed by Topic Operator.</p>
</li>
<li>
<p>Authentication and authorization configuration for Kafka components. Includes example configuration for TLS and SCRAM-SHA-512 authentication. The Keycloak example includes <code>Kafka</code> custom resource configuration and a Keycloak realm specification. You can use the example to try Keycloak authorization services. There is also an example with enabled <code>oauth</code> authentication and <code>keycloak</code> authorization metrics.</p>
</li>
<li>
<p><code>Kafka</code> custom resource configuration for a deployment of Mirror Maker. Includes example configuration for replication policy and synchronization frequency.</p>
</li>
<li>
<p><a href="#assembly-metrics-config-files-str">Metrics configuration</a>, including Prometheus installation and Grafana dashboard files.</p>
</li>
<li>
<p><code>Kafka</code> custom resource configuration for a deployment of Kafka. Includes example configuration for an ephemeral or persistent single or multi-node deployment.</p>
</li>
<li>
<p><code>Kafka</code> custom resource with a deployment configuration for Cruise Control. Includes <code>KafkaRebalance</code> custom resources to generate optimizations proposals from Cruise Control, with example configurations to use the default or user optimization goals.</p>
</li>
<li>
<p><code>KafkaConnect</code> and <code>KafkaConnector</code> custom resource configuration for a deployment of Kafka Connect. Includes example configuration for a single or multi-node deployment.</p>
</li>
<li>
<p><code>KafkaBridge</code> custom resource configuration for a deployment of Kafka Bridge.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#assembly-deployment-configuration-str" target="_blank" rel="noopener">Configuring a Strimzi deployment</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="container-images-str"><a class="link" href="#container-images-str">4.4. Pushing container images to your own registry</a></h3>
<div class="paragraph">
<p>Container images for Strimzi are available in the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.
The installation YAML files provided by Strimzi will pull the images directly from the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a>.</p>
</div>
<div class="paragraph">
<p>If you do not have access to the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> or want to use your own container repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pull <strong>all</strong> container images listed here</p>
</li>
<li>
<p>Push them into your own registry</p>
</li>
<li>
<p>Update the image names in the YAML files used in deployment</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Each Kafka version supported for the release has a separate image.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Container image</th>
<th class="tableblock halign-left valign-top">Namespace/Repository</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/kafka:latest-kafka-3.2.0</p>
</li>
<li>
<p>quay.io/strimzi/kafka:latest-kafka-3.2.1</p>
</li>
<li>
<p>quay.io/strimzi/kafka:latest-kafka-3.2.3</p>
</li>
<li>
<p>quay.io/strimzi/kafka:latest-kafka-3.3.1</p>
</li>
<li>
<p>quay.io/strimzi/kafka:latest-kafka-3.3.2</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running Kafka, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka Broker</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>ZooKeeper</p>
</li>
<li>
<p>TLS Sidecars</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/operator:latest</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running the operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster Operator</p>
</li>
<li>
<p>Topic Operator</p>
</li>
<li>
<p>User Operator</p>
</li>
<li>
<p>Kafka Initializer</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/kafka-bridge:0.24.0</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running the Strimzi kafka Bridge</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strimzi Drain Cleaner</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/drain-cleaner:0.3.1</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running the Strimzi Drain Cleaner</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JmxTrans</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>quay.io/strimzi/jmxtrans:latest</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Strimzi image for running the Strimzi JmxTrans</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="adding-users-the-strimzi-admin-role-str"><a class="link" href="#adding-users-the-strimzi-admin-role-str">4.5. Designating Strimzi administrators</a></h3>
<div class="paragraph">
<p>Strimzi provides custom resources for configuration of your deployment.
By default, permission to view, create, edit, and delete these resources is limited to Kubernetes cluster administrators.
Strimzi provides two cluster roles that you can use to assign these rights to other users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>strimzi-view</code> allows users to view and list Strimzi resources.</p>
</li>
<li>
<p><code>strimzi-admin</code> allows users to also create, edit or delete Strimzi resources.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you install these roles, they will automatically aggregate (add) these rights to the default Kubernetes cluster roles.
<code>strimzi-view</code> aggregates to the <code>view</code> role, and <code>strimzi-admin</code> aggregates to the <code>edit</code> and <code>admin</code> roles.
Because of the aggregation, you might not need to assign these roles to users who already have similar rights.</p>
</div>
<div class="paragraph">
<p>The following procedure shows how to assign a <code>strimzi-admin</code> role that allows non-cluster administrators to manage Strimzi resources.</p>
</div>
<div class="paragraph">
<p>A system administrator can designate Strimzi administrators after the Cluster Operator is deployed.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Strimzi Custom Resource Definitions (CRDs) and role-based access control (RBAC) resources to manage the CRDs have been <a href="#cluster-operator-str">deployed with the Cluster Operator</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the <code>strimzi-view</code> and <code>strimzi-admin</code> cluster roles in Kubernetes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/strimzi-admin</code></pre>
</div>
</div>
</li>
<li>
<p>If needed, assign the roles that provide access rights to users that require them.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create clusterrolebinding strimzi-admin --clusterrole=strimzi-admin --user=<em>user1</em> --user=<em>user2</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="deploy-kubernetes-str"><a class="link" href="#deploy-kubernetes-str">4.6. Installing a local Kubernetes cluster with Minikube</a></h3>
<div class="paragraph">
<p>Minikube offers an easy way to get started with Kubernetes.
If a Kubernetes cluster is unavailable, you can use Minikube to create a local cluster.</p>
</div>
<div class="paragraph">
<p>You can download and install Minikube from the <a href="https://kubernetes.io/docs/home/">Kubernetes website</a>, which also provides documentation.
Depending on the number of brokers you want to deploy inside the cluster, and whether you want to run Kafka Connect as well,
try running Minikube with at least with 4 GB of RAM instead of the default 2 GB.</p>
</div>
<div class="paragraph">
<p>Once installed, start Minikube using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">minikube start --memory 4096</code></pre>
</div>
</div>
<div class="paragraph">
<p>To interact with the cluster, install the <a href="https://kubernetes.io/docs/tasks/tools/"><code>kubectl</code></a> utility.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-tasks_str"><a class="link" href="#deploy-tasks_str">5. Deploying Strimzi using installation artifacts</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Having <a href="#deploy-tasks-prereqs_str">prepared your environment for a deployment of Strimzi</a>, you can deploy Strimzi to a Kubernetes cluster.
Use the installation files provided with the release artifacts.</p>
</div>
<div class="paragraph">
<p>You can deploy Strimzi latest on Kubernetes 1.19 and later.</p>
</div>
<div class="paragraph">
<p>The steps to deploy Strimzi using the installation files are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#cluster-operator-str">Deploy the Cluster Operator</a></p>
</li>
<li>
<p>Use the Cluster Operator to deploy the following:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#kafka-cluster-str">Kafka cluster</a></p>
</li>
<li>
<p><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-using-the-cluster-operator-str">User Operator</a></p>
</li>
</ol>
</div>
</li>
<li>
<p>Optionally, deploy the following Kafka components according to your requirements:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#kafka-connect-str">Kafka Connect</a></p>
</li>
<li>
<p><a href="#kafka-mirror-maker-str">Kafka MirrorMaker</a></p>
</li>
<li>
<p><a href="#kafka-bridge-str">Kafka Bridge</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
To run the commands in this guide, a Kubernetes user must have the rights to manage role-based access control (RBAC) and CRDs.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="con-deploy-paths-str"><a class="link" href="#con-deploy-paths-str">5.1. Basic deployment path</a></h3>
<div class="paragraph _abstract">
<p>You can set up a deployment where Strimzi manages a single Kafka cluster in the same namespace.
You might use this configuration for development or testing.
Or you can use Strimzi in a production environment to manage a number of Kafka clusters in different namespaces.</p>
</div>
<div class="paragraph">
<p>The first step for any deployment of Strimzi is to install the Cluster Operator using the <code>install/cluster-operator</code> files.</p>
</div>
<div class="paragraph">
<p>A single command applies all the installation files in the <code>cluster-operator</code> folder: <code>kubectl apply -f ./install/cluster-operator</code>.</p>
</div>
<div class="paragraph">
<p>The command sets up everything you need to be able to create and manage a Kafka deployment, including the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cluster Operator (<code>Deployment</code>, <code>ConfigMap</code>)</p>
</li>
<li>
<p>Strimzi CRDs (<code>CustomResourceDefinition</code>)</p>
</li>
<li>
<p>RBAC resources (<code>ClusterRole</code>, <code>ClusterRoleBinding</code>, <code>RoleBinding</code>)</p>
</li>
<li>
<p>Service account (<code>ServiceAccount</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The basic deployment path is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#downloads-str">Download the release artifacts</a></p>
</li>
<li>
<p>Create a Kubernetes namespace in which to deploy the Cluster Operator</p>
</li>
<li>
<p><a href="#cluster-operator-str">Deploy the Cluster Operator</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Update the <code>install/cluster-operator</code> files to use the namespace created for the Cluster Operator</p>
</li>
<li>
<p>Install the Cluster Operator to watch one, multiple, or all namespaces</p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#kafka-cluster-str">Create a Kafka cluster</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After which, you can deploy other Kafka components and set up monitoring of your deployment.</p>
</div>
</div>
<div class="sect2">
<h3 id="cluster-operator-str"><a class="link" href="#cluster-operator-str">5.2. Deploying the Cluster Operator</a></h3>
<div class="paragraph _abstract">
<p>The Cluster Operator is responsible for deploying and managing Kafka clusters within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>When the Cluster Operator is running, it starts to watch for updates of Kafka resources.</p>
</div>
<div class="paragraph">
<p>By default, a single replica of the Cluster Operator is deployed.
You can add replicas with leader election so that additional Cluster Operators are on standby in case of disruption.
For more information, see <a href="./configuring.html#assembly-using-multiple-cluster-operator-replicas-str">Running multiple Cluster Operator replicas with leader election</a>.</p>
</div>
<div class="sect3">
<h4 id="con-cluster-operator-watch-options-str"><a class="link" href="#con-cluster-operator-watch-options-str">5.2.1. Specifying the namespaces the Cluster Operator watches</a></h4>
<div class="paragraph _abstract">
<p>The Cluster Operator watches for updates in the namespaces where the Kafka resources are deployed.
When you deploy the Cluster Operator, you specify which namespaces to watch.
You can specify the following namespaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">A single namespace</a> (the same namespace containing the Cluster Operator)</p>
</li>
<li>
<p><a href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">Multiple namespaces</a></p>
</li>
<li>
<p><a href="#deploying-cluster-operator-to-watch-whole-cluster-str">All namespaces</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The Cluster Operator can watch one, multiple, or all namespaces in a Kubernetes cluster.
The Topic Operator and User Operator watch for <code>KafkaTopic</code> and <code>KafkaUser</code> resources in a single namespace. For more information, see <a href="./configuring.html#con-operators-namespaces-str" target="_blank" rel="noopener">Watching namespaces with Strimzi operators</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Cluster Operator watches for changes to the following resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kafka</code> for the Kafka cluster.</p>
</li>
<li>
<p><code>KafkaConnect</code> for the Kafka Connect cluster.</p>
</li>
<li>
<p><code>KafkaConnector</code> for creating and managing connectors in a Kafka Connect cluster.</p>
</li>
<li>
<p><code>KafkaMirrorMaker</code> for the Kafka MirrorMaker instance.</p>
</li>
<li>
<p><code>KafkaMirrorMaker2</code> for the Kafka MirrorMaker 2.0 instance.</p>
</li>
<li>
<p><code>KafkaBridge</code> for the Kafka Bridge instance.</p>
</li>
<li>
<p><code>KafkaRebalance</code> for the Cruise Control optimization requests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When one of these resources is created in the Kubernetes cluster, the operator gets the cluster description from the resource and starts creating a new cluster for the resource by creating the necessary Kubernetes resources, such as StatefulSets, Services and ConfigMaps.</p>
</div>
<div class="paragraph">
<p>Each time a Kafka resource is updated, the operator performs corresponding updates on the Kubernetes resources that make up the cluster for the resource.</p>
</div>
<div class="paragraph">
<p>Resources are either patched or deleted, and then recreated in order to make the cluster for the resource reflect the desired state of the cluster.
This operation might cause a rolling update that might lead to service disruption.</p>
</div>
<div class="paragraph">
<p>When a resource is deleted, the operator undeploys the cluster and deletes all related Kubernetes resources.</p>
</div>
</div>
<div class="sect3">
<h4 id="deploying-cluster-operator-str"><a class="link" href="#deploying-cluster-operator-str">5.2.2. Deploying the Cluster Operator to watch a single namespace</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources in a single namespace in your Kubernetes cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code>my-cluster-operator-namespace</code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n my-cluster-operator-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n my-cluster-operator-namespace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
strimzi-cluster-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-cluster-operator-to-watch-multiple-namespaces-str"><a class="link" href="#deploying-cluster-operator-to-watch-multiple-namespaces-str">5.2.3. Deploying the Cluster Operator to watch multiple namespaces</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources across multiple namespaces in your Kubernetes cluster.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code>my-cluster-operator-namespace</code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file
to add a list of all the namespaces the Cluster Operator will watch to the <code>STRIMZI_NAMESPACE</code> environment variable.</p>
<div class="paragraph">
<p>For example, in this  procedure the Cluster Operator will watch the namespaces <code>watched-namespace-1</code>, <code>watched-namespace-2</code>, <code>watched-namespace-3</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      serviceAccountName: strimzi-cluster-operator
      containers:
      - name: strimzi-cluster-operator
        image: quay.io/strimzi/operator:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: STRIMZI_NAMESPACE
          value: watched-namespace-1,watched-namespace-2,watched-namespace-3</code></pre>
</div>
</div>
</li>
<li>
<p>For each namespace listed, install the <code>RoleBindings</code>.</p>
<div class="paragraph">
<p>In this example, we replace <code><em>watched-namespace</em></code> in these commands with the namespaces listed in the previous step,
repeating them for <code>watched-namespace-1</code>, <code>watched-namespace-2</code>, <code>watched-namespace-3</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator/020-RoleBinding-strimzi-cluster-operator.yaml -n <em>&lt;watched_namespace&gt;</em>
kubectl create -f install/cluster-operator/023-RoleBinding-strimzi-cluster-operator.yaml -n <em>&lt;watched_namespace&gt;</em>
kubectl create -f install/cluster-operator/031-RoleBinding-strimzi-cluster-operator-entity-operator-delegation.yaml -n <em>&lt;watched_namespace&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n my-cluster-operator-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n my-cluster-operator-namespace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
strimzi-cluster-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-cluster-operator-to-watch-whole-cluster-str"><a class="link" href="#deploying-cluster-operator-to-watch-whole-cluster-str">5.2.4. Deploying the Cluster Operator to watch all namespaces</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Cluster Operator to watch Strimzi resources across all namespaces in your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>When running in this mode, the Cluster Operator automatically manages clusters in any new namespaces that are created.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You need an account with permission to create and manage <code>CustomResourceDefinition</code> and RBAC (<code>ClusterRole</code>, and <code>RoleBinding</code>) resources.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the Strimzi installation files to use the namespace the Cluster Operator is going to be installed into.</p>
<div class="paragraph">
<p>For example, in this procedure the Cluster Operator is installed into the namespace <code>my-cluster-operator-namespace</code>.</p>
</div>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to set the value of the <code>STRIMZI_NAMESPACE</code> environment variable to <code>*</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
spec:
  # ...
  template:
    spec:
      # ...
      serviceAccountName: strimzi-cluster-operator
      containers:
      - name: strimzi-cluster-operator
        image: quay.io/strimzi/operator:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: STRIMZI_NAMESPACE
          value: "*"
        # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create <code>ClusterRoleBindings</code> that grant cluster-wide access for all namespaces to the Cluster Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create clusterrolebinding strimzi-cluster-operator-namespaced --clusterrole=strimzi-cluster-operator-namespaced --serviceaccount my-cluster-operator-namespace:strimzi-cluster-operator
kubectl create clusterrolebinding strimzi-cluster-operator-watched --clusterrole=strimzi-cluster-operator-watched --serviceaccount my-cluster-operator-namespace:strimzi-cluster-operator
kubectl create clusterrolebinding strimzi-cluster-operator-entity-operator-delegation --clusterrole=strimzi-entity-operator --serviceaccount my-cluster-operator-namespace:strimzi-cluster-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator to your Kubernetes cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/cluster-operator -n my-cluster-operator-namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n my-cluster-operator-namespace</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                      READY  UP-TO-DATE  AVAILABLE
strimzi-cluster-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-cluster-str"><a class="link" href="#kafka-cluster-str">5.3. Deploying Kafka</a></h3>
<div class="paragraph _abstract">
<p>To be able to manage a Kafka cluster with the Cluster Operator, you must deploy it as a <code>Kafka</code> resource.
Strimzi provides example deployment files to do this.
You can use these files to deploy the Topic Operator and User Operator at the same time.</p>
</div>
<div class="paragraph">
<p>After you have deployed the Cluster Operator, use a <code>Kafka</code> resource to deploy the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-kafka-cluster-str">Kafka cluster</a></p>
</li>
<li>
<p><a href="#deploying-the-topic-operator-using-the-cluster-operator-str">Topic Operator</a></p>
</li>
<li>
<p><a href="#deploying-the-user-operator-using-the-cluster-operator-str">User Operator</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When installing Kafka, Strimzi also installs a ZooKeeper cluster and adds the necessary configuration to connect Kafka with ZooKeeper.</p>
</div>
<div class="paragraph">
<p>If you haven&#8217;t deployed a Kafka cluster as a <code>Kafka</code> resource, you can&#8217;t use the Cluster Operator to manage it.
This applies, for example, to a Kafka cluster running outside of Kubernetes.
However, you can use the Topic Operator and User Operator with a Kafka cluster that is <strong>not managed</strong> by Strimzi, by <a href="#deploy-standalone-operators_str">deploying them as standalone components</a>.
You can also deploy and use other Kafka components with a Kafka cluster not managed by Strimzi.</p>
</div>
<div class="sect3">
<h4 id="deploying-kafka-cluster-str"><a class="link" href="#deploying-kafka-cluster-str">5.3.1. Deploying the Kafka cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>Kafka</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides the following <a href="#deploy-examples-str">example files</a> you can use to create a Kafka cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kafka-persistent.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with three ZooKeeper and three Kafka nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka-jbod.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with three ZooKeeper and three Kafka nodes (each using multiple persistent volumes).</p>
</dd>
<dt class="hdlist1"><code>kafka-persistent-single.yaml</code></dt>
<dd>
<p>Deploys a persistent cluster with a single ZooKeeper node and a single Kafka node.</p>
</dd>
<dt class="hdlist1"><code>kafka-ephemeral.yaml</code></dt>
<dd>
<p>Deploys an ephemeral cluster with three ZooKeeper and three Kafka nodes.</p>
</dd>
<dt class="hdlist1"><code>kafka-ephemeral-single.yaml</code></dt>
<dd>
<p>Deploys an ephemeral cluster with three ZooKeeper nodes and a single Kafka node.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In this procedure, we use the examples for an <em>ephemeral</em> and <em>persistent</em> Kafka cluster deployment.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Ephemeral cluster</dt>
<dd>
<p>In general, an ephemeral (or temporary) Kafka cluster is suitable for development and testing purposes, not for production. This deployment uses <code>emptyDir</code> volumes for storing broker information (for ZooKeeper) and topics or partitions (for Kafka). Using an <code>emptyDir</code> volume means that its content is strictly related to the pod life cycle and is deleted when the pod goes down.</p>
</dd>
<dt class="hdlist1">Persistent cluster</dt>
<dd>
<p>A persistent Kafka cluster uses persistent volumes to store ZooKeeper and Kafka data. A <code>PersistentVolume</code> is acquired using a <code>PersistentVolumeClaim</code> to make it independent of the actual type of the <code>PersistentVolume</code>. The <code>PersistentVolumeClaim</code> can use a <code>StorageClass</code> to trigger automatic volume provisioning.
When no <code>StorageClass</code> is specified, Kubernetes will try to use the default <code>StorageClass</code>.</p>
<div class="paragraph">
<p>The following examples show some common types of persistent volumes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your Kubernetes cluster runs on Amazon AWS, Kubernetes can provision Amazon EBS volumes</p>
</li>
<li>
<p>If your Kubernetes cluster runs on Microsoft Azure, Kubernetes can provision Azure Disk Storage volumes</p>
</li>
<li>
<p>If your Kubernetes cluster runs on Google Cloud, Kubernetes can provision Persistent Disk volumes</p>
</li>
<li>
<p>If your Kubernetes cluster runs on bare metal, Kubernetes can provision local persistent volumes</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The example YAML files specify the latest supported Kafka version, and configuration for its supported log message format version and inter-broker protocol version.
The <code>inter.broker.protocol.version</code> property for the Kafka <code>config</code> must be the version supported by the specified Kafka version (<code>spec.kafka.version</code>).
The property represents the version of Kafka protocol used in a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.</p>
</div>
<div class="paragraph">
<p>An update to the <code>inter.broker.protocol.version</code> is required when <a href="#assembly-upgrading-kafka-versions-str">upgrading Kafka</a>.</p>
</div>
<div class="paragraph">
<p>The example clusters are named <code>my-cluster</code> by default.
The cluster name is defined by the name of the resource and cannot be changed after the cluster has been deployed.
To change the cluster name before you deploy the cluster, edit the <code>Kafka.metadata.name</code> property of the <code>Kafka</code> resource in the relevant YAML file.</p>
</div>
<div class="listingblock">
<div class="title">Default cluster name and specified Kafka versions</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    version: 3.3.2
    #...
    config:
      #...
      log.message.format.version: "3.3"
      inter.broker.protocol.version: "3.3"
  # ...</code></pre>
</div>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create and deploy an ephemeral or persistent cluster.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>To create and deploy an ephemeral cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/kafka-ephemeral.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>To create and deploy a persistent cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/kafka/kafka-persistent.yaml</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the pod names and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY   STATUS    RESTARTS
my-cluster-entity-operator  3/3     Running   0
my-cluster-kafka-0          1/1     Running   0
my-cluster-kafka-1          1/1     Running   0
my-cluster-kafka-2          1/1     Running   0
my-cluster-zookeeper-0      1/1     Running   0
my-cluster-zookeeper-1      1/1     Running   0
my-cluster-zookeeper-2      1/1     Running   0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>With the default deployment, you install an Entity Operator cluster, 3 Kafka pods, and 3 ZooKeeper pods.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> shows as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="./configuring.html#assembly-config-kafka-str" target="_blank" rel="noopener">Kafka cluster configuration</a></p>
</div>
</div>
<div class="sect3">
<h4 id="deploying-the-topic-operator-using-the-cluster-operator-str"><a class="link" href="#deploying-the-topic-operator-using-the-cluster-operator-str">5.3.2. Deploying the Topic Operator using the Cluster Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to deploy the Topic Operator using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You configure the <code>entityOperator</code> property of the <code>Kafka</code> resource to include the <code>topicOperator</code>.
By default, the Topic Operator watches for <code>KafkaTopic</code> resources in the namespace of the Kafka cluster deployed by the Cluster Operator.
You can also specify a namespace using <code>watchedNamespace</code> in the Topic Operator <code>spec</code>.
A single Topic Operator can watch a single namespace.
One namespace should be watched by only one Topic Operator.</p>
</div>
<div class="paragraph">
<p>If you use Strimzi to deploy multiple Kafka clusters into the same namespace, enable the Topic Operator for only one Kafka cluster or use the <code>watchedNamespace</code> property to configure the Topic Operators to watch other namespaces.</p>
</div>
<div class="paragraph">
<p>If you want to use the Topic Operator with a Kafka cluster that is not managed by Strimzi,
you must <a href="#deploying-the-topic-operator-standalone-str">deploy the Topic Operator as a standalone component</a>.</p>
</div>
<div class="paragraph">
<p>For more information about configuring the <code>entityOperator</code> and <code>topicOperator</code> properties,
see <a href="./configuring.html#assembly-kafka-entity-operator-str" target="_blank" rel="noopener">Configuring the Entity Operator</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>entityOperator</code> properties of the <code>Kafka</code> resource to include <code>topicOperator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  #...
  entityOperator:
    <strong>topicOperator: {}</strong>
    userOperator: {}</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Topic Operator <code>spec</code> using the properties described in <a href="./configuring.html#type-EntityTopicOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityTopicOperatorSpec</code> schema reference</a>.</p>
<div class="paragraph">
<p>Use an empty object (<code>{}</code>) if you want all properties to use their default values.</p>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the pod name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY   STATUS    RESTARTS
my-cluster-entity-operator  3/3     Running   0
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> shows as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-the-user-operator-using-the-cluster-operator-str"><a class="link" href="#deploying-the-user-operator-using-the-cluster-operator-str">5.3.3. Deploying the User Operator using the Cluster Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to deploy the User Operator using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You configure the <code>entityOperator</code> property of the <code>Kafka</code> resource to include the <code>userOperator</code>.
By default, the User Operator watches for <code>KafkaUser</code> resources in the namespace of the Kafka cluster deployment.
You can also specify a namespace using <code>watchedNamespace</code> in the User Operator <code>spec</code>.
A single User Operator can watch a single namespace.
One namespace should be watched by only one User Operator.</p>
</div>
<div class="paragraph">
<p>If you want to use the User Operator with a Kafka cluster that is not managed by Strimzi,
you must <a href="#deploying-the-user-operator-standalone-str">deploy the User Operator as a standalone component</a>.</p>
</div>
<div class="paragraph">
<p>For more information about configuring the <code>entityOperator</code> and <code>userOperator</code> properties, see <a href="./configuring.html#assembly-kafka-entity-operator-str" target="_blank" rel="noopener">Configuring the Entity Operator</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>entityOperator</code> properties of the <code>Kafka</code> resource to include <code>userOperator</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  #...
  entityOperator:
    topicOperator: {}
    <strong>userOperator: {}</strong></code></pre>
</div>
</div>
</li>
<li>
<p>Configure the User Operator <code>spec</code> using the properties described in <a href="./configuring.html#type-EntityUserOperatorSpec-reference" target="_blank" rel="noopener"><code>EntityUserOperatorSpec</code> schema reference</a>.</p>
<div class="paragraph">
<p>Use an empty object (<code>{}</code>) if you want all properties to use their default values.</p>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the pod name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY   STATUS    RESTARTS
my-cluster-entity-operator  3/3     Running   0
# ...</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-cluster</code> is the name of the Kafka cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>STATUS</code> shows as <code>Running</code>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-connect-str"><a class="link" href="#kafka-connect-str">5.4. Deploying Kafka Connect</a></h3>
<div class="paragraph _abstract">
<p><a href="https://kafka.apache.org/documentation/#connect" target="_blank" rel="noopener">Kafka Connect</a> is a tool for streaming data between Apache Kafka and other systems.
For example, Kafka Connect might integrate Kafka with external databases or storage and messaging systems.</p>
</div>
<div class="paragraph">
<p>In Strimzi, Kafka Connect is deployed in distributed mode.
Kafka Connect can also work in standalone mode, but this is not supported by Strimzi.</p>
</div>
<div class="paragraph">
<p>Using the concept of <em>connectors</em>, Kafka Connect provides a framework for moving large amounts of data into and out of your Kafka cluster while maintaining scalability and reliability.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator manages Kafka Connect clusters deployed using the <code>KafkaConnect</code> resource and connectors created using the <code>KafkaConnector</code> resource.</p>
</div>
<div class="paragraph">
<p>In order to use Kafka Connect, you need to do the following.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#deploying-kafka-connect-str">Deploy a Kafka Connect cluster</a></p>
</li>
<li>
<p><a href="#using-kafka-connect-with-plug-ins-str">Add connectors to integrate with other systems</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The term <em>connector</em> is used interchangeably to mean a connector instance running within a Kafka Connect cluster, or a connector class.
In this guide, the term <em>connector</em> is used when the meaning is clear from the context.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="deploying-kafka-connect-str"><a class="link" href="#deploying-kafka-connect-str">5.4.1. Deploying Kafka Connect to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka Connect cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A Kafka Connect cluster is implemented as a <code>Deployment</code> with a configurable number of nodes (also called <em>workers</em>) that distribute the workload of connectors as <em>tasks</em> so that the message flow is highly scalable and reliable.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaConnect</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
In this procedure, we use the following example file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/connect/kafka-connect.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p><a href="#deploying-kafka-cluster-str">Running Kafka cluster.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka Connect to your Kubernetes cluster.
Use the <code>examples/connect/kafka-connect.yaml</code> file to deploy Kafka Connect.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/kafka-connect.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        READY  UP-TO-DATE  AVAILABLE
my-connect-cluster-connect  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-connect-cluster</code> is the name of the Kafka Connect cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p><a href="./configuring.html#assembly-kafka-connect-str" target="_blank" rel="noopener">Kafka Connect cluster configuration</a></p>
</div>
</div>
<div class="sect3">
<h4 id="con-kafka-connect-multiple-instances-str"><a class="link" href="#con-kafka-connect-multiple-instances-str">5.4.2. Configuring Kafka Connect for multiple instances</a></h4>
<div class="paragraph">
<p>If you are running multiple instances of Kafka Connect, you have to change the default configuration of the following <code>config</code> properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect
spec:
  # ...
  config:
    group.id: connect-cluster <b class="conum">(1)</b>
    offset.storage.topic: connect-cluster-offsets <b class="conum">(2)</b>
    config.storage.topic: connect-cluster-configs <b class="conum">(3)</b>
    status.storage.topic: connect-cluster-status  <b class="conum">(4)</b>
    # ...
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kafka Connect cluster ID within Kafka.</p>
</li>
<li>
<p>Kafka topic that stores connector offsets.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status configurations.</p>
</li>
<li>
<p>Kafka topic that stores connector and task status updates.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Values for the three topics must be the same for all Kafka Connect instances with the same <code>group.id</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Unless you change the default settings, each Kafka Connect instance connecting to the same Kafka cluster is deployed with the same values.
What happens, in effect, is all instances are coupled to run in a cluster and use the same topics.</p>
</div>
<div class="paragraph">
<p>If multiple Kafka Connect clusters try to use the same topics, Kafka Connect will not work as expected and generate errors.</p>
</div>
<div class="paragraph">
<p>If you wish to run multiple Kafka Connect instances, change the values of these properties for each instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-kafka-connect-with-plug-ins-str"><a class="link" href="#using-kafka-connect-with-plug-ins-str">5.4.3. Adding connectors</a></h4>
<div class="paragraph _abstract">
<p>Kafka Connect uses connectors to integrate with other systems to stream data.
A connector is an instance of a Kafka <code>Connector</code> class, which can be one of the following type:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Source connector</dt>
<dd>
<p>A source connector is a runtime entity that fetches data from an external system and feeds it to Kafka as messages.</p>
</dd>
<dt class="hdlist1">Sink connector</dt>
<dd>
<p>A sink connector is a runtime entity that fetches messages from Kafka topics and feeds them to an external system.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Kafka Connect uses a plugin architecture to provide the implementation artifacts for connectors.
Plugins allow connections to other systems and provide additional configuration to manipulate data.
Plugins include connectors and other components, such as data converters and transforms.
A connector operates with a specific type of external system.
Each connector defines a schema for its configuration.
You supply the configuration to Kafka Connect to create a connector instance within Kafka Connect.
Connector instances then define a set of tasks for moving data between systems.</p>
</div>
<div class="paragraph">
<p>Add connector plugins to Kafka Connect in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-new-image-using-kafka-connect-build-str">Configure Kafka Connect to build a new container image with plugins automatically</a></p>
</li>
<li>
<p><a href="#creating-new-image-from-base-str">Create a Docker image from the base Kafka Connect image</a> (manually or using continuous integration)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After plugins have been added to the container image, you can start, stop, and manage connector instances in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-deploying-kafkaconnector-str">Using Strimzi’s <code>KafkaConnector</code> custom resource</a></p>
</li>
<li>
<p><a href="#con-exposing-kafka-connect-api-str">Using the Kafka Connect API</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also create new connector instances using these options.</p>
</div>
<div class="sect4">
<h5 id="creating-new-image-using-kafka-connect-build-str"><a class="link" href="#creating-new-image-using-kafka-connect-build-str">Building a new container image with connector plugins automatically</a></h5>
<div class="paragraph _abstract">
<p>Configure Kafka Connect so that Strimzi automatically builds a new container image with additional connectors.
You define the connector plugins using the <code>.spec.build.plugins</code> property of the <code>KafkaConnect</code> custom resource.
Strimzi will automatically download and add the connector plugins into a new container image.
The container is pushed into the container repository specified in <code>.spec.build.output</code> and automatically used in the Kafka Connect deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
<li>
<p>A container registry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You need to provide your own container registry where images can be pushed to, stored, and pulled from.
Strimzi supports private container registries as well as public registries such as <a href="https://quay.io/" target="_blank" rel="noopener">Quay</a> or <a href="https://hub.docker.com//" target="_blank" rel="noopener">Docker Hub</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaConnect</code> custom resource by specifying the container registry in <code>.spec.build.output</code>, and additional connectors in <code>.spec.build.plugins</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec: # <b class="conum">(1)</b>
  #...
  build:
    output: # <b class="conum">(2)</b>
      type: docker
      image: my-registry.io/my-org/my-connect-cluster:latest
      pushSecret: my-registry-credentials
    plugins: # <b class="conum">(3)</b>
      - name: debezium-postgres-connector
        artifacts:
          - type: tgz
            url: https://repo1.maven.org/maven2/io/debezium/debezium-connector-postgres/2.1.1.Final/debezium-connector-postgres-2.1.1.Final-plugin.tar.gz
            sha512sum: 962a12151bdf9a5a30627eebac739955a4fd95a08d373b86bdcea2b4d0c27dd6e1edd5cb548045e115e33a9e69b1b2a352bee24df035a0447cb820077af00c03
      - name: camel-telegram
        artifacts:
          - type: tgz
            url: https://repo.maven.apache.org/maven2/org/apache/camel/kafkaconnector/camel-telegram-kafka-connector/0.9.0/camel-telegram-kafka-connector-0.9.0-package.tar.gz
            sha512sum: a9b1ac63e3284bea7836d7d24d84208c49cdf5600070e6bd1535de654f6920b74ad950d51733e8020bf4187870699819f54ef5859c7846ee4081507f48873479
  #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><a href="./configuring.html#type-KafkaConnectSpec-reference" target="_blank" rel="noopener">The specification for the Kafka Connect cluster</a>.</p>
</li>
<li>
<p>(Required) Configuration of the container registry where new images are pushed.</p>
</li>
<li>
<p>(Required) List of connector plugins and their artifacts to add to the new container image. Each plugin must be configured with at least one <code>artifact</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ kubectl apply -f &lt;kafka_connect_configuration_file&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the new container image to build, and for the Kafka Connect cluster to be deployed.</p>
</li>
<li>
<p>Use the Kafka Connect REST API or <code>KafkaConnector</code> custom resources to use the connector plugins you added.</p>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-Build-reference" target="_blank" rel="noopener">Kafka Connect <code>Build</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="creating-new-image-from-base-str"><a class="link" href="#creating-new-image-from-base-str">Building a new container image with connector plugins from the Kafka Connect base image</a></h5>
<div class="paragraph _abstract">
<p>Create a custom Docker image with connector plugins from the Kafka Connect base image
Add the custom image to the <code>/opt/kafka/plugins</code> directory.</p>
</div>
<div class="paragraph">
<p>You can use the Kafka container image on <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> as a base image for creating your own custom image with additional connector plugins.</p>
</div>
<div class="paragraph">
<p>At startup, the Strimzi version of Kafka Connect loads any third-party connector plugins contained in the <code>/opt/kafka/plugins</code> directory.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a new <code>Dockerfile</code> using <code>quay.io/strimzi/kafka:latest-kafka-3.3.2</code> as the base image:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">FROM quay.io/strimzi/kafka:latest-kafka-3.3.2
USER root:root
COPY ./<em>my-plugins</em>/ /opt/kafka/plugins/
USER 1001</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example plugins file</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ tree ./<em>my-plugins</em>/
./<em>my-plugins</em>/
├── debezium-connector-mongodb
│   ├── bson-&lt;version&gt;.jar
│   ├── CHANGELOG.md
│   ├── CONTRIBUTE.md
│   ├── COPYRIGHT.txt
│   ├── debezium-connector-mongodb-&lt;version&gt;.jar
│   ├── debezium-core-&lt;version&gt;.jar
│   ├── LICENSE.txt
│   ├── mongodb-driver-core-&lt;version&gt;.jar
│   ├── README.md
│   └── # ...
├── debezium-connector-mysql
│   ├── CHANGELOG.md
│   ├── CONTRIBUTE.md
│   ├── COPYRIGHT.txt
│   ├── debezium-connector-mysql-&lt;version&gt;.jar
│   ├── debezium-core-&lt;version&gt;.jar
│   ├── LICENSE.txt
│   ├── mysql-binlog-connector-java-&lt;version&gt;.jar
│   ├── mysql-connector-java-&lt;version&gt;.jar
│   ├── README.md
│   └── # ...
└── debezium-connector-postgres
    ├── CHANGELOG.md
    ├── CONTRIBUTE.md
    ├── COPYRIGHT.txt
    ├── debezium-connector-postgres-&lt;version&gt;.jar
    ├── debezium-core-&lt;version&gt;.jar
    ├── LICENSE.txt
    ├── postgresql-&lt;version&gt;.jar
    ├── protobuf-java-&lt;version&gt;.jar
    ├── README.md
    └── # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The COPY command points to the plugin files to copy to the container image.</p>
</div>
<div class="paragraph">
<p>This example adds plugins for Debezium connectors (MongoDB, MySQL, and PostgreSQL), though not all files are listed for brevity. Debezium running in Kafka Connect looks the same as any other Kafka Connect task.</p>
</div>
</li>
<li>
<p>Build the container image.</p>
</li>
<li>
<p>Push your custom image to your container registry.</p>
</li>
<li>
<p>Point to the new container image.</p>
<div class="paragraph">
<p>You can point to the image in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit the <code>KafkaConnect.spec.image</code> property of the <code>KafkaConnect</code> custom resource.</p>
<div class="paragraph">
<p>If set, this property overrides the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> environment variable in the Cluster Operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec: <b class="conum">(1)</b>
  #...
  image: my-new-container-image <b class="conum">(2)</b>
  config: <b class="conum">(3)</b>
    #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><a href="./configuring.html#type-KafkaConnectSpec-reference" target="_blank" rel="noopener">The specification for the Kafka Connect cluster</a>.</p>
</li>
<li>
<p>The docker image for the pods.</p>
</li>
<li>
<p>Configuration of the Kafka Connect <em>workers</em> (not connectors).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Edit the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> environment variable in the <code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to point to the new container image, and then reinstall the Cluster Operator.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#con-common-configuration-images-reference" target="_blank" rel="noopener">Container image configuration and the <code>KafkaConnect.spec.image property</code></a></p>
</li>
<li>
<p><a href="./configuring.html#ref-operator-cluster-str" target="_blank" rel="noopener">Cluster Operator configuration and the <code>STRIMZI_KAFKA_CONNECT_IMAGES</code> variable</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="proc-deploying-kafkaconnector-str"><a class="link" href="#proc-deploying-kafkaconnector-str">Deploying KafkaConnector resources</a></h5>
<div class="paragraph _abstract">
<p>Deploy <code>KafkaConnector</code> resources to manage connectors.
The <code>KafkaConnector</code> custom resource offers a Kubernetes-native approach to management of connectors by the Cluster Operator.
You don&#8217;t need to send HTTP requests to manage connectors, as with the Kafka Connect REST API.
You manage a running connector instance by updating its corresponding <code>KafkaConnector</code> resource, and then applying the updates.
The Cluster Operator updates the configurations of the running connector instances.
You remove a connector by deleting its corresponding <code>KafkaConnector</code>.</p>
</div>
<div class="paragraph">
<p><code>KafkaConnector</code> resources must be deployed to the same namespace as the Kafka Connect cluster they link to.</p>
</div>
<div class="paragraph">
<p>In the configuration shown in this procedure, the <code>autoRestart</code> property is set to <code>true</code>.
This enables automatic restarts of failed connectors and tasks.
Up to seven restart attempts are made, after which restarts must be made manually.
You annotate the <code>KafkaConnector</code> resource to <a href="#proc-manual-restart-connector-str">restart a connector</a> or <a href="#proc-manual-restart-connector-task-str">restart a connector task</a> manually.</p>
</div>
<div class="paragraph">
<div class="title">Example connectors</div>
<p>You can use your own connectors or try the examples provided by Strimzi.
Up until Apache Kafka 3.1.0, example file connector plugins were included with Apache Kafka.
Starting from the 3.1.1 and 3.2.0 releases of Apache Kafka, the examples need to be <a href="#using-kafka-connect-with-plug-ins-str">added to the plugin path as any other connector</a>.</p>
</div>
<div class="paragraph">
<p>Strimzi provides an <a href="#deploy-examples-str">example <code>KafkaConnector</code> configuration file</a> (<code>examples/connect/source-connector.yaml</code>) for the example file connector plugins, which creates the following connector instances as <code>KafkaConnector</code> resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>FileStreamSourceConnector</code> instance that reads each line from the Kafka license file (the source) and writes the data as messages to a single Kafka topic.</p>
</li>
<li>
<p>A <code>FileStreamSinkConnector</code> instance that reads messages from the Kafka topic and writes the messages to a temporary file (the sink).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We use the example file to create connectors in this procedure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The example connectors are not intended for use in a production environment.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kafka Connect deployment</p>
</li>
<li>
<p>The Cluster Operator is running</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the <code>FileStreamSourceConnector</code> and <code>FileStreamSinkConnector</code> plugins to Kafka Connect in one of the following ways:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#creating-new-image-using-kafka-connect-build-str">Configure Kafka Connect to build a new container image with plugins automatically</a></p>
</li>
<li>
<p><a href="#creating-new-image-from-base-str">Create a Docker image from the base Kafka Connect image</a> (manually or using continuous integration)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Set the <code>strimzi.io/use-connector-resources annotation</code> to <code>true</code> in the Kafka Connect configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect <b class="conum">(1)</b>
metadata:
  name: my-connect-cluster
  annotations:
    strimzi.io/use-connector-resources: "true"
spec:
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>KafkaConnector</code> resources enabled, the Cluster Operator watches for them.</p>
</div>
</li>
<li>
<p>Edit the <code>examples/connect/source-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-source-connector # <b class="conum">(1)</b>
  labels:
    strimzi.io/cluster: my-connect-cluster # <b class="conum">(2)</b>
spec:
  class: org.apache.kafka.connect.file.FileStreamSourceConnector # <b class="conum">(3)</b>
  tasksMax: 2 # <b class="conum">(4)</b>
  autoRestart: # <b class="conum">(5)</b>
    enabled: true
  config: # <b class="conum">(6)</b>
    file: "/opt/kafka/LICENSE" # <b class="conum">(7)</b>
    topic: my-topic <b class="conum">(8)</b>
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the <code>KafkaConnector</code> resource, which is used as the name of the connector. Use any name that is valid for a Kubernetes resource.</p>
</li>
<li>
<p>Name of the Kafka Connect cluster to create the connector instance in. Connectors must be deployed to the same namespace as the Kafka Connect cluster they link to.</p>
</li>
<li>
<p>Full name or alias of the connector class. This should be present in the image being used by the Kafka Connect cluster.</p>
</li>
<li>
<p>Maximum number of Kafka Connect tasks that the connector can create.</p>
</li>
<li>
<p>Enables automatic restarts of failed connectors and tasks.</p>
</li>
<li>
<p><a href="#kafkaconnector-configs">Connector configuration</a> as key-value pairs.</p>
</li>
<li>
<p>This example source connector configuration reads data from the <code>/opt/kafka/LICENSE</code> file.</p>
</li>
<li>
<p>Kafka topic to publish the source data to.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the source <code>KafkaConnector</code> in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/source-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Create an <code>examples/connect/sink-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">touch examples/connect/sink-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Paste the following YAML into the <code>sink-connector.yaml</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: my-sink-connector
  labels:
    strimzi.io/cluster: my-connect
spec:
  class: org.apache.kafka.connect.file.FileStreamSinkConnector <b class="conum">(1)</b>
  tasksMax: 2
  config: <b class="conum">(2)</b>
    file: "/tmp/my-file" <b class="conum">(3)</b>
    topics: my-topic <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Full name or alias of the connector class. This should be present in the image being used by the Kafka Connect cluster.</p>
</li>
<li>
<p><a href="#kafkaconnector-configs">Connector configuration</a> as key-value pairs.</p>
</li>
<li>
<p>Temporary file to publish the source data to.</p>
</li>
<li>
<p>Kafka topic to read the source data from.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create the sink <code>KafkaConnector</code> in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/connect/sink-connector.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the connector resources were created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kctr --selector strimzi.io/cluster=&lt;my_connect_cluster&gt; -o name

my-source-connector
my-sink-connector</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace &lt;my_connect_cluster&gt; with the name of your Kafka Connect cluster.</p>
</div>
</li>
<li>
<p>In the container, execute <code>kafka-console-consumer.sh</code> to read the messages that were written to the topic by the source connector:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec &lt;my_kafka_cluster&gt;-kafka-0 -i -t -- bin/kafka-console-consumer.sh --bootstrap-server &lt;my_kafka_cluster&gt;-kafka-bootstrap.<em>NAMESPACE</em>.svc:9092 --topic my-topic --from-beginning</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace &lt;my_kafka_cluster&gt; with the name of your Kafka cluster.</p>
</div>
</li>
</ol>
</div>
<h6 id="kafkaconnector-configs" class="discrete">Source and sink connector configuration options</h6>
<div class="paragraph">
<p>The connector configuration is defined in the <code>spec.config</code> property of the <code>KafkaConnector</code> resource.</p>
</div>
<div class="paragraph">
<p>The <code>FileStreamSourceConnector</code> and <code>FileStreamSinkConnector</code> classes support the same configuration options as the Kafka Connect REST API.
Other connectors support different configuration options.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 1. Configuration options for the <code>FileStreamSource</code> connector class</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source file to write messages to. If not specified, the standard input is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Kafka topic to publish data to.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 2. Configuration options for <code>FileStreamSinkConnector</code> class</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>file</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination file to write messages to. If not specified, the standard output is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topics</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more Kafka topics to read data from.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>topics.regex</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A regular expression matching one or more Kafka topics to read data from.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="proc-manual-restart-connector-str"><a class="link" href="#proc-manual-restart-connector-str">Manually restarting connectors</a></h5>
<div class="paragraph _abstract">
<p>If you are using <code>KafkaConnector</code> resources to manage connectors, use the <code>restart</code> annotation to manually trigger a restart of a connector.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaConnector</code> custom resource that controls the Kafka connector you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaConnector</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the connector by annotating the <code>KafkaConnector</code> resource in Kubernetes.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaConnector &lt;kafka_connector_name&gt; strimzi.io/restart=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>restart</code> annotation is set to <code>true</code>.</p>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The Kafka connector is restarted, as long as the annotation was detected by the reconciliation process.
When Kafka Connect accepts the restart request, the annotation is removed from the <code>KafkaConnector</code> custom resource.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-manual-restart-connector-task-str"><a class="link" href="#proc-manual-restart-connector-task-str">Manually restarting Kafka connector tasks</a></h5>
<div class="paragraph _abstract">
<p>If you are using <code>KafkaConnector</code> resources to manage connectors, use the <code>restart-task</code> annotation to manually trigger a restart of a connector task.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Find the name of the <code>KafkaConnector</code> custom resource that controls the Kafka connector task you want to restart:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get KafkaConnector</code></pre>
</div>
</div>
</li>
<li>
<p>Find the ID of the task to be restarted from the <code>KafkaConnector</code> custom resource.
Task IDs are non-negative integers, starting from 0:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl describe KafkaConnector &lt;kafka_connector_name&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Use the ID to restart the connector task by annotating the <code>KafkaConnector</code> resource in Kubernetes:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate KafkaConnector &lt;kafka_connector_name&gt; strimzi.io/restart-task=0</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, task <code>0</code> is restarted.</p>
</div>
</li>
<li>
<p>Wait for the next reconciliation to occur (every two minutes by default).</p>
<div class="paragraph">
<p>The Kafka connector task is restarted, as long as the annotation was detected by the reconciliation process.
When Kafka Connect accepts the restart request, the annotation is removed from the <code>KafkaConnector</code> custom resource.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="con-exposing-kafka-connect-api-str"><a class="link" href="#con-exposing-kafka-connect-api-str">Exposing the Kafka Connect API</a></h5>
<div class="paragraph _abstract">
<p>Use the Kafka Connect REST API as an alternative to using <code>KafkaConnector</code> resources to manage connectors.
The Kafka Connect REST API is available as a service running on <code><em>&lt;connect_cluster_name&gt;</em>-connect-api:8083</code>, where <em>&lt;connect_cluster_name&gt;</em> is the name of your Kafka Connect cluster.
The service is created when you create a Kafka Connect instance.</p>
</div>
<div class="paragraph">
<p>The operations supported by the Kafka Connect REST API are described in the <a href="https://kafka.apache.org/documentation#connect_rest" target="_blank" rel="noopener">Apache Kafka Connect API documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>strimzi.io/use-connector-resources</code> annotation enables KafkaConnectors.
If you applied the annotation to your <code>KafkaConnect</code> resource configuration, you need to remove it to use the Kafka Connect API.
Otherwise, manual changes made directly using the Kafka Connect REST API are reverted by the Cluster Operator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can add the connector configuration as a JSON object.</p>
</div>
<div class="listingblock">
<div class="title">Example curl request to add connector configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-curl hljs" data-lang="curl">curl -X POST \
  http://my-connect-cluster-connect-api:8083/connectors \
  -H 'Content-Type: application/json' \
  -d '{ "name": "my-source-connector",
    "config":
    {
      "connector.class":"org.apache.kafka.connect.file.FileStreamSourceConnector",
      "file": "/opt/kafka/LICENSE",
      "topic":"my-topic",
      "tasksMax": "4",
      "type": "source"
    }
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The API is only accessible within the Kubernetes cluster.
If you want to make the Kafka Connect API accessible to applications running outside of the Kubernetes cluster, you can expose it manually by creating one of the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LoadBalancer</code> or <code>NodePort</code> type services</p>
</li>
<li>
<p><code>Ingress</code> resources</p>
</li>
<li>
<p>OpenShift routes</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The connection is insecure, so allow external access advisedly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you decide to create services, use the labels from the <code>selector</code> of the <code><em>&lt;connect_cluster_name&gt;</em>-connect-api</code> service to configure the pods to which the service will route the traffic:</p>
</div>
<div class="listingblock">
<div class="title">Selector configuration for the service</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
selector:
  strimzi.io/cluster: my-connect-cluster <b class="conum">(1)</b>
  strimzi.io/kind: KafkaConnect
  strimzi.io/name: my-connect-cluster-connect <b class="conum">(2)</b>
#...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the Kafka Connect custom resource in your Kubernetes cluster.</p>
</li>
<li>
<p>Name of the Kafka Connect deployment created by the Cluster Operator.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You must also create a <code>NetworkPolicy</code> that allows HTTP requests from external clients.</p>
</div>
<div class="listingblock">
<div class="title">Example NetworkPolicy to allow requests to the Kafka Connect API</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: my-custom-connect-network-policy
spec:
  ingress:
  - from:
    - podSelector: <b class="conum">(1)</b>
        matchLabels:
          app: my-connector-manager
    ports:
    - port: 8083
      protocol: TCP
  podSelector:
    matchLabels:
      strimzi.io/cluster: my-connect-cluster
      strimzi.io/kind: KafkaConnect
      strimzi.io/name: my-connect-cluster-connect
  policyTypes:
  - Ingress</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The label of the pod that is allowed to connect to the API.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To add the connector configuration outside the cluster, use the URL of the resource that exposes the API in the curl command.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-switching-api-to-kafka-connector-str"><a class="link" href="#con-switching-api-to-kafka-connector-str">Switching from using the Kafka Connect API to using KafkaConnector custom resources</a></h5>
<div class="paragraph _abstract">
<p>You can switch from using the Kafka Connect API to using <code>KafkaConnector</code> custom resources to manage your connectors.
To make the switch, do the following in the order shown:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy <code>KafkaConnector</code> resources with the configuration to create your connector instances.</p>
</li>
<li>
<p>Enable <code>KafkaConnector</code> resources in your Kafka Connect configuration by setting the <code>strimzi.io/use-connector-resources</code> annotation to <code>true</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you enable <code>KafkaConnector</code> resources before creating them, you delete all connectors.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To switch from using <code>KafkaConnector</code> resources to using the Kafka Connect API, first remove the annotation that enables the <code>KafkaConnector</code> resources from your Kafka Connect configuration.
Otherwise, manual changes made directly using the Kafka Connect REST API are reverted by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>When making the switch, <a href="./configuring.html#con-custom-resources-status-str" target="_blank" rel="noopener">check the status of the <code>KafkaConnect</code> resource</a>.
The value of <code>metadata.generation</code> (the current version of the deployment) must match <code>status.observedGeneration</code> (the latest reconciliation of the resource).
When the Kafka Connect cluster is <code>Ready</code>, you can delete the <code>KafkaConnector</code> resources.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-mirror-maker-str"><a class="link" href="#kafka-mirror-maker-str">5.5. Deploying Kafka MirrorMaker</a></h3>
<div class="paragraph">
<p>The Cluster Operator deploys one or more Kafka MirrorMaker replicas to replicate data between Kafka clusters.
This process is called mirroring to avoid confusion with the Kafka partitions replication concept.
MirrorMaker consumes messages from the source cluster and republishes those messages to the target cluster.</p>
</div>
<div class="sect3">
<h4 id="deploying-kafka-mirror-maker-str"><a class="link" href="#deploying-kafka-mirror-maker-str">5.5.1. Deploying Kafka MirrorMaker to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka MirrorMaker cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaMirrorMaker</code> or <code>KafkaMirrorMaker2</code> resource depending on the version of MirrorMaker deployed.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Kafka MirrorMaker 1 (referred to as just <em>MirrorMaker</em> in the documentation) has been deprecated in Apache Kafka 3.0.0 and will be removed in Apache Kafka 4.0.0.
As a result, the <code>KafkaMirrorMaker</code> custom resource which is used to deploy Kafka MirrorMaker 1 has been deprecated in Strimzi as well.
The <code>KafkaMirrorMaker</code> resource will be removed from Strimzi when we adopt Apache Kafka 4.0.0.
As a replacement, use the <code>KafkaMirrorMaker2</code> custom resource with the <a href="./configuring.html#unidirectional_replication_activepassive"><code>IdentityReplicationPolicy</code></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
In this procedure, we use the following example files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/mirror-maker/kafka-mirror-maker.yaml</code></p>
</li>
<li>
<p><code>examples/mirror-maker/kafka-mirror-maker-2.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka MirrorMaker to your Kubernetes cluster:</p>
<div class="paragraph">
<p>For MirrorMaker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/mirror-maker/kafka-mirror-maker.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>For MirrorMaker 2.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/mirror-maker/kafka-mirror-maker-2.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                          READY  UP-TO-DATE  AVAILABLE
my-mirror-maker-mirror-maker  1/1    1           1
my-mm2-cluster-mirrormaker2   1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-mirror-maker</code> is the name of the Kafka MirrorMaker cluster.
<code>my-mm2-cluster</code> is the name of the Kafka MirrorMaker 2.0 cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#assembly-deployment-configuration-kafka-mirror-maker-str" target="_blank" rel="noopener">Kafka MirrorMaker cluster configuration</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka-bridge-str"><a class="link" href="#kafka-bridge-str">5.6. Deploying Kafka Bridge</a></h3>
<div class="paragraph">
<p>The Cluster Operator deploys one or more Kafka bridge replicas to send data between Kafka clusters and clients via HTTP API.</p>
</div>
<div class="sect3">
<h4 id="deploying-kafka-bridge-str"><a class="link" href="#deploying-kafka-bridge-str">5.6.1. Deploying Kafka Bridge to your Kubernetes cluster</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy a Kafka Bridge cluster to your Kubernetes cluster using the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>The deployment uses a YAML file to provide the specification to create a <code>KafkaBridge</code> resource.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
In this procedure, we use the following example file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/bridge/kafka-bridge.yaml</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#deploying-cluster-operator-str">The Cluster Operator must be deployed.</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Kafka Bridge to your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f examples/bridge/kafka-bridge.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments -n <em>&lt;my_cluster_operator_namespace&gt;</em></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME              READY  UP-TO-DATE  AVAILABLE
my-bridge-bridge  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>my-bridge</code> is the name of the Kafka Bridge cluster.</p>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#assembly-config-kafka-bridge-str" target="_blank" rel="noopener">Kafka Bridge cluster configuration</a></p>
</li>
<li>
<p><a href="https://strimzi.io/docs/bridge/latest/" target="_blank" rel="noopener">Using the Strimzi Kafka Bridge</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-exposing-kafka-bridge-service-local-machine-str"><a class="link" href="#proc-exposing-kafka-bridge-service-local-machine-str">5.6.2. Exposing the Kafka Bridge service to your local machine</a></h4>
<div class="paragraph _abstract">
<p>Use port forwarding to expose the Strimzi Kafka Bridge service to your local machine on <a href="http://localhost:8080" class="bare">http://localhost:8080</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Port forwarding is only suitable for development and testing purposes.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>List the names of the pods in your Kubernetes cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods -o name

pod/kafka-consumer
# ...
pod/my-bridge-bridge-7cbd55496b-nclrt</code></pre>
</div>
</div>
</li>
<li>
<p>Connect to the Kafka Bridge pod on port <code>8080</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl port-forward pod/my-bridge-bridge-7cbd55496b-nclrt 8080:8080 &amp;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If port 8080 on your local machine is already in use, use an alternative HTTP port, such as <code>8008</code>.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>API requests are now forwarded from port 8080 on your local machine to port 8080 in the Kafka Bridge pod.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-accessing-kafka-bridge-from-outside-str"><a class="link" href="#con-accessing-kafka-bridge-from-outside-str">5.6.3. Accessing the Kafka Bridge outside of Kubernetes</a></h4>
<div class="paragraph">
<p>After deployment, the Strimzi Kafka Bridge can only be accessed by applications running in the same Kubernetes cluster.
These applications use the <code><em>&lt;kafka_bridge_name&gt;</em>-bridge-service</code> service to access the API.</p>
</div>
<div class="paragraph">
<p>If you want to make the Kafka Bridge accessible to applications running outside of the Kubernetes cluster, you can expose it manually by creating one of the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LoadBalancer</code> or <code>NodePort</code> type services</p>
</li>
<li>
<p><code>Ingress</code> resources</p>
</li>
<li>
<p>OpenShift routes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you decide to create Services, use the labels from the <code>selector</code> of the <code><em>&lt;kafka_bridge_name&gt;</em>-bridge-service</code> service to configure the pods to which the service will route the traffic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  selector:
    strimzi.io/cluster: kafka-bridge-name <b class="conum">(1)</b>
    strimzi.io/kind: KafkaBridge
  #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Name of the Kafka Bridge custom resource in your Kubernetes cluster.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploy-standalone-operators_str"><a class="link" href="#deploy-standalone-operators_str">5.7. Alternative standalone deployment options for Strimzi operators</a></h3>
<div class="paragraph _abstract">
<p>You can perform a standalone deployment of the Topic Operator and User Operator.
Consider a standalone deployment of these operators if you are using a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>You deploy the operators to Kubernetes.
Kafka can be running outside of Kubernetes.
For example, you might be using a Kafka as a managed service.
You adjust the deployment configuration for the standalone operator to match the address of your Kafka cluster.</p>
</div>
<div class="sect3">
<h4 id="deploying-the-topic-operator-standalone-str"><a class="link" href="#deploying-the-topic-operator-standalone-str">5.7.1. Deploying the standalone Topic Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the Topic Operator as a standalone component for topic management.
You can use a standalone Topic Operator with a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A standalone deployment can operate with any Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Standalone deployment files are provided with Strimzi.
Use the <code>05-Deployment-strimzi-topic-operator.yaml</code> deployment file to deploy the Topic Operator.
Add or set the environment variables needed to make a connection to a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The Topic Operator watches for <code>KafkaTopic</code> resources in a single namespace.
You specify the namespace to watch, and the connection to the Kafka cluster, in the Topic Operator configuration.
A single Topic Operator can watch a single namespace.
One namespace should be watched by only one Topic Operator.
If you want to use more than one Topic Operator, configure each of them to watch different namespaces.
In this way, you can use Topic Operators with multiple Kafka clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You are running a Kafka cluster for the Topic Operator to connect to.</p>
<div class="paragraph">
<p>As long as the standalone Topic Operator is correctly configured for connection,
the Kafka cluster can be running on a bare-metal environment, a virtual machine, or as a managed cloud application service.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the <code>env</code> properties in the <code>install/topic-operator/05-Deployment-strimzi-topic-operator.yaml</code> standalone deployment file.</p>
<div class="listingblock">
<div class="title">Example standalone Topic Operator deployment configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-topic-operator
  labels:
    app: strimzi
spec:
  # ...
  template:
    # ...
    spec:
      # ...
      containers:
        - name: strimzi-topic-operator
          # ...
          env:
            - name: STRIMZI_NAMESPACE <b class="conum">(1)</b>
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS <b class="conum">(2)</b>
              value: my-kafka-bootstrap-address:9092
            - name: STRIMZI_RESOURCE_LABELS <b class="conum">(3)</b>
              value: "strimzi.io/cluster=my-cluster"
            - name: STRIMZI_ZOOKEEPER_CONNECT <b class="conum">(4)</b>
              value: my-cluster-zookeeper-client:2181
            - name: STRIMZI_ZOOKEEPER_SESSION_TIMEOUT_MS <b class="conum">(5)</b>
              value: "18000"
            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS <b class="conum">(6)</b>
              value: "120000"
            - name: STRIMZI_TOPIC_METADATA_MAX_ATTEMPTS <b class="conum">(7)</b>
              value: "6"
            - name: STRIMZI_LOG_LEVEL <b class="conum">(8)</b>
              value: INFO
            - name: STRIMZI_TLS_ENABLED <b class="conum">(9)</b>
              value: "false"
            - name: STRIMZI_JAVA_OPTS <b class="conum">(10)</b>
              value: "-Xmx=512M -Xms=256M"
            - name: STRIMZI_JAVA_SYSTEM_PROPERTIES <b class="conum">(11)</b>
              value: "-Djavax.net.debug=verbose -DpropertyName=value"
            - name: STRIMZI_PUBLIC_CA <b class="conum">(12)</b>
              value: "false"
            - name: STRIMZI_TLS_AUTH_ENABLED <b class="conum">(13)</b>
              value: "false"
            - name: STRIMZI_SASL_ENABLED <b class="conum">(14)</b>
              value: "false"
            - name: STRIMZI_SASL_USERNAME <b class="conum">(15)</b>
              value: "admin"
            - name: STRIMZI_SASL_PASSWORD <b class="conum">(16)</b>
              value: "password"
            - name: STRIMZI_SASL_MECHANISM <b class="conum">(17)</b>
              value: "scram-sha-512"
            - name: STRIMZI_SECURITY_PROTOCOL <b class="conum">(18)</b>
              value: "SSL"</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes namespace for the Topic Operator to watch for <code>KafkaTopic</code> resources. Specify the namespace of the Kafka cluster.</p>
</li>
<li>
<p>The host and port pair of the bootstrap broker address to discover and connect to all brokers in the Kafka cluster.
Use a comma-separated list to specify two or three broker addresses in case a server is down.</p>
</li>
<li>
<p>The label to identify the <code>KafkaTopic</code> resources managed by the Topic Operator.
This does not have to be the name of the Kafka cluster.
It can be the label assigned to the <code>KafkaTopic</code> resource.
If you deploy more than one Topic Operator, the labels must be unique for each.
That is, the operators cannot manage the same resources.</p>
</li>
<li>
<p>The host and port pair of the address to connect to the ZooKeeper cluster.
This must be the same ZooKeeper cluster that your Kafka cluster is using.</p>
</li>
<li>
<p>The ZooKeeper session timeout, in milliseconds.
The default is <code>18000</code> (18 seconds).</p>
</li>
<li>
<p>The interval between periodic reconciliations, in milliseconds.
The default is <code>120000</code> (2 minutes).</p>
</li>
<li>
<p>The number of attempts at getting topic metadata from Kafka.
The time between each attempt is defined as an exponential backoff.
Consider increasing this value when topic creation takes more time due to the number of partitions or replicas.
The default is <code>6</code> attempts.</p>
</li>
<li>
<p>The level for printing logging messages.
You can set the level to <code>ERROR</code>, <code>WARNING</code>, <code>INFO</code>, <code>DEBUG</code>, or <code>TRACE</code>.</p>
</li>
<li>
<p>Enables TLS support for encrypted communication with the Kafka brokers.</p>
</li>
<li>
<p>(Optional) The Java options used by the JVM running the Topic Operator.</p>
</li>
<li>
<p>(Optional) The debugging (<code>-D</code>) options set for the Topic Operator.</p>
</li>
<li>
<p>(Optional) Skips the generation of trust store certificates if TLS is enabled through <code>STRIMZI_TLS_ENABLED</code>. If this environment variable is enabled, the brokers must use a public trusted certificate authority for their TLS certificates.
The default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Generates key store certificates for mTLS authentication. Setting this to <code>false</code> disables client authentication with mTLS to the Kafka brokers.
The default is <code>true</code>.</p>
</li>
<li>
<p>(Optional) Enables SASL support for client authentication when connecting to Kafka brokers.
The default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) The SASL username for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.</p>
</li>
<li>
<p>(Optional) The SASL password for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.</p>
</li>
<li>
<p>(Optional) The SASL mechanism for client authentication.
Mandatory only if SASL is enabled through <code>STRIMZI_SASL_ENABLED</code>.
You can set the value to <code>plain</code>, <code>scram-sha-256</code>, or <code>scram-sha-512</code>.</p>
</li>
<li>
<p>(Optional) The security protocol used for communication with Kafka brokers.
The default value is "PLAINTEXT".
You can set the value to <code>PLAINTEXT</code>, <code>SSL</code>, <code>SASL_PLAINTEXT</code>, or <code>SASL_SSL</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you want to connect to Kafka brokers that are using certificates from a public certificate authority, set <code>STRIMZI_PUBLIC_CA</code> to <code>true</code>. Set this property to <code>true</code>, for example, if you are using Amazon AWS MSK service.</p>
</li>
<li>
<p>If you enabled mTLS with the <code>STRIMZI_TLS_ENABLED</code> environment variable, specify the keystore and truststore used to authenticate connection to the Kafka cluster.</p>
<div class="listingblock">
<div class="title">Example mTLS configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ....
env:
  - name: STRIMZI_TRUSTSTORE_LOCATION <b class="conum">(1)</b>
    value: "/path/to/truststore.p12"
  - name: STRIMZI_TRUSTSTORE_PASSWORD <b class="conum">(2)</b>
    value: "<em>TRUSTSTORE-PASSWORD</em>"
  - name: STRIMZI_KEYSTORE_LOCATION <b class="conum">(3)</b>
    value: "/path/to/keystore.p12"
  - name: STRIMZI_KEYSTORE_PASSWORD <b class="conum">(4)</b>
    value: "<em>KEYSTORE-PASSWORD</em>"
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The truststore contains the public keys of the Certificate Authorities used to sign the Kafka and ZooKeeper server certificates.</p>
</li>
<li>
<p>The password for accessing the truststore.</p>
</li>
<li>
<p>The keystore contains the private key for mTLS authentication.</p>
</li>
<li>
<p>The password for accessing the keystore.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the Topic Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/topic-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                    READY  UP-TO-DATE  AVAILABLE
strimzi-topic-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="deploying-the-user-operator-standalone-str"><a class="link" href="#deploying-the-user-operator-standalone-str">5.7.2. Deploying the standalone User Operator</a></h4>
<div class="paragraph _abstract">
<p>This procedure shows how to deploy the User Operator as a standalone component for user management.
You can use a standalone User Operator with a Kafka cluster that is not managed by the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>A standalone deployment can operate with any Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Standalone deployment files are provided with Strimzi.
Use the <code>05-Deployment-strimzi-user-operator.yaml</code> deployment file to deploy the User Operator.
Add or set the environment variables needed to make a connection to a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The User Operator watches for <code>KafkaUser</code> resources in a single namespace.
You specify the namespace to watch, and the connection to the Kafka cluster, in the User Operator configuration.
A single User Operator can watch a single namespace.
One namespace should be watched by only one User Operator.
If you want to use more than one User Operator, configure each of them to watch different namespaces.
In this way, you can use the User Operator with multiple Kafka clusters.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You are running a Kafka cluster for the User Operator to connect to.</p>
<div class="paragraph">
<p>As long as the standalone User Operator is correctly configured for connection,
the Kafka cluster can be running on a bare-metal environment, a virtual machine, or as a managed cloud application service.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Edit the following <code>env</code> properties in the <code>install/user-operator/05-Deployment-strimzi-user-operator.yaml</code> standalone deployment file.</p>
<div class="listingblock">
<div class="title">Example standalone User Operator deployment configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-user-operator
  labels:
    app: strimzi
spec:
  # ...
  template:
    # ...
    spec:
      # ...
      containers:
        - name: strimzi-user-operator
          # ...
          env:
            - name: STRIMZI_NAMESPACE <b class="conum">(1)</b>
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS <b class="conum">(2)</b>
              value: my-kafka-bootstrap-address:9092
            - name: STRIMZI_CA_CERT_NAME <b class="conum">(3)</b>
              value: my-cluster-clients-ca-cert
            - name: STRIMZI_CA_KEY_NAME <b class="conum">(4)</b>
              value: my-cluster-clients-ca
            - name: STRIMZI_LABELS <b class="conum">(5)</b>
              value: "strimzi.io/cluster=my-cluster"
            - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS <b class="conum">(6)</b>
              value: "120000"
            - name: STRIMZI_WORK_QUEUE_SIZE <b class="conum">(7)</b>
              value: 10000
            - name: STRIMZI_CONTROLLER_THREAD_POOL_SIZE <b class="conum">(8)</b>
              value: 10
            - name: STRIMZI_USER_OPERATIONS_THREAD_POOL_SIZE <b class="conum">(9)</b>
              value: 4
            - name: STRIMZI_LOG_LEVEL <b class="conum">(10)</b>
              value: INFO
            - name: STRIMZI_GC_LOG_ENABLED <b class="conum">(11)</b>
              value: "true"
            - name: STRIMZI_CA_VALIDITY <b class="conum">(12)</b>
              value: "365"
            - name: STRIMZI_CA_RENEWAL <b class="conum">(13)</b>
              value: "30"
            - name: STRIMZI_JAVA_OPTS <b class="conum">(14)</b>
              value: "-Xmx=512M -Xms=256M"
            - name: STRIMZI_JAVA_SYSTEM_PROPERTIES <b class="conum">(15)</b>
              value: "-Djavax.net.debug=verbose -DpropertyName=value"
            - name: STRIMZI_SECRET_PREFIX <b class="conum">(16)</b>
              value: "kafka-"
            - name: STRIMZI_ACLS_ADMIN_API_SUPPORTED <b class="conum">(17)</b>
              value: "true"
            - name: STRIMZI_MAINTENANCE_TIME_WINDOWS <b class="conum">(18)</b>
              value: '* * 8-10 * * ?;* * 14-15 * * ?'
            - name: STRIMZI_KAFKA_ADMIN_CLIENT_CONFIGURATION <b class="conum">(19)</b>
              value: |
                default.api.timeout.ms=120000
                request.timeout.ms=60000</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes namespace for the User Operator to watch for <code>KafkaUser</code> resources. Only one namespace can be specified.</p>
</li>
<li>
<p>The host and port pair of the bootstrap broker address to discover and connect to all brokers in the Kafka cluster.
Use a comma-separated list to specify two or three broker addresses in case a server is down.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the public key (<code>ca.crt</code>) value of the CA (certificate authority) that signs new user certificates for mTLS authentication.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the private key (<code>ca.key</code>) value of the CA that signs new user certificates for mTLS authentication.</p>
</li>
<li>
<p>The label to identify the <code>KafkaUser</code> resources managed by the User Operator.
This does not have to be the name of the Kafka cluster.
It can be the label assigned to the <code>KafkaUser</code> resource.
If you deploy more than one User Operator, the labels must be unique for each.
That is, the operators cannot manage the same resources.</p>
</li>
<li>
<p>The interval between periodic reconciliations, in milliseconds.
The default is <code>120000</code> (2 minutes).</p>
</li>
<li>
<p>The size of the controller event queue.
The size of the queue should be at least as big as the maximal amount of users you expect the User Operator to operate.
The default is <code>1024</code>.</p>
</li>
<li>
<p>The size of the worker pool for reconciling the users.
Bigger pool might require more resources, but it will also handle more <code>KafkaUser</code> resources
The default is <code>50</code>.</p>
</li>
<li>
<p>The size of the worker pool for Kafka Admin API and Kubernetes operations.
Bigger pool might require more resources, but it will also handle more <code>KafkaUser</code> resources
The default is <code>4</code>.</p>
</li>
<li>
<p>The level for printing logging messages.
You can set the level to <code>ERROR</code>, <code>WARNING</code>, <code>INFO</code>, <code>DEBUG</code>, or <code>TRACE</code>.</p>
</li>
<li>
<p>Enables garbage collection (GC) logging.
The default is <code>true</code>.</p>
</li>
<li>
<p>The validity period for the CA.
The default is <code>365</code> days.</p>
</li>
<li>
<p>The renewal period for the CA. The renewal period is measured backwards from the expiry date of the current certificate.
The default is <code>30</code> days to initiate certificate renewal before the old certificates expire.</p>
</li>
<li>
<p>(Optional) The Java options used by the JVM running the User Operator</p>
</li>
<li>
<p>(Optional) The debugging (<code>-D</code>) options set for the User Operator</p>
</li>
<li>
<p>(Optional) Prefix for the names of Kubernetes secrets created by the User Operator.</p>
</li>
<li>
<p>(Optional) Indicates whether the Kafka cluster supports management of authorization ACL rules using the Kafka Admin API.
When set to <code>false</code>, the User Operator will reject all resources with <code>simple</code> authorization ACL rules.
This helps to avoid unnecessary exceptions in the Kafka cluster logs.
The default is <code>true</code>.</p>
</li>
<li>
<p>(Optional) Semi-colon separated list of Cron Expressions defining the maintenance time windows during which the expiring user certificates will be renewed.</p>
</li>
<li>
<p>(Optional) Configuration options for configuring the Kafka Admin client used by the User Operator in the properties format.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you are using mTLS to connect to the Kafka cluster, specify the secrets used to authenticate connection.
Otherwise, go to the next step.</p>
<div class="listingblock">
<div class="title">Example mTLS configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># ....
env:
  - name: STRIMZI_CLUSTER_CA_CERT_SECRET_NAME <b class="conum">(1)</b>
    value: my-cluster-cluster-ca-cert
  - name: STRIMZI_EO_KEY_SECRET_NAME <b class="conum">(2)</b>
    value: my-cluster-entity-operator-certs
# ..."</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Kubernetes <code>Secret</code> that contains the public key (<code>ca.crt</code>) value of the CA that signs Kafka broker certificates.</p>
</li>
<li>
<p>The Kubernetes <code>Secret</code> that contains the keystore (<code>entity-operator.p12</code>) with the private key and certificate for mTLS authentication against the Kafka cluster.
The <code>Secret</code> must also contain the password (<code>entity-operator.password</code>) for accessing the keystore.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the User Operator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f install/user-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Check the status of the deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get deployments</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output shows the deployment name and readiness</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                   READY  UP-TO-DATE  AVAILABLE
strimzi-user-operator  1/1    1           1</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>READY</code> shows the number of replicas that are ready/expected.
The deployment is successful when the <code>AVAILABLE</code> output shows <code>1</code>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-strimzi-from-operator-hub-str"><a class="link" href="#deploying-strimzi-from-operator-hub-str">6. Deploying Strimzi from OperatorHub.io</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>OperatorHub.io is a catalog of Kubernetes operators sourced from multiple providers.
It offers you an alternative way to install a stable version of Strimzi.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/operator-framework/operator-lifecycle-manager" target="_blank" rel="noopener">Operator Lifecycle Manager</a> is used for the installation and management of all operators published on OperatorHub.io.
<a href="https://github.com/operator-framework/operator-lifecycle-manager" target="_blank" rel="noopener">Operator Lifecycle Manager</a> is a prerequisite for installing the Strimzi Kafka operator</p>
</div>
<div class="paragraph">
<p>To install Strimzi, locate <em>Strimzi</em> from <a href="https://operatorhub.io/operator/strimzi-kafka-operator" target="_blank" rel="noopener">OperatorHub.io</a>, and follow the instructions provided to deploy the Cluster Operator.
After you have deployed the Cluster Operator, you can deploy Strimzi components using custom resources.
For example, you can deploy the <code>Kafka</code> custom resource, and the installed Cluster Operator will create a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>Upgrades between versions might include manual steps.
Always read the release notes before upgrading.</p>
</div>
<div class="paragraph">
<p>For information on upgrades, see <a href="#assembly-upgrade-cluster-operator-str">Cluster Operator upgrade options</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Make sure you use the appropriate update channel.
Installing Strimzi from the default <em>stable</em> channel is generally safe.
However, we do not recommend enabling <em>automatic</em> OLM updates on the stable channel.
An automatic upgrade will skip any necessary steps prior to upgrade.
For example, to upgrade from 0.22 or earlier
you must first <a href="#con-upgrade-paths-earlier-versions-str">update custom resources to support the <code>v1beta2</code> API version</a>.
Use automatic upgrades only on version-specific channels.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-cluster-operator-helm-chart-str"><a class="link" href="#deploying-cluster-operator-helm-chart-str">7. Deploying Strimzi using Helm</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p><a href="https://helm.sh/">Helm</a> charts are used to package, configure, and deploy Kubernetes resources.
Strimzi provides a Helm chart to deploy the Cluster Operator.</p>
</div>
<div class="paragraph">
<p>After you have deployed the Cluster Operator this way, you can deploy Strimzi components using custom resources.
For example, you can deploy the <code>Kafka</code> custom resource, and the installed Cluster Operator will create a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>For information on upgrades, see <a href="#assembly-upgrade-cluster-operator-str">Cluster Operator upgrade options</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Helm client must be installed on a local machine.</p>
</li>
<li>
<p>Helm must be installed to the Kubernetes cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the Strimzi Helm Chart repository:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm repo add strimzi https://strimzi.io/charts/</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Cluster Operator using the Helm command line tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm install strimzi/strimzi-kafka-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Cluster Operator has been deployed successfully using the Helm command line tool:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm ls</code></pre>
</div>
</div>
</li>
<li>
<p><a href="#deploying-kafka-cluster-str">Deploy Kafka</a> and other Kafka components using custom resources.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-client-access-str"><a class="link" href="#deploy-client-access-str">8. Setting up client access to a Kafka cluster</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>After you have <a href="#deploy-tasks_str">deployed Strimzi</a>, you can set up client access to your Kafka cluster.
To verify the deployment, you can deploy example producer and consumer clients.
Otherwise, create listeners that provide client access within or outside the Kubernetes cluster.</p>
</div>
<div class="sect2">
<h3 id="deploying-example-clients-str"><a class="link" href="#deploying-example-clients-str">8.1. Deploying example clients</a></h3>
<div class="paragraph _abstract">
<p>Deploy example producer and consumer clients to send and receive messages.
You can use these clients to verify a deployment of Strimzi.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Kafka cluster is available for the clients.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy a Kafka producer.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-producer -ti --image=quay.io/strimzi/kafka:latest-kafka-3.3.2 --rm=true --restart=Never -- bin/kafka-console-producer.sh --bootstrap-server <em>cluster-name</em>-kafka-bootstrap:9092 --topic <em>my-topic</em></code></pre>
</div>
</div>
</li>
<li>
<p>Type a message into the console where the producer is running.</p>
</li>
<li>
<p>Press <em>Enter</em> to send the message.</p>
</li>
<li>
<p>Deploy a Kafka consumer.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-consumer -ti --image=quay.io/strimzi/kafka:latest-kafka-3.3.2 --rm=true --restart=Never -- bin/kafka-console-consumer.sh --bootstrap-server <em>cluster-name</em>-kafka-bootstrap:9092 --topic <em>my-topic</em> --from-beginning</code></pre>
</div>
</div>
</li>
<li>
<p>Confirm that you see the incoming messages in the consumer console.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuration-points-listeners-str"><a class="link" href="#configuration-points-listeners-str">8.2. Configuring listeners to connect to Kafka brokers</a></h3>
<div class="paragraph _abstract">
<p>Use listeners for client connection to Kafka brokers.
Strimzi provides a generic <code>GenericKafkaListener</code> schema with properties to configure listeners through the <code>Kafka</code> resource.
The <code>GenericKafkaListener</code> provides a flexible approach to listener configuration.
You can specify properties to configure <em>internal</em> listeners for connecting within the Kubernetes cluster or <em>external</em> listeners for connecting outside the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>Specify a connection <code>type</code> to expose Kafka in the listener configuration.
The type chosen depends on your requirements, and your environment and infrastructure.
The following listener types are supported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Internal listeners</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>internal</code> to connect within the same Kubernetes cluster</p>
</li>
<li>
<p><code>cluster-ip</code> to expose Kafka using per-broker <code>ClusterIP</code> services</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">External listeners</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>nodeport</code> to use ports on Kubernetes nodes</p>
</li>
<li>
<p><code>loadbalancer</code> to use loadbalancer services</p>
</li>
<li>
<p><code>ingress</code> to use Kubernetes Ingress and the <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Ingress NGINX Controller for Kubernetes</a> (Kubernetes only)</p>
</li>
<li>
<p><code>route</code> to use OpenShift <code>Route</code> and the default HAProxy router (OpenShift only)</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Do not use <code>ingress</code> on OpenShift, use the <code>route</code> type instead. The Ingress NGINX Controller is only intended for use on Kubernetes. The <code>route</code> type is only supported on OpenShift.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An <code>internal</code> type listener configuration uses a headless service and the DNS names given to the broker pods.
You might want to join your Kubernetes network to an outside network.
In which case, you can configure an <code>internal</code> type listener (using the <code>useServiceDnsDomain</code> property) so that the Kubernetes service DNS domain (typically <code>.cluster.local</code>) is not used.
You can also configure a <code>cluster-ip</code> type of listener that exposes a Kafka cluster based on per-broker <code>ClusterIP</code> services.
This is a useful option when you can&#8217;t route through the headless service or you wish to incorporate a custom access mechanism.
For example, you might use this listener when building your own type of external listener for a specific Ingress controller or the Kubernetes Gateway API.</p>
</div>
<div class="paragraph">
<p>External listeners handle access to a Kafka cluster from networks that require different authentication mechanisms.
You can configure external listeners for client access outside a Kubernetes environment using a specified connection mechanism, such as a loadbalancer or route.
For example, loadbalancers might not be suitable for certain infrastructure, such as bare metal, where node ports provide a better option.</p>
</div>
<div class="paragraph">
<p>Each listener is defined as an array in the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example listener configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: false
        configuration:
          useServiceDnsDomain: true
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
      - name: external
        port: 9094
        type: route
        tls: true
        configuration:
          brokerCertChainAndKey:
            secretName: my-secret
            certificate: my-certificate.crt
            key: my-key.key
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure as many listeners as required, as long as their names and ports are unique.
You can also configure listeners for secure connection using authentication.</p>
</div>
<div class="paragraph">
<p>If you want to know more about the pros and cons of each connection type, refer to <a href="https://strimzi.io/2019/04/17/accessing-kafka-part-1.html" target="_blank" rel="noopener">Accessing Apache Kafka in Strimzi</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you scale your Kafka cluster while using external listeners, it might trigger a rolling update of all Kafka brokers. This depends on the configuration.
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-GenericKafkaListener-reference"><code>GenericKafkaListener</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="setup-external-clients-str"><a class="link" href="#setup-external-clients-str">8.3. Setting up client access to a Kafka cluster using listeners</a></h3>
<div class="paragraph _abstract">
<p>Using the address of the Kafka cluster, you can provide access to a client in the same Kubernetes cluster; or provide external access to a client on a different Kubernetes namespace or outside Kubernetes entirely.
This procedure shows how to configure client access to a Kafka cluster from outside Kubernetes or from another Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>A Kafka listener provides access to the Kafka cluster.
Client access is secured using the following configuration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An external listener is configured for the Kafka cluster, with TLS encryption and mTLS authentication, and Kafka <code>simple</code> authorization enabled.</p>
</li>
<li>
<p>A <code>KafkaUser</code> is created for the client, with mTLS authentication, and Access Control Lists (ACLs) defined for <code>simple</code> authorization.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You can configure your listener to use mutual <code>tls</code>, <code>scram-sha-512</code>, or <code>oauth</code> authentication.
mTLS always uses encryption, but encryption is also recommended when using SCRAM-SHA-512 and OAuth 2.0 authentication.</p>
</div>
<div class="paragraph">
<p>You can configure <code>simple</code>, <code>oauth</code>, <code>opa</code>, or <code>custom</code> authorization for Kafka brokers.
When enabled, authorization is applied to all enabled listeners.</p>
</div>
<div class="paragraph">
<p>When you configure the <code>KafkaUser</code> authentication and authorization mechanisms, ensure they match the equivalent Kafka configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KafkaUser.spec.authentication</code> matches <code>Kafka.spec.kafka.listeners[*].authentication</code></p>
</li>
<li>
<p><code>KafkaUser.spec.authorization</code> matches <code>Kafka.spec.kafka.authorization</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You should have at least one listener supporting the authentication you want to use for the <code>KafkaUser</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Authentication between Kafka users and Kafka brokers depends on the authentication settings for each.
For example, it is not possible to authenticate a user with mTLS if it is not also enabled in the Kafka configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Strimzi operators automate the configuration process and create the certificates required for authentication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Cluster Operator creates the listeners and sets up the cluster and client certificate authority (CA) certificates to enable authentication with the Kafka cluster.</p>
</li>
<li>
<p>The User Operator creates the user representing the client and the security credentials used for client authentication, based on the chosen authentication type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You add the certificates to your client configuration.</p>
</div>
<div class="paragraph">
<p>In this procedure, the CA certificates generated by the Cluster Operator are used, but you can replace them by <a href="./configuring.html#installing-your-own-ca-certificates-str" target="_blank" rel="noopener">installing your own certificates</a>.
You can also configure your listener to <a href="#proc-installing-certs-per-listener-str">use a Kafka listener certificate managed by an external CA (certificate authority)^</a>.</p>
</div>
<div class="paragraph">
<p>Certificates are available in PEM (.crt) and PKCS #12 (.p12) formats.
This procedure uses PEM certificates.
Use PEM certificates with clients that use certificates in X.509 format.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For internal clients in the same Kubernetes cluster and namespace, you can mount the cluster CA certificate in the pod specification.
For more information, see <a href="./configuring.html#configuring-internal-clients-to-trust-cluster-ca-str" target="_blank" rel="noopener">Configuring internal clients to trust the cluster CA</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Kafka cluster is available for connection by a client running outside the Kubernetes cluster</p>
</li>
<li>
<p>The Cluster Operator and User Operator are running in the cluster</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the Kafka cluster with a Kafka listener.</p>
<div class="ulist">
<ul>
<li>
<p>Define the authentication required to access the Kafka broker through the listener.</p>
</li>
<li>
<p>Enable authorization on the Kafka broker.</p>
<div class="listingblock">
<div class="title">Example listener configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners: # <b class="conum">(1)</b>
    - name: external # <b class="conum">(2)</b>
      port: 9094 <b class="conum">(3)</b>
      type: <em>&lt;listener_type&gt;</em> # <b class="conum">(4)</b>
      tls: true # <b class="conum">(5)</b>
      authentication:
        type: tls # <b class="conum">(6)</b>
      configuration: # <b class="conum">(7)</b>
        #...
    authorization: # <b class="conum">(8)</b>
      type: simple
      superUsers:
        - super-user-name # <b class="conum">(9)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration options for enabling external listeners are described in the <a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener">Generic Kafka listener schema reference</a>.</p>
</li>
<li>
<p>Name to identify the listener. Must be unique within the Kafka cluster.</p>
</li>
<li>
<p>Port number used by the listener inside Kafka. The port number has to be unique within a given Kafka cluster. Allowed port numbers are 9092 and higher with the exception of ports 9404 and 9999, which are already used for Prometheus and JMX. Depending on the listener type, the port number might not be the same as the port number that connects Kafka clients.</p>
</li>
<li>
<p>External listener type specified as <code>route</code>, <code>loadbalancer</code>, <code>nodeport</code> or <code>ingress</code>. An internal listener is specified as <code>internal</code> or <code>cluster-ip</code>.</p>
</li>
<li>
<p>Required. TLS encryption on the listener. For <code>route</code> and <code>ingress</code> type listeners it must be set to <code>true</code>. For mTLS authentication, also use the <code>authentication</code> property.</p>
</li>
<li>
<p>Client authentication mechanism on the listener. For server and client authentication using mTLS, you specify <code>tls: true</code> and <code>authentication.type: tls</code>.</p>
</li>
<li>
<p>(Optional) Depending on the requirements of the listener type, you can specify additional <a href="./configuring.html#type-GenericKafkaListenerConfiguration-reference" target="_blank" rel="noopener">listener configuration</a>.</p>
</li>
<li>
<p>Authorization specified as <code>simple</code>, which uses the <code>AclAuthorizer</code> Kafka plugin.</p>
</li>
<li>
<p>(Optional) Super users can access all brokers regardless of any access restrictions defined in ACLs.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
An OpenShift Route address comprises the name of the Kafka cluster, the name of the listener, and the name of the namespace it is created in.
For example, <code>my-cluster-kafka-listener1-bootstrap-myproject</code> (<em>CLUSTER-NAME</em>-kafka-<em>LISTENER-NAME</em>-bootstrap-<em>NAMESPACE</em>).
If you are using a <code>route</code> listener type, be careful that the whole length of the address does not exceed a maximum limit of 63 characters.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create or update the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kafka cluster is configured with a Kafka broker listener using mTLS authentication.</p>
</div>
<div class="paragraph">
<p>A service is created for each Kafka broker pod.</p>
</div>
<div class="paragraph">
<p>A service is created to serve as the <em>bootstrap address</em> for connection to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>A service is also created as the <em>external bootstrap address</em> for external connection to the Kafka cluster using <code>nodeport</code> listeners.</p>
</div>
<div class="paragraph">
<p>The cluster CA certificate to verify the identity of the kafka brokers is also created in the secret <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you scale your Kafka cluster while using external listeners, it might trigger a rolling update of all Kafka brokers. This depends on the configuration.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Retrieve the bootstrap address you can use to access the Kafka cluster from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka <em>&lt;kafka_cluster_name&gt;</em> -o=jsonpath='{.status.listeners[?(@.name=="<em>&lt;listener_name&gt;</em>")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="external")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the bootstrap address in your Kafka client to connect to the Kafka cluster.</p>
</div>
</li>
<li>
<p>Create or modify a user representing the client that requires access to the Kafka cluster.</p>
<div class="ulist">
<ul>
<li>
<p>Specify the same authentication type as the <code>Kafka</code> listener.</p>
</li>
<li>
<p>Specify the authorization ACLs for <code>simple</code> authorization.</p>
<div class="listingblock">
<div class="title">Example user configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster # <b class="conum">(1)</b>
spec:
  authentication:
    type: tls # <b class="conum">(2)</b>
  authorization:
    type: simple
    acls: # <b class="conum">(3)</b>
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operations:
          - Describe
          - Read
      - resource:
          type: group
          name: my-group
          patternType: literal
        operations:
          - Read</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The label must match the label of the Kafka cluster.</p>
</li>
<li>
<p>Authentication specified as mutual <code>tls</code>.</p>
</li>
<li>
<p>Simple authorization requires an accompanying list of ACL rules to apply to the user.
The rules define the operations allowed on Kafka resources based on the <em>username</em> (<code>my-user</code>).</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create or modify the <code>KafkaUser</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>USER-CONFIG-FILE</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The user is created, as well as a secret with the same name as the <code>KafkaUser</code> resource.
The secret contains a public and private key for mTLS authentication.</p>
</div>
<div class="listingblock">
<div class="title">Example secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  ca.crt: <em>&lt;public_key&gt;</em> # Public key of the clients CA
  user.crt: <em>&lt;user_certificate&gt;</em> # Public key of the user
  user.key: <em>&lt;user_private_key&gt;</em> # Private key of the user
  user.p12: <em>&lt;store&gt;</em> # PKCS #12 store for user certificates and keys
  user.password: <em>&lt;password_for_store&gt;</em> # Protects the PKCS #12 store</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the cluster CA certificate from the <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code> secret of the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;cluster_name&gt;</em>-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the user CA certificate from the <code><em>&lt;user_name&gt;</em></code> secret.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;user_name&gt;</em> -o jsonpath='{.data.user\.crt}' | base64 -d &gt; user.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the private key of the user from the <code><em>&lt;user_name&gt;</em></code> secret.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>&lt;user_name&gt;</em> -o jsonpath='{.data.user\.key}' | base64 -d &gt; user.key</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client with the bootstrap address hostname and port for connecting to the Kafka cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "<em>&lt;hostname&gt;:&lt;port&gt;</em>");</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client with the truststore credentials to verify the identity of the Kafka cluster.</p>
<div class="paragraph">
<p>Specify the public cluster CA certificate.</p>
</div>
<div class="listingblock">
<div class="title">Example truststore configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, "SSL");
props.put(SslConfigs.SSL_TRUSTSTORE_TYPE_CONFIG, "PEM");
props.put(SslConfigs.SSL_TRUSTSTORE_CERTIFICATES_CONFIG, "<em>&lt;ca.crt_file_content&gt;</em>");</code></pre>
</div>
</div>
<div class="paragraph">
<p>SSL is the specified security protocol for mTLS authentication.
Specify <code>SASL_SSL</code> for SCRAM-SHA-512 authentication over TLS.
PEM is the file format of the truststore.</p>
</div>
</li>
<li>
<p>Configure your client with the keystore credentials to verify the user when connecting to the Kafka cluster.</p>
<div class="paragraph">
<p>Specify the public certificate and private key.</p>
</div>
<div class="listingblock">
<div class="title">Example keystore configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, "SSL");
props.put(SslConfigs.SSL_KEYSTORE_TYPE_CONFIG, "PEM");
props.put(SslConfigs.SSL_KEYSTORE_CERTIFICATE_CHAIN_CONFIG, "<em>&lt;user.crt_file_content&gt;</em>");
props.put(SslConfigs.SSL_KEYSTORE_KEY_CONFIG, "<em>&lt;user.key_file_content&gt;</em>");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the keystore certificate and the private key directly to the configuration.
Add as a single-line format.
Between the <code>BEGIN CERTIFICATE</code> and <code>END CERTIFICATE</code> delimiters, start with a newline character (<code>\n</code>).
End each line from the original certificate with <code>\n</code> too.</p>
</div>
<div class="listingblock">
<div class="title">Example keystore configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">props.put(SslConfigs.SSL_KEYSTORE_CERTIFICATE_CHAIN_CONFIG, "-----BEGIN CERTIFICATE----- \n<em>&lt;user_certificate_content_line_1&gt;</em>\n<em>&lt;user_certificate_content_line_n&gt;</em>\n-----END CERTIFICATE---");
props.put(SslConfigs.SSL_KEYSTORE_KEY_CONFIG, "----BEGIN PRIVATE KEY-----\n<em>&lt;user_key_content_line_1&gt;</em>\n<em>&lt;user_key_content_line_n&gt;</em>\n-----END PRIVATE KEY-----");</code></pre>
</div>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-securing-kafka-authentication-str">Listener authentication</a></p>
</li>
<li>
<p><a href="#con-securing-kafka-authorization-str">Kafka authorization</a></p>
</li>
<li>
<p>If you are using an authorization server, you can use token-based authentication and authorization:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-oauth-authentication_str">Using OAuth 2.0 token-based authentication</a></p>
</li>
<li>
<p><a href="#assembly-oauth-authorization_str">Using OAuth 2.0 token-based authorization</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-nodeports-str"><a class="link" href="#proc-accessing-kafka-using-nodeports-str">8.4. Accessing Kafka using node ports</a></h3>
<div class="paragraph">
<p>This procedure describes how to access a Strimzi Kafka cluster from an external client using node ports.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you need a hostname and port number for the Kafka <em>bootstrap address</em>,
as well as the certificate used for authentication.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>nodeport</code> type.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    listeners:
      - name: external
        port: 9094
        type: nodeport
        tls: true
        authentication:
          type: tls
        # ...
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>NodePort</code> type services are created for each Kafka broker, as well as an external <em>bootstrap service</em>.
The bootstrap service routes external traffic to the Kafka brokers.
Node addresses used for connection are propagated to the <code>status</code> of the Kafka custom resource.</p>
</div>
<div class="paragraph">
<p>The cluster CA certificate to verify the identity of the kafka brokers is also created in the secret <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>.</p>
</div>
</li>
<li>
<p>Retrieve the bootstrap address you can use to access the Kafka cluster from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka <em>&lt;kafka_cluster_name&gt;</em> -o=jsonpath='{.status.listeners[?(@.name=="<em>&lt;listener_name&gt;</em>")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="external")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
</li>
<li>
<p>If TLS encryption is enabled, extract the public certificate of the broker certification authority.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>KAFKA-CLUSTER-NAME</em>-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the extracted certificate in your Kafka client to configure TLS connection.
If you enabled any authentication, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-loadbalancers-str"><a class="link" href="#proc-accessing-kafka-using-loadbalancers-str">8.5. Accessing Kafka using loadbalancers</a></h3>
<div class="paragraph">
<p>This procedure describes how to access a Strimzi Kafka cluster from an external client using loadbalancers.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you need the address of the <em>bootstrap loadbalancer</em>,
as well as the certificate used for TLS encryption.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>loadbalancer</code> type.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    listeners:
      - name: external
        port: 9094
        type: loadbalancer
        tls: true
        # ...
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>loadbalancer</code> type services and loadbalancers are created for each Kafka broker, as well as an external <em>bootstrap service</em>.
The bootstrap service routes external traffic to all Kafka brokers.
DNS names and IP addresses used for connection are propagated to the <code>status</code> of each service.</p>
</div>
<div class="paragraph">
<p>The cluster CA certificate to verify the identity of the kafka brokers is also created in the secret <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>.</p>
</div>
</li>
<li>
<p>Retrieve the address of the bootstrap service you can use to access the Kafka cluster from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka <em>&lt;kafka_cluster_name&gt;</em> -o=jsonpath='{.status.listeners[?(@.name=="<em>&lt;listener_name&gt;</em>")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="external")].bootstrapServers}{"\n"}'</code></pre>
</div>
</div>
</li>
<li>
<p>If TLS encryption is enabled, extract the public certificate of the broker certification authority.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret <em>KAFKA-CLUSTER-NAME</em>-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the extracted certificate in your Kafka client to configure the TLS connection.
If you enabled any authentication, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-ingress-str"><a class="link" href="#proc-accessing-kafka-using-ingress-str">8.6. Accessing Kafka using an Ingress NGINX Controller for Kubernetes</a></h3>
<div class="paragraph _abstract">
<p>Use an <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">Ingress NGINX Controller for Kubernetes</a> to access a Strimzi Kafka cluster from clients outside the Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>To be able to use an Ingress NGINX Controller for Kubernetes, add configuration for an <code>ingress</code> type listener in the <code>Kafka</code> custom resource.
When applied, the configuration creates a dedicated ingress and service for an external bootstrap and each broker in the cluster.
Clients connect to the bootstrap ingress, which routes them through the bootstrap service to connect to a broker.
Per-broker connections are then established using DNS names, which route traffic from the client to the broker through the broker-specific ingresses and services.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you specify a hostname for the ingress bootstrap address, as well as the TLS certificate.
Authentication is optional.</p>
</div>
<div class="paragraph">
<p>For access using an ingress, the port used in the Kafka client is typically 443.</p>
</div>
<div class="paragraph">
<div class="title">TLS passthrough</div>
<p>Make sure that you enable TLS passthrough in your Ingress NGINX Controller for Kubernetes deployment.
Kafka uses a binary protocol over TCP, but the Ingress NGINX Controller for Kubernetes is designed to work with a HTTP protocol.
To be able to route TCP traffic through ingresses, Strimzi uses TLS passthrough with Server Name Indication (SNI).</p>
</div>
<div class="paragraph">
<p>SNI helps with identifying and passing connection to Kafka brokers.
In passthrough mode, TLS encryption is always used.
Because the connection passes to the brokers, the listeners use the TLS certificates signed by the internal cluster CA and not the ingress certificates.
To configure listeners to use your own listener certificates, <a href="#proc-installing-certs-per-listener-str">use the <code>brokerCertChainAndKey</code> property</a>.</p>
</div>
<div class="paragraph">
<p>For more information about enabling TLS passthrough, see the <a href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/#ssl-passthrough">TLS passthrough documentation</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An Ingress NGINX Controller for Kubernetes is running with TLS passthrough enabled</p>
</li>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the Kafka cluster name is <code>my-cluster</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>ingress</code> type.</p>
<div class="paragraph">
<p>Specify an ingress hostname for the bootstrap service and each of the Kafka brokers in the Kafka cluster.
Add any hostname to the <code>bootstrap</code> and <code>broker-&lt;index&gt;</code> prefixes that identify the bootstrap and brokers.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  labels:
    app: my-cluster
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: external
        port: 9094
        type: ingress
        tls: true # <b class="conum">(1)</b>
        authentication:
          type: tls
        configuration:
          bootstrap:
            host: bootstrap.myingress.com
          brokers:
          - broker: 0
            host: broker-0.myingress.com
          - broker: 1
            host: broker-1.myingress.com
          - broker: 2
            host: broker-2.myingress.com
          class: nginx  # <b class="conum">(2)</b>
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For <code>ingress</code> type listeners, TLS encryption must be enabled (<code>true</code>).</p>
</li>
<li>
<p>(Optional) Class that specifies the ingress controller to use. You might need to add a class if you have not set up a default and a class name is missing in the ingresses created.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>A cluster CA certificate to verify the identity of the kafka brokers is created in the secret <code>my-cluster-cluster-ca-cert</code>.</p>
</div>
<div class="paragraph">
<p><code>ClusterIP</code> type services are created for each Kafka broker, as well as an external bootstrap service.</p>
</div>
<div class="paragraph">
<p>An <code>ingress</code> is also created for each service, with a DNS address to expose them using the Ingress NGINX Controller for Kubernetes.</p>
</div>
<div class="listingblock">
<div class="title">Ingresses created for the bootstrap and brokers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                        CLASS  HOSTS                    ADDRESS               PORTS
my-cluster-kafka-0          nginx  broker-0.myingress.com   external.ingress.com  80,443
my-cluster-kafka-1          nginx  broker-1.myingress.com   external.ingress.com  80,443
my-cluster-kafka-2          nginx  broker-2.myingress.com   external.ingress.com  80,443
my-cluster-kafka-bootstrap  nginx  bootstrap.myingress.com  external.ingress.com  80,443</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DNS addresses used for client connection are propagated to the <code>status</code> of each ingress.</p>
</div>
<div class="listingblock">
<div class="title">Status for the bootstrap ingress</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  loadBalancer:
    ingress:
      - hostname: external.ingress.com
 # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Use a target broker to check the client-server TLS connection on port 443 using the OpenSSL <code>s_client</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl s_client -connect broker-0.myingress.com:443 -servername broker-0.myingress.com -showcerts</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server name is the SNI for passing the connection to the broker.</p>
</div>
<div class="paragraph">
<p>If the connection is successful, the certificates for the broker are returned.</p>
</div>
<div class="listingblock">
<div class="title">Certificates for the broker</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Certificate chain
 0 s:O = io.strimzi, CN = my-cluster-kafka
   i:O = io.strimzi, CN = cluster-ca v0</code></pre>
</div>
</div>
</li>
<li>
<p>Extract the cluster CA certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client to connect to the brokers.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the bootstrap host (from the listener <code>configuration</code>) and port 443 in your Kafka client as the bootstrap address to connect to the Kafka cluster. For example, <code>bootstrap.myingress.com:443</code>.</p>
</li>
<li>
<p>Add the extracted certificate to the truststore of your Kafka client to configure a TLS connection.</p>
<div class="paragraph">
<p>If you enabled any authentication, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own listener certificates, check whether you need to add the CA certificate to the client&#8217;s truststore configuration.
If it is a public (external) CA, you usually won&#8217;t need to add it.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="proc-accessing-kafka-using-routes-str"><a class="link" href="#proc-accessing-kafka-using-routes-str">8.7. Accessing Kafka using OpenShift routes</a></h3>
<div class="paragraph _abstract">
<p>Use OpenShift routes to access a Strimzi Kafka cluster from clients outside the OpenShift cluster.</p>
</div>
<div class="paragraph">
<p>To be able to use routes, add configuration for a <code>route</code> type listener in the <code>Kafka</code> custom resource.
When applied, the configuration creates a dedicated route and service for an external bootstrap and each broker in the cluster.
Clients connect to the bootstrap route, which routes them through the bootstrap service to connect to a broker.
Per-broker connections are then established using DNS names, which route traffic from the client to the broker through the broker-specific routes and services.</p>
</div>
<div class="paragraph">
<p>To connect to a broker, you specify a hostname for the route bootstrap address, as well as the certificate used for authentication.</p>
</div>
<div class="paragraph">
<p>For access using routes, the port is always 443.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
An OpenShift route address comprises the name of the Kafka cluster, the name of the listener, and the name of the project it is created in.
For example, <code>my-cluster-kafka-listener1-bootstrap-myproject</code> (&lt;cluster_name&gt;-kafka-&lt;listener_name&gt;-bootstrap-&lt;namespace&gt;). Be careful that the whole length of the address does not exceed a maximum limit of 63 characters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">TLS passthrough</div>
<p>TLS passthrough is enabled for routes created by Strimzi.
Kafka uses a binary protocol over TCP, but routes are designed to work with a HTTP protocol.
To be able to route TCP traffic through routes, Strimzi uses TLS passthrough with Server Name Indication (SNI).</p>
</div>
<div class="paragraph">
<p>SNI helps with identifying and passing connection to Kafka brokers.
In passthrough mode, TLS encryption is always used.
Because the connection passes to the brokers, the listeners use TLS certificates signed by the internal cluster CA and not the ingress certificates.
To configure listeners to use your own listener certificates, <a href="#proc-installing-certs-per-listener-str">use the <code>brokerCertChainAndKey</code> property</a>.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Cluster Operator</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this procedure, the Kafka cluster name is <code>my-cluster</code>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure a <code>Kafka</code> resource with an external listener set to the <code>route</code> type.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  labels:
    app: my-cluster
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: listener1
        port: 9094
        type: route
        tls: true # <b class="conum">(1)</b>
        # ...
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For <code>route</code> type listeners, TLS encryption must be enabled (<code>true</code>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>A cluster CA certificate to verify the identity of the kafka brokers is created in the secret <code>my-cluster-cluster-ca-cert</code>.</p>
</div>
<div class="paragraph">
<p><code>ClusterIP</code> type services are created for each Kafka broker, as well as an external bootstrap service.</p>
</div>
<div class="paragraph">
<p>A <code>route</code> is also created for each service, with a DNS address (host/port) to expose them using the default OpenShift HAProxy router.</p>
</div>
<div class="paragraph">
<p>The routes are preconfigured with TLS passthrough.</p>
</div>
<div class="listingblock">
<div class="title">Routes created for the bootstraps and brokers</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                  HOST/PORT                                                   SERVICES                              PORT  TERMINATION
my-cluster-kafka-listener1-0          my-cluster-kafka-listener1-0-my-project.router.com          my-cluster-kafka-listener1-0          9094  passthrough
my-cluster-kafka-listener1-1          my-cluster-kafka-listener1-1-my-project.router.com          my-cluster-kafka-listener1-1          9094  passthrough
my-cluster-kafka-listener1-2          my-cluster-kafka-listener1-2-my-project.router.com          my-cluster-kafka-listener1-2          9094  passthrough
my-cluster-kafka-listener1-bootstrap  my-cluster-kafka-listener1-bootstrap-my-project.router.com  my-cluster-kafka-listener1-bootstrap  9094  passthrough</code></pre>
</div>
</div>
<div class="paragraph">
<p>The DNS addresses used for client connection are propagated to the <code>status</code> of each route.</p>
</div>
<div class="listingblock">
<div class="title">Example status for the bootstrap route</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">status:
  ingress:
    - host: &gt;-
        my-cluster-kafka-listener1-bootstrap-my-project.router.com
 # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Use a target broker to check the client-server TLS connection on port 443 using the OpenSSL <code>s_client</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">openssl s_client -connect my-cluster-kafka-listener1-0-my-project.router.com:443 -servername my-cluster-kafka-listener1-0-my-project.router.com -showcerts</code></pre>
</div>
</div>
<div class="paragraph">
<p>The server name is the SNI for passing the connection to the broker.</p>
</div>
<div class="paragraph">
<p>If the connection is successful, the certificates for the broker are returned.</p>
</div>
<div class="listingblock">
<div class="title">Certificates for the broker</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Certificate chain
 0 s:O = io.strimzi, CN = my-cluster-kafka
   i:O = io.strimzi, CN = cluster-ca v0</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieve the address of the bootstrap service from the status of the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka my-cluster -o=jsonpath='{.status.listeners[?(@.name=="listener1")].bootstrapServers}{"\n"}'

my-cluster-kafka-listener1-bootstrap-my-project.router.com:443</code></pre>
</div>
</div>
<div class="paragraph">
<p>The address comprises the cluster name, the listener name, the project name and the domain of the router (<code>router.com</code> in this example).</p>
</div>
</li>
<li>
<p>Extract the cluster CA certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get secret my-cluster-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 -d &gt; ca.crt</code></pre>
</div>
</div>
</li>
<li>
<p>Configure your client to connect to the brokers.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Specify the address for the bootstrap service and port 443 in your Kafka client as the bootstrap address to connect to the Kafka cluster.</p>
</li>
<li>
<p>Add the extracted certificate to the truststore of your Kafka client to configure a TLS connection.</p>
<div class="paragraph">
<p>If you enabled any authentication, you will also need to configure it in your client.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using your own listener certificates, check whether you need to add the CA certificate to the client&#8217;s truststore configuration.
If it is a public (external) CA, you usually won&#8217;t need to add it.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-securing-access-str"><a class="link" href="#assembly-securing-access-str">9. Managing secure access to Kafka</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Secure your Kafka cluster by managing the access a client has to Kafka brokers.
Specify configuration options to secure Kafka brokers and clients</p>
</div>
<div class="paragraph">
<p>A secure connection between Kafka brokers and clients can encompass the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Encryption for data exchange</p>
</li>
<li>
<p>Authentication to prove identity</p>
</li>
<li>
<p>Authorization to allow or decline actions executed by users</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The authentication and authorization mechanisms specified for a client must match those specified for the Kafka brokers.
Strimzi operators automate the configuration process and create the certificates required for authentication.</p>
</div>
<div class="sect2">
<h3 id="assembly-securing-kafka-brokers-str"><a class="link" href="#assembly-securing-kafka-brokers-str">9.1. Security options for Kafka</a></h3>
<div class="paragraph">
<p>Use the <code>Kafka</code> resource to configure the mechanisms used for Kafka authentication and authorization.</p>
</div>
<div class="sect3">
<h4 id="con-securing-kafka-authentication-str"><a class="link" href="#con-securing-kafka-authentication-str">9.1.1. Listener authentication</a></h4>
<div class="paragraph _abstract">
<p>Configure client authentication for Kafka brokers when creating listeners.
Specify the listener authentication type using the <code>Kafka.spec.kafka.listeners.authentication</code> property in the <code>Kafka</code> resource.</p>
</div>
<div class="paragraph">
<p>For clients inside the Kubernetes cluster, you can create <code>plain</code> (without encryption) or <code>tls</code> <em>internal</em> listeners.
The <code>internal</code> listener type use a headless service and the DNS names given to the broker pods.
As an alternative to the headless service, you can also create a <code>cluster-ip</code> type of internal listener to expose Kafka using per-broker <code>ClusterIP</code> services.
For clients outside the Kubernetes cluster, you create <em>external</em> listeners and specify a connection mechanism,
which can be <code>nodeport</code>, <code>loadbalancer</code>, <code>ingress</code>, or <code>route</code> (on OpenShift).</p>
</div>
<div class="paragraph">
<p>For more information on the configuration options for connecting an external client, see <a href="#deploy-client-access-str">Setting up client access to a Kafka cluster</a>.</p>
</div>
<div class="paragraph">
<p>Supported authentication options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>mTLS authentication (only on the listeners with TLS enabled encryption)</p>
</li>
<li>
<p>SCRAM-SHA-512 authentication</p>
</li>
<li>
<p><a href="#assembly-oauth-authentication_str">OAuth 2.0 token-based authentication</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaListenerAuthenticationCustom-reference" target="_blank" rel="noopener">Custom authentication</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The authentication option you choose depends on how you wish to authenticate client access to Kafka brokers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Try exploring the standard authentication options before using custom authentication. Custom authentication allows for any type of kafka-supported authentication. It can provide more flexibility, but also adds complexity.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/listener-config-options.png" alt="options for listener authentication configuration">
</div>
<div class="title">Figure 1. Kafka listener authentication options</div>
</div>
<div class="paragraph">
<p>The listener <code>authentication</code> property is used to specify an authentication mechanism specific to that listener.</p>
</div>
<div class="paragraph">
<p>If no <code>authentication</code> property is specified then the listener does not authenticate clients which connect through that listener.
The listener will accept all connections without authentication.</p>
</div>
<div class="paragraph">
<p>Authentication must be configured when using the User Operator to manage <code>KafkaUsers</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>plain</code> listener configured for SCRAM-SHA-512 authentication</p>
</li>
<li>
<p>A <code>tls</code> listener with mTLS authentication</p>
</li>
<li>
<p>An <code>external</code> listener with mTLS authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each listener is configured with a unique name and port within a Kafka cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Listeners cannot be configured to use the ports reserved for inter-broker communication (9091 or 9090) and metrics (9404).
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example listener authentication configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    listeners:
      - name: plain
        port: 9092
        type: internal
        tls: true
        authentication:
          type: scram-sha-512
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
      - name: external
        port: 9094
        type: loadbalancer
        tls: true
        authentication:
          type: tls
# ...</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="con-mutual-tls-authentication-str"><a class="link" href="#con-mutual-tls-authentication-str">mTLS authentication</a></h5>
<div class="paragraph">
<p>mTLS authentication is always used for the communication between Kafka brokers and ZooKeeper pods.</p>
</div>
<div class="paragraph">
<p>Strimzi can configure Kafka to use TLS (Transport Layer Security) to provide encrypted communication between Kafka brokers and clients either with or without mutual authentication.
For mutual, or two-way, authentication, both the server and the client present certificates.
When you configure mTLS authentication, the broker authenticates the client (client authentication) and the client authenticates the broker (server authentication).</p>
</div>
<div class="paragraph">
<p>mTLS listener configuration in the <code>Kafka</code> resource requires the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tls: true</code> to specify TLS encryption and server authentication</p>
</li>
<li>
<p><code>authentication.type: tls</code> to specify the client authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a Kafka cluster is created by the Cluster Operator, it creates a new secret with the name <code>&lt;cluster_name&gt;-cluster-ca-cert</code>.
The secret contains a CA certificate.
The CA certificate is in <a href="./configuring.html#certificates-and-secrets-formats-str" target="_blank" rel="noopener">PEM and PKCS #12 format</a>.
To verify a Kafka cluster, add the CA certificate to the truststore in your client configuration.
To verify a client, add a user certificate and key to the keystore in your client configuration.
For more information on configuring a client for mTLS, see <a href="#con-securing-client-authentication-str">User authentication</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TLS authentication is more commonly one-way, with one party authenticating the identity of another.
For example, when HTTPS is used between a web browser and a web server, the browser obtains proof of the identity of the web server.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="con-scram-sha-authentication-str"><a class="link" href="#con-scram-sha-authentication-str">SCRAM-SHA-512 authentication</a></h5>
<div class="paragraph">
<p>SCRAM (Salted Challenge Response Authentication Mechanism) is an authentication protocol that can establish mutual authentication using passwords.
Strimzi can configure Kafka to use SASL (Simple Authentication and Security Layer) SCRAM-SHA-512 to provide authentication on both unencrypted and encrypted client connections.</p>
</div>
<div class="paragraph">
<p>When SCRAM-SHA-512 authentication is used with a TLS connection, the TLS protocol provides the encryption, but is not used for authentication.</p>
</div>
<div class="paragraph">
<p>The following properties of SCRAM make it safe to use SCRAM-SHA-512 even on unencrypted connections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The passwords are not sent in the clear over the communication channel.
Instead the client and the server are each challenged by the other to offer proof that they know the password of the authenticating user.</p>
</li>
<li>
<p>The server and client each generate a new challenge for each authentication exchange.
This means that the exchange is resilient against replay attacks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When <code>KafkaUser.spec.authentication.type</code> is configured with <code>scram-sha-512</code> the User Operator will generate a random 12-character password consisting of upper and lowercase ASCII letters and numbers.</p>
</div>
</div>
<div class="sect4">
<h5 id="assembly-kafka-broker-listener-network-policies-str"><a class="link" href="#assembly-kafka-broker-listener-network-policies-str">Network policies</a></h5>
<div class="paragraph">
<p>By default, Strimzi automatically creates a <code>NetworkPolicy</code> resource for every listener that is enabled on a Kafka broker.
This <code>NetworkPolicy</code> allows applications to connect to listeners in all namespaces.
Use network policies as part of the listener configuration.</p>
</div>
<div class="paragraph">
<p>If you want to restrict access to a listener at the network level to only selected applications or namespaces, use the <code>networkPolicyPeers</code> property.
Each listener can have a different <a href="./configuring.html#configuration-listener-network-policy-reference"><code>networkPolicyPeers</code> configuration</a>.
For more information on network policy peers, refer to the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#networkpolicypeer-v1-networking-k8s-io" target="_blank" rel="noopener">NetworkPolicyPeer API reference</a>.</p>
</div>
<div class="paragraph">
<p>If you want to use custom network policies, you can set the <code>STRIMZI_NETWORK_POLICY_GENERATION</code> environment variable to <code>false</code> in the Cluster Operator configuration.
For more information, see <a href="./configuring.html#ref-operator-cluster-str" target="_blank" rel="noopener">Cluster Operator configuration</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Your configuration of Kubernetes must support ingress <code>NetworkPolicies</code> in order to use network policies in Strimzi.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="providing_listener_certificates"><a class="link" href="#providing_listener_certificates">Providing listener certificates</a></h5>
<div class="paragraph">
<p>You can provide your own server certificates, called <em>Kafka listener certificates</em>, for TLS listeners or external listeners which have TLS encryption enabled.
For more information, see <a href="#proc-installing-certs-per-listener-str">Providing your own Kafka listener certificates for TLS encryption</a>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-GenericKafkaListener-reference"><code>GenericKafkaListener</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-securing-kafka-authorization-str"><a class="link" href="#con-securing-kafka-authorization-str">9.1.2. Kafka authorization</a></h4>
<div class="paragraph _abstract">
<p>Configure authorization for Kafka brokers using the <code>Kafka.spec.kafka.authorization</code> property in the <code>Kafka</code> resource.
If the <code>authorization</code> property is missing, no authorization is enabled and clients have no restrictions.
When enabled, authorization is applied to all enabled listeners.
The authorization method is defined in the <code>type</code> field.</p>
</div>
<div class="paragraph">
<p>Supported authorization options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#type-KafkaAuthorizationSimple-reference">Simple authorization</a></p>
</li>
<li>
<p><a href="#assembly-oauth-authorization_str">OAuth 2.0 authorization</a> (if you are using OAuth 2.0 token based authentication)</p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaAuthorizationOpa-reference">Open Policy Agent (OPA) authorization</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaAuthorizationCustom-reference">Custom authorization</a></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kafka-authorization-config-options.png" alt="options for kafka authorization configuration">
</div>
<div class="title">Figure 2. Kafka cluster authorization options</div>
</div>
<div class="sect4">
<h5 id="super_users"><a class="link" href="#super_users">Super users</a></h5>
<div class="paragraph">
<p>Super users can access all resources in your Kafka cluster regardless of any access restrictions,
and are supported by all authorization mechanisms.</p>
</div>
<div class="paragraph">
<p>To designate super users for a Kafka cluster, add a list of user principals to the <code>superUsers</code> property.
If a user uses mTLS authentication, the username is the common name from the TLS certificate subject prefixed with <code>CN=</code>.
If you are not using the User Operator and using your own certificates for mTLS, the username is the full certificate subject.
A full certificate subject can have the following fields: <code>CN=user,OU=my_ou,O=my_org,L=my_location,ST=my_state,C=my_country_code</code>.
Omit any fields that are not present.</p>
</div>
<div class="listingblock">
<div class="title">An example configuration with super users</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    authorization:
      type: simple
      superUsers:
        - CN=client_1
        - user_2
        - CN=client_3
        - CN=client_4,OU=my_ou,O=my_org,L=my_location,ST=my_state,C=US
        - CN=client_5,OU=my_ou,O=my_org,C=GB
        - CN=client_6,O=my_org
    # ...</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-securing-kafka-clients-str"><a class="link" href="#assembly-securing-kafka-clients-str">9.2. Security options for Kafka clients</a></h3>
<div class="paragraph _abstract">
<p>Use the <code>KafkaUser</code> resource to configure the authentication mechanism, authorization mechanism, and access rights for Kafka clients.
In terms of configuring security, clients are represented as users.</p>
</div>
<div class="paragraph">
<p>You can authenticate and authorize user access to Kafka brokers.
Authentication permits access, and authorization constrains the access to permissible actions.</p>
</div>
<div class="paragraph">
<p>You can also create <em>super users</em> that have unconstrained access to Kafka brokers.</p>
</div>
<div class="paragraph">
<p>The authentication and authorization mechanisms must match the <a href="#proc-securing-kafka-str">specification for the listener used to access the Kafka brokers</a>.</p>
</div>
<div class="paragraph">
<div class="title">Configuring users for secure access to Kafka brokers</div>
<p>For more information on configuring a <code>KafkaUser</code> resource to access Kafka brokers securely, see the following sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#proc-configuring-kafka-user-str" target="_blank" rel="noopener">Securing user access to Kafka</a></p>
</li>
<li>
<p><a href="#setup-external-clients-str">Setting up client access to a Kafka cluster using listeners</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="con-securing-client-labels-str"><a class="link" href="#con-securing-client-labels-str">9.2.1. Identifying a Kafka cluster for user handling</a></h4>
<div class="paragraph">
<p>A <code>KafkaUser</code> resource includes a label that defines the appropriate name of the Kafka cluster (derived from the name of the <code>Kafka</code> resource) to which it belongs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>The label is used by the User Operator to identify the <code>KafkaUser</code> resource and create a new user, and also in subsequent handling of the user.</p>
</div>
<div class="paragraph">
<p>If the label does not match the Kafka cluster, the User Operator cannot identify the <code>KafkaUser</code> and the user is not created.</p>
</div>
<div class="paragraph">
<p>If the status of the <code>KafkaUser</code> resource remains empty, check your label.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-securing-client-authentication-str"><a class="link" href="#con-securing-client-authentication-str">9.2.2. User authentication</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>KafkaUser</code> custom resource to configure authentication credentials for users (clients) that require access to a Kafka cluster.
Configure the credentials using the <code>authentication</code> property in <code>KafkaUser.spec</code>.
By specifying a <code>type</code>, you control what credentials are generated.</p>
</div>
<div class="paragraph">
<p>Supported authentication types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>tls</code> for mTLS authentication</p>
</li>
<li>
<p><code>tls-external</code> for mTLS authentication using external certificates</p>
</li>
<li>
<p><code>scram-sha-512</code> for SCRAM-SHA-512 authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>tls</code> or <code>scram-sha-512</code> is specified, the User Operator creates authentication credentials when it creates the user.
If <code>tls-external</code> is specified, the user still uses mTLS, but no authentication credentials are created.
Use this option when you&#8217;re providing your own certificates.
When no authentication type is specified, the User Operator does not create the user or its credentials.</p>
</div>
<div class="paragraph">
<p>You can use <code>tls-external</code> to authenticate with mTLS using a certificate issued outside the User Operator.
The User Operator does not generate a TLS certificate or a secret.
You can still manage ACL rules and quotas through the User Operator in the same way as when you&#8217;re using the <code>tls</code> mechanism.
This means that you use the <code>CN=<em>USER-NAME</em></code> format when specifying ACL rules and quotas.
<em>USER-NAME</em> is the common name given in a TLS certificate.</p>
</div>
<div class="sect4">
<h5 id="mtls_authentication"><a class="link" href="#mtls_authentication">mTLS authentication</a></h5>
<div class="paragraph">
<p>To use mTLS authentication, you set the <code>type</code> field in the <code>KafkaUser</code> resource to <code>tls</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example user with mTLS authentication enabled</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: tls
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The authentication type must match the equivalent configuration for the <code>Kafka</code> listener used to access the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>When the user is created by the User Operator, it creates a new secret with the same name as the <code>KafkaUser</code> resource.
The secret contains a private and public key for mTLS.
The public key is contained in a user certificate, which is signed by a clients CA (certificate authority) when it is created.
All keys are in X.509 format.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using the clients CA generated by the Cluster Operator, the user certificates generated by the User Operator are also renewed when the clients CA is renewed by the Cluster Operator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The user secret <a href="./configuring.html#certificates-and-secrets-formats-str" target="_blank" rel="noopener">provides keys and certificates in PEM and PKCS #12 formats</a>.</p>
</div>
<div class="listingblock">
<div class="title">Example secret with user credentials</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  ca.crt: <em>&lt;public_key&gt;</em> # Public key of the clients CA
  user.crt: <em>&lt;user_certificate&gt;</em> # Public key of the user
  user.key: <em>&lt;user_private_key&gt;</em> # Private key of the user
  user.p12: <em>&lt;store&gt;</em> # PKCS #12 store for user certificates and keys
  user.password: <em>&lt;password_for_store&gt;</em> # Protects the PKCS #12 store</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you configure a client, you specify the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Truststore</strong> properties for the public cluster CA certificate to verify the identity of the Kafka cluster</p>
</li>
<li>
<p><strong>Keystore</strong> properties for the user authentication credentials to verify the client</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The configuration depends on the file format (PEM or PKCS #12).
This example uses PKCS #12 stores, and the passwords required to access the credentials in the stores.</p>
</div>
<div class="listingblock">
<div class="title">Example client configuration using mTLS in PKCS #12 format</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">bootstrap.servers=<em>&lt;kafka_cluster_name&gt;</em>-kafka-bootstrap:9093 # <b class="conum">(1)</b>
security.protocol=SSL # <b class="conum">(2)</b>
ssl.truststore.location=/tmp/ca.p12 # <b class="conum">(3)</b>
ssl.truststore.password=<em>&lt;truststore_password&gt;</em> # <b class="conum">(4)</b>
ssl.keystore.location=/tmp/user.p12 # <b class="conum">(5)</b>
ssl.keystore.password=<em>&lt;keystore_password&gt;</em> # <b class="conum">(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The bootstrap server address to connect to the Kafka cluster.</p>
</li>
<li>
<p>The security protocol option when using TLS for encryption.</p>
</li>
<li>
<p>The truststore location contains the public key certificate (<code>ca.p12</code>) for the Kafka cluster. A cluster CA certificate and password is generated by the Cluster Operator in the <code>&lt;cluster_name&gt;-cluster-ca-cert</code> secret when the Kafka cluster is created.</p>
</li>
<li>
<p>The password (<code>ca.password</code>) for accessing the truststore.</p>
</li>
<li>
<p>The keystore location contains the public key certificate (<code>user.p12</code>) for the Kafka user.</p>
</li>
<li>
<p>The password (<code>user.password</code>) for accessing the keystore.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="mtls_authentication_using_a_certificate_issued_outside_the_user_operator"><a class="link" href="#mtls_authentication_using_a_certificate_issued_outside_the_user_operator">mTLS authentication using a certificate issued outside the User Operator</a></h5>
<div class="paragraph">
<p>To use mTLS authentication using a certificate issued outside the User Operator, you set the <code>type</code> field in the <code>KafkaUser</code> resource to <code>tls-external</code>.
A secret and credentials are not created for the user.</p>
</div>
<div class="listingblock">
<div class="title">Example user with mTLS authentication that uses a certificate issued outside the User Operator</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: tls-external
  # ...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="scram_sha_512_authentication"><a class="link" href="#scram_sha_512_authentication">SCRAM-SHA-512 authentication</a></h5>
<div class="paragraph">
<p>To use the SCRAM-SHA-512 authentication mechanism, you set the <code>type</code> field in the <code>KafkaUser</code> resource to <code>scram-sha-512</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example user with SCRAM-SHA-512 authentication enabled</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: scram-sha-512
  # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the user is created by the User Operator, it creates a new secret with the same name as the <code>KafkaUser</code> resource.
The secret contains the generated password in the <code>password</code> key, which is encoded with base64.
In order to use the password, it must be decoded.</p>
</div>
<div class="listingblock">
<div class="title">Example secret with user credentials</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-user
  labels:
    strimzi.io/kind: KafkaUser
    strimzi.io/cluster: my-cluster
type: Opaque
data:
  password: Z2VuZXJhdGVkcGFzc3dvcmQ= <b class="conum">(1)</b>
  sasl.jaas.config: b3JnLmFwYWNoZS5rYWZrYS5jb21tb24uc2VjdXJpdHkuc2NyYW0uU2NyYW1Mb2dpbk1vZHVsZSByZXF1aXJlZCB1c2VybmFtZT0ibXktdXNlciIgcGFzc3dvcmQ9ImdlbmVyYXRlZHBhc3N3b3JkIjsK <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The generated password, base64 encoded.</p>
</li>
<li>
<p>The JAAS configuration string for SASL SCRAM-SHA-512 authentication, base64 encoded.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Decoding the generated password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>echo "Z2VuZXJhdGVkcGFzc3dvcmQ=" | base64 --decode</pre>
</div>
</div>
<div class="sect5">
<h6 id="custom_password_configuration"><a class="link" href="#custom_password_configuration">Custom password configuration</a></h6>
<div class="paragraph">
<p>When a user is created, Strimzi generates a random password.
You can use your own password instead of the one generated by Strimzi. To do so, create a secret with the password and reference it in the <code>KafkaUser</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example user with a password set for SCRAM-SHA-512 authentication</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication:
    type: scram-sha-512
    password:
      valueFrom:
        secretKeyRef:
          name: my-secret <b class="conum">(1)</b>
          key: my-password <b class="conum">(2)</b>
  # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The name of the secret containing the predefined password.</p>
</li>
<li>
<p>The key for the password stored inside the secret.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-securing-client-authorization-str"><a class="link" href="#con-securing-client-authorization-str">9.2.3. User authorization</a></h4>
<div class="paragraph _abstract">
<p>Use the <code>KafkaUser</code> custom resource to configure authorization rules for users (clients) that require access to a Kafka cluster.
Configure the rules using the <code>authorization</code> property in <code>KafkaUser.spec</code>.
By specifying a <code>type</code>, you control what rules are used.</p>
</div>
<div class="paragraph">
<p>To use simple authorization, you set the <code>type</code> property to <code>simple</code> in <code>KafkaUser.spec.authorization</code>.
The simple authorization uses the Kafka Admin API to manage the ACL rules inside your Kafka cluster.
Whether ACL management in the User Operator is enabled or not depends on your authorization configuration in the Kafka cluster.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For simple authorization, ACL management is always enabled.</p>
</li>
<li>
<p>For OPA authorization, ACL management is always disabled.
Authorization rules are configured in the OPA server.</p>
</li>
<li>
<p>For Keycloak authorization, you can manage the ACL rules directly in Keycloak.
You can also delegate authorization to the simple authorizer as a fallback option in the configuration.
When delegation to the simple authorizer is enabled, the User Operator will enable management of ACL rules as well.</p>
</li>
<li>
<p>For custom authorization using a custom authorization plugin, use the <code>supportsAdminApi</code> property in the <code>.spec.kafka.authorization</code> configuration of the <code>Kafka</code> custom resource to enable or disable the support.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authorization is cluster-wide.
The authorization type must match the equivalent configuration in the <code>Kafka</code> custom resource.</p>
</div>
<div class="paragraph">
<p>If ACL management is not enabled, Strimzi rejects a resource if it contains any ACL rules.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using a standalone deployment of the User Operator, ACL management is enabled by default.
You can disable it using the <code>STRIMZI_ACLS_ADMIN_API_SUPPORTED</code> environment variable.</p>
</div>
<div class="paragraph">
<p>If no authorization is specified, the User Operator does not provision any access rights for the user.
Whether such a <code>KafkaUser</code> can still access resources depends on the authorizer being used.
For example, for the <code>AclAuthorizer</code> this is determined by its <code>allow.everyone.if.no.acl.found</code> configuration.</p>
</div>
<div class="sect4">
<h5 id="acl_rules"><a class="link" href="#acl_rules">ACL rules</a></h5>
<div class="paragraph">
<p><code>AclAuthorizer</code> uses ACL rules to manage access to Kafka brokers.</p>
</div>
<div class="paragraph">
<p>ACL rules grant access rights to the user, which you specify in the <code>acls</code> property.</p>
</div>
<div class="paragraph">
<p>For more information about the <code>AclRule</code> object, see the <a href="./configuring.html#type-AclRule-reference" target="_blank" rel="noopener"><code>AclRule</code> schema reference</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="super_user_access_to_kafka_brokers"><a class="link" href="#super_user_access_to_kafka_brokers">Super user access to Kafka brokers</a></h5>
<div class="paragraph">
<p>If a user is added to a list of super users in a Kafka broker configuration,
the user is allowed unlimited access to the cluster regardless of any authorization constraints defined in ACLs in <code>KafkaUser</code>.</p>
</div>
<div class="paragraph">
<p>For more information on configuring super user access to brokers, see <a href="#con-securing-kafka-authorization-str">Kafka authorization</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="user_quotas"><a class="link" href="#user_quotas">User quotas</a></h5>
<div class="paragraph">
<p>You can configure the <code>spec</code> for the <code>KafkaUser</code> resource to enforce quotas so that a user does not exceed a configured level of access to Kafka brokers.
You can set size-based network usage and time-based CPU utilization thresholds.
You can also add a partition mutation quota to control the rate at which requests to change partitions are accepted for user requests.</p>
</div>
<div class="listingblock">
<div class="title">An example <code>KafkaUser</code> with user quotas</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  # ...
  quotas:
    producerByteRate: 1048576 <b class="conum">(1)</b>
    consumerByteRate: 2097152 <b class="conum">(2)</b>
    requestPercentage: 55 <b class="conum">(3)</b>
    controllerMutationRate: 10 <b class="conum">(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Byte-per-second quota on the amount of data the user can push to a Kafka broker</p>
</li>
<li>
<p>Byte-per-second quota on the amount of data the user can fetch from a Kafka broker</p>
</li>
<li>
<p>CPU utilization limit as a percentage of time for a client group</p>
</li>
<li>
<p>Number of concurrent partition creation and deletion operations (mutations) allowed per second</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information on these properties, see the <a href="./configuring.html#type-KafkaUserQuotas-reference" target="_blank" rel="noopener"><code>KafkaUserQuotas</code> schema reference</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-securing-kafka-str"><a class="link" href="#assembly-securing-kafka-str">9.3. Securing access to Kafka brokers</a></h3>
<div class="paragraph _abstract">
<p>To establish secure access to Kafka brokers, you configure and apply:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>Kafka</code> resource to:</p>
<div class="ulist">
<ul>
<li>
<p>Create listeners with a specified authentication type</p>
</li>
<li>
<p>Configure authorization for the whole Kafka cluster</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <code>KafkaUser</code> resource to access the Kafka brokers securely through the listeners</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configure the <code>Kafka</code> resource to set up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Listener authentication</p>
</li>
<li>
<p>Network policies that restrict access to Kafka listeners</p>
</li>
<li>
<p>Kafka authorization</p>
</li>
<li>
<p>Super users for unconstrained access to brokers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authentication is configured independently for each listener.
Authorization is always configured for the whole Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator creates the listeners and sets up the cluster and client certificate authority (CA) certificates to enable authentication within the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>You can replace the certificates generated by the Cluster Operator by <a href="./configuring.html#installing-your-own-ca-certificates-str" target="_blank" rel="noopener">installing your own certificates</a>.</p>
</div>
<div class="paragraph">
<p>You can also provide your own server certificates and private keys for any listener with TLS encryption enabled.
These user-provided certificates are called <em>Kafka listener certificates</em>.
Providing Kafka listener certificates allows you to leverage existing security infrastructure, such as your organization&#8217;s private CA or a public CA.
Kafka clients will need to trust the CA which was used to sign the listener certificate.
You must manually renew Kafka listener certificates when needed.
Certificates are available in PKCS #12 format (.p12) and PEM (.crt) formats.</p>
</div>
<div class="paragraph">
<p>Use <code>KafkaUser</code> to enable the authentication and authorization mechanisms that a specific client uses to access Kafka.</p>
</div>
<div class="paragraph">
<p>Configure the <code>KafkaUser</code> resource to set up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication to match the enabled listener authentication</p>
</li>
<li>
<p>Authorization to match the enabled Kafka authorization</p>
</li>
<li>
<p>Quotas to control the use of resources by clients</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The User Operator creates the user representing the client and the security credentials used for client authentication, based on the chosen authentication type.</p>
</div>
<div class="paragraph">
<p>Refer to the schema reference for more information on access configuration properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#type-Kafka-reference" target="_blank" rel="noopener"><code>Kafka</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaUser-reference" target="_blank" rel="noopener"><code>KafkaUser</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#type-GenericKafkaListener-reference" target="_blank" rel="noopener"><code>GenericKafkaListener</code> schema reference</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="proc-securing-kafka-str"><a class="link" href="#proc-securing-kafka-str">9.3.1. Securing Kafka brokers</a></h4>
<div class="paragraph">
<p>This procedure shows the steps involved in securing Kafka brokers when running Strimzi.</p>
</div>
<div class="paragraph">
<p>The security implemented for Kafka brokers must be compatible with the security implemented for the clients requiring access.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Kafka.spec.kafka.listeners[*].authentication</code> matches <code>KafkaUser.spec.authentication</code></p>
</li>
<li>
<p><code>Kafka.spec.kafka.authorization</code> matches <code>KafkaUser.spec.authorization</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The steps show the configuration for simple authorization and a listener using mTLS authentication.
For more information on listener configuration, see the <a href="./configuring.html#type-GenericKafkaListener-reference"><code>GenericKafkaListener</code> schema reference</a>.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can use SCRAM-SHA or OAuth 2.0 for <a href="#con-securing-kafka-authentication-str">listener authentication</a>,
and OAuth 2.0 or OPA for <a href="#con-securing-kafka-authorization-str">Kafka authorization</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>Kafka</code> resource.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Configure the <code>authorization</code> property for authorization.</p>
</li>
<li>
<p>Configure the <code>listeners</code> property to create a listener with authentication.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    authorization: <b class="conum">(1)</b>
      type: simple
      superUsers: <b class="conum">(2)</b>
        - CN=client_1
        - user_2
        - CN=client_3
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls <b class="conum">(3)</b>
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Authorization <a href="#con-securing-kafka-authorization-str">enables <code>simple</code> authorization on the Kafka broker using the <code>AclAuthorizer</code> Kafka plugin</a>.</p>
</li>
<li>
<p>List of user principals with unlimited access to Kafka. <em>CN</em> is the common name from the client certificate when mTLS authentication is used.</p>
</li>
<li>
<p>Listener authentication mechanisms may be configured for each listener, and <a href="#assembly-securing-kafka-brokers-str">specified as mTLS, SCRAM-SHA-512, or token-based OAuth 2.0</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are configuring an external listener, the configuration is dependent on the chosen connection mechanism.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the <code>Kafka</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;kafka_configuration_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kafka cluster is configured with a Kafka broker listener using mTLS authentication.</p>
</div>
<div class="paragraph">
<p>A service is created for each Kafka broker pod.</p>
</div>
<div class="paragraph">
<p>A service is created to serve as the <em>bootstrap address</em> for connection to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The cluster CA certificate to verify the identity of the kafka brokers is also created in the secret <code><em>&lt;cluster_name&gt;</em>-cluster-ca-cert</code>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-secure-kafka-user-str"><a class="link" href="#proc-configuring-secure-kafka-user-str">9.3.2. Securing user access to Kafka</a></h4>
<div class="paragraph _abstract">
<p>Create or modify a <code>KafkaUser</code> to represent a client that requires secure access to the Kafka cluster.</p>
</div>
<div class="paragraph">
<p>When you configure the <code>KafkaUser</code> authentication and authorization mechanisms, ensure they match the equivalent <code>Kafka</code> configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>KafkaUser.spec.authentication</code> matches <code>Kafka.spec.kafka.listeners[*].authentication</code></p>
</li>
<li>
<p><code>KafkaUser.spec.authorization</code> matches <code>Kafka.spec.kafka.authorization</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This procedure shows how a user is created with mTLS authentication.
You can also create a user with SCRAM-SHA authentication.</p>
</div>
<div class="paragraph">
<p>The authentication required depends on the <a href="#con-securing-kafka-authentication-str">type of authentication configured for the Kafka broker listener</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Authentication between Kafka users and Kafka brokers depends on the authentication settings for each.
For example, it is not possible to authenticate a user with mTLS if it is not also enabled in the Kafka configuration.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Kafka cluster <a href="#con-mutual-tls-authentication-str">configured with a Kafka broker listener using mTLS authentication and TLS encryption</a>.</p>
</li>
<li>
<p>A running User Operator (typically deployed with the Entity Operator).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The authentication type in <code>KafkaUser</code> should match the authentication configured in <code>Kafka</code> brokers.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Configure the <code>KafkaUser</code> resource.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: my-user
  labels:
    strimzi.io/cluster: my-cluster
spec:
  authentication: <b class="conum">(1)</b>
    type: tls
  authorization:
    type: simple <b class="conum">(2)</b>
    acls:
      - resource:
          type: topic
          name: my-topic
          patternType: literal
        operations:
          - Describe
          - Read
      - resource:
          type: group
          name: my-group
          patternType: literal
        operations:
          - Read</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>User authentication mechanism, defined as mutual <code>tls</code> or <code>scram-sha-512</code>.</p>
</li>
<li>
<p>Simple authorization, which requires an accompanying list of ACL rules.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or update the <code>KafkaUser</code> resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;user_config_file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The user is created, as well as a Secret with the same name as the <code>KafkaUser</code> resource.
The Secret contains a private and public key for mTLS authentication.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For information on configuring a Kafka client with properties for secure connection to Kafka brokers, see <a href="#setup-external-clients-str">Setting up client access to a Kafka cluster using listeners</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-restricting-access-to-listeners-using-network-policies-str"><a class="link" href="#proc-restricting-access-to-listeners-using-network-policies-str">9.3.3. Restricting access to Kafka listeners using network policies</a></h4>
<div class="paragraph _abstract">
<p>You can restrict access to a listener to only selected applications by using the <code>networkPolicyPeers</code> property.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A Kubernetes cluster with support for Ingress NetworkPolicies.</p>
</li>
<li>
<p>The Cluster Operator is running.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open the <code>Kafka</code> resource.</p>
</li>
<li>
<p>In the <code>networkPolicyPeers</code> property, define the application pods or namespaces that will be allowed to access the Kafka cluster.</p>
<div class="paragraph">
<p>For example, to configure a <code>tls</code> listener to allow connections only from application pods with the label <code>app</code> set to <code>kafka-client</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: tls
        networkPolicyPeers:
          - podSelector:
              matchLabels:
                app: kafka-client
    # ...
  zookeeper:
    # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Create or update the resource.</p>
<div class="paragraph">
<p>Use <code>kubectl apply</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>your-file</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph _additional-resources">
<div class="title">Additional resources</div>
<p>ink:./configuring.html#
* <a href="./configuring.html#configuration-listener-network-policy-reference" target="_blank" rel="noopener"><code>networkPolicyPeers</code> configuration</a>
* <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#networkpolicypeer-v1-networking-k8s-io" target="_blank" rel="noopener">NetworkPolicyPeer API reference</a></p>
</div>
</div>
<div class="sect3">
<h4 id="proc-installing-certs-per-listener-str"><a class="link" href="#proc-installing-certs-per-listener-str">9.3.4. Providing your own Kafka listener certificates for TLS encryption</a></h4>
<div class="paragraph _abstract">
<p>Listeners provide client access to Kafka brokers.
Configure listeners in the <code>Kafka</code> resource, including the configuration required for client access using TLS.</p>
</div>
<div class="paragraph">
<p>By default, the listeners use certificates signed by the internal CA (certificate authority) certificates generated by Strimzi.
A CA certificate is generated by the Cluster Operator when it creates a Kafka cluster.
When you configure a client for TLS, you add the CA certificate to its truststore configuration to verify the Kafka cluster.
You can also <a href="./configuring.html#installing-your-own-ca-certificates-str">install and use your own CA certificates</a>.
Or you can configure a listener using <code>brokerCertChainAndKey</code> properties and use a custom server certificate.</p>
</div>
<div class="paragraph">
<p>The <code>brokerCertChainAndKey</code> properties allow you to access Kafka brokers using your own custom certificates at the listener-level.
You create a secret with your own private key and server certificate, then specify the key and certificate in the listener&#8217;s <code>brokerCertChainAndKey</code> configuration.
You can use a certificate signed by a public (external) CA or a private CA.
If signed by a public CA, you usually won&#8217;t need to add it to a client&#8217;s truststore configuration.
Custom certificates are not managed by Strimzi, so you need to renew them manually.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Listener certificates are used for TLS encryption and server authentication only.
They are not used for TLS client authentication.
If you want to use your own certificate for TLS client authentication as well, you must <a href="./configuring.html#installing-your-own-ca-certificates-str">install and use your own clients CA</a>.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running.</p>
</li>
<li>
<p>Each listener requires the following:</p>
<div class="ulist">
<ul>
<li>
<p>A compatible server certificate signed by an external CA. (Provide an X.509 certificate in PEM format.)</p>
<div class="paragraph">
<p>You can use one listener certificate for multiple listeners.</p>
</div>
</li>
<li>
<p>Subject Alternative Names (SANs) are specified in the certificate for each listener.
For more information, see <a href="#ref-alternative-subjects-certs-for-listeners-str">Alternative subjects in server certificates for Kafka listeners</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are not using a self-signed certificate, you can provide a certificate that includes the whole CA chain in the certificate.</p>
</div>
<div class="paragraph">
<p>You can only use the <code>brokerCertChainAndKey</code> properties if TLS encryption (<code>tls: true</code>) is configured for the listener.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Secret</code> containing your private key and server certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret generic <em>my-secret</em> --from-file=<em>my-listener-key.key</em> --from-file=<em>my-listener-certificate.crt</em></code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>Kafka</code> resource for your cluster.</p>
<div class="paragraph">
<p>Configure the listener to use your <code>Secret</code>, certificate file, and private key file in the <code>configuration.brokerCertChainAndKey</code> property.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for a <code>loadbalancer</code> external listener with TLS encryption enabled</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
listeners:
  - name: plain
    port: 9092
    type: internal
    tls: false
  - name: external
    port: 9094
    type: loadbalancer
    tls: true
    configuration:
      brokerCertChainAndKey:
        secretName: my-secret
        certificate: my-listener-certificate.crt
        key: my-listener-key.key
# ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example configuration for a TLS listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
listeners:
  - name: plain
    port: 9092
    type: internal
    tls: false
  - name: tls
    port: 9093
    type: internal
    tls: true
    configuration:
      brokerCertChainAndKey:
        secretName: my-secret
        certificate: my-listener-certificate.crt
        key: my-listener-key.key
# ...</code></pre>
</div>
</div>
</li>
<li>
<p>Apply the new configuration to create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>kafka.yaml</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Cluster Operator starts a rolling update of the Kafka cluster, which updates the configuration of the listeners.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A rolling update is also started if you update a Kafka listener certificate in a <code>Secret</code> that is already used by a listener.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref-alternative-subjects-certs-for-listeners-str"><a class="link" href="#ref-alternative-subjects-certs-for-listeners-str">9.3.5. Alternative subjects in server certificates for Kafka listeners</a></h4>
<div class="paragraph _abstract">
<p>In order to use TLS hostname verification with your own <a href="#proc-installing-certs-per-listener-str">Kafka listener certificates</a>, you must use the correct Subject Alternative Names (SANs) for each listener. The certificate SANs must specify hostnames for the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All of the Kafka brokers in your cluster</p>
</li>
<li>
<p>The Kafka cluster bootstrap service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use wildcard certificates if they are supported by your CA.</p>
</div>
<div class="sect4">
<h5 id="tls_listener_san_examples"><a class="link" href="#tls_listener_san_examples">TLS listener SAN examples</a></h5>
<div class="paragraph">
<p>Use the following examples to help you specify hostnames of the SANs in your certificates for TLS listeners.</p>
</div>
<div class="listingblock">
<div class="title">Wildcards example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">//Kafka brokers
*.<em>&lt;cluster-name&gt;</em>-kafka-brokers
*.<em>&lt;cluster-name&gt;</em>-kafka-brokers.<em>&lt;namespace&gt;</em>.svc

// Bootstrap service
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap.<em>&lt;namespace&gt;</em>.svc</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Non-wildcards example</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">// Kafka brokers
<em>&lt;cluster-name&gt;</em>-kafka-0.<em>&lt;cluster-name&gt;</em>-kafka-brokers
<em>&lt;cluster-name&gt;</em>-kafka-0.<em>&lt;cluster-name&gt;</em>-kafka-brokers.<em>&lt;namespace&gt;</em>.svc
<em>&lt;cluster-name&gt;</em>-kafka-1.<em>&lt;cluster-name&gt;</em>-kafka-brokers
<em>&lt;cluster-name&gt;</em>-kafka-1.<em>&lt;cluster-name&gt;</em>-kafka-brokers.<em>&lt;namespace&gt;</em>.svc
# ...

// Bootstrap service
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap
<em>&lt;cluster-name&gt;</em>-kafka-bootstrap.<em>&lt;namespace&gt;</em>.svc</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="external_listener_san_examples"><a class="link" href="#external_listener_san_examples">External listener SAN examples</a></h5>
<div class="paragraph">
<p>For external listeners which have TLS encryption enabled, the hostnames you need to specify in certificates depends on the external listener <code>type</code>.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 3. SANs for each type of external listener</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">External listener type</th>
<th class="tableblock halign-left valign-top">In the SANs, specify&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Route</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addresses of all Kafka broker <code>Routes</code> and the address of the bootstrap <code>Route</code>.</p>
<p class="tableblock">You can use a matching wildcard name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>loadbalancer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addresses of all Kafka broker <code>loadbalancers</code> and the bootstrap <code>loadbalancer</code> address.</p>
<p class="tableblock">You can use a matching wildcard name.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NodePort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addresses of all Kubernetes worker nodes that the Kafka broker pods might be scheduled to.</p>
<p class="tableblock">You can use a matching wildcard name.</p></td>
</tr>
</tbody>
</table>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-installing-certs-per-listener-str">Providing your own Kafka listener certificates for TLS encryption</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-oauth-authentication_str"><a class="link" href="#assembly-oauth-authentication_str">9.4. Using OAuth 2.0 token-based authentication</a></h3>
<div class="paragraph _abstract">
<p>Strimzi supports the use of <a href="https://oauth.net/2/" target="_blank" rel="noopener">OAuth 2.0 authentication</a> using the <em>OAUTHBEARER</em> and <em>PLAIN</em> mechanisms.</p>
</div>
<div class="paragraph">
<p>OAuth 2.0 enables standardized token-based authentication and authorization between applications, using a central authorization server to issue tokens that grant limited access to resources.</p>
</div>
<div class="paragraph">
<p>Kafka brokers and clients both need to be configured to use OAuth 2.0.
You can configure OAuth 2.0 authentication, then <a href="#assembly-oauth-authorization_str">OAuth 2.0 authorization</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OAuth 2.0 authentication can be used in conjunction with <a href="#con-securing-kafka-authorization-str">Kafka authorization</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using OAuth 2.0 authentication, application clients can access resources on application servers (called <em>resource servers</em>) without exposing account credentials.</p>
</div>
<div class="paragraph">
<p>The application client passes an access token as a means of authenticating, which application servers can also use to determine the level of access to grant.
The authorization server handles the granting of access and inquiries about access.</p>
</div>
<div class="paragraph">
<p>In the context of Strimzi:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka brokers act as OAuth 2.0 resource servers</p>
</li>
<li>
<p>Kafka clients act as OAuth 2.0 application clients</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Kafka clients authenticate to Kafka brokers.
The brokers and clients communicate with the OAuth 2.0 authorization server, as necessary, to obtain or validate access tokens.</p>
</div>
<div class="paragraph">
<p>For a deployment of Strimzi, OAuth 2.0 integration provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Server-side OAuth 2.0 support for Kafka brokers</p>
</li>
<li>
<p>Client-side OAuth 2.0 support for Kafka MirrorMaker, Kafka Connect, and the Kafka Bridge</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-flow-str"><a class="link" href="#con-oauth-authentication-flow-str">9.4.1. OAuth 2.0 authentication mechanisms</a></h4>
<div class="paragraph _abstract">
<p>Strimzi supports the OAUTHBEARER and PLAIN mechanisms for OAuth 2.0 authentication.
Both mechanisms allow Kafka clients to establish authenticated sessions with Kafka brokers.
The authentication flow between clients, the authorization server, and Kafka brokers is different for each mechanism.</p>
</div>
<div class="paragraph">
<p>We recommend that you configure clients to use OAUTHBEARER whenever possible.
OAUTHBEARER provides a higher level of security than PLAIN because client credentials are <em>never</em> shared with Kafka brokers.
Consider using PLAIN only with Kafka clients that do not support OAUTHBEARER.</p>
</div>
<div class="paragraph">
<p>You configure Kafka broker listeners to use OAuth 2.0 authentication for connecting clients.
If necessary, you can use the OAUTHBEARER and PLAIN mechanisms on the same <code>oauth</code> listener.
The properties to support each mechanism must be explicitly specified in the <code>oauth</code> listener configuration.</p>
</div>
<div class="paragraph">
<div class="title">OAUTHBEARER overview</div>
<p>OAUTHBEARER is automatically enabled in the <code>oauth</code> listener configuration for the Kafka broker.
You can set the <code>enableOauthBearer</code> property to <code>true</code>, though this is not required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  authentication:
    type: oauth
    # ...
    enableOauthBearer: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many Kafka client tools use libraries that provide basic support for OAUTHBEARER at the protocol level.
To support application development, Strimzi provides an <em>OAuth callback handler</em> for the upstream Kafka Client Java libraries (but not for other libraries).
Therefore, you do not need to write your own callback handlers.
An application client can use the callback handler to provide the access token.
Clients written in other languages, such as Go, must use custom code to connect to the authorization server and obtain the access token.</p>
</div>
<div class="paragraph">
<p>With OAUTHBEARER, the client initiates a session with the Kafka broker for credentials exchange, where credentials take the form of a bearer token provided by the callback handler.
Using the callbacks, you can configure token provision in one of three ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID and Secret (by using the <em>OAuth 2.0 client credentials</em> mechanism)</p>
</li>
<li>
<p>A long-lived access token, obtained manually at configuration time</p>
</li>
<li>
<p>A long-lived refresh token, obtained manually at configuration time</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OAUTHBEARER authentication can only be used by Kafka clients that support the OAUTHBEARER mechanism at the protocol level.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">PLAIN overview</div>
<p>To use PLAIN, you must enable it in the <code>oauth</code> listener configuration for the Kafka broker.</p>
</div>
<div class="paragraph">
<p>In the following example, PLAIN is enabled in addition to OAUTHBEARER, which is enabled by default.
If you want to use PLAIN only, you can disable OAUTHBEARER by setting <code>enableOauthBearer</code> to <code>false</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  authentication:
    type: oauth
    # ...
    enablePlain: true
    tokenEndpointUri: https://<em>OAUTH-SERVER-ADDRESS</em>/auth/realms/external/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>PLAIN is a simple authentication mechanism used by all Kafka client tools.
To enable PLAIN to be used with OAuth 2.0 authentication, Strimzi provides <em>OAuth 2.0 over PLAIN</em> server-side callbacks.</p>
</div>
<div class="paragraph">
<p>With the Strimzi implementation of PLAIN, the client credentials are not stored in ZooKeeper.
Instead, client credentials are handled centrally behind a compliant authorization server, similar to when OAUTHBEARER authentication is used.</p>
</div>
<div class="paragraph">
<p>When used with the OAuth 2.0 over PLAIN callbacks, Kafka clients authenticate with Kafka brokers using either of the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID and secret (by using the OAuth 2.0 client credentials mechanism)</p>
</li>
<li>
<p>A long-lived access token, obtained manually at configuration time</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For both methods, the client must provide the PLAIN <code>username</code> and <code>password</code> properties to pass credentials to the Kafka broker.
The client uses these properties to pass a client ID and secret or username and access token.</p>
</div>
<div class="paragraph">
<p>Client IDs and secrets are used to obtain access tokens.</p>
</div>
<div class="paragraph">
<p>Access tokens are passed as <code>password</code> property values.
You pass the access token with or without an <code>$accessToken:</code> prefix.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you configure a token endpoint (<code>tokenEndpointUri</code>) in the listener configuration, you need the prefix.</p>
</li>
<li>
<p>If you don&#8217;t configure a token endpoint (<code>tokenEndpointUri</code>) in the listener configuration, you don&#8217;t need the prefix.
The Kafka broker interprets the password as a raw access token.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the <code>password</code> is set as the access token, the <code>username</code> must be set to the same principal name that the Kafka broker obtains from the access token.
You can specify username extraction options in your listener using the <code>userNameClaim</code>, <code>fallbackUserNameClaim</code>, <code>fallbackUsernamePrefix</code>, and <code>userInfoEndpointUri</code> properties.
The username extraction process also depends on your authorization server; in particular, how it maps client IDs to account names.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>OAuth over PLAIN does not support <code>password grant</code> mechanism. You can only 'proxy' through SASL PLAIN mechanism the <code>client credentials</code> (clientId + secret) or the access token as described above.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-broker-str"><a class="link" href="#con-oauth-authentication-broker-str">9.4.2. OAuth 2.0 Kafka broker configuration</a></h4>
<div class="paragraph">
<p>Kafka broker configuration for OAuth 2.0 involves:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creating the OAuth 2.0 client in the authorization server</p>
</li>
<li>
<p>Configuring OAuth 2.0 authentication in the Kafka custom resource</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In relation to the authorization server, Kafka brokers and Kafka clients are both regarded as OAuth 2.0 clients.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="oauth_2_0_client_configuration_on_an_authorization_server"><a class="link" href="#oauth_2_0_client_configuration_on_an_authorization_server">OAuth 2.0 client configuration on an authorization server</a></h5>
<div class="paragraph">
<p>To configure a Kafka broker to validate the token received during session initiation,
the recommended approach is to create an OAuth 2.0 <em>client</em> definition in an authorization server, configured as <em>confidential</em>, with the following client credentials enabled:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID of <code>kafka</code> (for example)</p>
</li>
<li>
<p>Client ID and Secret as the authentication mechanism</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You only need to use a client ID and secret when using a non-public introspection endpoint of the authorization server.
The credentials are not typically required when using public authorization server endpoints, as with fast local JWT token validation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="oauth_2_0_authentication_configuration_in_the_kafka_cluster"><a class="link" href="#oauth_2_0_authentication_configuration_in_the_kafka_cluster">OAuth 2.0 authentication configuration in the Kafka cluster</a></h5>
<div class="paragraph">
<p>To use OAuth 2.0 authentication in the Kafka cluster, you specify, for example, a <code>tls</code> listener configuration for your Kafka cluster custom resource with the authentication method <code>oauth</code>:</p>
</div>
<div class="listingblock">
<div class="title">Assigining the authentication method type for OAuth 2.0</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    # ...
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: <strong>oauth</strong>
      #...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure OAuth 2.0 authentication in your listeners.
We recommend using OAuth 2.0 authentication together with TLS encryption (<code>tls: true</code>).
Without encryption, the connection is vulnerable to network eavesdropping and unauthorized access through token theft.</p>
</div>
<div class="paragraph">
<p>You configure an <code>external</code> listener with <code>type: oauth</code> for a secure transport layer to communicate with the client.</p>
</div>
<div class="listingblock">
<div class="title">Using OAuth 2.0 with an external listener</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
listeners:
  - name: external
    port: 9094
    type: loadbalancer
    tls: true
    authentication:
      type: <strong>oauth</strong>
    #...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>tls</code> property is <em>false</em> by default, so it must be enabled.</p>
</div>
<div class="paragraph">
<p>When you have defined the type of authentication as OAuth 2.0, you add configuration based on the type of validation, either as <a href="#con-oauth-authentication-broker-fast-local">fast local JWT validation</a> or <a href="#con-oauth-authentication-broker-intro-local">token validation using an introspection endpoint</a>.</p>
</div>
<div class="paragraph">
<p>The procedure to configure OAuth 2.0 for listeners, with descriptions and examples, is described in <a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-oauth-authentication-broker-fast-local"><a class="link" href="#con-oauth-authentication-broker-fast-local">Fast local JWT token validation configuration</a></h5>
<div class="paragraph">
<p>Fast local JWT token validation checks a JWT token signature locally.</p>
</div>
<div class="paragraph">
<p>The local check ensures that a token:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Conforms to type by containing a (<em>typ</em>) claim value of <code>Bearer</code> for an access token</p>
</li>
<li>
<p>Is valid (not expired)</p>
</li>
<li>
<p>Has an issuer that matches a <code>validIssuerURI</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You specify a <code>validIssuerURI</code> attribute when you configure the listener, so that any tokens not issued by the authorization server are rejected.</p>
</div>
<div class="paragraph">
<p>The authorization server does not need to be contacted during fast local JWT token validation.
You activate fast local JWT token validation by specifying a <code>jwksEndpointUri</code> attribute, the endpoint exposed by the OAuth 2.0 authorization server.
The endpoint contains the public keys used to validate signed JWT tokens, which are sent as credentials by Kafka clients.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
All communication with the authorization server should be performed using TLS encryption.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can configure a certificate truststore as a Kubernetes Secret in your Strimzi project namespace, and use a <code>tlsTrustedCertificates</code> attribute to point to the Kubernetes Secret containing the truststore file.</p>
</div>
<div class="paragraph">
<p>You might want to configure a <code>userNameClaim</code> to properly extract a username from the JWT token.
If you want to use Kafka ACL authorization, you need to identify the user by their username during authentication.
(The <code>sub</code> claim in JWT tokens is typically a unique ID, not a username.)</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for fast local JWT token validation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    #...
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: <strong>oauth</strong>
          validIssuerUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/tls</em>&gt;
          jwksEndpointUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/tls/protocol/openid-connect/certs</em>&gt;
          userNameClaim: preferred_username
          maxSecondsWithoutReauthentication: 3600
          tlsTrustedCertificates:
          - secretName: oauth-server-cert
            certificate: ca.crt
    #...</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="con-oauth-authentication-broker-intro-local"><a class="link" href="#con-oauth-authentication-broker-intro-local">OAuth 2.0 introspection endpoint configuration</a></h5>
<div class="paragraph">
<p>Token validation using an OAuth 2.0 introspection endpoint treats a received access token as opaque.
The Kafka broker sends an access token to the introspection endpoint, which responds with the token information necessary for validation.
Importantly, it returns up-to-date information if the specific access token is valid, and also information about when the token expires.</p>
</div>
<div class="paragraph">
<p>To configure OAuth 2.0 introspection-based validation, you specify an <code>introspectionEndpointUri</code> attribute rather than the <code>jwksEndpointUri</code> attribute specified for fast local JWT token validation.
Depending on the authorization server, you typically have to specify a <code>clientId</code> and <code>clientSecret</code>, because the introspection endpoint is usually protected.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for an introspection endpoint</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  kafka:
    listeners:
      - name: tls
        port: 9093
        type: internal
        tls: true
        authentication:
          type: <strong>oauth</strong>
          clientId: kafka-broker
          clientSecret:
            secretName: my-cluster-oauth
            key: clientSecret
          validIssuerUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/tls</em>&gt;
          introspectionEndpointUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/tls/protocol/openid-connect/token/introspect</em>&gt;
          userNameClaim: preferred_username
          maxSecondsWithoutReauthentication: 3600
          tlsTrustedCertificates:
          - secretName: oauth-server-cert
            certificate: ca.crt</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="str"><a class="link" href="#str">9.4.3. Session re-authentication for Kafka brokers</a></h4>
<div class="paragraph">
<p>You can configure <code>oauth</code> listeners to use Kafka <em>session re-authentication</em> for OAuth 2.0 sessions between Kafka clients and Kafka brokers.
This mechanism enforces the expiry of an authenticated session between the client and the broker after a defined period of time.
When a session expires, the client immediately starts a new session by reusing the existing connection rather than dropping it.</p>
</div>
<div class="paragraph">
<p>Session re-authentication is disabled by default.
To enable it, you set a time value for <code>maxSecondsWithoutReauthentication</code> in the <code>oauth</code> listener configuration.
The same property is used to configure session re-authentication for OAUTHBEARER and PLAIN authentication.
For an example configuration, see <a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a>.</p>
</div>
<div class="paragraph">
<p>Session re-authentication must be supported by the Kafka client libraries used by the client.</p>
</div>
<div class="paragraph">
<p>Session re-authentication can be used with <em>fast local JWT</em> or <em>introspection endpoint</em> token validation.</p>
</div>
<div class="paragraph">
<div class="title">Client re-authentication</div>
<p>When the broker&#8217;s authenticated session expires, the client must re-authenticate to the existing session by sending a new, valid access token to the broker, without dropping the connection.</p>
</div>
<div class="paragraph">
<p>If token validation is successful, a new client session is started using the existing connection.
If the client fails to re-authenticate, the broker will close the connection if further attempts are made to send or receive messages.
Java clients that use Kafka client library 2.2 or later automatically re-authenticate if the re-authentication mechanism is enabled on the broker.</p>
</div>
<div class="paragraph">
<p>Session re-authentication also applies to refresh tokens, if used.
When the session expires, the client refreshes the access token by using its refresh token.
The client then uses the new access token to re-authenticate to the existing session.</p>
</div>
<div class="paragraph">
<div class="title">Session expiry for OAUTHBEARER and PLAIN</div>
<p>When session re-authentication is configured, session expiry works differently for OAUTHBEARER and PLAIN authentication.</p>
</div>
<div class="paragraph">
<p>For OAUTHBEARER and PLAIN, using the client ID and secret method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The broker&#8217;s authenticated session will expire at the configured <code>maxSecondsWithoutReauthentication</code>.</p>
</li>
<li>
<p>The session will expire earlier if the access token expires before the configured time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For PLAIN using the long-lived access token method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The broker&#8217;s authenticated session will expire at the configured <code>maxSecondsWithoutReauthentication</code>.</p>
</li>
<li>
<p>Re-authentication will fail if the access token expires before the configured time.
Although session re-authentication is attempted, PLAIN has no mechanism for refreshing tokens.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>maxSecondsWithoutReauthentication</code> is <em>not</em> configured, OAUTHBEARER and PLAIN clients can remain connected to brokers indefinitely, without needing to re-authenticate.
Authenticated sessions do not end with access token expiry.
However, this can be considered when configuring authorization, for example, by using <code>keycloak</code> authorization or installing a custom authorizer.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#con-oauth-authentication-broker-str">OAuth 2.0 Kafka broker configuration</a></p>
</li>
<li>
<p><a href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a></p>
</li>
<li>
<p><a href="./configuring.html#type-KafkaListenerAuthenticationOAuth-reference" target="_blank" rel="noopener"><code>KafkaListenerAuthenticationOAuth</code> schema reference</a></p>
</li>
<li>
<p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-368%3A+Allow+SASL+Connections+to+Periodically+Re-Authenticate" target="_blank" rel="noopener">KIP-368</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-client-str"><a class="link" href="#con-oauth-authentication-client-str">9.4.4. OAuth 2.0 Kafka client configuration</a></h4>
<div class="paragraph">
<p>A Kafka client is configured with either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The credentials required to obtain a valid access token from an authorization server (client ID and Secret)</p>
</li>
<li>
<p>A valid long-lived access token or refresh token, obtained using tools provided by an authorization server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only information ever sent to the Kafka broker is an access token.
The credentials used to authenticate with the authorization server to obtain the access token are never sent to the broker.</p>
</div>
<div class="paragraph">
<p>When a client obtains an access token, no further communication with the authorization server is needed.</p>
</div>
<div class="paragraph">
<p>The simplest mechanism is authentication with a client ID and Secret.
Using a long-lived access token, or a long-lived refresh token, adds more complexity because there is an additional dependency on authorization server tools.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you are using long-lived access tokens, you may need to configure the client in the authorization server to increase the maximum lifetime of the token.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the Kafka client is not configured with an access token directly, the client exchanges credentials for an access token during Kafka session initiation by contacting the authorization server.
The Kafka client exchanges either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Client ID and Secret</p>
</li>
<li>
<p>Client ID, refresh token, and (optionally) a secret</p>
</li>
<li>
<p>Username and password, with client ID and (optionally) a secret</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-authentication-client-options-str"><a class="link" href="#con-oauth-authentication-client-options-str">9.4.5. OAuth 2.0 client authentication flows</a></h4>
<div class="paragraph _abstract">
<p>OAuth 2.0 authentication flows depend on the underlying Kafka client and Kafka broker configuration.
The flows must also be supported by the authorization server used.</p>
</div>
<div class="paragraph">
<p>The Kafka broker listener configuration determines how clients authenticate using an access token.
The client can pass a client ID and secret to request an access token.</p>
</div>
<div class="paragraph">
<p>If a listener is configured to use PLAIN authentication, the client can authenticate with a client ID and secret or username and access token.
These values are passed as the <code>username</code> and <code>password</code> properties of the PLAIN mechanism.</p>
</div>
<div class="paragraph">
<p>Listener configuration supports the following token validation options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can use fast local token validation based on JWT signature checking and local token introspection, without contacting an authorization server.
The authorization server provides a JWKS endpoint with public certificates that are used to validate signatures on the tokens.</p>
</li>
<li>
<p>You can use a call to a token introspection endpoint provided by an authorization server.
Each time a new Kafka broker connection is established, the broker passes the access token received from the client to the authorization server.
The Kafka broker checks the response to confirm whether or not the token is valid.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
An authorization server might only allow the use of opaque access tokens, which means that local token validation is not possible.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Kafka client credentials can also be configured for the following types of authentication:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Direct local access using a previously generated long-lived access token</p>
</li>
<li>
<p>Contact with the authorization server for a new access token to be issued (using a client ID and a secret, or a refresh token, or a username and a password)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="example_client_authentication_flows_using_the_sasl_oauthbearer_mechanism"><a class="link" href="#example_client_authentication_flows_using_the_sasl_oauthbearer_mechanism">Example client authentication flows using the SASL OAUTHBEARER mechanism</a></h5>
<div class="paragraph">
<p>You can use the following communication flows for Kafka authentication using the SASL OAUTHBEARER mechanism.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#oauth-introspection-endpoint-str">Client using client ID and secret, with broker delegating validation to authorization server</a></p>
</li>
<li>
<p><a href="#oauth-jwt-str">Client using client ID and secret, with broker performing fast local token validation</a></p>
</li>
<li>
<p><a href="#oauth-token-endpoint-str">Client using long-lived access token, with broker delegating validation to authorization server</a></p>
</li>
<li>
<p><a href="#oauth-token-jwt-str">Client using long-lived access token, with broker performing fast local validation</a></p>
</li>
</ul>
</div>
<div id="oauth-introspection-endpoint-str" class="paragraph">
<div class="title">Client using client ID and secret, with broker delegating validation to authorization server</div>
<p><span class="image"><img src="images/oauth-introspection-endpoint.png" alt="Client using client ID and secret with broker delegating validation to authorization server"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client requests an access token from the authorization server using a client ID and secret, and optionally a refresh token. Alternatively, the client may authenticate using a username and a password.</p>
</li>
<li>
<p>The authorization server generates a new access token.</p>
</li>
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token by calling a token introspection endpoint on the authorization server using its own client ID and secret.</p>
</li>
<li>
<p>A Kafka client session is established if the token is valid.</p>
</li>
</ol>
</div>
<div id="oauth-jwt-str" class="paragraph">
<div class="title">Client using client ID and secret, with broker performing fast local token validation</div>
<p><span class="image"><img src="images/oauth-jwt-signature.png" alt="Client using client ID and secret with broker performing fast local token validation"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client authenticates with the authorization server from the token endpoint, using a client ID and secret, and optionally a refresh token. Alternatively, the client may authenticate using a username and a password.</p>
</li>
<li>
<p>The authorization server generates a new access token.</p>
</li>
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token locally using a JWT token signature check, and local token introspection.</p>
</li>
</ol>
</div>
<div id="oauth-token-endpoint-str" class="paragraph">
<div class="title">Client using long-lived access token, with broker delegating validation to authorization server</div>
<p><span class="image"><img src="images/oauth-introspection-endpoint-long-token.png" alt="Client using long-lived access token with broker delegating validation to authorization server"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the long-lived access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token by calling a token introspection endpoint on the authorization server, using its own client ID and secret.</p>
</li>
<li>
<p>A Kafka client session is established if the token is valid.</p>
</li>
</ol>
</div>
<div id="oauth-token-jwt-str" class="paragraph">
<div class="title">Client using long-lived access token, with broker performing fast local validation</div>
<p><span class="image"><img src="images/oauth-jwt-signature-token.png" alt="Client using long-lived access token with broker performing fast local validation"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client authenticates with the Kafka broker using the SASL OAUTHBEARER mechanism to pass the long-lived access token.</p>
</li>
<li>
<p>The Kafka broker validates the access token locally using a JWT token signature check and local token introspection.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Fast local JWT token signature validation is suitable only for short-lived tokens as there is no check with the authorization server if a token has been revoked.
Token expiration is written into the token, but revocation can happen at any time, so cannot be accounted for without contacting the authorization server.
Any issued token would be considered valid until it expires.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="example_client_authentication_flows_using_the_sasl_plain_mechanism"><a class="link" href="#example_client_authentication_flows_using_the_sasl_plain_mechanism">Example client authentication flows using the SASL PLAIN mechanism</a></h5>
<div class="paragraph">
<p>You can use the following communication flows for Kafka authentication using the OAuth PLAIN mechanism.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#oauth-plain-client-id-str">Client using a client ID and secret, with the broker obtaining the access token for the client</a></p>
</li>
<li>
<p><a href="#oauth-plain-access-token-str">Client using a long-lived access token without a client ID and secret</a></p>
</li>
</ul>
</div>
<div id="oauth-plain-client-id-str" class="paragraph">
<div class="title">Client using a client ID and secret, with the broker obtaining the access token for the client</div>
<p><span class="image"><img src="images/oauth-plain-client-id.png" alt="Client using a client ID and secret with the broker obtaining the access token for the client"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client passes a <code>clientId</code> as a username and a <code>secret</code> as a password.</p>
</li>
<li>
<p>The Kafka broker uses a token endpoint to pass the <code>clientId</code> and <code>secret</code> to the authorization server.</p>
</li>
<li>
<p>The authorization server returns a fresh access token or an error if the client credentials are not valid.</p>
</li>
<li>
<p>The Kafka broker validates the token in one of the following ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If a token introspection endpoint is specified, the Kafka broker validates the access token by calling the endpoint on the authorization server.
A session is established if the token validation is successful.</p>
</li>
<li>
<p>If local token introspection is used, a request is not made to the authorization server.
The Kafka broker validates the access token locally using a JWT token signature check.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div id="oauth-plain-access-token-str" class="paragraph">
<div class="title">Client using a long-lived access token without a client ID and secret</div>
<p><span class="image"><img src="images/oauth-plain-access-token.png" alt="Client using a long-lived access token without a client ID and secret"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Kafka client passes a username and password. The password provides the value of an access token that was obtained manually and configured before running the client.</p>
</li>
<li>
<p>The password is passed with or without an <code>$accessToken:</code> string prefix depending on whether or not the Kafka broker listener is configured with a token endpoint for authentication.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the token endpoint is configured, the password should be prefixed by <code>$accessToken:</code> to let the broker know that the password parameter contains an access token rather than a client secret. The Kafka broker interprets the username as the account username.</p>
</li>
<li>
<p>If the token endpoint is not configured on the Kafka broker listener (enforcing a <code>no-client-credentials mode</code>), the password should provide the access token without the prefix. The Kafka broker interprets the username as the account username.
In this mode, the client doesn&#8217;t use a client ID and secret, and the <code>password</code> parameter is always interpreted as a raw access token.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The Kafka broker validates the token in one of the following ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If a token introspection endpoint is specified, the Kafka broker validates the access token by calling the endpoint on the authorization server. A session is established if token validation is successful.</p>
</li>
<li>
<p>If local token introspection is used, there is no request made to the authorization server. Kafka broker validates the access token locally using a JWT token signature check.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-strimzi-config-str"><a class="link" href="#con-oauth-strimzi-config-str">9.4.6. Configuring OAuth 2.0 authentication</a></h4>
<div class="paragraph">
<p>OAuth 2.0 is used for interaction between Kafka clients and Strimzi components.</p>
</div>
<div class="paragraph">
<p>In order to use OAuth 2.0 for Strimzi, you must:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-oauth-server-config-str">Configure an OAuth 2.0 authorization server for the Strimzi cluster and Kafka clients</a></p>
</li>
<li>
<p><a href="#proc-oauth-authentication-broker-config-str">Deploy or update the Kafka cluster with Kafka broker listeners configured to use OAuth 2.0</a></p>
</li>
<li>
<p><a href="#proc-oauth-client-config-str">Update your Java-based Kafka clients to use OAuth 2.0</a></p>
</li>
<li>
<p><a href="#proc-oauth-kafka-config-str">Update Kafka component clients to use OAuth 2.0</a></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="proc-oauth-server-config-str"><a class="link" href="#proc-oauth-server-config-str">Configuring an OAuth 2.0 authorization server</a></h5>
<div class="paragraph">
<p>This procedure describes in general what you need to do to configure an authorization server for integration with Strimzi.</p>
</div>
<div class="paragraph">
<p>These instructions are not product specific.</p>
</div>
<div class="paragraph">
<p>The steps are dependent on the chosen authorization server.
Consult the product documentation for the authorization server for information on how to set up OAuth 2.0 access.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you already have an authorization server deployed, you can skip the deployment step and use your current deployment.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy the authorization server to your cluster.</p>
</li>
<li>
<p>Access the CLI or admin console for the authorization server to configure OAuth 2.0 for Strimzi.</p>
<div class="paragraph">
<p>Now prepare the authorization server to work with Strimzi.</p>
</div>
</li>
<li>
<p>Configure a <code>kafka-broker</code> client.</p>
</li>
<li>
<p>Configure clients for each Kafka client component of your application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">What to do next</div>
<p>After deploying and configuring the authorization server, <a href="#proc-oauth-authentication-broker-config-str">configure the Kafka brokers to use OAuth 2.0</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authentication-broker-config-str"><a class="link" href="#proc-oauth-authentication-broker-config-str">Configuring OAuth 2.0 support for Kafka brokers</a></h5>
<div class="paragraph">
<p>This procedure describes how to configure Kafka brokers so that the broker listeners are enabled to use OAuth 2.0 authentication using an authorization server.</p>
</div>
<div class="paragraph">
<p>We advise use of OAuth 2.0 over an encrypted interface through through a listener with <code>tls: true</code>.
Plain listeners are not recommended.</p>
</div>
<div class="paragraph">
<p>If the authorization server is using certificates signed by the trusted CA and matching the OAuth 2.0 server hostname, TLS connection works using the default settings.
Otherwise, you may need to configure the truststore with proper certificates or disable the certificate hostname validation.</p>
</div>
<div class="paragraph">
<p>When configuring the Kafka broker you have two options for the mechanism used to validate the access token during OAuth 2.0 authentication of the newly connected Kafka client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#example-1">Configuring fast local JWT token validation</a></p>
</li>
<li>
<p><a href="#example-2">Configuring token validation using an introspection endpoint</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Before you start</div>
<p>For more information on the configuration of OAuth 2.0 authentication for Kafka broker listeners, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./configuring.html#type-KafkaListenerAuthenticationOAuth-reference" target="_blank" rel="noopener"><code>KafkaListenerAuthenticationOAuth</code> schema reference</a></p>
</li>
<li>
<p><a href="#con-oauth-authentication-flow-str">OAuth 2.0 authentication mechanisms</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi and Kafka are running</p>
</li>
<li>
<p>An OAuth 2.0 authorization server is deployed</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka broker configuration (<code>Kafka.spec.kafka</code>) of your <code>Kafka</code> resource in an editor.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka my-cluster</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Kafka broker <code>listeners</code> configuration.</p>
<div class="paragraph">
<p>The configuration for each type of listener does not have to be the same, as they are independent.</p>
</div>
<div class="paragraph">
<p>The examples here show the configuration options as configured for external listeners.</p>
</div>
<div class="openblock">
<div class="content">
<div id="example-1" class="listingblock">
<div class="title">Example 1: Configuring fast local JWT token validation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">#...
- name: external
  port: 9094
  type: loadbalancer
  tls: true
  authentication:
    type: oauth <b class="conum">(1)</b>
    validIssuerUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/external</em>&gt; <b class="conum">(2)</b>
    jwksEndpointUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/external/protocol/openid-connect/certs</em>&gt; <b class="conum">(3)</b>
    userNameClaim: preferred_username <b class="conum">(4)</b>
    maxSecondsWithoutReauthentication: 3600 <b class="conum">(5)</b>
    tlsTrustedCertificates: <b class="conum">(6)</b>
    - secretName: oauth-server-cert
      certificate: ca.crt
    disableTlsHostnameVerification: true <b class="conum">(7)</b>
    jwksExpirySeconds: 360 <b class="conum">(8)</b>
    jwksRefreshSeconds: 300 <b class="conum">(9)</b>
    jwksMinRefreshPauseSeconds: 1 <b class="conum">(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Listener type set to <code>oauth</code>.</p>
</li>
<li>
<p>URI of the token issuer used for authentication.</p>
</li>
<li>
<p>URI of the JWKS certificate endpoint used for local JWT validation.</p>
</li>
<li>
<p>The token claim (or key) that contains the actual user name in the token. The user name is the <em>principal</em> used to identify the user. The <code>userNameClaim</code> value will depend on the authentication flow and the authorization server used.</p>
</li>
<li>
<p>(Optional) Activates the Kafka re-authentication mechanism that enforces session expiry to the same length of time as the access token. If the specified value is less than the time left for the access token to expire, then the client will have to re-authenticate before the actual token expiry. By default, the session does not expire when the access token expires, and the client does not attempt re-authentication.</p>
</li>
<li>
<p>(Optional) Trusted certificates for TLS connection to the authorization server.</p>
</li>
<li>
<p>(Optional) Disable TLS hostname verification. Default is <code>false</code>.</p>
</li>
<li>
<p>The duration the JWKS certificates are considered valid before they expire. Default is <code>360</code> seconds. If you specify a longer time, consider the risk of allowing access to revoked certificates.</p>
</li>
<li>
<p>The period between refreshes of JWKS certificates. The interval must be at least 60 seconds shorter than the expiry interval. Default is <code>300</code> seconds.</p>
</li>
<li>
<p>The minimum pause in seconds between consecutive attempts to refresh JWKS public keys. When an unknown signing key is encountered, the JWKS keys refresh is scheduled outside the regular periodic schedule with at least the specified pause since the last refresh attempt. The refreshing of keys follows the rule of exponential backoff, retrying on unsuccessful refreshes with ever increasing pause, until it reaches <code>jwksRefreshSeconds</code>. The default value is 1.</p>
</li>
</ol>
</div>
<div id="example-2" class="listingblock">
<div class="title">Example 2: Configuring token validation using an introspection endpoint</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: external
  port: 9094
  type: loadbalancer
  tls: true
  authentication:
    type: oauth
    validIssuerUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/external</em>&gt;
    introspectionEndpointUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/external/protocol/openid-connect/token/introspect</em>&gt; <b class="conum">(1)</b>
    clientId: kafka-broker <b class="conum">(2)</b>
    clientSecret: <b class="conum">(3)</b>
      secretName: my-cluster-oauth
      key: clientSecret
    userNameClaim: preferred_username <b class="conum">(4)</b>
    maxSecondsWithoutReauthentication: 3600 <b class="conum">(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>URI of the token introspection endpoint.</p>
</li>
<li>
<p>Client ID to identify the client.</p>
</li>
<li>
<p>Client Secret and client ID is used for authentication.</p>
</li>
<li>
<p>The token claim (or key) that contains the actual user name in the token. The user name is the <em>principal</em> used to identify the user. The <code>userNameClaim</code> value will depend on the authorization server used.</p>
</li>
<li>
<p>(Optional) Activates the Kafka re-authentication mechanism that enforces session expiry to the same length of time as the access token. If the specified value is less than the time left for the access token to expire, then the client will have to re-authenticate before the actual token expiry. By default, the session does not expire when the access token expires, and the client does not attempt re-authentication.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Depending on how you apply OAuth 2.0 authentication, and the type of authorization server, there are additional (optional) configuration settings you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  # ...
  authentication:
    type: oauth
    # ...
    checkIssuer: false <b class="conum">(1)</b>
    checkAudience: true <b class="conum">(2)</b>
    fallbackUserNameClaim: client_id <b class="conum">(3)</b>
    fallbackUserNamePrefix: client-account- <b class="conum">(4)</b>
    validTokenType: bearer <b class="conum">(5)</b>
    userInfoEndpointUri: <em>https://OAUTH-SERVER-ADDRESS/auth/realms/external/protocol/openid-connect/userinfo</em> <b class="conum">(6)</b>
    enableOauthBearer: false <b class="conum">(7)</b>
    enablePlain: true <b class="conum">(8)</b>
    tokenEndpointUri: <em>https://OAUTH-SERVER-ADDRESS/auth/realms/external/protocol/openid-connect/token</em> <b class="conum">(9)</b>
    customClaimCheck: "@.custom == 'custom-value'" <b class="conum">(10)</b>
    clientAudience: <em>AUDIENCE</em> <b class="conum">(11)</b>
    clientScope: <em>SCOPE</em> <b class="conum">(12)</b>
    connectTimeoutSeconds: 60 <b class="conum">(13)</b>
    readTimeoutSeconds: 60 <b class="conum">(14)</b>
    groupsClaim: "$.groups" <b class="conum">(15)</b>
    groupsClaimDelimiter: "," <b class="conum">(16)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>If your authorization server does not provide an <code>iss</code> claim, it is not possible to perform an issuer check. In this situation, set <code>checkIssuer</code> to <code>false</code> and do not specify a <code>validIssuerUri</code>. Default is <code>true</code>.</p>
</li>
<li>
<p>If your authorization server provides an <code>aud</code> (audience) claim, and you want to enforce an audience check, set <code>checkAudience</code> to <code>true</code>. Audience checks identify the intended recipients of tokens. As a result, the Kafka broker will reject tokens that do not have its <code>clientId</code> in their <code>aud</code> claim. Default is <code>false</code>.</p>
</li>
<li>
<p>An authorization server may not provide a single attribute to identify both regular users and clients. When a client authenticates in its own name, the server might provide a <em>client ID</em>. When a user authenticates using a username and password, to obtain a refresh token or an access token, the server might provide a <em>username</em> attribute in addition to a client ID. Use this fallback option to specify the username claim (attribute) to use if a primary user ID attribute is not available.</p>
</li>
<li>
<p>In situations where <code>fallbackUserNameClaim</code> is applicable, it may also be necessary to prevent name collisions between the values of the username claim, and those of the fallback username claim. Consider a situation where a client called <code>producer</code> exists, but also a regular user called <code>producer</code> exists. In order to differentiate between the two, you can use this property to add a prefix to the user ID of the client.</p>
</li>
<li>
<p>(Only applicable when using <code>introspectionEndpointUri</code>) Depending on the authorization server you are using, the introspection endpoint may or may not return the <em>token type</em> attribute, or it may contain different values. You can specify a valid token type value that the response from the introspection endpoint has to contain.</p>
</li>
<li>
<p>(Only applicable when using <code>introspectionEndpointUri</code>) The authorization server may be configured or implemented in such a way to not provide any identifiable information in an Introspection Endpoint response. In order to obtain the user ID, you can configure the URI of the <code>userinfo</code> endpoint as a fallback. The <code>userNameClaim</code>, <code>fallbackUserNameClaim</code>, and <code>fallbackUserNamePrefix</code> settings are applied to the response of <code>userinfo</code> endpoint.</p>
</li>
<li>
<p>Set this to <code>false</code> to disable the OAUTHBEARER mechanism on the listener. At least one of PLAIN or OAUTHBEARER has to be enabled. Default is <code>true</code>.</p>
</li>
<li>
<p>Set to <code>true</code> to enable PLAIN authentication on the listener, which is supported for clients on all platforms.</p>
</li>
<li>
<p>Additional configuration for the PLAIN mechanism. If specified, clients can authenticate over PLAIN by passing an access token as the <code>password</code> using an <code>$accessToken:</code> prefix.
For production, always use <code>https://</code> urls.</p>
</li>
<li>
<p>Additional custom rules can be imposed on the JWT access token during validation by setting this to a JsonPath filter query. If the access token does not contain the necessary data, it is rejected. When using the <code>introspectionEndpointUri</code>, the custom check is applied to the introspection endpoint response JSON.</p>
</li>
<li>
<p>An <code>audience</code> parameter passed to the token endpoint. An <em>audience</em> is used  when obtaining an access token for inter-broker authentication. It is also used in the name of a client for OAuth 2.0 over PLAIN client authentication using a <code>clientId</code> and <code>secret</code>. This only affects the ability to obtain the token, and the content of the token, depending on the authorization server. It does not affect token validation rules by the listener.</p>
</li>
<li>
<p>A <code>scope</code> parameter passed to the token endpoint. A <em>scope</em> is used when obtaining an access token for inter-broker authentication. It is also used in the name of a client for OAuth 2.0 over PLAIN client authentication using a <code>clientId</code> and <code>secret</code>. This only affects the ability to obtain the token, and the content of the token, depending on the authorization server. It does not affect token validation rules by the listener.</p>
</li>
<li>
<p>The connect timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
<li>
<p>The read timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
<li>
<p>A JsonPath query used to extract groups information from JWT token or introspection endpoint response. Not set by default. This can be used by a custom authorizer to make authorization decisions based on user groups.</p>
</li>
<li>
<p>A delimiter used to parse groups information when returned as a single delimited string. The default value is ',' (comma).</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
</li>
<li>
<p>Check the update in the logs or by watching the pod state transitions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs -f ${POD_NAME} -c ${CONTAINER_NAME}
kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling update configures the brokers to use OAuth 2.0 authentication.</p>
</div>
</li>
</ol>
</div>
<div class="ulist">
<div class="title">What to do next</div>
<ul>
<li>
<p><a href="#proc-oauth-client-config-str">Configure your Kafka clients to use OAuth 2.0</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-client-config-str"><a class="link" href="#proc-oauth-client-config-str">Configuring Kafka Java clients to use OAuth 2.0</a></h5>
<div class="paragraph _abstract">
<p>Configure Kafka producer and consumer APIs to use OAuth 2.0 for interaction with Kafka brokers.
Add a callback plugin to your client <code>pom.xml</code> file, then configure your client for OAuth 2.0.</p>
</div>
<div class="paragraph">
<p>Specify the following in your client configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A SASL (Simple Authentication and Security Layer) security protocol:</p>
<div class="ulist">
<ul>
<li>
<p><code>SASL_SSL</code> for authentication over TLS encrypted connections</p>
</li>
<li>
<p><code>SASL_PLAINTEXT</code> for authentication over unencrypted connections</p>
<div class="paragraph">
<p>Use <code>SASL_SSL</code> for production and <code>SASL_PLAINTEXT</code> for local development only.
When using <code>SASL_SSL</code>, additional <code>ssl.truststore</code> configuration is needed.
The truststore configuration is required for secure connection (<code>https://</code>) to the OAuth 2.0 authorization server.
To verify the OAuth 2.0 authorization server, add the CA certificate for the authorization server to the truststore in your client configuration.
You can configure a truststore in PEM or PKCS #12 format.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>A Kafka SASL mechanism:</p>
<div class="ulist">
<ul>
<li>
<p><code>OAUTHBEARER</code> for credentials exchange using a bearer token</p>
</li>
<li>
<p><code>PLAIN</code> to pass client credentials (clientId + secret) or an access token</p>
</li>
</ul>
</div>
</li>
<li>
<p>A JAAS (Java Authentication and Authorization Service) module that implements the SASL mechanism:</p>
<div class="ulist">
<ul>
<li>
<p><code>org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule</code> implements the OAUTHBEARER mechanism</p>
</li>
<li>
<p><code>org.apache.kafka.common.security.plain.PlainLoginModule</code> implements the PLAIN mechanism</p>
</li>
</ul>
</div>
</li>
<li>
<p>SASL authentication properties, which support the following authentication methods:</p>
<div class="ulist">
<ul>
<li>
<p>OAuth 2.0 client credentials</p>
</li>
<li>
<p>OAuth 2.0 password grant (deprecated)</p>
</li>
<li>
<p>Access token</p>
</li>
<li>
<p>Refresh token</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Add the SASL authentication properties as JAAS configuration (<code>sasl.jaas.config</code>).
How you configure the authentication properties depends on the authentication method you are using to access the OAuth 2.0 authorization server.
In this procedure, the properties are specified in a properties file, then loaded into the client configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can also specify authentication properties as environment variables, or as Java system properties. For Java system properties, you can set them using <code>setProperty</code> and pass them on the command line using the <code>-D</code> option.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi and Kafka are running</p>
</li>
<li>
<p>An OAuth 2.0 authorization server is deployed and configured for OAuth access to Kafka brokers</p>
</li>
<li>
<p>Kafka brokers are configured for OAuth 2.0</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the client library with OAuth 2.0 support to the <code>pom.xml</code> file for the Kafka client:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.strimzi&lt;/groupId&gt;
 &lt;artifactId&gt;kafka-oauth-client&lt;/artifactId&gt;
 &lt;version&gt;0.11.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the client properties by specifying the following configuration in a properties file:</p>
<div class="ulist">
<ul>
<li>
<p>The security protocol</p>
</li>
<li>
<p>The SASL mechanism</p>
</li>
<li>
<p>The JAAS module and authentication properties according to the method being used</p>
<div class="paragraph">
<p>For example, we can add the following to a <code>client.properties</code> file:</p>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Client credentials mechanism properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL # <b class="conum">(1)</b>
sasl.mechanism=OAUTHBEARER # <b class="conum">(2)</b>
ssl.truststore.location=/tmp/truststore.p12 <b class="conum">(3)</b>
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="<em>&lt;token_endpoint_url&gt;</em>" \ # <b class="conum">(4)</b>
  oauth.client.id="<em>&lt;client_id&gt;</em>" \ # <b class="conum">(5)</b>
  oauth.client.secret="<em>&lt;client_secret&gt;</em>" \ # <b class="conum">(6)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \ <b class="conum">(7)</b>
  oauth.ssl.truststore.password="$STOREPASS" \ <b class="conum">(8)</b>
  oauth.ssl.truststore.type="PKCS12" \ <b class="conum">(9)</b>
  oauth.scope="<em>&lt;scope&gt;</em>" \ # <b class="conum">(10)</b>
  oauth.audience="<em>&lt;audience&gt;</em>" ; # <b class="conum">(11)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>SASL_SSL</code> security protocol for TLS-encrypted connections. Use <code>SASL_PLAINTEXT</code> over unencrypted connections for local development only.</p>
</li>
<li>
<p>The SASL mechanism specified as <code>OAUTHBEARER</code> or <code>PLAIN</code>.</p>
</li>
<li>
<p>The truststore configuration for secure access to the Kafka cluster.</p>
</li>
<li>
<p>URI of the authorization server token endpoint.</p>
</li>
<li>
<p>Client ID, which is the name used when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>Client secret created when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>The location contains the public key certificate (<code>truststore.p12</code>) for the authorization server.</p>
</li>
<li>
<p>The password for accessing the truststore.</p>
</li>
<li>
<p>The truststore type.</p>
</li>
<li>
<p>(Optional) The <code>scope</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the scope.</p>
</li>
<li>
<p>(Optional) The <code>audience</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the audience.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Password grants mechanism properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL
sasl.mechanism=OAUTHBEARER
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="<em>&lt;token_endpoint_url&gt;</em>" \
  oauth.client.id="<em>&lt;client_id&gt;</em>" \ # <b class="conum">(1)</b>
  oauth.client.secret="<em>&lt;client_secret&gt;</em>" \ # <b class="conum">(2)</b>
  oauth.password.grant.username="<em>&lt;username&gt;</em>" \ # <b class="conum">(3)</b>
  oauth.password.grant.password="<em>&lt;password&gt;</em>" \ # <b class="conum">(4)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.scope="<em>&lt;scope&gt;</em>" \
  oauth.audience="<em>&lt;audience&gt;</em>" ;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Client ID, which is the name used when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>(Optional) Client secret created when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>Username for password grant authentication. OAuth password grant configuration (username and password) uses the OAuth 2.0 password grant method. To use password grants, create a user account for a client on your authorization server with limited permissions. The account should act like a service account. Use in environments where user accounts are required for authentication, but consider using a refresh token first.</p>
</li>
<li>
<p>Password for password grant authentication.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
SASL PLAIN does not support passing a username and password (password grants) using the OAuth 2.0 password grant method.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Access token properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL
sasl.mechanism=OAUTHBEARER
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="<em>&lt;token_endpoint_url&gt;</em>" \
  oauth.access.token="<em>&lt;access_token&gt;</em>" ; # <b class="conum">(1)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Long-lived access token for Kafka clients.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Refresh token properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">security.protocol=SASL_SSL
sasl.mechanism=OAUTHBEARER
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.token.endpoint.uri="<em>&lt;token_endpoint_url&gt;</em>" \
  oauth.client.id="<em>&lt;client_id&gt;</em>" \ # <b class="conum">(1)</b>
  oauth.client.secret="<em>&lt;client_secret&gt;</em>" \ # <b class="conum">(2)</b>
  oauth.refresh.token="<em>&lt;refresh_token&gt;</em>" ; # <b class="conum">(3)</b>
  oauth.ssl.truststore.location="/tmp/oauth-truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Client ID, which is the name used when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>(Optional) Client secret created when creating the <em>client</em> in the authorization server.</p>
</li>
<li>
<p>Long-lived refresh token for Kafka clients.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Input the client properties for OAUTH 2.0 authentication into the Java client code.</p>
<div class="listingblock">
<div class="title">Example showing input of client properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Properties props = new Properties();
try (FileReader reader = new FileReader("client.properties", StandardCharsets.UTF_8)) {
  props.load(reader);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the Kafka client can access the Kafka brokers.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-kafka-config-str"><a class="link" href="#proc-oauth-kafka-config-str">Configuring OAuth 2.0 for Kafka components</a></h5>
<div class="paragraph">
<p>This procedure describes how to configure Kafka components to use OAuth 2.0 authentication using an authorization server.</p>
</div>
<div class="paragraph">
<p>You can configure authentication for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka MirrorMaker</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this scenario, the Kafka component and the authorization server are running in the same cluster.</p>
</div>
<div class="paragraph">
<div class="title">Before you start</div>
<p>For more information on the configuration of OAuth 2.0 authentication for Kafka components, see the <a href="./configuring.html#type-KafkaClientAuthenticationOAuth-reference" target="_blank" rel="noopener"><code>KafkaClientAuthenticationOAuth</code> schema reference</a>.
The schema reference includes examples of configuration options.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi and Kafka are running</p>
</li>
<li>
<p>An OAuth 2.0 authorization server is deployed and configured for OAuth access to Kafka brokers</p>
</li>
<li>
<p>Kafka brokers are configured for OAuth 2.0</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a client secret and mount it to the component as an environment variable.</p>
<div class="paragraph">
<p>For example, here we are creating a client <code>Secret</code> for the Kafka Bridge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Secret
metadata:
 name: my-bridge-oauth
type: Opaque
data:
 clientSecret: MGQ1OTRmMzYtZTllZS00MDY2LWI5OGEtMTM5MzM2NjdlZjQw <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>clientSecret</code> key must be in base64 format.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create or edit the resource for the Kafka component so that OAuth 2.0 authentication is configured for the authentication property.</p>
<div class="paragraph">
<p>For OAuth 2.0 authentication, you can use the following options:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Client ID and secret</p>
</li>
<li>
<p>Client ID and refresh token</p>
</li>
<li>
<p>Access token</p>
</li>
<li>
<p>Username and password</p>
</li>
<li>
<p>TLS</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>For example, here OAuth 2.0 is assigned to the Kafka Bridge client using a client ID and secret, and TLS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  # ...
  authentication:
    type: oauth <b class="conum">(1)</b>
    tokenEndpointUri: https://&lt;auth-server-address&gt;/auth/realms/master/protocol/openid-connect/token <b class="conum">(2)</b>
    clientId: kafka-bridge
    clientSecret:
      secretName: my-bridge-oauth
      key: clientSecret
    tlsTrustedCertificates: <b class="conum">(3)</b>
    - secretName: oauth-server-cert
      certificate: tls.crt</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Authentication type set to <code>oauth</code>.</p>
</li>
<li>
<p>URI of the token endpoint for authentication.</p>
</li>
<li>
<p>Trusted certificates for TLS connection to the authorization server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Depending on how you apply OAuth 2.0 authentication, and the type of authorization server, there are additional configuration options you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ...
spec:
  # ...
  authentication:
    # ...
    disableTlsHostnameVerification: true <b class="conum">(1)</b>
    checkAccessTokenType: false <b class="conum">(2)</b>
    accessTokenIsJwt: false <b class="conum">(3)</b>
    scope: any <b class="conum">(4)</b>
    audience: kafka <b class="conum">(5)</b>
    connectTimeoutSeconds: 60 <b class="conum">(6)</b>
    readTimeoutSeconds: 60 <b class="conum">(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>(Optional) Disable TLS hostname verification. Default is <code>false</code>.</p>
</li>
<li>
<p>If the authorization server does not return a <code>typ</code> (type) claim inside the JWT token, you can apply <code>checkAccessTokenType: false</code> to skip the token type check. Default is <code>true</code>.</p>
</li>
<li>
<p>If you are using opaque tokens, you can apply <code>accessTokenIsJwt: false</code> so that access tokens are not treated as JWT tokens.</p>
</li>
<li>
<p>(Optional) The <code>scope</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the scope.
In this case it is <code>any</code>.</p>
</li>
<li>
<p>(Optional) The <code>audience</code> for requesting the token from the token endpoint.
An authorization server may require a client to specify the audience.
In this case it is <code>kafka</code>.</p>
</li>
<li>
<p>(Optional) The connect timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
<li>
<p>(Optional) The read timeout in seconds when connecting to the authorization server. The default value is 60.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Apply the changes to the deployment of your Kafka resource.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl apply -f your-file</code></pre>
</div>
</div>
</li>
<li>
<p>Check the update in the logs or by watching the pod state transitions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl logs -f ${POD_NAME} -c ${CONTAINER_NAME}
kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling updates configure the component for interaction with Kafka brokers using OAuth 2.0 authentication.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="con-oauth-server-examples-str"><a class="link" href="#con-oauth-server-examples-str">9.4.7. Authorization server examples</a></h4>
<div class="paragraph">
<p>When choosing an authorization server, consider the features that best support configuration of your chosen authentication flow.</p>
</div>
<div class="paragraph">
<p>For the purposes of testing OAuth 2.0 with Strimzi, Keycloak and ORY Hydra were implemented as the OAuth 2.0 authorization server.</p>
</div>
<div class="paragraph">
<p>For more information, see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://strimzi.io/2019/10/25/kafka-authentication-using-oauth-2.0.html" target="_blank" rel="noopener">Kafka authentication using OAuth 2.0</a></p>
</li>
<li>
<p><a href="https://github.com/strimzi/strimzi-kafka-oauth/tree/0.11.0/examples" target="_blank" rel="noopener">Using Keycloak as the OAuth 2.0 authorization server</a></p>
</li>
<li>
<p><a href="https://github.com/strimzi/strimzi-kafka-oauth/tree/0.11.0/examples/docker#running-with-hydra-using-ssl-and-opaque-tokens" target="_blank" rel="noopener">Using Hydra as the OAuth 2.0 authorization server</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-oauth-authorization_str"><a class="link" href="#assembly-oauth-authorization_str">9.5. Using OAuth 2.0 token-based authorization</a></h3>
<div id="con-oauth-authorization-intro_str" class="paragraph">
<p>If you are using OAuth 2.0 with Keycloak for token-based authentication,
you can also use Keycloak to configure authorization rules to constrain client access to Kafka brokers.
Authentication establishes the identity of a user.
Authorization decides the level of access for that user.</p>
</div>
<div class="paragraph">
<p>Strimzi supports the use of OAuth 2.0 token-based authorization through Keycloak <a href="https://www.keycloak.org/docs/latest/authorization_services/index.html" target="_blank" rel="noopener">Keycloak Authorization Services</a>,
which allows you to manage security policies and permissions centrally.</p>
</div>
<div class="paragraph">
<p>Security policies and permissions defined in Keycloak are used to grant access to resources on Kafka brokers.
Users and clients are matched against policies that permit access to perform specific actions on Kafka brokers.</p>
</div>
<div class="paragraph">
<p>Kafka allows all users full access to brokers by default,
and also provides the <code>AclAuthorizer</code> plugin to configure authorization based on Access Control Lists (ACLs).</p>
</div>
<div class="paragraph">
<p>ZooKeeper stores ACL rules that grant or deny access to resources based on <em>username</em>.
However, OAuth 2.0 token-based authorization with  Keycloak offers far greater flexibility on how you wish to implement access control to Kafka brokers.
In addition, you can configure your Kafka brokers to use OAuth 2.0 authorization and ACLs.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="#assembly-oauth-authentication_str">Using OAuth 2.0 token-based authentication</a></p>
</li>
<li>
<p><a href="#con-securing-kafka-authorization-str">Kafka Authorization</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/documentation.html" target="_blank" rel="noopener">Keycloak documentation</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="con-oauth-authorization-mechanism_str"><a class="link" href="#con-oauth-authorization-mechanism_str">9.5.1. OAuth 2.0 authorization mechanism</a></h4>
<div class="paragraph">
<p>OAuth 2.0 authorization in Strimzi uses Keycloak server Authorization Services REST endpoints to extend token-based authentication with Keycloak by applying defined security policies on a particular user,
and providing a list of permissions granted on different resources for that user.
Policies use roles and groups to match permissions to users.
OAuth 2.0 authorization enforces permissions locally based on the received list of grants for the user from Keycloak Authorization Services.</p>
</div>
<div class="sect4">
<h5 id="kafka_broker_custom_authorizer"><a class="link" href="#kafka_broker_custom_authorizer">Kafka broker custom authorizer</a></h5>
<div class="paragraph">
<p>A Keycloak <em>authorizer</em> (<code>KeycloakRBACAuthorizer</code>) is provided with Strimzi.
To be able to use the Keycloak REST endpoints for Authorization Services provided by Keycloak,
you configure a custom authorizer on the Kafka broker.</p>
</div>
<div class="paragraph">
<p>The authorizer fetches a list of granted permissions from the authorization server as needed,
and enforces authorization locally on the Kafka Broker, making rapid authorization decisions for each client request.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-oauth-authorization-broker-config-str"><a class="link" href="#proc-oauth-authorization-broker-config-str">9.5.2. Configuring OAuth 2.0 authorization support</a></h4>
<div class="paragraph">
<p>This procedure describes how to configure Kafka brokers to use OAuth 2.0 authorization using Keycloak Authorization Services.</p>
</div>
<div class="paragraph">
<div class="title">Before you begin</div>
<p>Consider the access you require or want to limit for certain users.
You can use a combination of Keycloak <em>groups</em>, <em>roles</em>, <em>clients</em>, and <em>users</em> to configure access in Keycloak.</p>
</div>
<div class="paragraph">
<p>Typically, groups are used to match users based on organizational departments or geographical locations.
And roles are used to match users based on their function.</p>
</div>
<div class="paragraph">
<p>With Keycloak, you can store users and groups in LDAP, whereas clients and roles cannot be stored this way.
Storage and access to user data may be a factor in how you choose to configure authorization policies.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<a href="./configuring.html#property-simple-authorization-superusers-reference" target="_blank" rel="noopener">Super users</a> always have unconstrained access to a Kafka broker regardless of the authorization implemented on the Kafka broker.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Strimzi must be configured to use OAuth 2.0 with Keycloak for <a href="#assembly-oauth-authentication_str">token-based authentication</a>.
You use the same Keycloak server endpoint when you set up authorization.</p>
</li>
<li>
<p>OAuth 2.0 authentication must be configured with the <code>maxSecondsWithoutReauthentication</code> option to enable re-authentication.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Access the Keycloak Admin Console or use the Keycloak Admin CLI to enable Authorization Services for the Kafka broker client you created when setting up OAuth 2.0 authentication.</p>
</li>
<li>
<p>Use Authorization Services to define resources, authorization scopes, policies, and permissions for the client.</p>
</li>
<li>
<p>Bind the permissions to users and clients by assigning them roles and groups.</p>
</li>
<li>
<p>Configure the Kafka brokers to use Keycloak authorization by updating the Kafka broker configuration (<code>Kafka.spec.kafka</code>) of your <code>Kafka</code> resource in an editor.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka my-cluster</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the Kafka broker <code>kafka</code> configuration to use <code>keycloak</code> authorization, and to be able to access the authorization server and Authorization Services.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    authorization:
      type: <strong>keycloak</strong> <b class="conum">(1)</b>
      tokenEndpointUri: &lt;<em>https://&lt;auth-server-address&gt;/auth/realms/external/protocol/openid-connect/token</em>&gt; <b class="conum">(2)</b>
      clientId: kafka <b class="conum">(3)</b>
      delegateToKafkaAcls: false <b class="conum">(4)</b>
      disableTlsHostnameVerification: false <b class="conum">(5)</b>
      superUsers: <b class="conum">(6)</b>
      - CN=fred
      - sam
      - CN=edward
      tlsTrustedCertificates: <b class="conum">(7)</b>
      - secretName: oauth-server-cert
        certificate: ca.crt
      grantsRefreshPeriodSeconds: 60 <b class="conum">(8)</b>
      grantsRefreshPoolSize: 5 <b class="conum">(9)</b>
      connectTimeoutSeconds: 60 <b class="conum">(10)</b>
      readTimeoutSeconds: 60 <b class="conum">(11)</b>
    #...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Type <code>keycloak</code> enables Keycloak authorization.</p>
</li>
<li>
<p>URI of the Keycloak token endpoint. For production, always use <code>https://</code> urls.
When you configure token-based <code>oauth</code> authentication, you specify a <code>jwksEndpointUri</code> as the URI for local JWT validation.
The hostname for the <code>tokenEndpointUri</code> URI must be the same.</p>
</li>
<li>
<p>The client ID of the OAuth 2.0 client definition in Keycloak that has Authorization Services enabled. Typically, <code>kafka</code> is used as the ID.</p>
</li>
<li>
<p>(Optional) Delegate authorization to Kafka <code>AclAuthorizer</code> if access is denied by Keycloak Authorization Services policies.
Default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Disable TLS hostname verification. Default is <code>false</code>.</p>
</li>
<li>
<p>(Optional) Designated super users.</p>
</li>
<li>
<p>(Optional) Trusted certificates for TLS connection to the authorization server.</p>
</li>
<li>
<p>(Optional) The time between two consecutive grants refresh runs. That is the maximum time for active sessions to detect any permissions changes for the user on Keycloak. The default value is 60.</p>
</li>
<li>
<p>(Optional) The number of threads to use to refresh (in parallel) the grants for the active sessions. The default value is 5.</p>
</li>
<li>
<p>(Optional) The connect timeout in seconds when connecting to the Keycloak token endpoint. The default value is 60.</p>
</li>
<li>
<p>(Optional) The read timeout in seconds when connecting to the Keycloak token endpoint. The default value is 60.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
</li>
<li>
<p>Check the update in the logs or by watching the pod state transitions:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs -f ${POD_NAME} -c kafka
kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling update configures the brokers to use OAuth 2.0 authorization.</p>
</div>
</li>
<li>
<p>Verify the configured permissions by accessing Kafka brokers as clients or  users with specific roles, making sure they have the necessary access, or do not have the access they are not supposed to have.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="assembly-managing-policies-permissions-keycloak_str"><a class="link" href="#assembly-managing-policies-permissions-keycloak_str">9.5.3. Managing policies and permissions in Keycloak Authorization Services</a></h4>
<div class="paragraph _abstract">
<p>This section describes the authorization models used by Keycloak Authorization Services and Kafka, and defines the important concepts in each model.</p>
</div>
<div class="paragraph">
<p>To grant permissions to access Kafka, you can map Keycloak Authorization Services objects to Kafka resources by creating an <em>OAuth client specification</em> in Keycloak.
Kafka permissions are granted to user accounts or service accounts using Keycloak Authorization Services rules.</p>
</div>
<div class="paragraph">
<p><a href="#ref-example-permissions-for-kafka-operations_authz-model">Examples</a> are shown of the different user permissions required for common Kafka operations, such as creating and listing topics.</p>
</div>
<div class="sect4">
<h5 id="con-kafka-keycloak-authz-models_authz-model"><a class="link" href="#con-kafka-keycloak-authz-models_authz-model">Kafka and Keycloak authorization models overview</a></h5>
<div class="paragraph _abstract">
<p>Kafka and Keycloak Authorization Services use different authorization models.</p>
</div>
<h6 id="kafka_authorization_model" class="discrete">Kafka authorization model</h6>
<div class="paragraph">
<p>Kafka&#8217;s authorization model uses <em>resource types</em>.
When a Kafka client performs an action on a broker, the broker uses the configured <code>KeycloakRBACAuthorizer</code> to check the client&#8217;s permissions, based on the action and resource type.</p>
</div>
<div class="paragraph">
<p>Kafka uses five resource types to control access: <code>Topic</code>, <code>Group</code>, <code>Cluster</code>, <code>TransactionalId</code>, and <code>DelegationToken</code>.
Each resource type has a set of available permissions.</p>
</div>
<div class="paragraph">
<p><strong>Topic</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Create</code></p>
</li>
<li>
<p><code>Write</code></p>
</li>
<li>
<p><code>Read</code></p>
</li>
<li>
<p><code>Delete</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>DescribeConfigs</code></p>
</li>
<li>
<p><code>Alter</code></p>
</li>
<li>
<p><code>AlterConfigs</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Group</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Read</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Delete</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Cluster</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Create</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Alter</code></p>
</li>
<li>
<p><code>DescribeConfigs</code></p>
</li>
<li>
<p><code>AlterConfigs</code></p>
</li>
<li>
<p><code>IdempotentWrite</code></p>
</li>
<li>
<p><code>ClusterAction</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>TransactionalId</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Write</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>DelegationToken</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Describe</code></p>
</li>
</ul>
</div>
<h6 id="keycloak_authorization_services_model" class="discrete">Keycloak Authorization Services model</h6>
<div class="paragraph">
<p>The Keycloak Authorization Services model has four concepts for defining and granting permissions: <em>resources</em>, <em>authorization scopes</em>, <em>policies</em>, and <em>permissions</em>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Resources</dt>
<dd>
<p>A resource is a set of resource definitions that are used to match resources with permitted actions.
A resource might be an individual topic, for example, or all topics with names starting with the same prefix.
A resource definition is associated with a set of available authorization scopes, which represent a set of all actions available on the resource.
Often, only a subset of these actions is actually permitted.</p>
</dd>
<dt class="hdlist1">Authorization scopes</dt>
<dd>
<p>An authorization scope is a set of all the available actions on a specific resource definition.
When you define a new resource, you add scopes from the set of all scopes.</p>
</dd>
<dt class="hdlist1">Policies</dt>
<dd>
<p>A policy is an authorization rule that uses criteria to match against a list of accounts.
Policies can match:</p>
<div class="ulist">
<ul>
<li>
<p><em>Service accounts</em> based on client ID or roles</p>
</li>
<li>
<p><em>User accounts</em> based on username, groups, or roles.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Permissions</dt>
<dd>
<p>A permission grants a subset of authorization scopes on a specific resource definition to a set of users.</p>
</dd>
</dl>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kafka.apache.org/documentation/#security_authz_primitives">Kafka authorization model</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="con-mapping-keycloak-authz-services-to-kafka-model_authz-model"><a class="link" href="#con-mapping-keycloak-authz-services-to-kafka-model_authz-model">Map Keycloak Authorization Services to the Kafka authorization model</a></h5>
<div class="paragraph _abstract">
<p>The Kafka authorization model is used as a basis for defining the Keycloak roles and resources that will control access to Kafka.</p>
</div>
<div class="paragraph">
<p>To grant Kafka permissions to user accounts or service accounts, you first create an <em>OAuth client specification</em> in Keycloak for the Kafka broker.
You then specify Keycloak Authorization Services rules on the client.
Typically, the client id of the OAuth client that represents the broker is <code>kafka</code>.
The <a href="#proc-oauth-authorization-keycloak-example_str">example configuration files</a> provided with Strimzi use <code>kafka</code> as the OAuth client id.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you have multiple Kafka clusters, you can use a single OAuth client (<code>kafka</code>) for all of them.
This gives you a single, unified space in which to define and manage authorization rules.
However, you can also use different OAuth client ids (for example, <code>my-cluster-kafka</code> or <code>cluster-dev-kafka</code>) and define authorization rules for each cluster within each client configuration.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>kafka</code> client definition must have the <strong>Authorization Enabled</strong> option enabled in the Keycloak Admin Console.</p>
</div>
<div class="paragraph">
<p>All permissions exist within the scope of the <code>kafka</code> client. If you have different Kafka clusters configured with different OAuth client IDs, they each need a separate set of permissions even though they&#8217;re part of the same Keycloak realm.</p>
</div>
<div class="paragraph">
<p>When the Kafka client uses OAUTHBEARER authentication, the Keycloak authorizer (<code>KeycloakRBACAuthorizer</code>) uses the access token of the current session to retrieve a list of grants from the Keycloak server.
To retrieve the grants, the authorizer evaluates the Keycloak Authorization Services policies and permissions.</p>
</div>
<div class="paragraph">
<div class="title">Authorization scopes for Kafka permissions</div>
<p>An initial Keycloak configuration usually involves uploading authorization scopes to create a list of all possible actions that can be performed on each Kafka resource type.
This step is performed once only, before defining any permissions.
You can add authorization scopes manually instead of uploading them.</p>
</div>
<div class="paragraph">
<p>Authorization scopes must contain all the possible Kafka permissions regardless of the resource type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Create</code></p>
</li>
<li>
<p><code>Write</code></p>
</li>
<li>
<p><code>Read</code></p>
</li>
<li>
<p><code>Delete</code></p>
</li>
<li>
<p><code>Describe</code></p>
</li>
<li>
<p><code>Alter</code></p>
</li>
<li>
<p><code>DescribeConfig</code></p>
</li>
<li>
<p><code>AlterConfig</code></p>
</li>
<li>
<p><code>ClusterAction</code></p>
</li>
<li>
<p><code>IdempotentWrite</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you&#8217;re certain you won&#8217;t need a permission (for example, <code>IdempotentWrite</code>), you can omit it from the list of authorization scopes.
However, that permission won&#8217;t be available to target on Kafka resources.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Resource patterns for permissions checks</div>
<p>Resource patterns are used for pattern matching against the targeted resources when performing permission checks.
The general pattern format is <code><em>RESOURCE-TYPE:PATTERN-NAME</em></code>.</p>
</div>
<div class="paragraph">
<p>The resource types mirror the Kafka authorization model.
The pattern allows for two matching options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Exact matching (when the pattern does not end with <code>*</code>)</p>
</li>
<li>
<p>Prefix matching (when the pattern ends with <code>*</code>)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example patterns for resources</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Topic:my-topic
Topic:orders-*
Group:orders-*
Cluster:*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, the general pattern format can be prefixed by <code>kafka-cluster:<em>CLUSTER-NAME</em></code> followed by a comma, where <em>CLUSTER-NAME</em> refers to the <code>metadata.name</code> in the Kafka custom resource.</p>
</div>
<div class="listingblock">
<div class="title">Example patterns for resources with cluster prefix</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">kafka-cluster:my-cluster,Topic:*
kafka-cluster:*,Group:b_*</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>kafka-cluster</code> prefix is missing, it is assumed to be <code>kafka-cluster:*</code>.</p>
</div>
<div class="paragraph">
<p>When defining a resource, you can associate it with a list of possible authorization scopes which are relevant to the resource.
Set whatever actions make sense for the targeted resource type.</p>
</div>
<div class="paragraph">
<p>Though you may add any authorization scope to any resource, only the scopes supported by the resource type are considered for access control.</p>
</div>
<div class="paragraph">
<div class="title">Policies for applying access permission</div>
<p>Policies are used to target permissions to one or more user accounts or service accounts.
Targeting can refer to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specific user or service accounts</p>
</li>
<li>
<p>Realm roles or client roles</p>
</li>
<li>
<p>User groups</p>
</li>
<li>
<p>JavaScript rules to match a client IP address</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A policy is given a unique name and can be reused to target multiple permissions to multiple resources.</p>
</div>
<div class="paragraph">
<div class="title">Permissions to grant access</div>
<p>Use fine-grained permissions to pull together the policies, resources, and authorization scopes that grant access to users.</p>
</div>
<div class="paragraph">
<p>The name of each permission should clearly define which permissions it grants to which users.
For example, <code>Dev Team B can read from topics starting with x</code>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p>For more information about how to configure permissions through Keycloak Authorization Services, see <a href="#proc-oauth-authorization-keycloak-example_str">Trying Keycloak Authorization Services</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="ref-example-permissions-for-kafka-operations_authz-model"><a class="link" href="#ref-example-permissions-for-kafka-operations_authz-model">Example permissions required for Kafka operations</a></h5>
<div class="paragraph _abstract">
<p>The following examples demonstrate the user permissions required for performing common operations on Kafka.</p>
</div>
<div class="paragraph">
<div class="title">Create a topic</div>
<p>To create a topic, the <code>Create</code> permission is required for the specific topic, or for <code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --create --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">List topics</div>
<p>If a user has the <code>Describe</code> permission on a specified topic, the topic is listed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --list \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Display topic details</div>
<p>To display a topic&#8217;s details, <code>Describe</code> and <code>DescribeConfigs</code> permissions are required on the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --describe --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Produce messages to a topic</div>
<p>To produce messages to a topic, <code>Describe</code> and <code>Write</code> permissions are required on the topic.</p>
</div>
<div class="paragraph">
<p>If the topic hasn&#8217;t been created yet, and topic auto-creation is enabled, the permissions to create a topic are required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh  --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --producer.config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Consume messages from a topic</div>
<p>To consume messages from a topic, <code>Describe</code> and <code>Read</code> permissions are required on the topic.
Consuming from the topic normally relies on storing the consumer offsets in a consumer group, which requires additional <code>Describe</code> and <code>Read</code> permissions on the consumer group.</p>
</div>
<div class="paragraph">
<p>Two <code>resources</code> are needed for matching. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Topic:my-topic
Group:my-group-*</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --topic my-topic --group my-group-1 --from-beginning \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --consumer.config /tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Produce messages to a topic using an idempotent producer</div>
<p>As well as the permissions for producing to a topic, an additional <code>IdempotentWrite</code> permission is required on the
<code>Cluster:kafka-cluster</code> resource.</p>
</div>
<div class="paragraph">
<p>Two <code>resources</code> are needed for matching. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Topic:my-topic
Cluster:kafka-cluster</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh  --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --producer.config=/tmp/config.properties --producer-property enable.idempotence=true --request-required-acks -1</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">List consumer groups</div>
<p>When listing consumer groups, only the groups on which the user has the <code>Describe</code> permissions are returned.
Alternatively, if the user has the <code>Describe</code> permission on the <code>Cluster:kafka-cluster</code>, all the consumer groups are returned.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-consumer-groups.sh --list \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Display consumer group details</div>
<p>To display a consumer group&#8217;s details, the <code>Describe</code> permission is required on the group and the topics associated with the group.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-consumer-groups.sh --describe --group my-group-1 \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Change topic configuration</div>
<p>To change a topic&#8217;s configuration, the <code>Describe</code> and <code>Alter</code> permissions are required on the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --alter --topic my-topic --partitions 2 \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Display Kafka broker configuration</div>
<p>In order to use <code>kafka-configs.sh</code> to get a broker&#8217;s configuration, the <code>DescribeConfigs</code> permission is required on the
<code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs.sh --entity-type brokers --entity-name 0 --describe --all \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Change Kafka broker configuration</div>
<p>To change a Kafka broker&#8217;s configuration, <code>DescribeConfigs</code> and <code>AlterConfigs</code> permissions are required on <code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs --entity-type brokers --entity-name 0 --alter --add-config log.cleaner.threads=2 \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Delete a topic</div>
<p>To delete a topic, the <code>Describe</code> and <code>Delete</code> permissions are required on the topic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --delete --topic my-topic \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config=/tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Select a lead partition</div>
<p>To run leader selection for topic partitions, the <code>Alter</code> permission is required on the <code>Cluster:kafka-cluster</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-leader-election.sh --topic my-topic --partition 0 --election-type PREFERRED  /
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --admin.config /tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">Reassign partitions</div>
<p>To generate a partition reassignment file, <code>Describe</code> permissions are required on the topics involved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --topics-to-move-json-file /tmp/topics-to-move.json --broker-list "0,1" --generate \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config /tmp/config.properties &gt; /tmp/partition-reassignment.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute the partition reassignment, <code>Describe</code> and <code>Alter</code> permissions are required on <code>Cluster:kafka-cluster</code>. Also,
<code>Describe</code> permissions are required on the topics involved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --reassignment-json-file /tmp/partition-reassignment.json --execute \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config /tmp/config.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>To verify partition reassignment, <code>Describe</code>, and <code>AlterConfigs</code> permissions are required on <code>Cluster:kafka-cluster</code>, and on each
of the topics involved.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-reassign-partitions.sh --reassignment-json-file /tmp/partition-reassignment.json --verify \
  --bootstrap-server my-cluster-kafka-bootstrap:9092 --command-config /tmp/config.properties</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-oauth-authorization-keycloak-example_str"><a class="link" href="#proc-oauth-authorization-keycloak-example_str">9.5.4. Trying Keycloak Authorization Services</a></h4>
<div class="paragraph _abstract">
<p>This example explains how to use Keycloak Authorization Services with <code>keycloak</code> authorization.
Use Keycloak Authorization Services to enforce access restrictions on Kafka clients.
Keycloak Authorization Services use authorization scopes, policies and permissions to define and apply access control to resources.</p>
</div>
<div class="paragraph">
<p>Keycloak Authorization Services REST endpoints provide a list of granted permissions on resources for authenticated users.
The list of grants (permissions) is fetched from the Keycloak server as the first action after an authenticated session is established by the Kafka client.
The list is refreshed in the background so that changes to the grants are detected.
Grants are cached and enforced locally on the Kafka broker for each user session to provide fast authorization decisions.</p>
</div>
<div class="paragraph">
<p>Strimzi provides <a href="#deploy-examples-str">example configuration files</a>.
These include the following example files for setting up Keycloak:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>kafka-ephemeral-oauth-single-keycloak-authz.yaml</code></dt>
<dd>
<p>An example <code>Kafka</code> custom resource configured for OAuth 2.0 token-based authorization using Keycloak.
You can use the custom resource to deploy a Kafka cluster that uses <code>keycloak</code> authorization and token-based <code>oauth</code> authentication.</p>
</dd>
<dt class="hdlist1"><code>kafka-authz-realm.json</code></dt>
<dd>
<p>An example Keycloak realm configured with sample groups, users, roles and clients.
You can import the realm into a Keycloak instance to set up fine-grained permissions to access Kafka.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you want to try the example with Keycloak, use these files to perform the tasks outlined in this section in the order shown.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-setup_str">Accessing the Keycloak Admin Console</a></p>
</li>
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-deploy-kafka_str">Deploying a Kafka cluster with Keycloak authorization</a></p>
</li>
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-authentication_str">Preparing TLS connectivity for a CLI Kafka client session</a></p>
</li>
<li>
<p><a href="#proc-oauth-authorization-keycloak-example-check_str">Checking authorized access to Kafka using a CLI Kafka client session</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Authentication</div>
<p>When you configure token-based <code>oauth</code> authentication, you specify a <code>jwksEndpointUri</code> as the URI for local JWT validation.
When you configure <code>keycloak</code> authorization, you specify a <code>tokenEndpointUri</code> as the URI of the Keycloak token endpoint.
The hostname for both URIs must be the same.</p>
</div>
<div class="paragraph">
<div class="title">Targeted permissions with group or role policies</div>
<p>In Keycloak, confidential clients with service accounts enabled can authenticate to the server in their own name using a client ID and a secret.
This is convenient for microservices that typically act in their own name, and not as agents of a particular user (like a web site).
Service accounts can have roles assigned like regular users.
They cannot, however, have groups assigned.
As a consequence, if you want to target permissions to microservices using service accounts, you cannot use group policies, and should instead use role policies.
Conversely, if you want to limit certain permissions only to regular user accounts where authentication with a username and password is required, you can achieve that as a side effect of using the group policies rather than the role policies.
This is what is used in this example for permissions that start with <code>ClusterManager</code>.
Performing cluster management is usually done interactively using CLI tools.
It makes sense to require the user to log in before using the resulting access token to authenticate to the Kafka broker.
In this case, the access token represents the specific user, rather than the client application.</p>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-setup_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-setup_str">Accessing the Keycloak Admin Console</a></h5>
<div class="paragraph">
<p>Set up Keycloak, then connect to its Admin Console and add the preconfigured realm.
Use the example <code>kafka-authz-realm.json</code> file to import the realm.
You can check the authorization rules defined for the realm in the Admin Console.
The rules grant access to the resources on the Kafka cluster configured to use the example Keycloak realm.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>A running Kubernetes cluster.</p>
</li>
<li>
<p>The Strimzi <code>examples/security/keycloak-authorization/kafka-authz-realm.json</code> file that contains the preconfigured realm.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Install the Keycloak server using the Keycloak Operator as described in <a href="https://www.keycloak.org/operator/installation" target="_blank" rel="noopener">Installing the Keycloak Operator</a> in the Keycloak documentation.</p>
</li>
<li>
<p>Wait until the Keycloak instance is running.</p>
</li>
<li>
<p>Get the external hostname to be able to access the Admin Console.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NS=sso
kubectl get ingress keycloak -n $NS</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we assume the Keycloak server is running in the <code>sso</code> namespace.</p>
</div>
</li>
<li>
<p>Get the password for the <code>admin</code> user.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get -n $NS pod keycloak-0 -o yaml | less</code></pre>
</div>
</div>
<div class="paragraph">
<p>The password is stored as a secret, so get the configuration YAML file for the Keycloak instance to identify the name of the secret (<code>secretKeyRef.name</code>).</p>
</div>
</li>
<li>
<p>Use the name of the secret to obtain the clear text password.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SECRET_NAME=credential-keycloak
kubectl get -n $NS secret $SECRET_NAME -o yaml | grep PASSWORD | awk '{print $2}' | base64 -D</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we assume the name of the secret is <code>credential-keycloak</code>.</p>
</div>
</li>
<li>
<p>Log in to the Admin Console with the username <code>admin</code> and the password you obtained.</p>
<div class="paragraph">
<p>Use <code>https://<em>HOSTNAME</em></code> to access the Kubernetes ingress.</p>
</div>
<div class="paragraph">
<p>You can now upload the example realm to Keycloak using the Admin Console.</p>
</div>
</li>
<li>
<p>Click <strong>Add Realm</strong> to import the example realm.</p>
</li>
<li>
<p>Add the <code>examples/security/keycloak-authorization/kafka-authz-realm.json</code> file, and then click <strong>Create</strong>.</p>
<div class="paragraph">
<p>You now have <code>kafka-authz</code> as your current realm in the Admin Console.</p>
</div>
<div class="paragraph">
<p>The default view displays the <strong>Master</strong> realm.</p>
</div>
</li>
<li>
<p>In the Keycloak Admin Console, go to <strong>Clients</strong> &gt; <strong>kafka</strong> &gt; <strong>Authorization</strong> &gt; <strong>Settings</strong> and check that <strong>Decision Strategy</strong> is set to <strong>Affirmative</strong>.</p>
<div class="paragraph">
<p>An affirmative policy means that at least one policy must be satisfied for a client to access the Kafka cluster.</p>
</div>
</li>
<li>
<p>In the Keycloak Admin Console, go to <strong>Groups</strong>, <strong>Users</strong>, <strong>Roles</strong> and <strong>Clients</strong> to view the realm configuration.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Groups</dt>
<dd>
<p><code>Groups</code> are used to create user groups and set user permissions. Groups are sets of users with a name assigned. They are used to compartmentalize users into geographical, organizational or departmental units.
Groups can be linked to an LDAP identity provider. You can make a user a member of a group through a custom LDAP server admin user interface, for example, to grant permissions on Kafka resources.</p>
</dd>
<dt class="hdlist1">Users</dt>
<dd>
<p><code>Users</code> are used to create users. For this example, <code>alice</code> and <code>bob</code> are defined. <code>alice</code> is a member of the <code>ClusterManager</code> group and <code>bob</code> is a member of <code>ClusterManager-my-cluster</code> group.
Users can be stored in an LDAP identity provider.</p>
</dd>
<dt class="hdlist1">Roles</dt>
<dd>
<p><code>Roles</code> mark users or clients as having certain permissions.
Roles are a concept analogous to groups. They are usually used to <em>tag</em> users with organizational roles and have the requisite permissions.
Roles cannot be stored in an LDAP identity provider.
If LDAP is a requirement, you can use groups instead, and add Keycloak roles to the groups so that when users are assigned a group they also get a corresponding role.</p>
</dd>
<dt class="hdlist1">Clients</dt>
<dd>
<p><code>Clients</code> can have specific configurations. For this example, <code>kafka</code>, <code>kafka-cli</code>, <code>team-a-client</code>, and <code>team-b-client</code> clients are configured.</p>
<div class="ulist">
<ul>
<li>
<p>The <code>kafka</code> client is used by Kafka brokers to perform the necessary OAuth 2.0 communication for access token validation.
This client also contains the authorization services resource definitions, policies, and authorization scopes used to perform authorization on the Kafka brokers.
The authorization configuration is defined in the <code>kafka</code> client from the <strong>Authorization</strong> tab, which becomes visible when <strong>Authorization Enabled</strong> is switched on from the <strong>Settings</strong> tab.</p>
</li>
<li>
<p>The <code>kafka-cli</code> client is a public client that is used by the Kafka command line tools when authenticating with username and password to obtain an access token or a refresh token.</p>
</li>
<li>
<p>The <code>team-a-client</code> and <code>team-b-client</code> clients are confidential clients representing services with partial access to certain Kafka topics.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>In the Keycloak Admin Console, go to <strong>Authorization</strong> &gt; <strong>Permissions</strong> to see the granted permissions that use the resources and policies defined for the realm.</p>
<div class="paragraph">
<p>For example, the <code>kafka</code> client has the following permissions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Dev Team A can write to topics that start with x_ on any cluster
Dev Team B can read from topics that start with x_ on any cluster
Dev Team B can update consumer group offsets that start with x_ on any cluster
ClusterManager of my-cluster Group has full access to cluster config on my-cluster
ClusterManager of my-cluster Group has full access to consumer groups on my-cluster
ClusterManager of my-cluster Group has full access to topics on my-cluster</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Dev Team A</dt>
<dd>
<p>The Dev Team A realm role can write to topics that start with <code>x_</code> on any cluster. This combines a resource called <code>Topic:x_*</code>, <code>Describe</code> and <code>Write</code> scopes, and the <code>Dev Team A</code> policy. The <code>Dev Team A</code> policy matches all users that have a realm role called <code>Dev Team A</code>.</p>
</dd>
<dt class="hdlist1">Dev Team B</dt>
<dd>
<p>The Dev Team B realm role can read from topics that start with <code>x_</code> on any cluster. This combines <code>Topic:x_*</code>, <code>Group:x_*</code> resources, <code>Describe</code> and <code>Read</code> scopes, and the <code>Dev Team B</code> policy. The <code>Dev Team B</code> policy matches all users that have a realm role called <code>Dev Team B</code>. Matching users and clients have the ability to read from topics, and update the consumed offsets for topics and consumer groups that have names starting with <code>x_</code>.</p>
</dd>
</dl>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-deploy-kafka_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-deploy-kafka_str">Deploying a Kafka cluster with Keycloak authorization</a></h5>
<div class="paragraph">
<p>Deploy a Kafka cluster configured to connect to the Keycloak server.
Use the example <code>kafka-ephemeral-oauth-single-keycloak-authz.yaml</code> file to deploy the Kafka cluster as a <code>Kafka</code> custom resource.
The example deploys a single-node Kafka cluster with <code>keycloak</code> authorization and <code>oauth</code> authentication.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Keycloak authorization server is deployed to your Kubernetes cluster and loaded with the example realm.</p>
</li>
<li>
<p>The Cluster Operator is deployed to your Kubernetes cluster.</p>
</li>
<li>
<p>The Strimzi <code>examples/security/keycloak-authorization/kafka-ephemeral-oauth-single-keycloak-authz.yaml</code> custom resource.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use the hostname of the Keycloak instance you deployed to prepare a truststore certificate for Kafka brokers to communicate with the Keycloak server.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em>
SSO_HOST_PORT=$SSO_HOST:443
STOREPASS=storepass

echo "Q" | openssl s_client -showcerts -connect $SSO_HOST_PORT 2&gt;/dev/null | awk ' /BEGIN CERTIFICATE/,/END CERTIFICATE/ { print $0 } ' &gt; /tmp/sso.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The certificate is required as Kubernetes ingress is used to make a secure (HTTPS) connection.</p>
</div>
<div class="paragraph">
<p>Usually there is not one single certificate, but a certificate chain. You only have to provide the top-most issuer CA, which is listed last in the <code>/tmp/sso.pem</code> file.
You can extract it manually or using the following commands:</p>
</div>
<div class="listingblock">
<div class="title">Example command to extract the top CA certificate in a certificate chain</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">split -p "-----BEGIN CERTIFICATE-----" sso.pem sso-
for f in $(ls sso-*); do mv $f $f.pem; done
cp $(ls sso-* | sort -r | head -n 1) sso-ca.crt</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A trusted CA certificate is normally obtained from a trusted source, and not by using the <code>openssl</code> command.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Deploy the certificate to Kubernetes as a secret.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create secret generic oauth-server-cert --from-file=/tmp/sso-ca.crt -n $NS</code></pre>
</div>
</div>
</li>
<li>
<p>Set the hostname as an environment variable</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em></code></pre>
</div>
</div>
</li>
<li>
<p>Create and deploy the example Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat examples/security/keycloak-authorization/kafka-ephemeral-oauth-single-keycloak-authz.yaml | sed -E 's#\${SSO_HOST}'"#$SSO_HOST#" | kubectl create -n $NS -f -</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-authentication_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-authentication_str">Preparing TLS connectivity for a CLI Kafka client session</a></h5>
<div class="paragraph">
<p>Create a new pod for an interactive CLI session.
Set up a truststore with a Keycloak certificate for TLS connectivity.
The truststore is to connect to Keycloak and the Kafka broker.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Keycloak authorization server is deployed to your Kubernetes cluster and loaded with the example realm.</p>
<div class="paragraph">
<p>In the Keycloak Admin Console, check the roles assigned to the clients are displayed in <strong>Clients</strong> &gt; <strong>Service Account Roles</strong>.</p>
</div>
</li>
<li>
<p>The Kafka cluster configured to connect with Keycloak is deployed to your Kubernetes cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Run a new interactive pod container using the Strimzi Kafka image to connect to a running Kafka broker.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NS=sso
kubectl run -ti --restart=Never --image=quay.io/strimzi/kafka:latest-kafka-3.3.2 kafka-cli -n $NS -- /bin/sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If <code>kubectl</code> times out waiting on the image download, subsequent attempts may result in an <em>AlreadyExists</em> error.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Attach to the pod container.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl attach -ti kafka-cli -n $NS</code></pre>
</div>
</div>
</li>
<li>
<p>Use the hostname of the Keycloak instance to prepare a certificate for client connection using TLS.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em>
SSO_HOST_PORT=$SSO_HOST:443
STOREPASS=storepass

echo "Q" | openssl s_client -showcerts -connect $SSO_HOST_PORT 2&gt;/dev/null | awk ' /BEGIN CERTIFICATE/,/END CERTIFICATE/ { print $0 } ' &gt; /tmp/sso.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>Usually there is not one single certificate, but a certificate chain. You only have to provide the top-most issuer CA, which is listed last in the <code>/tmp/sso.pem</code> file.
You can extract it manually or using the following command:</p>
</div>
<div class="listingblock">
<div class="title">Example command to extract the top CA certificate in a certificate chain</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">split -p "-----BEGIN CERTIFICATE-----" sso.pem sso-
for f in $(ls sso-*); do mv $f $f.pem; done
cp $(ls sso-* | sort -r | head -n 1) sso-ca.crt</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A trusted CA certificate is normally obtained from a trusted source, and not by using the <code>openssl</code> command.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create a truststore for TLS connection to the Kafka brokers.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">keytool -keystore /tmp/truststore.p12 -storetype pkcs12 -alias sso -storepass $STOREPASS -import -file /tmp/sso-ca.crt -noprompt</code></pre>
</div>
</div>
</li>
<li>
<p>Use the Kafka bootstrap address as the hostname of the Kafka broker and the <code>tls</code> listener port (9093) to prepare a certificate for the Kafka broker.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">KAFKA_HOST_PORT=my-cluster-kafka-bootstrap:9093
STOREPASS=storepass

echo "Q" | openssl s_client -showcerts -connect $KAFKA_HOST_PORT 2&gt;/dev/null | awk ' /BEGIN CERTIFICATE/,/END CERTIFICATE/ { print $0 } ' &gt; /tmp/my-cluster-kafka.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The obtained <code>.pem</code> file is usually not one single certificate, but a certificate chain. You only have to provide the top-most issuer CA, which is listed last in the <code>/tmp/my-cluster-kafka.pem</code> file.
You can extract it manually or using the following command:</p>
</div>
<div class="listingblock">
<div class="title">Example command to extract the top CA certificate in a certificate chain</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">split -p "-----BEGIN CERTIFICATE-----" /tmp/my-cluster-kafka.pem kafka-
for f in $(ls kafka-*); do mv $f $f.pem; done
cp $(ls kafka-* | sort -r | head -n 1) my-cluster-kafka-ca.crt</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A trusted CA certificate is normally obtained from a trusted source, and not by using the <code>openssl</code> command.
      For this example we assume the client is running in a pod in the same namespace where the Kafka cluster was deployed.
      If the client is accessing the Kafka cluster from outside the Kubernetes cluster, you would have to first determine the bootstrap address.
      In that case you can also get the cluster certificate directly from the Kubernetes secret, and there is no need for <code>openssl</code>.
      For more information, see <a href="#deploy-client-access-str">Setting up client access to a Kafka cluster</a>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the certificate for the Kafka broker to the truststore.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">keytool -keystore /tmp/truststore.p12 -storetype pkcs12 -alias my-cluster-kafka -storepass $STOREPASS -import -file /tmp/my-cluster-kafka-ca.crt -noprompt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keep the session open to check authorized access.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-oauth-authorization-keycloak-example-check_str"><a class="link" href="#proc-oauth-authorization-keycloak-example-check_str">Checking authorized access to Kafka using a CLI Kafka client session</a></h5>
<div class="paragraph">
<p>Check the authorization rules applied through the Keycloak realm using an interactive CLI session.
Apply the checks using Kafka&#8217;s example producer and consumer clients to create topics with user and service accounts that have different levels of access.</p>
</div>
<div class="paragraph">
<p>Use the <code>team-a-client</code> and <code>team-b-client</code> clients to check the authorization rules.
Use the <code>alice</code> admin user to perform additional administrative tasks on Kafka.</p>
</div>
<div class="paragraph">
<p>The Strimzi Kafka image used in this example contains Kafka producer and consumer binaries.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>ZooKeeper and Kafka are running in the Kubernetes cluster to be able to send and receive messages.</p>
</li>
<li>
<p>The <a href="#proc-oauth-authorization-keycloak-example-authentication_str">interactive CLI Kafka client session</a> is started.</p>
<div class="paragraph">
<p><a href="http://kafka.apache.org/" target="_blank" rel="noopener">Apache Kafka download</a>.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Setting up client and admin user configuration</div>
<ol class="arabic">
<li>
<p>Prepare a Kafka configuration file with authentication properties for the <code>team-a-client</code> client.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">SSO_HOST=<em>SSO-HOSTNAME</em>

cat &gt; /tmp/team-a-client.properties &lt;&lt; EOF
security.protocol=SASL_SSL
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.mechanism=OAUTHBEARER
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.client.id="team-a-client" \
  oauth.client.secret="team-a-client-secret" \
  oauth.ssl.truststore.location="/tmp/truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.token.endpoint.uri="https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SASL OAUTHBEARER mechanism is used.
This mechanism requires a client ID and client secret, which means the client first connects to the Keycloak server to obtain an access token.
The client then connects to the Kafka broker and uses the access token to authenticate.</p>
</div>
</li>
<li>
<p>Prepare a Kafka configuration file with authentication properties for the <code>team-b-client</code> client.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &gt; /tmp/team-b-client.properties &lt;&lt; EOF
security.protocol=SASL_SSL
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.mechanism=OAUTHBEARER
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.client.id="team-b-client" \
  oauth.client.secret="team-b-client-secret" \
  oauth.ssl.truststore.location="/tmp/truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.token.endpoint.uri="https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Authenticate admin user <code>alice</code> by using <code>curl</code> and performing a password grant authentication to obtain a refresh token.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">USERNAME=alice
PASSWORD=alice-password

GRANT_RESPONSE=$(curl -X POST "https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" -H 'Content-Type: application/x-www-form-urlencoded' -d "grant_type=password&amp;username=$USERNAME&amp;password=$PASSWORD&amp;client_id=kafka-cli&amp;scope=offline_access" -s -k)

REFRESH_TOKEN=$(echo $GRANT_RESPONSE | awk -F "refresh_token\":\"" '{printf $2}' | awk -F "\"" '{printf $1}')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The refresh token is an offline token that is long-lived and does not expire.</p>
</div>
</li>
<li>
<p>Prepare a Kafka configuration file with authentication properties for the admin user <code>alice</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &gt; /tmp/alice.properties &lt;&lt; EOF
security.protocol=SASL_SSL
ssl.truststore.location=/tmp/truststore.p12
ssl.truststore.password=$STOREPASS
ssl.truststore.type=PKCS12
sasl.mechanism=OAUTHBEARER
sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required \
  oauth.refresh.token="$REFRESH_TOKEN" \
  oauth.client.id="kafka-cli" \
  oauth.ssl.truststore.location="/tmp/truststore.p12" \
  oauth.ssl.truststore.password="$STOREPASS" \
  oauth.ssl.truststore.type="PKCS12" \
  oauth.token.endpoint.uri="https://$SSO_HOST/auth/realms/kafka-authz/protocol/openid-connect/token" ;
sasl.login.callback.handler.class=io.strimzi.kafka.oauth.client.JaasClientOauthLoginCallbackHandler
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kafka-cli</code> public client is used for the <code>oauth.client.id</code> in the <code>sasl.jaas.config</code>.
Since it&#8217;s a public client it does not require a secret.
The client authenticates with the refresh token that was authenticated in the previous step.
The refresh token requests an access token behind the scenes, which is then sent to the Kafka broker for authentication.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Producing messages with authorized access</div>
<p>Use the <code>team-a-client</code> configuration to check that you can produce messages to topics that start with <code>a_</code> or <code>x_</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write to topic <code>my-topic</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic my-topic \
  --producer.config=/tmp/team-a-client.properties
First message</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [my-topic]</code> error.</p>
</div>
<div class="paragraph">
<p><code>team-a-client</code> has a <code>Dev Team A</code> role that gives it permission to perform any supported actions on topics that start with <code>a_</code>, but can only write to topics that start with <code>x_</code>.
The topic named <code>my-topic</code> matches neither of those rules.</p>
</div>
</li>
<li>
<p>Write to topic <code>a_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --producer.config /tmp/team-a-client.properties
First message
Second message</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are produced to Kafka successfully.</p>
</div>
</li>
<li>
<p>Press CTRL+C to exit the CLI application.</p>
</li>
<li>
<p>Check the Kafka container log for a debug log of <code>Authorization GRANTED</code> for the request.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs my-cluster-kafka-0 -f -n $NS</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Consuming messages with authorized access</div>
<p>Use the <code>team-a-client</code> configuration to consume messages from topic <code>a_messages</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fetch messages from topic <code>a_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request returns an error because the <code>Dev Team A</code> role for <code>team-a-client</code> only has access to consumer groups that have names starting with <code>a_</code>.</p>
</div>
</li>
<li>
<p>Update the <code>team-a-client</code> properties to specify the custom consumer group it is permitted to use.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties --group a_consumer_group_1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The consumer receives all the messages from the <code>a_messages</code> topic.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Administering Kafka with authorized access</div>
<p>The <code>team-a-client</code> is an account without any cluster-level access, but it can be used with some administrative operations.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>List topics.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties --list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>a_messages</code> topic is returned.</p>
</div>
</li>
<li>
<p>List consumer groups.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-consumer-groups.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties --list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>a_consumer_group_1</code> consumer group is returned.</p>
</div>
<div class="paragraph">
<p>Fetch details on the cluster configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties \
  --entity-type brokers --describe --entity-default</code></pre>
</div>
</div>
<div class="paragraph">
<p>The request returns an error because the operation requires cluster level permissions that <code>team-a-client</code> does not have.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Using clients with different permissions</div>
<p>Use the <code>team-b-client</code> configuration to produce messages to topics that start with <code>b_</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Write to topic <code>a_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic a_messages \
  --producer.config /tmp/team-b-client.properties
Message 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [a_messages]</code> error.</p>
</div>
</li>
<li>
<p>Write to topic <code>b_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic b_messages \
  --producer.config /tmp/team-b-client.properties
Message 1
Message 2
Message 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are produced to Kafka successfully.</p>
</div>
</li>
<li>
<p>Write to topic <code>x_messages</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-b-client.properties
Message 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Not authorized to access topics: [x_messages]</code> error is returned,
The <code>team-b-client</code> can only read from topic <code>x_messages</code>.</p>
</div>
</li>
<li>
<p>Write to topic <code>x_messages</code> using <code>team-a-client</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-a-client.properties
Message 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.
The <code>team-a-client</code> can write to the <code>x_messages</code> topic, but it does not have a permission to create a topic if it does not yet exist.
Before <code>team-a-client</code> can write to the <code>x_messages</code> topic, an admin <em>power user</em> must create it with the correct configuration, such as the number of partitions and replicas.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Managing Kafka with an authorized admin user</div>
<p>Use admin user <code>alice</code> to manage Kafka.
<code>alice</code> has full access to manage everything on any Kafka cluster.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the <code>x_messages</code> topic as <code>alice</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/alice.properties \
  --topic x_messages --create --replication-factor 1 --partitions 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The topic is created successfully.</p>
</div>
</li>
<li>
<p>List all topics as <code>alice</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/alice.properties --list
bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-a-client.properties --list
bin/kafka-topics.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/team-b-client.properties --list</code></pre>
</div>
</div>
<div class="paragraph">
<p>Admin user <code>alice</code> can list all the topics, whereas <code>team-a-client</code> and <code>team-b-client</code> can only list the topics they have access to.</p>
</div>
<div class="paragraph">
<p>The <code>Dev Team A</code> and <code>Dev Team B</code> roles both have <code>Describe</code> permission on topics that start with <code>x_</code>, but they cannot see the other team&#8217;s topics because they do not have <code>Describe</code> permissions on them.</p>
</div>
</li>
<li>
<p>Use the <code>team-a-client</code> to produce messages to the <code>x_messages</code> topic:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-a-client.properties
Message 1
Message 2
Message 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>As <code>alice</code> created the <code>x_messages</code> topic, messages are produced to Kafka successfully.</p>
</div>
</li>
<li>
<p>Use the <code>team-b-client</code> to produce messages to the <code>x_messages</code> topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-producer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --producer.config /tmp/team-b-client.properties
Message 4
Message 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.</p>
</div>
</li>
<li>
<p>Use the <code>team-b-client</code> to consume messages from the <code>x_messages</code> topic:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/team-b-client.properties --group x_consumer_group_b</code></pre>
</div>
</div>
<div class="paragraph">
<p>The consumer receives all the messages from the <code>x_messages</code> topic.</p>
</div>
</li>
<li>
<p>Use the <code>team-a-client</code> to consume messages from the <code>x_messages</code> topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties --group x_consumer_group_a</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.</p>
</div>
</li>
<li>
<p>Use the <code>team-a-client</code> to consume messages from a consumer group that begins with <code>a_</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/team-a-client.properties --group a_consumer_group_a</code></pre>
</div>
</div>
<div class="paragraph">
<p>This request returns a <code>Not authorized to access topics: [x_messages]</code> error.</p>
</div>
<div class="paragraph">
<p><code>Dev Team A</code> has no <code>Read</code> access on topics that start with a <code>x_</code>.</p>
</div>
</li>
<li>
<p>Use <code>alice</code> to produce messages to the <code>x_messages</code> topic.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-console-consumer.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --topic x_messages \
  --from-beginning --consumer.config /tmp/alice.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are produced to Kafka successfully.</p>
</div>
<div class="paragraph">
<p><code>alice</code> can read from or write to any topic.</p>
</div>
</li>
<li>
<p>Use <code>alice</code> to read the cluster configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">bin/kafka-configs.sh --bootstrap-server my-cluster-kafka-bootstrap:9093 --command-config /tmp/alice.properties \
  --entity-type brokers --describe --entity-default</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cluster configuration for this example is empty.</p>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://www.keycloak.org/operator/installation" target="_blank" rel="noopener">Installing the Keycloak Operator</a></p>
</li>
<li>
<p><a href="#con-mapping-keycloak-authz-services-to-kafka-model_authz-model">Map Keycloak Authorization Services to the Kafka authorization model</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-metrics-str"><a class="link" href="#assembly-metrics-str">10. Introducing metrics</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>You can use Prometheus and Grafana to monitor your Strimzi deployment.</p>
</div>
<div class="paragraph">
<p>You can monitor your Strimzi deployment by viewing key metrics on dashboards and setting up alerts that trigger under certain conditions.
Metrics are available for each of the components of Strimzi.</p>
</div>
<div class="paragraph">
<p>You can also collect metrics specific to <code>oauth</code> authentication and <code>opa</code> or <code>keycloak</code> authorization.
You do this by setting the <code>enableMetrics</code> property to <code>true</code> in the listener configuration of the <code>Kafka</code> resource.
For example, set <code>enableMetrics</code>  to <code>true</code> in <code>spec.kafka.listeners.authentication</code> and <code>spec.kafka.authorization</code>.
Similarly, you can enable metrics for <code>oauth</code> authentication in the <code>KafkaBridge</code>, <code>KafkaConnect</code>, <code>KafkaMirrorMaker</code>, and <code>KafkaMirrorMaker2</code> custom resources.</p>
</div>
<div class="paragraph">
<p>To provide metrics information, Strimzi uses Prometheus rules and Grafana dashboards.</p>
</div>
<div class="paragraph">
<p>When configured with a set of rules for each component of Strimzi, Prometheus consumes key metrics from the pods that are running in your cluster.
Grafana then visualizes those metrics on dashboards.
Strimzi includes example Grafana dashboards that you can customize to suit your deployment.</p>
</div>
<div class="paragraph">
<p>Depending on your requirements, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#assembly-metrics-setup-str">Set up and deploy Prometheus to expose metrics</a></p>
</li>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Deploy Kafka Exporter to provide additional metrics</a></p>
</li>
<li>
<p><a href="#proc-metrics-grafana-dashboard-str">Use Grafana to present the Prometheus metrics</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With Prometheus and Grafana set up, you can use the example Grafana dashboards provided by Strimzi for monitoring.</p>
</div>
<div class="paragraph">
<p>Additionally, you can configure your deployment to track messages end-to-end by <a href="#assembly-distributed-tracing-str">setting up distributed tracing</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Strimzi provides example installation files for Prometheus and Grafana.
You can use these files as a starting point when trying out monitoring of Strimzi.
For further support, try engaging with the Prometheus and Grafana developer communities.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Supporting documentation for metrics and monitoring tools</div>
<p>For more information on the metrics and monitoring tools, refer to the supporting documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/prometheus" target="_blank" rel="noopener">Prometheus</a></p>
</li>
<li>
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration" target="_blank" rel="noopener">Prometheus configuration</a></p>
</li>
<li>
<p><a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="noopener">Kafka Exporter</a></p>
</li>
<li>
<p><a href="https://grafana.com/" target="_blank" rel="noopener">Grafana Labs</a></p>
</li>
<li>
<p><a href="http://kafka.apache.org/documentation/#monitoring">Apache Kafka Monitoring</a> describes JMX metrics exposed by Apache Kafka</p>
</li>
<li>
<p><a href="https://zookeeper.apache.org/doc/current/zookeeperJMX.html">ZooKeeper JMX</a> describes JMX metrics exposed by Apache ZooKeeper</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="con-metrics-kafka-exporter-lag-str"><a class="link" href="#con-metrics-kafka-exporter-lag-str">10.1. Monitoring consumer lag with Kafka Exporter</a></h3>
<div class="paragraph _abstract">
<p><a href="https://github.com/danielqsj/kafka_exporter" target="_blank" rel="noopener">Kafka Exporter</a> is an open source project to enhance monitoring of Apache Kafka brokers and clients.
You can configure the <code>Kafka</code> resource to <a href="#proc-metrics-kafka-deploy-options-str">deploy Kafka Exporter with your Kafka cluster</a>.
Kafka Exporter extracts additional metrics data from Kafka brokers related to offsets, consumer groups, consumer lag, and topics.
The metrics data is used, for example, to help identify slow consumers.
Lag data is exposed as Prometheus metrics, which can then be presented in Grafana for analysis.</p>
</div>
<div class="paragraph">
<p>Kafka Exporter reads from the  <code>__consumer_offsets</code> topic, which stores information on committed offsets for consumer groups.
For Kafka Exporter to be able to work properly, consumer groups needs to be in use.</p>
</div>
<div class="paragraph">
<p>A Grafana dashboard for Kafka Exporter is one of a number of <a href="#ref-metrics-dashboards-str">example Grafana dashboards</a> provided by Strimzi.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Kafka Exporter provides only additional metrics related to consumer lag and consumer offsets.
For regular Kafka metrics, you have to configure the Prometheus metrics in <a href="#proc-metrics-kafka-deploy-options-str">Kafka brokers</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Consumer lag indicates the difference in the rate of production and consumption of messages.
Specifically, consumer lag for a given consumer group indicates the delay between the last message in the partition and the message being currently picked up by that consumer.</p>
</div>
<div class="paragraph">
<p>The lag reflects the position of the consumer offset in relation to the end of the partition log.</p>
</div>
<div class="paragraph">
<div class="title">Consumer lag between the producer and consumer offset</div>
<p><span class="image"><img src="images/consumer-lag.png" alt="Consumer lag"></span></p>
</div>
<div class="paragraph">
<p>This difference is sometimes referred to as the <em>delta</em> between the producer offset and consumer offset: the read and write positions in the Kafka broker topic partitions.</p>
</div>
<div class="paragraph">
<p>Suppose a topic streams 100 messages a second. A lag of 1000 messages between the producer offset (the topic partition head) and the last offset the consumer has read means a 10-second delay.</p>
</div>
<h4 id="the_importance_of_monitoring_consumer_lag" class="discrete">The importance of monitoring consumer lag</h4>
<div class="paragraph">
<p>For applications that rely on the processing of (near) real-time data, it is critical to monitor consumer lag to check that it does not become too big.
The greater the lag becomes, the further the process moves from the real-time processing objective.</p>
</div>
<div class="paragraph">
<p>Consumer lag, for example, might be a result of consuming too much old data that has not been purged, or through unplanned shutdowns.</p>
</div>
<h4 id="reducing_consumer_lag" class="discrete">Reducing consumer lag</h4>
<div class="paragraph">
<p>Use the Grafana charts to analyze lag and to check if actions to reduce lag are having an impact on an affected consumer group.
If, for example, Kafka brokers are adjusted to reduce lag, the dashboard will show the  <em>Lag by consumer group</em> chart going down and the <em>Messages consumed per minute</em> chart going up.</p>
</div>
<div class="paragraph">
<p>Typical actions to reduce lag include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scaling-up consumer groups by adding new consumers</p>
</li>
<li>
<p>Increasing the retention time for a message to remain in a topic</p>
</li>
<li>
<p>Adding more disk capacity to increase the message buffer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Actions to reduce consumer lag depend on the underlying infrastructure and the use cases Strimzi is supporting.
For instance, a lagging consumer is less likely to benefit from the broker being able to service a fetch request from its disk cache.
And in certain cases, it might be acceptable to automatically drop messages until a consumer has caught up.</p>
</div>
</div>
<div class="sect2">
<h3 id="con-metrics-cruise-control-str"><a class="link" href="#con-metrics-cruise-control-str">10.2. Monitoring Cruise Control operations</a></h3>
<div class="paragraph _abstract">
<p>Cruise Control monitors Kafka brokers in order to track the utilization of brokers, topics, and partitions.
Cruise Control also provides a set of metrics for monitoring its own performance.</p>
</div>
<div class="paragraph">
<p>The Cruise Control metrics reporter collects raw metrics data from Kafka brokers.
The data is produced to topics that are automatically created by Cruise Control.
The metrics are used to <a href="./configuring.html#proc-generating-optimization-proposals-str" target="_blank" rel="noopener">generate optimization proposals for Kafka clusters</a>.</p>
</div>
<div class="paragraph">
<p>Cruise Control metrics are available for real-time monitoring of Cruise Control operations.
For example, you can use Cruise Control metrics to monitor the status of rebalancing operations that are running or provide alerts on any anomalies that are detected in an operation&#8217;s performance.</p>
</div>
<div class="paragraph">
<p>You expose Cruise Control metrics by enabling the <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">Prometheus JMX Exporter</a> in the Cruise Control configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For a full list of available Cruise Control metrics, which are known as <em>sensors</em>, see the <a href="https://github.com/linkedin/cruise-control/wiki/Sensors" target="_blank" rel="noopener">Cruise Control documentation</a>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="exposing_cruise_control_metrics"><a class="link" href="#exposing_cruise_control_metrics">10.2.1. Exposing Cruise Control metrics</a></h4>
<div class="paragraph">
<p>If you want to expose metrics on Cruise Control operations, configure the <code>Kafka</code> resource <a href="#proc-metrics-kafka-deploy-options-str">to deploy Cruise Control and enable Prometheus metrics in the deployment</a>.
You can use your own configuration or use the example <code>kafka-cruise-control-metrics.yaml</code> file provided by Strimzi.</p>
</div>
<div class="paragraph">
<p>You add the configuration to the <code>metricsConfig</code> of the <code>CruiseControl</code> property in the <code>Kafka</code> resource.
The configuration enables the <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">Prometheus JMX Exporter</a> to expose Cruise Control metrics through an HTTP endpoint.
The HTTP endpoint is scraped by the Prometheus server.</p>
</div>
<div class="listingblock">
<div class="title">Example metrics configuration for Cruise Control</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  apiVersion: kafka.strimzi.io/v1beta2
  kind: Kafka
  metadata:
    name: my-cluster
  Spec:
    # ...
    cruiseControl:
      # ...
      metricsConfig:
        type: jmxPrometheusExporter
        valueFrom:
          configMapKeyRef:
            name: cruise-control-metrics
            key: metrics-config.yml
  ---
  kind: ConfigMap
  apiVersion: v1
  metadata:
    name: cruise-control-metrics
    labels:
      app: strimzi
  data:
    metrics-config.yml: |
    # <em>metrics configuration...</em></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="viewing_cruise_control_metrics"><a class="link" href="#viewing_cruise_control_metrics">10.2.2. Viewing Cruise Control metrics</a></h4>
<div class="paragraph">
<p>After you expose the Cruise Control metrics, you can use Prometheus or another suitable monitoring system to view information on the metrics data.
Strimzi provides an <a href="#assembly-metrics-config-files-str">example Grafana dashboard</a> to display visualizations of Cruise Control metrics.
The dashboard is a JSON file called <code>strimzi-cruise-control.json</code>.
The exposed metrics provide the monitoring data when you <a href="#proc-metrics-grafana-dashboard-str">enable the Grafana dashboard</a>.</p>
</div>
<div class="sect4">
<h5 id="monitoring_balancedness_scores"><a class="link" href="#monitoring_balancedness_scores">Monitoring balancedness scores</a></h5>
<div class="paragraph">
<p>Cruise Control metrics include a balancedness score.
Balancedness is the measure of how evenly a workload is distributed in a Kafka cluster.</p>
</div>
<div class="paragraph">
<p>The Cruise Control metric for balancedness score (<code>balancedness-score</code>) might differ from the balancedness score in the <code>KafkaRebalance</code> resource.
Cruise Control calculates each score using <code>anomaly.detection.goals</code> which might not be the same as the <code>default.goals</code> used in the <code>KafkaRebalance</code> resource.
The <code>anomaly.detection.goals</code> are specified in the <code>spec.cruiseControl.config</code> of the <code>Kafka</code> custom resource.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Refreshing the <code>KafkaRebalance</code> resource fetches an optimization proposal.
The latest cached optimization proposal is fetched if one of the following conditions applies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>KafkaRebalance <code>goals</code> match the goals configured in the <code>default.goals</code> section of the <code>Kafka</code> resource</p>
</li>
<li>
<p>KafkaRebalance <code>goals</code> are not specified</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otherwise, Cruise Control generates a new optimization proposal based on KafkaRebalance <code>goals</code>. If new proposals are generated with each refresh, this can impact performance monitoring.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="alerts_on_anomaly_detection"><a class="link" href="#alerts_on_anomaly_detection">Alerts on anomaly detection</a></h5>
<div class="paragraph">
<p>Cruise control&#8217;s <em>anomaly detector</em> provides metrics data for conditions that block the generation of optimization goals, such as broker failures.
If you want more visibility, you can use the metrics provided by the anomaly detector to set up alerts and send out notifications.
You can set up Cruise Control’s <em>anomaly notifier</em> to route alerts based on these metrics through a specified notification channel.
Alternatively, you can set up Prometheus to scrape the metrics data provided by the anomaly detector and generate alerts.
Prometheus Alertmanager can then route the alerts generated by Prometheus.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/linkedin/cruise-control/wiki/Configurations" target="_blank" rel="noopener">Cruise Control documentation</a> provides information on <code>AnomalyDetector</code> metrics and the anomaly notifier.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-metrics-config-files-str"><a class="link" href="#assembly-metrics-config-files-str">10.3. Example metrics files</a></h3>
<div class="paragraph _abstract">
<p>You can find example Grafana dashboards and other metrics configuration files in the <a href="#deploy-examples-str">example configuration files</a> provided by Strimzi.</p>
</div>
<div class="listingblock">
<div class="title">Example metrics files provided with Strimzi</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">metrics
├── grafana-dashboards <b class="conum">(1)</b>
│   ├── strimzi-cruise-control.json
│   ├── strimzi-kafka-bridge.json
│   ├── strimzi-kafka-connect.json
│   ├── strimzi-kafka-exporter.json
│   ├── strimzi-kafka-mirror-maker-2.json
│   ├── strimzi-kafka.json
│   ├── strimzi-operators.json
│   └── strimzi-zookeeper.json
├── grafana-install
│   └── grafana.yaml <b class="conum">(2)</b>
├── prometheus-additional-properties
│   └── prometheus-additional.yaml <b class="conum">(3)</b>
├── prometheus-alertmanager-config
│   └── alert-manager-config.yaml <b class="conum">(4)</b>
├── prometheus-install
│    ├── alert-manager.yaml <b class="conum">(5)</b>
│    ├── prometheus-rules.yaml <b class="conum">(6)</b>
│    ├── prometheus.yaml <b class="conum">(7)</b>
│    ├── strimzi-pod-monitor.yaml <b class="conum">(8)</b>
├── kafka-bridge-metrics.yaml <b class="conum">(9)</b>
├── kafka-connect-metrics.yaml <b class="conum">(10)</b>
├── kafka-cruise-control-metrics.yaml <b class="conum">(11)</b>
├── kafka-metrics.yaml <b class="conum">(12)</b>
└── kafka-mirror-maker-2-metrics.yaml <b class="conum">(13)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Example Grafana dashboards for the different Strimzi components.</p>
</li>
<li>
<p>Installation file for the Grafana image.</p>
</li>
<li>
<p>Additional configuration to scrape metrics for CPU, memory and disk volume usage, which comes directly from the Kubernetes cAdvisor agent and kubelet on the nodes.</p>
</li>
<li>
<p>Hook definitions for sending notifications through Alertmanager.</p>
</li>
<li>
<p>Resources for deploying and configuring Alertmanager.</p>
</li>
<li>
<p>Alerting rules examples for use with Prometheus Alertmanager (deployed with Prometheus).</p>
</li>
<li>
<p>Installation resource file for the Prometheus image.</p>
</li>
<li>
<p>PodMonitor definitions translated by the Prometheus Operator into jobs for the Prometheus server to be able to scrape metrics data directly from pods.</p>
</li>
<li>
<p>Kafka Bridge resource with metrics enabled.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka Connect.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Cruise Control.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka and ZooKeeper.</p>
</li>
<li>
<p>Metrics configuration that defines Prometheus JMX Exporter relabeling rules for Kafka Mirror Maker 2.0.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="ref-metrics-prometheus-metrics-config-str"><a class="link" href="#ref-metrics-prometheus-metrics-config-str">10.3.1. Example Prometheus metrics configuration</a></h4>
<div class="paragraph _abstract">
<p>Strimzi uses the <a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener">Prometheus JMX Exporter</a> to expose metrics through an HTTP endpoint, which can be scraped by the Prometheus server.</p>
</div>
<div class="paragraph">
<p>Grafana dashboards are dependent on Prometheus JMX Exporter relabeling rules, which are defined for Strimzi components in the custom resource configuration.</p>
</div>
<div class="paragraph">
<p>A label is a name-value pair.
Relabeling is the process of writing a label dynamically.
For example, the value of a label may be derived from the name of a Kafka server and client ID.</p>
</div>
<div class="paragraph">
<p>Strimzi provides example custom resource configuration YAML files with relabeling rules.
When deploying Prometheus metrics configuration, you can can deploy the example custom resource or copy the metrics configuration to your own custom resource definition.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 4. Example custom resources with metrics configuration</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Custom resource</th>
<th class="tableblock halign-left valign-top">Example YAML file</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka and ZooKeeper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaConnect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-connect-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka MirrorMaker 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaMirrorMaker2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-mirror-maker-2-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>KafkaBridge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-bridge-metrics.yaml</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Kafka</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>kafka-cruise-control-metrics.yaml</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="ref-metrics-alertmanager-examples-str"><a class="link" href="#ref-metrics-alertmanager-examples-str">10.3.2. Example Prometheus rules for alert notifications</a></h4>
<div class="paragraph _abstract">
<p>Example Prometheus rules for alert notifications are provided with the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The rules are specified in the example <code>prometheus-rules.yaml</code> file for use in a <a href="#proc-metrics-deploying-prometheus-str">Prometheus deployment</a>.</p>
</div>
<div class="paragraph">
<p>Alerting rules provide notifications about specific conditions observed in metrics.
Rules are declared on the Prometheus server, but Prometheus Alertmanager is responsible for alert notifications.</p>
</div>
<div class="paragraph">
<p>Prometheus alerting rules describe conditions using <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL</a> expressions that are continuously evaluated.</p>
</div>
<div class="paragraph">
<p>When an alert expression becomes true, the condition is met and the Prometheus server sends alert data to the Alertmanager.
Alertmanager then sends out a notification using the communication method configured for its deployment.</p>
</div>
<div class="paragraph">
<p>General points about the alerting rule definitions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>for</code> property is used with the rules to determine the period of time a condition must persist before an alert is triggered.</p>
</li>
<li>
<p>A tick is a basic ZooKeeper time unit, which is measured in milliseconds and configured using the <code>tickTime</code> parameter of <code>Kafka.spec.zookeeper.config</code>. For example, if ZooKeeper <code>tickTime=3000</code>, 3 ticks (3 x 3000) equals 9000 milliseconds.</p>
</li>
<li>
<p>The availability of the <code>ZookeeperRunningOutOfSpace</code> metric and alert is dependent on the Kubernetes configuration and storage implementation used. Storage implementations for certain platforms may not be able to supply the information on available space required for the metric to provide an alert.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alertmanager can be configured to use email, chat messages or other notification methods.
Adapt the default configuration of the example rules according to your specific needs.</p>
</div>
<div class="sect4">
<h5 id="example_altering_rules"><a class="link" href="#example_altering_rules">Example altering rules</a></h5>
<div class="paragraph">
<p>The <code>prometheus-rules.yaml</code> file contains example rules for the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kafka</p>
</li>
<li>
<p>ZooKeeper</p>
</li>
<li>
<p>Entity Operator</p>
</li>
<li>
<p>Kafka Connect</p>
</li>
<li>
<p>Kafka Bridge</p>
</li>
<li>
<p>MirrorMaker</p>
</li>
<li>
<p>Kafka Exporter</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A description of each of the example rules is provided in the file.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ref-metrics-dashboards-str"><a class="link" href="#ref-metrics-dashboards-str">10.3.3. Example Grafana dashboards</a></h4>
<div class="paragraph _abstract">
<p>If you deploy Prometheus to provide metrics,
you can use the example Grafana dashboards provided with Strimzi to monitor Strimzi components.</p>
</div>
<div class="paragraph">
<p>Example dashboards are provided in the <code>examples/metrics/grafana-dashboards</code> directory as JSON files.</p>
</div>
<div class="paragraph">
<p>All dashboards provide JVM metrics, as well as metrics specific to the component.
For example, the Grafana dashboard for Strimzi operators provides information on the number of reconciliations or custom resources they are processing.</p>
</div>
<div class="paragraph">
<p>The example dashboards don&#8217;t show all the metrics supported by Kafka.
The dashboards are populated with a representative set of metrics for monitoring.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<caption class="title">Table 5. Example Grafana dashboard files</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Example JSON file</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strimzi operators</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-operators.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZooKeeper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-zookeeper.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-connect.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka MirrorMaker 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-mirror-maker-2.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Bridge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-bridge.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cruise Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-cruise-control.json</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Exporter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strimzi-kafka-exporter.json</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When metrics are not available to the Kafka Exporter, because there is no traffic in the cluster yet, the Kafka Exporter Grafana dashboard will show <code>N/A</code> for numeric fields and <code>No data to show</code> for graphs.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-metrics-setup-str"><a class="link" href="#assembly-metrics-setup-str">10.4. Using Prometheus with Strimzi</a></h3>
<div class="paragraph">
<p>You can use Prometheus to provide monitoring data for the example Grafana dashboards provided with Strimzi.</p>
</div>
<div class="paragraph">
<p>To expose metrics in Prometheus format, you add configuration to a custom resource.
You will also need to make sure that the metrics are scraped by your monitoring stack.
Prometheus and Prometheus Alertmanager are used in the examples provided by Strimzi, but you can use also other compatible tools.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Deploying Prometheus metrics configuration</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Setting up Prometheus</a></p>
</li>
<li>
<p><a href="#proc-metrics-deploying-prometheus-alertmanager-str">Deploying Prometheus Alertmanager</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="proc-metrics-kafka-deploy-options-str"><a class="link" href="#proc-metrics-kafka-deploy-options-str">10.4.1. Deploying Prometheus metrics configuration</a></h4>
<div class="paragraph _abstract">
<p>Deploy Prometheus metrics configuration to use Prometheus with Strimzi.
Use the <code>metricsConfig</code> property to enable and configure Prometheus metrics.</p>
</div>
<div class="paragraph">
<p>You can use your own configuration or the <a href="#ref-metrics-prometheus-metrics-config-str">example custom resource configuration files provided with Strimzi</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kafka-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-connect-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-mirror-maker-2-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-bridge-metrics.yaml</code></p>
</li>
<li>
<p><code>kafka-cruise-control-metrics.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The example configuration files have relabeling rules and the configuration required to enable Prometheus metrics.
Prometheus scrapes metrics from target HTTP endpoints.
The example files are a good way to try Prometheus with Strimzi.</p>
</div>
<div class="paragraph">
<p>To apply the relabeling rules and metrics configuration, do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy the example configuration to your own custom resources</p>
</li>
<li>
<p>Deploy the custom resource with the metrics configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want to include <a href="#con-metrics-kafka-exporter-lag-str">Kafka Exporter</a> metrics, add <code>kafkaExporter</code> configuration to your <code>Kafka</code> resource.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Kafka Exporter provides only additional metrics related to consumer lag and consumer offsets.
For regular Kafka metrics, you have to configure the Prometheus metrics in <a href="#proc-metrics-kafka-deploy-options-str">Kafka brokers</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This procedure shows how to deploy Prometheus metrics configuration in the <code>Kafka</code> resource.
The process is the same when using the example files for other resources.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy the example custom resource with the Prometheus configuration.</p>
<div class="paragraph">
<p>For example, for each <code>Kafka</code> resource you apply the <code>kafka-metrics.yaml</code> file.</p>
</div>
<div class="listingblock">
<div class="title">Deploying the example configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f kafka-metrics.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can copy the example configuration in <code>kafka-metrics.yaml</code> to your own <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Copying the example configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka <em>&lt;kafka-configuration-file&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the <code>metricsConfig</code> property and the <code>ConfigMap</code> it references to your <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example metrics configuration for Kafka</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  kafka:
    # ...
    metricsConfig: <b class="conum">(1)</b>
      type: jmxPrometheusExporter
      valueFrom:
        configMapKeyRef:
          name: kafka-metrics
          key: kafka-metrics-config.yml
---
kind: ConfigMap <b class="conum">(2)</b>
apiVersion: v1
metadata:
  name: kafka-metrics
  labels:
    app: strimzi
data:
  kafka-metrics-config.yml: |
  # <em>metrics configuration...</em></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Copy the <code>metricsConfig</code> property that references the ConfigMap that contains metrics configuration.</p>
</li>
<li>
<p>Copy the whole <code>ConfigMap</code> that specifies the metrics configuration.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>For Kafka Bridge, you specify the <code>enableMetrics</code> property and set it to <code>true</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  # ...
  bootstrapServers: my-cluster-kafka:9092
  http:
    # ...
  enableMetrics: true
  # ...</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>To deploy Kafka Exporter, add <code>kafkaExporter</code> configuration.</p>
<div class="paragraph">
<p><code>kafkaExporter</code> configuration is only specified in the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Example configuration for deploying Kafka Exporter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  kafkaExporter:
    image: my-registry.io/my-org/my-exporter-cluster:latest <b class="conum">(1)</b>
    groupRegex: ".*" <b class="conum">(2)</b>
    topicRegex: ".*" <b class="conum">(3)</b>
    resources: <b class="conum">(4)</b>
      requests:
        cpu: 200m
        memory: 64Mi
      limits:
        cpu: 500m
        memory: 128Mi
    logging: debug <b class="conum">(5)</b>
    enableSaramaLogging: true <b class="conum">(6)</b>
    template: <b class="conum">(7)</b>
      pod:
        metadata:
          labels:
            label1: value1
        imagePullSecrets:
          - name: my-docker-credentials
        securityContext:
          runAsUser: 1000001
          fsGroup: 0
        terminationGracePeriodSeconds: 120
    readinessProbe: <b class="conum">(8)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
    livenessProbe: <b class="conum">(9)</b>
      initialDelaySeconds: 15
      timeoutSeconds: 5
# ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>ADVANCED OPTION: Container image configuration, which is <a href="./configuring.html#con-common-configuration-images-reference">recommended only in special situations</a>.</p>
</li>
<li>
<p>A regular expression to specify the consumer groups to include in the metrics.</p>
</li>
<li>
<p>A regular expression to specify the topics to include in the metrics.</p>
</li>
<li>
<p><a href="./configuring.html#con-common-configuration-resources-reference">CPU and memory resources to reserve</a>.</p>
</li>
<li>
<p>Logging configuration, to log messages with a given severity (debug, info, warn, error, fatal) or above.</p>
</li>
<li>
<p>Boolean to enable Sarama logging, a Go client library used by Kafka Exporter.</p>
</li>
<li>
<p><a href="./configuring.html#assembly-customizing-kubernetes-resources-str">Customization of deployment templates and pods</a>.</p>
</li>
<li>
<p><a href="./configuring.html#con-common-configuration-healthchecks-reference">Healthcheck readiness probes</a>.</p>
</li>
<li>
<p><a href="./configuring.html#con-common-configuration-healthchecks-reference">Healthcheck liveness probes</a>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For Kafka Exporter to be able to work properly, consumer groups need to be in use.
</td>
</tr>
</table>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#type-KafkaExporterTemplate-reference"><code>KafkaExporterTemplate</code> schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#con-common-configuration-prometheus-reference"><code>metricsConfig</code> schema reference</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="assembly-metrics-prometheus-str"><a class="link" href="#assembly-metrics-prometheus-str">10.4.2. Setting up Prometheus</a></h4>
<div class="paragraph">
<p><a href="https://prometheus.io/" target="_blank" rel="noopener">Prometheus</a> provides an open source set of components for systems monitoring and alert notification.</p>
</div>
<div class="paragraph">
<p>We describe here how you can use the <a href="https://github.com/coreos/prometheus-operator" target="_blank" rel="noopener">CoreOS Prometheus Operator</a> to run and manage a Prometheus server that is suitable for use in production environments, but with the correct configuration you can run any Prometheus server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The Prometheus server configuration uses service discovery to discover the pods in the cluster from which it gets metrics.  For this feature to work correctly, the service account used for running the Prometheus service pod must have access to the API server so it can retrieve the pod list.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="https://kubernetes.io/docs/concepts/services-networking/service/#discovering-services" target="_blank" rel="noopener">Discovering services</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="con-metrics-prometheus-options-str"><a class="link" href="#con-metrics-prometheus-options-str">Prometheus configuration</a></h5>
<div class="paragraph">
<p>Strimzi provides <a href="#assembly-metrics-config-files-str">example configuration files for the Prometheus server</a>.</p>
</div>
<div class="paragraph">
<p>A Prometheus YAML file is provided for deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prometheus.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional Prometheus-related configuration is also provided in the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prometheus-additional.yaml</code></p>
</li>
<li>
<p><code>prometheus-rules.yaml</code></p>
</li>
<li>
<p><code>strimzi-pod-monitor.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For Prometheus to obtain monitoring data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-metrics-deploying-prometheus-operator-str">Deploy the Prometheus Operator</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then use the configuration files to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-metrics-deploying-prometheus-operator-str">Deploy Prometheus</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Alerting rules</div>
<p>The <code>prometheus-rules.yaml</code> file provides <a href="#ref-metrics-alertmanager-examples-str">example alerting rule examples for use with Alertmanager</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="con-metrics-prometheus-resources-str"><a class="link" href="#con-metrics-prometheus-resources-str">Prometheus resources</a></h5>
<div class="paragraph">
<p>When you apply the Prometheus configuration, the following resources are created in your Kubernetes cluster and managed by the Prometheus Operator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>ClusterRole</code> that grants permissions to Prometheus to read the health endpoints exposed by the Kafka and ZooKeeper pods, cAdvisor and the kubelet for container metrics.</p>
</li>
<li>
<p>A <code>ServiceAccount</code> for the Prometheus pods to run under.</p>
</li>
<li>
<p>A <code>ClusterRoleBinding</code> which binds the <code>ClusterRole</code> to the <code>ServiceAccount</code>.</p>
</li>
<li>
<p>A <code>Deployment</code> to manage the Prometheus Operator pod.</p>
</li>
<li>
<p>A <code>PodMonitor</code> to manage the configuration of the Prometheus pod.</p>
</li>
<li>
<p>A <code>Prometheus</code> to manage the configuration of the Prometheus pod.</p>
</li>
<li>
<p>A <code>PrometheusRule</code> to manage alerting rules for the Prometheus pod.</p>
</li>
<li>
<p>A <code>Secret</code> to manage additional Prometheus settings.</p>
</li>
<li>
<p>A <code>Service</code> to allow applications running in the cluster to connect to Prometheus (for example, Grafana using Prometheus as datasource).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-prometheus-operator-str"><a class="link" href="#proc-metrics-deploying-prometheus-operator-str">Deploying the CoreOS Prometheus Operator</a></h5>
<div class="paragraph">
<p>To deploy the Prometheus Operator to your Kafka cluster, apply the YAML bundle resources file from the <a href="https://github.com/coreos/prometheus-operator">Prometheus CoreOS repository</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Download the <code>bundle.yaml</code> resources file from the repository.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -s https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml | sed -e '/[[:space:]]*namespace: [a-zA-Z0-9-]*$/s/namespace:[[:space:]]*[a-zA-Z0-9-]*$/namespace: <em>my-namespace</em>/' &gt; prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -s https://raw.githubusercontent.com/coreos/prometheus-operator/master/bundle.yaml | sed -e '' '/[[:space:]]*namespace: [a-zA-Z0-9-]*$/s/namespace:[[:space:]]*[a-zA-Z0-9-]*$/namespace: <em>my-namespace</em>/' &gt; prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace the example <code>namespace</code> with your own.</p>
</li>
<li>
<p>Use the latest <code>master</code> release as shown, or choose a release that is compatible with your version of Kubernetes (see the <a href="https://github.com/coreos/kube-prometheus#kubernetes-compatibility-matrix">Kubernetes compatibility matrix</a>).
The <code>master</code> release of the Prometheus Operator works with Kubernetes 1.18+.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If using OpenShift, specify a release of the <a href="https://github.com/openshift/prometheus-operator" target="_blank" rel="noopener">OpenShift fork</a> of the Prometheus Operator repository.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>(Optional) If it is not required, you can manually remove the <code>spec.template.spec.securityContext</code> property from the <code>prometheus-operator-deployment.yaml</code> file.</p>
</li>
<li>
<p>Deploy the Prometheus Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl create -f prometheus-operator-deployment.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="proc-metrics-deploying-prometheus-str"><a class="link" href="#proc-metrics-deploying-prometheus-str">Deploying Prometheus</a></h5>
<div class="paragraph _abstract">
<p>Use Prometheus to obtain monitoring data in your Kafka cluster.</p>
</div>
<div class="paragraph">
<p>You can use your own Prometheus deployment or deploy Prometheus using the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The example files include a configuration file for a Prometheus deployment and files for Prometheus-related resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-install/prometheus.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-install/prometheus-rules.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-install/strimzi-pod-monitor.yaml</code></p>
</li>
<li>
<p><code>examples/metrics/prometheus-additional-properties/prometheus-additional.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The deployment process creates a <code>ClusterRoleBinding</code> and discovers an Alertmanager instance in the namespace specified for the deployment.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
By default, the Prometheus Operator only supports jobs that include an <code>endpoints</code> role for service discovery. Targets are discovered and scraped for each endpoint port address. For endpoint discovery, the port address may be derived from service (<code>role: service</code>) or pod (<code>role: pod</code>) discovery.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Check the <a href="#ref-metrics-alertmanager-examples-str">example alerting rules provided</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Modify the Prometheus installation file (<code>prometheus.yaml</code>) according to the namespace Prometheus is going to be installed into:</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -i 's/namespace: .*/namespace: <em>my-namespace</em>/' prometheus.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">sed -i '' 's/namespace: .*/namespace: <em>my-namespace</em>/' prometheus.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>PodMonitor</code> resource in <code>strimzi-pod-monitor.yaml</code> to define Prometheus jobs that will scrape the metrics data from pods.</p>
<div class="paragraph">
<p>Update the <code>namespaceSelector.matchNames</code> property with the namespace where the pods to scrape the metrics from are running.</p>
</div>
<div class="paragraph">
<p><code>PodMonitor</code> is used to scrape data directly from pods for Apache Kafka, ZooKeeper, Operators, the Kafka Bridge and Cruise Control.</p>
</div>
</li>
<li>
<p>Edit the <code>prometheus.yaml</code> installation file to include additional configuration for scraping metrics directly from nodes.</p>
<div class="paragraph">
<p>The Grafana dashboards provided show metrics for CPU, memory and disk volume usage, which come directly from the Kubernetes cAdvisor agent and kubelet on the nodes.</p>
</div>
<div class="paragraph">
<p>The Prometheus Operator does not have a monitoring resource like <code>PodMonitor</code> for scraping the nodes, so the <code>prometheus-additional.yaml</code> file contains the additional configuration needed.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Create a <code>Secret</code> resource from the configuration file (<code>prometheus-additional.yaml</code> in the <code>examples/metrics/prometheus-additional-properties</code> directory):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f prometheus-additional.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Edit the <code>additionalScrapeConfigs</code> property in the <code>prometheus.yaml</code> file to include the name of the <code>Secret</code> and the <code>prometheus-additional.yaml</code> file.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Deploy the Prometheus resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f strimzi-pod-monitor.yaml
kubectl apply -f prometheus-rules.yaml
kubectl apply -f prometheus.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proc-metrics-deploying-prometheus-alertmanager-str"><a class="link" href="#proc-metrics-deploying-prometheus-alertmanager-str">10.4.3. Deploying Alertmanager</a></h4>
<div class="paragraph _abstract">
<p>Use Alertmanager to route alerts to a notification service.
<a href="https://prometheus.io/docs/alerting/alertmanager/" target="_blank" rel="noopener">Prometheus Alertmanager</a> is a component for handling alerts and routing them to a notification service.
Alertmanager supports an essential aspect of monitoring, which is to be notified of conditions that indicate potential issues based on alerting rules.</p>
</div>
<div class="paragraph">
<p>You can use the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi to deploy Alertmanager to send notifications to a Slack channel.
A configuration file defines the resources for deploying Alertmanager:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-install/alert-manager.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An additional configuration file provides the hook definitions for sending notifications from your Kafka cluster:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/prometheus-alertmanager-config/alert-manager-config.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following resources are defined on deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>Alertmanager</code> to manage the Alertmanager pod.</p>
</li>
<li>
<p>A <code>Secret</code> to manage the configuration of the Alertmanager.</p>
</li>
<li>
<p>A <code>Service</code> to provide an easy to reference hostname for other services to connect to Alertmanager (such as Prometheus).</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Metrics are configured for the Kafka cluster resource</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Prometheus is deployed</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a <code>Secret</code> resource from the Alertmanager configuration file (<code>alert-manager-config.yaml</code> in the <code>examples/metrics/prometheus-alertmanager-config</code> directory):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f alert-manager-config.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Update the <code>alert-manager-config.yaml</code> file to replace the:</p>
<div class="ulist">
<ul>
<li>
<p><code>slack_api_url</code> property with the actual value of the Slack API URL related to the application for the Slack workspace</p>
</li>
<li>
<p><code>channel</code> property with the actual Slack channel on which to send notifications</p>
</li>
</ul>
</div>
</li>
<li>
<p>Deploy Alertmanager:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f alert-manager.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="con-metrics-kafka-mini-kube-str"><a class="link" href="#con-metrics-kafka-mini-kube-str">10.4.4. Using metrics with Minikube</a></h4>
<div class="paragraph">
<p>When adding Prometheus and Grafana servers to an Apache Kafka deployment using Minikube, the memory available to the virtual machine should be increased (to 4 GB of RAM, for example, instead of the default 2 GB).</p>
</div>
<div class="paragraph">
<p>For information on how to increase the default amount of memory, see <a href="#deploy-kubernetes-str">Installing a local Kubernetes cluster with Minikube</a></p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/resource-usage-monitoring/">Prometheus - Monitoring Docker Container Metrics using cAdvisor</a> describes how to use cAdvisor (short for container Advisor) metrics with Prometheus to analyze and expose resource usage (CPU, Memory, and Disk) and performance data from running containers within pods on Kubernetes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-metrics-grafana-dashboard-str"><a class="link" href="#proc-metrics-grafana-dashboard-str">10.5. Enabling the example Grafana dashboards</a></h3>
<div class="paragraph _abstract">
<p>Use Grafana to provide visualizations of Prometheus metrics on customizable dashboards.</p>
</div>
<div class="paragraph">
<p>You can use your own Grafana deployment or deploy Grafana using the <a href="#assembly-metrics-config-files-str">example metrics configuration files</a> provided by Strimzi.
The example files include a configuration file for a Grafana deployment</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/grafana-install/grafana.yaml</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Strimzi also provides <a href="#ref-metrics-dashboards-str">example dashboard configuration files for Grafana</a> in JSON format.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>examples/metrics/grafana-dashboards</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This procedure uses the example Grafana configuration file and example dashboards.</p>
</div>
<div class="paragraph">
<p>The example dashboards are a good starting point for monitoring key metrics, but they don&#8217;t show all the metrics supported by Kafka.
You can modify the example dashboards or add other metrics, depending on your infrastructure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
No alert notification rules are defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When accessing a dashboard, you can use the <code>port-forward</code> command to forward traffic from the Grafana pod to the host.
The name of the Grafana pod is different for each user.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p><a href="#proc-metrics-kafka-deploy-options-str">Metrics are configured for the Kafka cluster resource</a></p>
</li>
<li>
<p><a href="#assembly-metrics-prometheus-str">Prometheus and Prometheus Alertmanager are deployed</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Deploy Grafana.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f grafana.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Get the details of the Grafana service.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get service grafana</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">NAME</th>
<th class="tableblock halign-left valign-top">TYPE</th>
<th class="tableblock halign-left valign-top">CLUSTER-IP</th>
<th class="tableblock halign-left valign-top">PORT(S)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">grafana</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ClusterIP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">172.30.123.40</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3000/TCP</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note the port number for port forwarding.</p>
</div>
</li>
<li>
<p>Use <code>port-forward</code> to redirect the Grafana user interface to <code>localhost:3000</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl port-forward svc/grafana 3000:3000</code></pre>
</div>
</div>
</li>
<li>
<p>In a web browser, access the Grafana login screen using the URL <code><a href="http://localhost:3000" class="bare">http://localhost:3000</a></code>.</p>
<div class="paragraph">
<p>The Grafana Log In page appears.</p>
</div>
</li>
<li>
<p>Enter your user name and password, and then click <strong>Log In</strong>.</p>
<div class="paragraph">
<p>The default Grafana user name and password are both <code>admin</code>. After logging in for the first time, you can change the password.</p>
</div>
</li>
<li>
<p>In <strong>Configuration &gt; Data Sources</strong>, add Prometheus as a <em>data source</em>.</p>
<div class="ulist">
<ul>
<li>
<p>Specify a name</p>
</li>
<li>
<p>Add <em>Prometheus</em> as the type</p>
</li>
<li>
<p>Specify a Prometheus server URL (http://prometheus-operated:9090)</p>
<div class="paragraph">
<p>Save and test the connection when you have added the details.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Click the <strong>+</strong> icon and then click <strong>Import</strong>.</p>
</li>
<li>
<p>In <code>examples/metrics/grafana-dashboards</code>, copy the JSON of the dashboard to import.</p>
</li>
<li>
<p>Paste the JSON into the text box, and then click <strong>Load</strong>.</p>
</li>
<li>
<p>Repeat steps 7-9 for the other example Grafana dashboards.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The imported Grafana dashboards are available to view from the <strong>Dashboards</strong> home page.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-distributed-tracing-str"><a class="link" href="#assembly-distributed-tracing-str">11. Introducing distributed tracing</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Distributed tracing tracks the progress of transactions between applications in a distributed system.
In a microservices architecture, tracing tracks the progress of transactions between services.
Trace data is useful for monitoring application performance and investigating issues with target systems and end-user applications.</p>
</div>
<div class="paragraph">
<p>In Strimzi, tracing facilitates the end-to-end tracking of messages: from source systems to Kafka, and then from Kafka to target systems and applications.
Distributed tracing complements the monitoring of metrics in Grafana dashboards, as well as the component loggers.</p>
</div>
<div class="paragraph">
<p>Support for tracing is built in to the following Kafka components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MirrorMaker to trace messages from a source cluster to a target cluster</p>
</li>
<li>
<p>Kafka Connect to trace messages consumed and produced by Kafka Connect</p>
</li>
<li>
<p>Kafka Bridge to trace messages between Kafka and HTTP client applications</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tracing is not supported for Kafka brokers.</p>
</div>
<div class="paragraph">
<p>You enable and configure tracing for these components through their custom resources.
You add tracing configuration using <code>spec.template</code> properties.</p>
</div>
<div class="paragraph">
<p>You enable tracing by specifying a tracing type using the <code>spec.tracing.type</code> property:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>opentelemetry</code></dt>
<dd>
<p>Specify <code>type: opentelemetry</code> to use OpenTelemetry. By Default, OpenTelemetry uses the OTLP (OpenTelemetry Protocol) exporter and endpoint to get trace data. You can specify other tracing systems supported by OpenTelemetry, including Jaeger tracing. To do this, you change the OpenTelemetry exporter and endpoint in the tracing configuration.</p>
</dd>
<dt class="hdlist1"><code>jaeger</code></dt>
<dd>
<p>Specify <code>type:jaeger</code> to use OpenTracing and the Jaeger client to get trace data.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Support for <code>type: jaeger</code> tracing is deprecated.
The Jaeger clients are now retired and the OpenTracing project archived.
As such, we cannot guarantee their support for future Kafka versions.
If possible, we will maintain the support for <code>type: jaeger</code> tracing until June 2023 and remove it afterwards.
Please migrate to OpenTelemetry as soon as possible.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="con-overview-tracing-str"><a class="link" href="#con-overview-tracing-str">11.1. Tracing options</a></h3>
<div class="paragraph _abstract">
<p>Use OpenTelemetry or OpenTracing (deprecated) with the Jaeger tracing system.</p>
</div>
<div class="paragraph">
<p>OpenTelemetry and OpenTracing provide API specifications that are independent from the tracing or monitoring system.</p>
</div>
<div class="paragraph">
<p>You use the APIs to instrument application code for tracing.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instrumented applications generate <em>traces</em> for individual requests across the distributed system.</p>
</li>
<li>
<p>Traces are composed of <em>spans</em> that define specific units of work over time.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Jaeger is a tracing system for microservices-based distributed systems.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jaeger implements the tracing APIs and provides client libraries for instrumentation.</p>
</li>
<li>
<p>The Jaeger user interface allows you to query, filter, and analyze trace data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">The Jaeger user interface showing a simple query</div>
<p><span class="image"><img src="images/image_con-overview-distributed-tracing.png" alt="The Jaeger user interface showing a simple query"></span></p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://www.jaegertracing.io/docs/" target="_blank" rel="noopener">Jaeger documentation</a></p>
</li>
<li>
<p><a href="https://opentelemetry.io/docs/" target="_blank" rel="noopener">OpenTelemetry documentation</a></p>
</li>
<li>
<p><a href="https://opentracing.io/docs/" target="_blank" rel="noopener">OpenTracing documentation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ref-tracing-environment-variables-str"><a class="link" href="#ref-tracing-environment-variables-str">11.2. Environment variables for tracing</a></h3>
<div class="paragraph _abstract">
<p>Use environment variables when you are enabling tracing for Kafka components or initializing a tracer for Kafka clients.</p>
</div>
<div class="paragraph">
<p>Tracing environment variables are subject to change.
For the latest information, see the <a href="https://opentelemetry.io/docs/" target="_blank" rel="noopener">OpenTelemetry documentation</a> and <a href="https://opentracing.io/docs/" target="_blank" rel="noopener">OpenTracing documentation</a>.</p>
</div>
<div class="paragraph">
<p>The following tables describe the key environment variables for setting up a tracer.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. OpenTelemetry environment variables</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OTEL_SERVICE_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the Jaeger tracing service for OpenTelemetry.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OTEL_EXPORTER_JAEGER_ENDPOINT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The exporter used for tracing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OTEL_TRACES_EXPORTER</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The exporter used for tracing.
Set to <code>otlp</code> by default. If using Jaeger tracing, you need to set this environment variable as <code>jaeger</code>.
If you are using another tracing implementation, <a href="#proc-enabling-tracing-type-str">specify the exporter used</a>.</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. OpenTracing environment variables</caption>
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JAEGER_SERVICE_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the Jaeger tracer service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JAEGER_AGENT_HOST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hostname for communicating with the <code>jaeger-agent</code> through the User Datagram Protocol (UDP).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JAEGER_AGENT_PORT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The port used for communicating with the <code>jaeger-agent</code> through UDP.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="assembly-distributed-tracing-procedures-str"><a class="link" href="#assembly-distributed-tracing-procedures-str">11.3. Setting up distributed tracing</a></h3>
<div class="paragraph _abstract">
<p>Enable distributed tracing in Kafka components by specifying a tracing type in the custom resource.
Instrument tracers in Kafka clients for end-to-end tracking of messages.</p>
</div>
<div class="paragraph">
<p>To set up distributed tracing, follow these procedures in order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str">Enable tracing for MirrorMaker, Kafka Connect, and the Kafka Bridge</a></p>
</li>
<li>
<p>Set up tracing for clients:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-configuring-tracers-kafka-clients-str">Initialize a Jaeger tracer for Kafka clients</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Instrument clients with tracers:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-instrumenting-producers-consumers-for-opentracing-str">Instrument producers and consumers for tracing</a></p>
</li>
<li>
<p><a href="#proc-instrumenting-kafka-streams-with-tracers-str">Instrument Kafka Streams applications for tracing</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="prerequisites"><a class="link" href="#prerequisites">11.3.1. Prerequisites</a></h4>
<div class="paragraph">
<p>Before setting up distributed tracing, make sure Jaeger backend components are deployed to your Kubernetes cluster.
We recommend using the Jaeger operator for deploying Jaeger on your Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>For deployment instructions, see the <a href="https://www.jaegertracing.io/docs/" target="_blank" rel="noopener">Jaeger documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Setting up tracing for applications and systems beyond Strimzi is outside the scope of this content.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str"><a class="link" href="#proc-enabling-tracing-in-connect-mirror-maker-bridge-resources-str">11.3.2. Enabling tracing in MirrorMaker, Kafka Connect, and Kafka Bridge resources</a></h4>
<div class="paragraph _abstract">
<p>Distributed tracing is supported for MirrorMaker, MirrorMaker 2.0, Kafka Connect, and the Strimzi Kafka Bridge.
Configure the custom resource of the component to specify and enable a tracer service.</p>
</div>
<div class="paragraph">
<p>Enabling tracing in a resource triggers the following events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interceptor classes are updated in the integrated consumers and producers of the component.</p>
</li>
<li>
<p>For MirrorMaker, MirrorMaker 2.0, and Kafka Connect, the tracing agent initializes a tracer based on the tracing configuration defined in the resource.</p>
</li>
<li>
<p>For the Kafka Bridge, a tracer based on the tracing configuration defined in the resource is initialized by the Kafka Bridge itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can enable tracing that uses OpenTelemetry or OpenTracing.</p>
</div>
<div class="paragraph">
<div class="title">Tracing in MirrorMaker and MirrorMaker 2.0</div>
<p>For MirrorMaker and MirrorMaker 2.0, messages are traced from the source cluster to the target cluster. The trace data records messages entering and leaving the MirrorMaker or MirrorMaker 2.0 component.</p>
</div>
<div class="paragraph">
<div class="title">Tracing in Kafka Connect</div>
<p>For Kafka Connect, only messages produced and consumed by Kafka Connect are traced. To trace messages sent between Kafka Connect and external systems, you must configure tracing in the connectors for those systems.</p>
</div>
<div class="paragraph">
<div class="title">Tracing in the Kafka Bridge</div>
<p>For the Kafka Bridge, messages produced and consumed by the Kafka Bridge are traced. Incoming HTTP requests from client applications to send and receive messages through the Kafka Bridge are also traced.
To have end-to-end tracing, you must configure tracing in your HTTP clients.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform these steps for each <code>KafkaMirrorMaker</code>, <code>KafkaMirrorMaker2</code>, <code>KafkaConnect</code>, and <code>KafkaBridge</code> resource.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <code>spec.template</code> property, configure the tracer service.</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Use the <a href="#ref-tracing-environment-variables-str">tracing environment variables</a> as template configuration properties.</p>
</li>
<li>
<p>For OpenTelemetry, set the <code>spec.tracing.type</code> property to <code>opentelemetry</code>.</p>
</li>
<li>
<p>For OpenTracing, set the <code>spec.tracing.type</code> property to <code>jaeger</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="title">Example tracing configuration for Kafka Connect using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
  #...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for MirrorMaker using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker
metadata:
  name: my-mirror-maker
spec:
  #...
  template:
    mirrorMakerContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for MirrorMaker 2.0 using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mm2-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for the Kafka Bridge using OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  #...
  template:
    bridgeContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-otel-service
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otlp-host:4317"
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for Kafka Connect using OpenTracing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnect
metadata:
  name: my-connect-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: JAEGER_SERVICE_NAME
          value: my-jaeger-service
        - name: JAEGER_AGENT_HOST
          value: jaeger-agent-name
        - name: JAEGER_AGENT_PORT
          value: "6831"
  tracing:
    type: jaeger
  #...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for MirrorMaker using OpenTracing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker
metadata:
  name: my-mirror-maker
spec:
  #...
  template:
    mirrorMakerContainer:
      env:
        - name: JAEGER_SERVICE_NAME
          value: my-jaeger-service
        - name: JAEGER_AGENT_HOST
          value: jaeger-agent-name
        - name: JAEGER_AGENT_PORT
          value: "6831"
  tracing:
    type: jaeger
#...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for MirrorMaker 2.0 using OpenTracing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mm2-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: JAEGER_SERVICE_NAME
          value: my-jaeger-service
        - name: JAEGER_AGENT_HOST
          value: jaeger-agent-name
        - name: JAEGER_AGENT_PORT
          value: "6831"
  tracing:
    type: jaeger
#...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example tracing configuration for the Kafka Bridge using OpenTracing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaBridge
metadata:
  name: my-bridge
spec:
  #...
  template:
    bridgeContainer:
      env:
        - name: JAEGER_SERVICE_NAME
          value: my-jaeger-service
        - name: JAEGER_AGENT_HOST
          value: jaeger-agent-name
        - name: JAEGER_AGENT_PORT
          value: "6831"
  tracing:
    type: jaeger
#...</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Create or update the resource:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl apply -f <em>&lt;resource_configuration_file&gt;</em></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-configuring-tracers-kafka-clients-str"><a class="link" href="#proc-configuring-tracers-kafka-clients-str">11.3.3. Initializing tracing for Kafka clients</a></h4>
<div class="paragraph _abstract">
<p>Initialize a tracer, then instrument your client applications for distributed tracing.
You can instrument Kafka producer and consumer clients, and Kafka Streams API applications.
You can initialize a tracer for OpenTracing or OpenTelemetry.</p>
</div>
<div class="paragraph">
<p>Configure and initialize a tracer using a set of <a href="#ref-tracing-environment-variables-str">tracing environment variables</a>.</p>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>In each client application add the dependencies for the tracer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the Maven dependencies to the <code>pom.xml</code> file for the client application:</p>
<div class="listingblock">
<div class="title">Dependencies for OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
    &lt;artifactId&gt;opentelemetry-sdk-extension-autoconfigure&lt;/artifactId&gt;
    &lt;version&gt;1.18.0-alpha&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.opentelemetry.instrumentation&lt;/groupId&gt;
  &lt;artifactId&gt;opentelemetry-kafka-clients-{OpenTelemetryKafkaClient}&lt;/artifactId&gt;
  &lt;version&gt;1.18.0-alpha&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;
  &lt;artifactId&gt;opentelemetry-exporter-otlp&lt;/artifactId&gt;
  &lt;version&gt;1.18.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Dependencies for OpenTracing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.jaegertracing&lt;/groupId&gt;
    &lt;artifactId&gt;jaeger-client&lt;/artifactId&gt;
    &lt;version&gt;1.3.2&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;io.opentracing.contrib&lt;/groupId&gt;
  &lt;artifactId&gt;opentracing-kafka-client&lt;/artifactId&gt;
  &lt;version&gt;0.1.15&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Define the configuration of the tracer using the <a href="#ref-tracing-environment-variables-str">tracing environment variables</a>.</p>
</li>
<li>
<p>Create a tracer, which is initialized with the environment variables:</p>
<div class="listingblock">
<div class="title">Creating a tracer for OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">OpenTelemetry ot = GlobalOpenTelemetry.get();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Creating a tracer for OpenTracing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Tracer tracer = Configuration.fromEnv().getTracer();</code></pre>
</div>
</div>
</li>
<li>
<p>Register the tracer as a global tracer:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">GlobalTracer.register(tracer);</code></pre>
</div>
</div>
</li>
<li>
<p>Instrument your client:</p>
<div class="ulist">
<ul>
<li>
<p><a href="#proc-instrumenting-producers-consumers-for-opentracing-str">Instrumenting producers and consumers for tracing</a></p>
</li>
<li>
<p><a href="#proc-instrumenting-kafka-streams-with-tracers-str">Instrumenting Kafka Streams applications for tracing</a></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="proc-instrumenting-producers-consumers-for-opentracing-str"><a class="link" href="#proc-instrumenting-producers-consumers-for-opentracing-str">11.3.4. Instrumenting producers and consumers for tracing</a></h4>
<div class="paragraph _abstract">
<p>Instrument application code to enable tracing in Kafka producers and consumers.
Use a decorator pattern or interceptors to instrument your Java producer and consumer application code for tracing.
You can then record traces when messages are produced or retrieved from a topic.</p>
</div>
<div class="paragraph">
<p>OpenTelemetry and OpenTracing instrumentation projects provide classes that support instrumentation of producers and consumers.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Decorator instrumentation</dt>
<dd>
<p>For decorator instrumentation, create a modified producer or consumer instance for tracing. Decorator instrumentation is different for OpenTelemetry and OpenTracing.</p>
</dd>
<dt class="hdlist1">Interceptor instrumentation</dt>
<dd>
<p>For interceptor instrumentation, add the tracing capability to the consumer or producer configuration. Interceptor instrumentation is the same for OpenTelemetry and OpenTracing.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-configuring-tracers-kafka-clients-str">initialized tracing for the client</a>.</p>
<div class="paragraph">
<p>You enable instrumentation in producer and consumer applications by adding the tracing JARs as dependencies to your project.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform these steps in the application code of each producer and consumer application.
Instrument your client application code using either a decorator pattern or interceptors.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To use a decorator pattern, create a modified producer or consumer instance to send or receive messages.</p>
<div class="paragraph">
<p>You pass the original <code>KafkaProducer</code> or <code>KafkaConsumer</code> class.</p>
</div>
<div class="listingblock">
<div class="title">Example decorator instrumentation for OpenTelemetry</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Producer instance
Producer &lt; String, String &gt; op = new KafkaProducer &lt; &gt; (
    configs,
    new StringSerializer(),
    new StringSerializer()
    );
    Producer &lt; String, String &gt; producer = tracing.wrap(op);
KafkaTracing tracing = KafkaTracing.create(GlobalOpenTelemetry.get());
producer.send(...);

//consumer instance
Consumer&lt;String, String&gt; oc = new KafkaConsumer&lt;&gt;(
    configs,
    new StringDeserializer(),
    new StringDeserializer()
    );
    Consumer&lt;String, String&gt; consumer = tracing.wrap(oc);
consumer.subscribe(Collections.singleton("mytopic"));
ConsumerRecords&lt;Integer, String&gt; records = consumer.poll(1000);
ConsumerRecord&lt;Integer, String&gt; record = ...
SpanContext spanContext = TracingKafkaUtils.extractSpanContext(record.headers(), tracer);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example decorator instrumentation for OpenTracing</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//producer instance
KafkaProducer&lt;Integer, String&gt; producer = new KafkaProducer&lt;&gt;(senderProps);
TracingKafkaProducer&lt;Integer, String&gt; tracingProducer = new TracingKafkaProducer&lt;&gt;(producer, tracer);
TracingKafkaProducer.send(...)

//consumer instance
KafkaConsumer&lt;Integer, String&gt; consumer = new KafkaConsumer&lt;&gt;(consumerProps);
TracingKafkaConsumer&lt;Integer, String&gt; tracingConsumer = new TracingKafkaConsumer&lt;&gt;(consumer, tracer);
tracingConsumer.subscribe(Collections.singletonList("mytopic"));
ConsumerRecords&lt;Integer, String&gt; records = tracingConsumer.poll(1000);
ConsumerRecord&lt;Integer, String&gt; record = ...
SpanContext spanContext = TracingKafkaUtils.extractSpanContext(record.headers(), tracer);</code></pre>
</div>
</div>
</li>
<li>
<p>To use interceptors, set the interceptor class in the producer or consumer configuration.</p>
<div class="paragraph">
<p>You use the <code>KafkaProducer</code> and <code>KafkaConsumer</code> classes in the usual way.
The <code>TracingProducerInterceptor</code> and <code>TracingConsumerInterceptor</code> interceptor classes take care of the tracing capability.</p>
</div>
<div class="listingblock">
<div class="title">Example producer configuration using interceptors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">senderProps.put(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG,
    TracingProducerInterceptor.class.getName());

KafkaProducer&lt;Integer, String&gt; producer = new KafkaProducer&lt;&gt;(senderProps);
producer.send(...);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example consumer configuration using interceptors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">consumerProps.put(ConsumerConfig.INTERCEPTOR_CLASSES_CONFIG,
    TracingConsumerInterceptor.class.getName());

KafkaConsumer&lt;Integer, String&gt; consumer = new KafkaConsumer&lt;&gt;(consumerProps);
consumer.subscribe(Collections.singletonList("messages"));
ConsumerRecords&lt;Integer, String&gt; records = consumer.poll(1000);
ConsumerRecord&lt;Integer, String&gt; record = ...
SpanContext spanContext = TracingKafkaUtils.extractSpanContext(record.headers(), tracer);</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-instrumenting-kafka-streams-with-tracers-str"><a class="link" href="#proc-instrumenting-kafka-streams-with-tracers-str">11.3.5. Instrumenting Kafka Streams applications for tracing</a></h4>
<div class="paragraph _abstract">
<p>Instrument application code to enable tracing in Kafka Streams API applications.
Use a decorator pattern or interceptors to instrument your Kafka Streams API applications for tracing.
You can then record traces when messages are produced or retrieved from a topic.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Decorator instrumentation</dt>
<dd>
<p>For decorator instrumentation, create a modified Kafka Streams instance for tracing. The OpenTracing instrumentation project provides a <code>TracingKafkaClientSupplier</code> class that supports instrumentation of Kafka Streams.
You create a wrapped instance of the <code>TracingKafkaClientSupplier</code> supplier interface, which provides tracing instrumentation for Kafka Streams.
For OpenTelemetry, the process is the same but you need to create a custom <code>TracingKafkaClientSupplier</code> class to provide the support.</p>
</dd>
<dt class="hdlist1">Interceptor instrumentation</dt>
<dd>
<p>For interceptor instrumentation, add the tracing capability to the Kafka Streams producer and consumer configuration.</p>
</dd>
</dl>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-configuring-tracers-kafka-clients-str">initialized tracing for the client</a>.</p>
<div class="paragraph">
<p>You enable instrumentation in Kafka Streams applications by adding the tracing JARs as dependencies to your project.</p>
</div>
</li>
<li>
<p>To instrument Kafka Streams with OpenTelemetry, you&#8217;ll need to write a custom <code>TracingKafkaClientSupplier</code>.</p>
</li>
<li>
<p>The custom <code>TracingKafkaClientSupplier</code> can extend Kafka&#8217;s <code>DefaultKafkaClientSupplier</code>, overriding the producer and consumer creation methods to wrap the instances with the telemetry-related code.</p>
<div class="listingblock">
<div class="title">Example custom <code>TracingKafkaClientSupplier</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private class TracingKafkaClientSupplier extends DefaultKafkaClientSupplier {
    @Override
    public Producer&lt;byte[], byte[]&gt; getProducer(Map&lt;String, Object&gt; config) {
        KafkaTelemetry telemetry = KafkaTelemetry.create(GlobalOpenTelemetry.get());
        return telemetry.wrap(super.getProducer(config));
    }

    @Override
    public Consumer&lt;byte[], byte[]&gt; getConsumer(Map&lt;String, Object&gt; config) {
        KafkaTelemetry telemetry = KafkaTelemetry.create(GlobalOpenTelemetry.get());
        return telemetry.wrap(super.getConsumer(config));
    }

    @Override
    public Consumer&lt;byte[], byte[]&gt; getRestoreConsumer(Map&lt;String, Object&gt; config) {
        return this.getConsumer(config);
    }

    @Override
    public Consumer&lt;byte[], byte[]&gt; getGlobalConsumer(Map&lt;String, Object&gt; config) {
        return this.getConsumer(config);
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>Perform these steps for each Kafka Streams API application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To use a decorator pattern, create an instance of the <code>TracingKafkaClientSupplier</code> supplier interface, then provide the supplier interface to <code>KafkaStreams</code>.</p>
<div class="listingblock">
<div class="title">Example decorator instrumentation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KafkaClientSupplier supplier = new TracingKafkaClientSupplier(tracer);
KafkaStreams streams = new KafkaStreams(builder.build(), new StreamsConfig(config), supplier);
streams.start();</code></pre>
</div>
</div>
</li>
<li>
<p>To use interceptors, set the interceptor class in the Kafka Streams producer and consumer configuration.</p>
<div class="paragraph">
<p>The <code>TracingProducerInterceptor</code> and <code>TracingConsumerInterceptor</code> interceptor classes take care of the tracing capability.</p>
</div>
<div class="listingblock">
<div class="title">Example producer and consumer configuration using interceptors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">props.put(StreamsConfig.PRODUCER_PREFIX + ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, TracingProducerInterceptor.class.getName());
props.put(StreamsConfig.CONSUMER_PREFIX + ConsumerConfig.INTERCEPTOR_CLASSES_CONFIG, TracingConsumerInterceptor.class.getName());</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="proc-enabling-tracing-type-str"><a class="link" href="#proc-enabling-tracing-type-str">11.3.6. Introducing a different OpenTelemetry tracing system</a></h4>
<div class="paragraph _abstract">
<p>Instead of the default OTLP system, you can specify other tracing systems that are supported by OpenTelemetry.
You do this by adding the required artifacts to the Kafka image provided with Strimzi.
Any required implementation specific environment variables must also be set.
You then enable the new tracing implementation using the <code>OTEL_TRACES_EXPORTER</code> environment variable.</p>
</div>
<div class="paragraph">
<p>This procedure shows how to implement Zipkin tracing.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Add the tracing artifacts to the <code>/opt/kafka/libs/</code> directory of the Strimzi Kafka image.</p>
<div class="paragraph">
<p>You can use the Kafka container image on the <a href="https://quay.io/organization/strimzi" target="_blank" rel="noopener">Container Registry</a> as a base image for creating a new custom image.</p>
</div>
<div class="listingblock">
<div class="title">OpenTelemetry artifact for Zipkin</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-env hljs" data-lang="env">io.opentelemetry:opentelemetry-exporter-zipkin</code></pre>
</div>
</div>
</li>
<li>
<p>Set the tracing exporter and endpoint for the new tracing implementation.</p>
<div class="listingblock">
<div class="title">Example Zikpin tracer configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaMirrorMaker2
metadata:
  name: my-mm2-cluster
spec:
  #...
  template:
    connectContainer:
      env:
        - name: OTEL_SERVICE_NAME
          value: my-zipkin-service
        - name: OTEL_EXPORTER_ZIPKIN_ENDPOINT
          value: http://zipkin-exporter-host-name:9411/api/v2/spans # <b class="conum">(1)</b>
        - name: OTEL_TRACES_EXPORTER
          value: zipkin # <b class="conum">(2)</b>
  tracing:
    type: opentelemetry
#...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Specifies the Zipkin endpoint to connect to.</p>
</li>
<li>
<p>The Zipkin exporter.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="ref-tracing-span-names-str"><a class="link" href="#ref-tracing-span-names-str">11.3.7. Custom span names</a></h4>
<div class="paragraph _abstract">
<p>A tracing <em>span</em> is a logical unit of work in Jaeger, with an operation name, start time, and duration.
Spans have built-in names, but you can specify custom span names in your Kafka client instrumentation where used.</p>
</div>
<div class="paragraph">
<p>Specifying custom span names is optional and only applies when using a decorator pattern <a href="#proc-instrumenting-producers-consumers-for-opentracing-str">in producer and consumer client instrumentation</a> or <a href="#proc-instrumenting-kafka-streams-with-tracers-str">Kafka Streams instrumentation</a>.</p>
</div>
<div class="sect4">
<h5 id="specifying_span_names_for_opentelemetry"><a class="link" href="#specifying_span_names_for_opentelemetry">Specifying span names for OpenTelemetry</a></h5>
<div class="paragraph">
<p>Custom span names cannot be specified directly with OpenTelemetry.
Instead, you retrieve span names by adding code to your client application to extract additional tags and attributes.</p>
</div>
<div class="listingblock">
<div class="title">Example code to extract attributes</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//Defines attribute extraction for a producer
private static class ProducerAttribExtractor implements AttributesExtractor &lt; ProducerRecord &lt; ? , ? &gt; , Void &gt; {
    @Override
    public void onStart(AttributesBuilder attributes, ProducerRecord &lt; ? , ? &gt; producerRecord) {
        set(attributes, AttributeKey.stringKey("prod_start"), "prod1");
    }
    @Override
    public void onEnd(AttributesBuilder attributes, ProducerRecord &lt; ? , ? &gt; producerRecord, @Nullable Void unused, @Nullable Throwable error) {
        set(attributes, AttributeKey.stringKey("prod_end"), "prod2");
    }
}
//Defines attribute extraction for a consumer
private static class ConsumerAttribExtractor implements AttributesExtractor &lt; ConsumerRecord &lt; ? , ? &gt; , Void &gt; {
    @Override
    public void onStart(AttributesBuilder attributes, ConsumerRecord &lt; ? , ? &gt; producerRecord) {
        set(attributes, AttributeKey.stringKey("con_start"), "con1");
    }
    @Override
    public void onEnd(AttributesBuilder attributes, ConsumerRecord &lt; ? , ? &gt; producerRecord, @Nullable Void unused, @Nullable Throwable error) {
        set(attributes, AttributeKey.stringKey("con_end"), "con2");
    }
}
//Extracts the attributes
public static void main(String[] args) throws Exception {
        Map &lt; String, Object &gt; configs = new HashMap &lt; &gt; (Collections.singletonMap(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092"));
        System.setProperty("otel.traces.exporter", "jaeger");
        System.setProperty("otel.service.name", "myapp1");
        KafkaTracing tracing = KafkaTracing.newBuilder(GlobalOpenTelemetry.get())
            .addProducerAttributesExtractors(new ProducerAttribExtractor())
            .addConsumerAttributesExtractors(new ConsumerAttribExtractor())
            .build();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="specifying_span_names_for_opentracing"><a class="link" href="#specifying_span_names_for_opentracing">Specifying span names for OpenTracing</a></h5>
<div class="paragraph">
<p>To specify custom span names for OpenTracing, pass a <code>BiFunction</code> object as an additional argument when instrumenting producers and consumers.</p>
</div>
<div class="paragraph">
<p>For more information on built-in names and specifying custom span names to instrument client application code in a decorator pattern, see the <a href="https://github.com/opentracing-contrib/java-kafka-client">OpenTracing Apache Kafka client instrumentation</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-upgrade-str"><a class="link" href="#assembly-upgrade-str">12. Upgrading Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>Strimzi can be upgraded to version latest to take advantage of new features and enhancements, performance improvements, and security options.</p>
</div>
<div class="paragraph">
<p>As part of the upgrade, you upgrade Kafka to the latest supported version.
Each Kafka release introduces new features, improvements, and bug fixes to your Strimzi deployment.</p>
</div>
<div class="paragraph">
<p>Strimzi can be <a href="#assembly-downgrade-str">downgraded</a> to the previous version if you encounter issues with the newer version.</p>
</div>
<div class="paragraph">
<p>Released versions of Strimzi are available from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a>.</p>
</div>
<div class="paragraph">
<div class="title">Upgrade downtime and availability</div>
<p>If topics are configured for high availability, upgrading Strimzi should not cause any downtime for consumers and producers that publish and read data from those topics.
Highly available topics have a replication factor of at least 3 and partitions distributed evenly among the brokers.</p>
</div>
<div class="paragraph">
<p>Upgrading Strimzi triggers rolling updates, where all brokers are restarted in turn, at different stages of the process.
During rolling updates, not all brokers are online, so overall <em>cluster availability</em> is temporarily reduced.
A reduction in cluster availability increases the chance that a broker failure will result in lost messages.</p>
</div>
<div class="sect2">
<h3 id="con-upgrade-paths-str"><a class="link" href="#con-upgrade-paths-str">12.1. Strimzi upgrade paths</a></h3>
<div class="paragraph _abstract">
<p>Two Strimzi upgrade paths are possible.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Incremental upgrade</dt>
<dd>
<p>Upgrading Strimzi from the previous minor version to version latest.</p>
</dd>
<dt class="hdlist1">Multi-version upgrade</dt>
<dd>
<p>Upgrading Strimzi from an old version to version latest within a single upgrade (skipping one or more intermediate versions).</p>
<div class="paragraph">
<p>For example, upgrading from Strimzi 0.24.0 directly to Strimzi latest.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
A multi-version Strimzi upgrade might still support the current version of a Kafka deployment.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="con-upgrade-paths-kafka-versions-str"><a class="link" href="#con-upgrade-paths-kafka-versions-str">12.1.1. Supported Kafka versions</a></h4>
<div class="paragraph">
<p>Decide which Kafka version to upgrade to before starting the Strimzi upgrade process.
You can review supported Kafka versions in the <a href="https://strimzi.io/downloads/" target="_blank" rel="noopener">Supported versions</a> table.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>Operators</strong> column lists all released Strimzi versions (the Strimzi version is often called the "Operator version").</p>
</li>
<li>
<p>The <strong>Kafka versions</strong> column lists the supported Kafka versions for each Strimzi version.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can only use a Kafka version supported by the version of Strimzi you are using.
You can upgrade to a higher Kafka version as long as it is supported by your version of Strimzi.
In some cases, you can also downgrade to a previous supported Kafka version.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-upgrade-paths-earlier-versions-str"><a class="link" href="#con-upgrade-paths-earlier-versions-str">12.1.2. Upgrading from a Strimzi version earlier than 0.22</a></h4>
<div class="paragraph">
<p>If you are upgrading to the latest version of Strimzi from a version prior to version 0.22, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade Strimzi to version 0.22 following the <a href="#con-upgrade-sequence-str">standard sequence</a>.</p>
</li>
<li>
<p>Convert Strimzi custom resources to <code>v1beta2</code> using the <em>API conversion tool</em> provided with Strimzi.</p>
</li>
<li>
<p>Do one of the following:</p>
<div class="ulist">
<ul>
<li>
<p>Upgrade Strimzi to a version between 0.23 and 0.26 (where the <code>ControlPlaneListener</code> feature gate is disabled by default).</p>
</li>
<li>
<p>Upgrade Strimzi to a version between 0.27 and 0.31 (where the <code>ControlPlaneListener</code> feature gate is enabled by default) with the <code>ControlPlaneListener</code> feature gate disabled.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enable the <code>ControlPlaneListener</code> feature gate.</p>
</li>
<li>
<p>Upgrade to Strimzi latest following the <a href="#con-upgrade-sequence-str">standard sequence</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Strimzi custom resources started using the <code>v1beta2</code> API version in release 0.22.
CRDs and custom resources must be converted <strong>before</strong> upgrading to Strimzi 0.23 or newer.
For information on using the API conversion tool, see the <a href="https://strimzi.io/docs/operators/0.24.0/deploying.html#assembly-upgrade-resources-str" target="_blank" rel="noopener">Strimzi 0.24.0 upgrade documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As an alternative to first upgrading to version 0.22, you can install the custom resources from version 0.22 and then convert the resources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ControlPlaneListener</code> feature is now permanently enabled in Strimzi.
You must upgrade to a version of Strimzi where it is disabled, then enable it using the
<code>STRIMZI_FEATURE_GATES</code> environment variable in the Cluster Operator configuration.</p>
</div>
<div class="listingblock">
<div class="title">Disabling the <code>ControlPlaneListener</code> feature gate</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_FEATURE_GATES
    value: -ControlPlaneListener</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Enabling the <code>ControlPlaneListener</code> feature gate</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_FEATURE_GATES
    value: +ControlPlaneListener</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="con-upgrade-sequence-str"><a class="link" href="#con-upgrade-sequence-str">12.2. Required upgrade sequence</a></h3>
<div class="paragraph _abstract">
<p>To upgrade brokers and clients without downtime, you <em>must</em> complete the Strimzi upgrade procedures in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure your Kubernetes cluster version is supported.</p>
<div class="paragraph">
<p>Strimzi latest requires Kubernetes 1.19 and later.</p>
</div>
<div class="paragraph">
<p>You can <a href="#con-upgrade-cluster-str">upgrade Kubernetes with minimal downtime</a>.</p>
</div>
</li>
<li>
<p><a href="#assembly-upgrade-cluster-operator-str">Upgrade the Cluster Operator</a>.</p>
</li>
<li>
<p><a href="#assembly-upgrading-kafka-versions-str">Upgrade all Kafka brokers and client applications</a> to the latest supported Kafka version.</p>
</li>
<li>
<p>Optional: Upgrade consumers and Kafka Streams applications <a href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">to use the <em>incremental cooperative rebalance</em> protocol</a> for partition rebalances.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="con-upgrade-cluster-str"><a class="link" href="#con-upgrade-cluster-str">12.3. Upgrading Kubernetes with minimal downtime</a></h3>
<div class="paragraph _abstract">
<p>If you are upgrading Kubernetes, refer to the Kubernetes upgrade documentation to check the upgrade path and the steps to upgrade your nodes correctly.
Before upgrading Kubernetes, <a href="https://strimzi.io/downloads/" target="_blank" rel="noopener">check the supported versions for your version of Strimzi</a>.</p>
</div>
<div class="paragraph">
<p>When performing your upgrade, you&#8217;ll want to keep your Kafka clusters available.</p>
</div>
<div class="paragraph">
<p>You can employ one of the following strategies:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configuring pod disruption budgets</p>
</li>
<li>
<p>Rolling pods by one of these methods:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Using the Strimzi Drain Cleaner</p>
</li>
<li>
<p>Manually by applying an annotation to your pod</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have to configure the pod disruption budget before using one of the methods to roll your pods.</p>
</div>
<div class="paragraph">
<p>For Kafka to stay operational, topics must also be replicated for high availability.
This requires topic configuration that specifies a replication factor of at least 3 and a minimum number of in-sync replicas to 1 less than the replication factor.</p>
</div>
<div class="listingblock">
<div class="title">Kafka topic replicated for high availability</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 1
  replicas: 3
  config:
    # ...
    min.insync.replicas: 2
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a highly available environment, the Cluster Operator maintains a minimum number of in-sync replicas for topics during the upgrade process so that there is no downtime.</p>
</div>
<div class="sect3">
<h4 id="rolling_pods_using_the_strimzi_drain_cleaner"><a class="link" href="#rolling_pods_using_the_strimzi_drain_cleaner">12.3.1. Rolling pods using the Strimzi Drain Cleaner</a></h4>
<div class="paragraph">
<p>You can use the Strimzi Drain Cleaner tool to evict nodes during an upgrade.
The Strimzi Drain Cleaner annotates pods with a rolling update pod annotation.
This informs the Cluster Operator to perform a rolling update of an evicted pod.</p>
</div>
<div class="paragraph">
<p>A pod disruption budget allows only a specified number of pods to be unavailable at a given time.
During planned maintenance of Kafka broker pods, a pod disruption budget ensures Kafka continues to run in a highly available environment.</p>
</div>
<div class="paragraph">
<p>You specify a pod disruption budget using a <code>template</code> customization for a Kafka component.
By default, pod disruption budgets allow only a single pod to be unavailable at a given time.</p>
</div>
<div class="paragraph">
<p>To do this, you set <code>maxUnavailable</code> to <code>0</code> (zero).
Reducing the maximum pod disruption budget to zero prevents voluntary disruptions, so pods must be evicted manually.</p>
</div>
<div class="listingblock">
<div class="title">Specifying a pod disruption budget</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
metadata:
  name: my-cluster
  namespace: myproject
spec:
  kafka:
    # ...
    template:
      podDisruptionBudget:
        maxUnavailable: 0
# ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rolling_pods_manually_while_keeping_topics_available"><a class="link" href="#rolling_pods_manually_while_keeping_topics_available">12.3.2. Rolling pods manually while keeping topics available</a></h4>
<div class="paragraph">
<p>During an upgrade, you can trigger a manual rolling update of pods through the Cluster Operator.
Using <code>Pod</code> resources, rolling updates restart the pods of resources with new pods.
As with using the Strimzi Drain Cleaner, you&#8217;ll need to set the <code>maxUnavailable</code> value to zero for the pod disruption budget.</p>
</div>
<div class="paragraph">
<p>You need to watch the pods that need to be drained.
You then add a pod annotation to make the update.</p>
</div>
<div class="paragraph">
<p>Here, the annotation updates a Kafka broker.</p>
</div>
<div class="listingblock">
<div class="title">Performing a manual rolling update on a Kafka broker pod</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl annotate pod <em>&lt;cluster_name&gt;</em>-kafka-<em>&lt;index&gt;</em> strimzi.io/manual-rolling-update=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You replace <em>&lt;cluster_name&gt;</em> with the name of the cluster.
Kafka broker pods are named <em>&lt;cluster-name&gt;</em>-kafka-<em>&lt;index&gt;</em>, where <em>&lt;index&gt;</em> starts at zero and ends at the total number of replicas minus one.
For example, <code>my-cluster-kafka-0</code>.</p>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/home/" target="_blank" rel="noopener">Kubernetes documentation</a></p>
</li>
<li>
<p><a href="./configuring.html#assembly-drain-cleaner-str">Draining pods using the Strimzi Drain Cleaner</a></p>
</li>
<li>
<p><a href="./configuring.html#replicating_topics_for_high_availability" target="_blank" rel="noopener">Replicating topics for high availability</a></p>
</li>
<li>
<p><a href="./configuring.html#type-PodDisruptionBudgetTemplate-reference" target="_blank" rel="noopener">PodDisruptionBudgetTemplate schema reference</a></p>
</li>
<li>
<p><a href="./configuring.html#proc-manual-rolling-update-pods-str" target="_blank" rel="noopener">Performing a rolling update using a pod annotation</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-upgrade-cluster-operator-str"><a class="link" href="#assembly-upgrade-cluster-operator-str">12.4. Upgrading the Cluster Operator</a></h3>
<div class="paragraph _abstract">
<p>Use the same method to upgrade the Cluster Operator as the initial method of deployment.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Using installation files</dt>
<dd>
<p>If you deployed the Cluster Operator using the installation YAML files, perform your upgrade by modifying the Operator installation files, as described in <a href="#proc-upgrading-the-co-str">Upgrading the Cluster Operator</a>.</p>
</dd>
<dt class="hdlist1">Using the OperatorHub.io</dt>
<dd>
<p>If you deployed Strimzi from <a href="https://operatorhub.io/operator/strimzi-kafka-operator" target="_blank" rel="noopener">OperatorHub.io</a>, use the Operator Lifecycle Manager (OLM) to change the update channel for the Strimzi operators to a new Strimzi version.</p>
<div class="paragraph">
<p>Updating the channel starts one of the following types of upgrade, depending on your chosen upgrade strategy:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>An automatic upgrade is initiated</p>
</li>
<li>
<p>A manual upgrade that requires approval before installation begins</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you subscribe to the <em>stable</em> channel, you can get automatic updates without changing channels.
However, enabling automatic updates is not recommended because of the potential for missing any pre-installation upgrade steps.
Use automatic upgrades only on version-specific channels.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information on using OperatorHub.io to upgrade Operators, see the <a href="https://olm.operatorframework.io/docs/" target="_blank" rel="noopener">Operator Lifecycle Manager documentation</a>.</p>
</div>
</dd>
<dt class="hdlist1">Using a Helm chart</dt>
<dd>
<p>If you deployed the Cluster Operator using a Helm chart, use <code>helm upgrade</code>.</p>
<div class="paragraph">
<p>The <code>helm upgrade</code> command does not upgrade the <a href="https://helm.sh/docs/chart_best_practices/custom_resource_definitions/" target="_blank" rel="noopener">Custom Resource Definitions for Helm</a>.
Install the new CRDs manually after upgrading the Cluster Operator.
You can access the CRDs from the <a href="https://github.com/strimzi/strimzi-kafka-operator/releases" target="_blank" rel="noopener">GitHub releases page</a> or find them in the <code>crd</code> subdirectory inside the Helm Chart.</p>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="con-upgrade-cluster-operator-unsupported-kafka-str"><a class="link" href="#con-upgrade-cluster-operator-unsupported-kafka-str">12.4.1. Upgrading the Cluster Operator returns Kafka version error</a></h4>
<div class="paragraph">
<p>If you upgrade the Cluster Operator and get an <em>unsupported Kafka version</em> error, your Kafka cluster deployment has an older Kafka version that is not supported by the new operator version.
This error applies to all installation methods.</p>
</div>
<div class="paragraph">
<p>If this error occurs, upgrade Kafka to a supported Kafka version.
Change the <code>spec.kafka.version</code> in the <code>Kafka</code> resource to the supported version.</p>
</div>
<div class="paragraph">
<p>You can use <code>kubectl</code> to check for error messages like this in the <code>status</code> of the <code>Kafka</code> resource.</p>
</div>
<div class="listingblock">
<div class="title">Checking the Kafka status for errors</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get kafka <em>&lt;kafka_cluster_name&gt;</em> -n <em>&lt;namespace&gt;</em> -o jsonpath='{.status.conditions}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code><em>&lt;kafka_cluster_name&gt;</em></code> with the name of your Kafka cluster and <code><em>&lt;namespace&gt;</em></code> with the Kubernetes namespace where the pod is running.</p>
</div>
</div>
<div class="sect3">
<h4 id="proc-upgrading-the-co-str"><a class="link" href="#proc-upgrading-the-co-str">12.4.2. Upgrading the Cluster Operator using installation files</a></h4>
<div class="paragraph _abstract">
<p>This procedure describes how to upgrade a Cluster Operator deployment to use Strimzi latest.</p>
</div>
<div class="paragraph">
<p>Follow this procedure if you deployed the Cluster Operator using the installation YAML files.</p>
</div>
<div class="paragraph">
<p>The availability of Kafka clusters managed by the Cluster Operator is not affected by the upgrade operation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Refer to the documentation supporting a specific version of Strimzi for information on how to upgrade to that version.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An existing Cluster Operator deployment is available.</p>
</li>
<li>
<p>You have <a href="#downloads-str">downloaded the release artifacts for Strimzi latest</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Take note of any configuration changes made to the existing Cluster Operator resources (in the <code>/install/cluster-operator</code> directory).
Any changes will be <strong>overwritten</strong> by the new version of the Cluster Operator.</p>
</li>
<li>
<p>Update your custom resources to reflect the supported configuration options available for Strimzi version latest.</p>
</li>
<li>
<p>Update the Cluster Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modify the installation files for the new Cluster Operator version according to the namespace the Cluster Operator is running in.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>If you modified one or more environment variables in your existing Cluster Operator <code>Deployment</code>, edit the
<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to use those environment variables.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have an updated configuration, deploy it along with the rest of the installation resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl replace -f install/cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the rolling updates to complete.</p>
</div>
</li>
<li>
<p>If the new Operator version no longer supports the Kafka version you are upgrading from, the Cluster Operator returns an error message to say the version is not supported.
Otherwise, no error message is returned.</p>
<div class="ulist">
<ul>
<li>
<p>If the error message is returned, upgrade to a Kafka version that is supported by the new Cluster Operator version:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Edit the <code>Kafka</code> custom resource.</p>
</li>
<li>
<p>Change the <code>spec.kafka.version</code> property to a supported Kafka version.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If the error message is <em>not</em> returned, go to the next step.
You will upgrade the Kafka version later.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Get the image for the Kafka pod to ensure the upgrade was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image tag shows the new Operator version. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">quay.io/strimzi/kafka:latest-kafka-3.3.2</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your Cluster Operator was upgraded to version latest but the version of Kafka running in the cluster it manages is unchanged.</p>
</div>
<div class="paragraph">
<p>Following the Cluster Operator upgrade, you must perform a <a href="#assembly-upgrading-kafka-versions-str">Kafka upgrade</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="assembly-upgrading-kafka-versions-str"><a class="link" href="#assembly-upgrading-kafka-versions-str">12.5. Upgrading Kafka</a></h3>
<div class="paragraph _abstract">
<p>After you have upgraded your Cluster Operator to latest, the next step is to upgrade all Kafka brokers to the latest supported version of Kafka.</p>
</div>
<div class="paragraph">
<p>Kafka upgrades are performed by the Cluster Operator through rolling updates of the Kafka brokers.</p>
</div>
<div class="paragraph">
<p>The Cluster Operator initiates rolling updates based on the Kafka cluster configuration.</p>
</div>
<table class="tableblock frame-all grid-all stripes-none stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">If <code>Kafka.spec.kafka.config</code> contains&#8230;&#8203;</th>
<th class="tableblock halign-left valign-top">The Cluster Operator initiates&#8230;&#8203;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both the <code>inter.broker.protocol.version</code> and the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A single rolling update. After the update, the <code>inter.broker.protocol.version</code> must be updated manually, followed by <code>log.message.format.version</code>.
Changing each will trigger a further rolling update.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either the <code>inter.broker.protocol.version</code> or the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two rolling updates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No configuration for the <code>inter.broker.protocol.version</code> or the <code>log.message.format.version</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Two rolling updates.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.
The <code>log.message.format.version</code> property for brokers and the <code>message.format.version</code> property for topics are deprecated and will be removed in a future release of Kafka.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As part of the Kafka upgrade, the Cluster Operator initiates rolling updates for ZooKeeper.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single rolling update occurs even if the ZooKeeper version is unchanged.</p>
</li>
<li>
<p>Additional rolling updates occur if the new version of Kafka requires a new ZooKeeper version.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="ref-kafka-versions-str"><a class="link" href="#ref-kafka-versions-str">12.5.1. Kafka versions</a></h4>
<div class="paragraph">
<p>Kafka&#8217;s log message format version and inter-broker protocol version specify, respectively, the log format version appended to messages and the version of the Kafka protocol used in a cluster.
To ensure the correct versions are used, the upgrade process involves making configuration changes to existing Kafka brokers and code changes to client applications (consumers and producers).</p>
</div>
<div class="paragraph">
<p>The following table shows the differences between Kafka versions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Kafka version differences</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kafka version</th>
<th class="tableblock halign-left valign-top">Inter-broker protocol version</th>
<th class="tableblock halign-left valign-top">Log message format version</th>
<th class="tableblock halign-left valign-top">ZooKeeper version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.6.3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Inter-broker protocol version</div>
<p>In Kafka, the network protocol used for inter-broker communication is called the <em>inter-broker protocol</em>.
Each version of Kafka has a compatible version of the inter-broker protocol.
The minor version of the protocol typically increases to match the minor version of Kafka, as shown in the preceding table.</p>
</div>
<div class="paragraph">
<p>The inter-broker protocol version is set cluster wide in the <code>Kafka</code> resource.
To change it, you edit the <code>inter.broker.protocol.version</code> property in <code>Kafka.spec.kafka.config</code>.</p>
</div>
<div class="paragraph">
<div class="title">Log message format version</div>
<p>When a producer sends a message to a Kafka broker, the message is encoded using a specific format.
The format can change between Kafka releases, so messages specify which version of the message format they were encoded with.</p>
</div>
<div class="paragraph">
<p>The properties used to set a specific message format version are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>message.format.version</code> property for topics</p>
</li>
<li>
<p><code>log.message.format.version</code> property for Kafka brokers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From Kafka 3.0.0, the message format version values are assumed to match the <code>inter.broker.protocol.version</code> and don&#8217;t need to be set.
The values reflect the Kafka version used.</p>
</div>
<div class="paragraph">
<p>When upgrading to Kafka 3.0.0 or higher, you can remove these settings when you update the <code>inter.broker.protocol.version</code>.
Otherwise, set the message format version based on the Kafka version you are upgrading to.</p>
</div>
<div class="paragraph">
<p>The default value of <code>message.format.version</code> for a topic is defined by the <code>log.message.format.version</code> that is set on the Kafka broker.
You can manually set the <code>message.format.version</code> of a topic by modifying its topic configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="con-strategies-for-upgrading-clients-str"><a class="link" href="#con-strategies-for-upgrading-clients-str">12.5.2. Strategies for upgrading clients</a></h4>
<div class="paragraph">
<p>The right approach to upgrading your client applications (including Kafka Connect connectors) depends on your particular circumstances.</p>
</div>
<div class="paragraph">
<p>Consuming applications need to receive messages in a message format that they understand. You can ensure that this is the case in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By upgrading all the consumers for a topic <em>before</em> upgrading any of the producers.</p>
</li>
<li>
<p>By having the brokers down-convert messages to an older format.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using broker down-conversion puts extra load on the brokers, so it is not ideal to rely on down-conversion for all topics for a prolonged period of time.
For brokers to perform optimally they should not be down converting messages at all.</p>
</div>
<div class="paragraph">
<p>Broker down-conversion is configured in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The topic-level <code>message.format.version</code> configures it for a single topic.</p>
</li>
<li>
<p>The broker-level <code>log.message.format.version</code> is the default for topics that do not have the topic-level <code>message.format.version</code> configured.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Messages published to a topic in a new-version format will be visible to consumers, because brokers perform down-conversion when they receive messages from producers, not when they are sent to consumers.</p>
</div>
<div class="paragraph">
<p>Common strategies you can use to upgrade your clients are described as follows.
Other strategies for upgrading client applications are also possible.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The steps outlined in each strategy change slightly when upgrading to Kafka 3.0.0 or later.
From Kafka 3.0.0, the message format version values are assumed to match the <code>inter.broker.protocol.version</code> and don&#8217;t need to be set.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Broker-level consumers first strategy</div>
<ol class="arabic">
<li>
<p>Upgrade all the consuming applications.</p>
</li>
<li>
<p>Change the broker-level <code>log.message.format.version</code> to the new version.</p>
</li>
<li>
<p>Upgrade all the producing applications.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This strategy is straightforward, and avoids any broker down-conversion.
However, it assumes that all consumers in your organization can be upgraded in a coordinated way, and it does not work for applications that are both consumers and producers.
There is also a risk that, if there is a problem with the upgraded clients, new-format messages might get added to the message log so that you cannot revert to the previous consumer version.</p>
</div>
<div class="paragraph">
<div class="title">Topic-level consumers first strategy</div>
<p>For each topic:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade all the consuming applications.</p>
</li>
<li>
<p>Change the topic-level <code>message.format.version</code> to the new version.</p>
</li>
<li>
<p>Upgrade all the producing applications.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This strategy avoids any broker down-conversion, and means you can proceed on a topic-by-topic basis. It does not work for applications that are both consumers and producers of the same topic. Again, it has the risk that, if there is a problem with the upgraded clients, new-format messages might get added to the message log.</p>
</div>
<div class="paragraph">
<div class="title">Topic-level consumers first strategy with down conversion</div>
<p>For each topic:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change the topic-level <code>message.format.version</code> to the old version
(or rely on the topic defaulting to the broker-level <code>log.message.format.version</code>).</p>
</li>
<li>
<p>Upgrade all the consuming and producing applications.</p>
</li>
<li>
<p>Verify that the upgraded applications function correctly.</p>
</li>
<li>
<p>Change the topic-level <code>message.format.version</code> to the new version.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This strategy requires broker down-conversion, but the load on the brokers is minimized because it is only required for a single topic (or small group of topics) at a time. It also works for applications that are both consumers and producers of the same topic. This approach ensures that the upgraded producers and consumers are working correctly before you commit to using the new message format version.</p>
</div>
<div class="paragraph">
<p>The main drawback of this approach is that it can be complicated to manage in a cluster with many topics and applications.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is also possible to apply multiple strategies.
For example, for the first few applications and topics the
"per-topic consumers first, with down conversion" strategy can be used.
When this has proved successful another, more efficient strategy can be considered acceptable to use instead.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="con-versions-and-images-str"><a class="link" href="#con-versions-and-images-str">12.5.3. Kafka version and image mappings</a></h4>
<div class="paragraph">
<p>When upgrading Kafka, consider your settings for the <code>STRIMZI_KAFKA_IMAGES</code> environment variable and the <code>Kafka.spec.kafka.version</code> property.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each <code>Kafka</code> resource can be configured with a <code>Kafka.spec.kafka.version</code>.</p>
</li>
<li>
<p>The Cluster Operator&#8217;s <code>STRIMZI_KAFKA_IMAGES</code> environment variable provides a mapping between the Kafka version and the image to be used when that version is requested in a given <code>Kafka</code> resource.</p>
<div class="ulist">
<ul>
<li>
<p>If <code>Kafka.spec.kafka.image</code> is not configured, the default image for the given version is used.</p>
</li>
<li>
<p>If <code>Kafka.spec.kafka.image</code> is configured, the default image is overridden.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The Cluster Operator cannot validate that an image actually contains a Kafka broker of the expected version.
Take care to ensure that the given image corresponds to the given Kafka version.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-upgrading-brokers-newer-kafka-str"><a class="link" href="#proc-upgrading-brokers-newer-kafka-str">12.5.4. Upgrading Kafka brokers and client applications</a></h4>
<div class="paragraph _abstract">
<p>Upgrade a Strimzi Kafka cluster to the latest supported Kafka version and <em>inter-broker protocol version</em>.</p>
</div>
<div class="paragraph">
<p>You should also choose a <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>.
Kafka clients are upgraded in step 6 of this procedure.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is up and running.</p>
</li>
<li>
<p>Before you upgrade the Strimzi Kafka cluster, check that the <code>Kafka.spec.kafka.config</code> properties of the <code>Kafka</code> resource do <em>not</em> contain configuration options that are not supported in the new Kafka version.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka <em>&lt;my_cluster&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>If configured, check that the <code>inter.broker.protocol.version</code> and <code>log.message.format.version</code> properties are set to the <em>current</em> version.</p>
<div class="paragraph">
<p>For example, the current version is 3.2 if upgrading from Kafka version 3.2.3 to 3.3.2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Kafka
spec:
  # ...
  kafka:
    version: 3.2.3
    config:
      log.message.format.version: "3.2"
      inter.broker.protocol.version: "3.2"
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> are not configured,
Strimzi automatically updates these versions to the current defaults after the update to the Kafka version in the next step.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> must be strings to prevent them from being interpreted as floating point numbers.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to specify the new Kafka version; leave the <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> at the defaults for the <em>current</em> Kafka version.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Changing the <code>kafka.version</code> ensures that all brokers in the cluster will be upgraded to start using the new broker binaries.
During this process, some brokers are using the old binaries while others have already upgraded to the new ones.
Leaving the <code>inter.broker.protocol.version</code> unchanged at the current setting ensures that the brokers can continue to communicate with each other throughout the upgrade.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, if upgrading from Kafka 3.2.3 to 3.3.2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.3.2 <b class="conum">(1)</b>
    config:
      log.message.format.version: "3.2" <b class="conum">(2)</b>
      inter.broker.protocol.version: "3.2" <b class="conum">(3)</b>
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka version is changed to the new version.</p>
</li>
<li>
<p>Message format version is unchanged.</p>
</li>
<li>
<p>Inter-broker protocol version is unchanged.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
You cannot downgrade Kafka if the <code>inter.broker.protocol.version</code> for the new Kafka version changes. The inter-broker protocol version determines the schemas used for persistent metadata stored by the broker, including messages written to <code>__consumer_offsets</code>. The downgraded cluster will not understand the messages.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If the image for the Kafka cluster is defined in the Kafka custom resource, in <code>Kafka.spec.kafka.image</code>, update the <code>image</code> to point to a container image with the new Kafka version.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a></p>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
<div class="paragraph">
<p>Check the progress of the rolling updates by watching the pod state transitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pods my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rolling updates ensure that each pod is using the broker binaries for the new version of Kafka.</p>
</div>
</li>
<li>
<p>Depending on your chosen <a href="#con-strategies-for-upgrading-clients-str">strategy for upgrading clients</a>, upgrade all client applications to use the new version of the client binaries.</p>
<div class="paragraph">
<p>If required, set the <code>version</code> property for Kafka Connect and MirrorMaker as the new version of Kafka:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>For Kafka Connect, update <code>KafkaConnect.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker, update <code>KafkaMirrorMaker.spec.version</code>.</p>
</li>
<li>
<p>For MirrorMaker 2.0, update <code>KafkaMirrorMaker2.spec.version</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If configured, update the Kafka resource to use the new <code>inter.broker.protocol.version</code> version. Otherwise, go to step 9.</p>
<div class="paragraph">
<p>For example, if upgrading to Kafka 3.3.2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.3.2
    config:
      log.message.format.version: "3.2"
      inter.broker.protocol.version: "3.3"
      # ...</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
</li>
<li>
<p>If configured, update the Kafka resource to use the new <code>log.message.format.version</code> version. Otherwise, go to step 10.</p>
<div class="paragraph">
<p>For example, if upgrading to Kafka 3.3.2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.3.2
    config:
      log.message.format.version: "3.3"
      inter.broker.protocol.version: "3.3"
      # ...</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Wait for the Cluster Operator to update the cluster.</p>
<div class="ulist">
<ul>
<li>
<p>The Kafka cluster and clients are now using the new Kafka version.</p>
</li>
<li>
<p>The brokers are configured to send messages using the inter-broker protocol version and message format version of the new version of Kafka.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Following the Kafka upgrade, if required, you can <a href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">upgrade consumers to use the incremental cooperative rebalance protocol</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proc-reenabling-FIPS-mode-str"><a class="link" href="#proc-reenabling-FIPS-mode-str">12.6. Switching to FIPS mode when upgrading Strimzi</a></h3>
<div class="paragraph _abstract">
<p>Upgrade Strimzi to run in FIPS mode on FIPS-enabled Kubernetes clusters.
Until Strimzi 0.33, running on FIPS-enabled Kubernetes clusters was possible only by disabling FIPS mode using the <code>FIPS_MODE</code> environment variable.
From release 0.33, Strimzi supports FIPS mode.
If you run Strimzi on a FIPS-enabled Kubernetes cluster with the <code>FIPS_MODE</code> set to <code>disabled</code>, you can enable it by following this procedure.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>FIPS-enabled Kubernetes cluster</p>
</li>
<li>
<p>An existing Cluster Operator deployment with the <code>FIPS_MODE</code> environment variable set to <code>disabled</code></p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Upgrade the Cluster Operator to version 0.33 or newer but keep the <code>FIPS_MODE</code> environment variable set to <code>disabled</code>.</p>
</li>
<li>
<p>If you initially deployed a Strimzi version older than 0.30, it might use old encryption and digest algorithms in its PKCS #12 stores, which are not supported with FIPS enabled.
To recreate the certificates with updated algorithms, renew the cluster and clients CA certificates.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To renew the CAs generated by the Cluster Operator, <a href="./configuring.html#proc-renewing-ca-certs-manually-str" target="_blank" rel="noopener">add the <code>force-renew</code> annotation to the CA secrets to trigger a renewal</a>.</p>
</li>
<li>
<p>To renew your own CAs, <a href="./configuring.html#renewing-your-own-ca-certificates-str" target="_blank" rel="noopener">add the new certificate to the CA secret and update the <code>ca-cert-generation</code> annotation with a higher incremental value to capture the update</a>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If you use SCRAM-SHA-512 authentication, check the password length of your users.
If they are less than 32 characters long, generate a new password in one of the following ways:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Delete the user secret so that the User Operator generates a new one with a new password of sufficient length.</p>
</li>
<li>
<p>If you provided your password using the <code>.spec.authentication.password</code> properties of the <code>KafkaUser</code> custom resource, update the password in the Kubernetes secret referenced in the same password configuration.
Don&#8217;t forget to update your clients to use the new passwords.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Ensure that the CA certificates are using the correct algorithms and the SCRAM-SHA-512 passwords are of sufficient length.
You can then enable the FIPS mode.</p>
</li>
<li>
<p>Remove the <code>FIPS_MODE</code> environment variable from the Cluster Operator deployment.
This restarts the Cluster Operator and rolls all the operands to enable the FIPS mode.
After the restart is complete, all Kafka clusters now run with FIPS mode enabled.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="proc-upgrading-consumers-streams-cooperative-rebalancing_str"><a class="link" href="#proc-upgrading-consumers-streams-cooperative-rebalancing_str">12.7. Upgrading consumers to cooperative rebalancing</a></h3>
<div class="paragraph">
<p>You can upgrade Kafka consumers and Kafka Streams applications to use the <em>incremental cooperative rebalance</em> protocol for partition rebalances instead of the default <em>eager rebalance</em> protocol. The new protocol was added in Kafka 2.4.0.</p>
</div>
<div class="paragraph">
<p>Consumers keep their partition assignments in a cooperative rebalance and only revoke them at the end of the process, if needed to achieve a balanced cluster. This reduces the unavailability of the consumer group or Kafka Streams application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Upgrading to the incremental cooperative rebalance protocol is optional. The eager rebalance protocol is still supported.
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You have <a href="#proc-upgrading-brokers-newer-kafka-str">upgraded Kafka brokers and client applications</a> to Kafka 3.3.2.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p><strong>To upgrade a Kafka consumer to use the incremental cooperative rebalance protocol:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replace the Kafka clients <code>.jar</code> file with the new version.</p>
</li>
<li>
<p>In the consumer configuration, append <code>cooperative-sticky</code> to the <code>partition.assignment.strategy</code>. For example, if the <code>range</code> strategy is set, change the configuration to <code>range, cooperative-sticky</code>.</p>
</li>
<li>
<p>Restart each consumer in the group in turn, waiting for the consumer to rejoin the group after each restart.</p>
</li>
<li>
<p>Reconfigure each consumer in the group by removing the earlier <code>partition.assignment.strategy</code> from the consumer configuration, leaving only the <code>cooperative-sticky</code> strategy.</p>
</li>
<li>
<p>Restart each consumer in the group in turn, waiting for the consumer to rejoin the group after each restart.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>To upgrade a Kafka Streams application to use the incremental cooperative rebalance protocol:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replace the Kafka Streams <code>.jar</code> file with the new version.</p>
</li>
<li>
<p>In the Kafka Streams configuration, set the <code>upgrade.from</code> configuration parameter to the Kafka version you are upgrading from (for example, 2.3).</p>
</li>
<li>
<p>Restart each of the stream processors (nodes) in turn.</p>
</li>
<li>
<p>Remove the <code>upgrade.from</code> configuration parameter from the Kafka Streams configuration.</p>
</li>
<li>
<p>Restart each consumer in the group in turn.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-downgrade-str"><a class="link" href="#assembly-downgrade-str">13. Downgrading Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>If you are encountering issues with the version of Strimzi you upgraded to,
you can revert your installation to the previous version.</p>
</div>
<div class="paragraph">
<p>If you used the YAML installation files to install Strimzi, you can use the YAML installation files from the previous release to perform the following downgrade procedures:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#proc-downgrade-cluster-operator-str">Downgrading the Cluster Operator to a previous version</a></p>
</li>
<li>
<p><a href="#assembly-downgrade-kafka-versions-str">Downgrading Kafka</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the previous version of Strimzi does not support the version of Kafka you are using,
you can also downgrade Kafka as long as the log message format versions appended to messages match.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you deployed Strimzi using another installation method, use a supported approach to downgrade Strimzi.
Do not use the downgrade instructions provided here.
For example, if you installed Strimzi using the Operator Lifecycle Manager (OLM), you can downgrade by changing the deployment channel to an earlier version of Strimzi.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="proc-downgrade-cluster-operator-str"><a class="link" href="#proc-downgrade-cluster-operator-str">13.1. Downgrading the Cluster Operator to a previous version</a></h3>
<div class="paragraph">
<p>If you are encountering issues with Strimzi,
you can revert your installation.</p>
</div>
<div class="paragraph">
<p>This procedure describes how to downgrade a Cluster Operator deployment to a previous version.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>An existing Cluster Operator deployment is available.</p>
</li>
<li>
<p>You have <a href="#downloads-str">downloaded the installation files for the previous version</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Take note of any configuration changes made to the existing Cluster Operator resources (in the <code>/install/cluster-operator</code> directory).
Any changes will be <strong>overwritten</strong> by the previous version of the Cluster Operator.</p>
</li>
<li>
<p>Revert your custom resources to reflect the supported configuration options available for the version of Strimzi you are downgrading to.</p>
</li>
<li>
<p>Update the Cluster Operator.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modify the installation files for the previous version according to the namespace the Cluster Operator is running in.</p>
<div class="paragraph">
<p>On Linux, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MacOS, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">sed -i '' 's/namespace: .*/namespace: my-cluster-operator-namespace/' install/cluster-operator/*RoleBinding*.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>If you modified one or more environment variables in your existing Cluster Operator <code>Deployment</code>, edit the
<code>install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml</code> file to use those environment variables.</p>
</li>
</ol>
</div>
</li>
<li>
<p>When you have an updated configuration, deploy it along with the rest of the installation resources:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl replace -f install/cluster-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the rolling updates to complete.</p>
</div>
</li>
<li>
<p>Get the image for the Kafka pod to ensure the downgrade was successful:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pod my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The image tag shows the new Strimzi version followed by the Kafka version. For example, <code><em>NEW-STRIMZI-VERSION</em>-kafka-<em>CURRENT-KAFKA-VERSION</em></code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your Cluster Operator was downgraded to the previous version.</p>
</div>
</div>
<div class="sect2">
<h3 id="assembly-downgrade-kafka-versions-str"><a class="link" href="#assembly-downgrade-kafka-versions-str">13.2. Downgrading Kafka</a></h3>
<div class="paragraph">
<p>Kafka version downgrades are performed by the Cluster Operator.</p>
</div>
<div class="sect3">
<h4 id="con-target-downgrade-version-str"><a class="link" href="#con-target-downgrade-version-str">13.2.1. Kafka version compatibility for downgrades</a></h4>
<div class="paragraph">
<p>Kafka downgrades are dependent on compatible current and target <a href="#ref-kafka-versions-str">Kafka versions</a>,
and the state at which messages have been logged.</p>
</div>
<div class="paragraph">
<p>You cannot revert to the previous Kafka version if that version does not support any of the <code>inter.broker.protocol.version</code> settings which have <em>ever been used</em> in that cluster,
or messages have been added to message logs that use a newer <code>log.message.format.version</code>.</p>
</div>
<div class="paragraph">
<p>The <code>inter.broker.protocol.version</code> determines the schemas used for persistent metadata stored by the broker, such as the schema for messages written to <code>__consumer_offsets</code>.
If you downgrade to a version of Kafka that does not understand an <code>inter.broker.protocol.version</code> that has ever been previously used in the cluster the broker will encounter data it cannot understand.</p>
</div>
<div class="paragraph">
<p>If the target downgrade version of Kafka has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>same</em> <code>log.message.format.version</code> as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.</p>
</li>
<li>
<p>A <em>different</em> <code>log.message.format.version</code>, downgrading is only possible if the running cluster has <em>always</em> had <code>log.message.format.version</code> set to the version used by the downgraded version.
This is typically only the case if the upgrade procedure was aborted before the <code>log.message.format.version</code> was changed.
In this case, the downgrade requires:</p>
<div class="ulist">
<ul>
<li>
<p>Two rolling restarts of the brokers if the interbroker protocol of the two versions is different</p>
</li>
<li>
<p>A single rolling restart if they are the same</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Downgrading is <em>not possible</em> if the new version has ever used a <code>log.message.format.version</code> that is not supported by the previous version, including when the default value for <code>log.message.format.version</code> is used. For example, this resource can be downgraded to Kafka version 3.2.3 because the <code>log.message.format.version</code> has not been changed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.3.2
    config:
      log.message.format.version: "3.2"
      # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The downgrade would not be possible if the <code>log.message.format.version</code> was set at <code>"3.3"</code> or a value was absent, so that the parameter took the default value for a 3.3.2 broker of 3.3.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="proc-downgrading-brokers-older-kafka-str"><a class="link" href="#proc-downgrading-brokers-older-kafka-str">13.2.2. Downgrading Kafka brokers and client applications</a></h4>
<div class="paragraph _abstract">
<p>Downgrade a Strimzi Kafka cluster to a lower (previous) version of Kafka, such as downgrading from 3.3.2 to 3.2.3.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is up and running.</p>
</li>
<li>
<p>Before you downgrade the Strimzi Kafka cluster, check the following for the <code>Kafka</code> resource:</p>
<div class="ulist">
<ul>
<li>
<p>IMPORTANT: <a href="#con-target-downgrade-version-str">Compatibility of Kafka versions</a>.</p>
</li>
<li>
<p><code>Kafka.spec.kafka.config</code> does not contain options that are not supported by the Kafka version being downgraded to.</p>
</li>
<li>
<p><code>Kafka.spec.kafka.config</code> has a <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> that is supported by the Kafka version being downgraded to.</p>
<div class="paragraph">
<p>From Kafka 3.0.0, when the <code>inter.broker.protocol.version</code> is set to <code>3.0</code> or higher, the <code>log.message.format.version</code> option is ignored and doesn&#8217;t need to be set.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the Kafka cluster configuration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl edit kafka <em>KAFKA-CONFIGURATION-FILE</em></code></pre>
</div>
</div>
</li>
<li>
<p>Change the <code>Kafka.spec.kafka.version</code> to specify the previous version.</p>
<div class="paragraph">
<p>For example, if downgrading from Kafka 3.3.2 to 3.2.3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta2
kind: Kafka
spec:
  # ...
  kafka:
    version: 3.2.3 <b class="conum">(1)</b>
    config:
      log.message.format.version: "3.2" <b class="conum">(2)</b>
      inter.broker.protocol.version: "3.2" <b class="conum">(3)</b>
      # ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Kafka version is changed to the previous version.</p>
</li>
<li>
<p>Message format version is unchanged.</p>
</li>
<li>
<p>Inter-broker protocol version is unchanged.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The value of <code>log.message.format.version</code> and <code>inter.broker.protocol.version</code> must be strings to prevent them from being interpreted as floating point numbers.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If the image for the Kafka version is different from the image defined in <code>STRIMZI_KAFKA_IMAGES</code> for the Cluster Operator, update <code>Kafka.spec.kafka.image</code>.</p>
<div class="paragraph">
<p>See <a href="#con-versions-and-images-str">Kafka version and image mappings</a></p>
</div>
</li>
<li>
<p>Save and exit the editor, then wait for rolling updates to complete.</p>
<div class="paragraph">
<p>Check the update in the logs or by watching the pod state transitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl logs -f <em>CLUSTER-OPERATOR-POD-NAME</em> | grep -E "Kafka version downgrade from [0-9.]+ to [0-9.]+, phase ([0-9]+) of \1 completed"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get pod -w</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the Cluster Operator logs for an <code>INFO</code> level message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Reconciliation #<em>NUM</em>(watch) Kafka(<em>NAMESPACE</em>/<em>NAME</em>): Kafka version downgrade from <em>FROM-VERSION</em> to <em>TO-VERSION</em>, phase 1 of 1 completed</code></pre>
</div>
</div>
</li>
<li>
<p>Downgrade all client applications (consumers) to use the previous version of the client binaries.</p>
<div class="paragraph">
<p>The Kafka cluster and clients are now using the previous Kafka version.</p>
</div>
</li>
<li>
<p>If you are reverting back to a version of Strimzi earlier than 0.22, which uses ZooKeeper for the storage of topic metadata, delete the internal topic store topics from the Kafka cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl run kafka-admin -ti --image=quay.io/strimzi/kafka:latest-kafka-3.3.2 --rm=true --restart=Never -- ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi-topic-operator-kstreams-topic-store-changelog --delete &amp;&amp; ./bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic __strimzi_store_topic --delete</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="ulist _additional-resources">
<div class="title">Additional resources</div>
<ul>
<li>
<p><a href="./configuring.html#ref-topic-operator-store-str" target="_blank" rel="noopener">Topic Operator topic store</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-deploy-restart-events-str"><a class="link" href="#assembly-deploy-restart-events-str">14. Finding information on Kafka restarts</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>After the Cluster Operator restarts a Kafka pod in a Kubernetes cluster, it emits a Kubernetes event into the pod&#8217;s namespace explaining why the pod restarted.
For help in understanding cluster behavior, you can check restart events from the command line.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can export and monitor restart events using metrics collection tools like Prometheus. Use the metrics tool with an <em>event exporter</em> that can export the output in a suitable format.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ref-operator-restart-events-reasons-str"><a class="link" href="#ref-operator-restart-events-reasons-str">14.1. Reasons for a restart event</a></h3>
<div class="paragraph _abstract">
<p>The Cluster Operator initiates a restart event for a specific reason.
You can check the reason by fetching information on the restart event.</p>
</div>
<div class="paragraph">
<p>The reason given depends on whether you are using <code>StrimziPodSet</code> or <code>StatefulSet</code> resources for the creation and management of pods.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Restart reasons</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">StrimziPodSet</th>
<th class="tableblock halign-left valign-top">StatefulSet</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertHasOldGeneration</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertHasOldGeneration</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pod is still using a server certificate signed with an old CA, so needs to be restarted as part of the certificate update.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertRemoved</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertRemoved</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expired CA certificates have been removed, and the pod is restarted to run with the current certificates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertRenewed</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CaCertRenewed</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CA certificates have been renewed, and the pod is restarted to run with the updated certificates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ClientCaCertKeyReplaced</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ClientCaCertKeyReplaced</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key used to sign clients CA certificates has been replaced, and the pod is being restarted as part of the CA renewal process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ClusterCaCertKeyReplaced</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ClusterCaCertKeyReplaced</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The key used to sign the cluster&#8217;s CA certificates has been replaced, and the pod is being restarted as part of the CA renewal process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ConfigChangeRequiresRestart</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ConfigChangeRequiresRestart</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Some Kafka configuration properties are changed dynamically, but others require that the broker be restarted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CustomListenerCaCertChanged</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>CustomListenerCaCertChanged</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The CA certificate used to secure the Kafka network listeners has changed, and the pod is restarted to use it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>FileSystemResizeNeeded</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>FileSystemResizeNeeded</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file system size has been increased, and a restart is needed to apply it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KafkaCertificatesChanged</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>KafkaCertificatesChanged</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One or more TLS certificates used by the Kafka broker have been updated, and a restart is needed to use them.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ManualRollingUpdate</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>ManualRollingUpdate</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A user annotated the pod, or the <code>StatefulSet`</code> or <code>StrimziPodSet</code> set it belongs to, to trigger a restart.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodForceRestartOnError</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodForceRestartOnError</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An error occurred that requires a pod restart to rectify.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodHasOldRevision</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>JbodVolumesChanged</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A disk was added or removed from the Kafka volumes, and a restart is needed to apply the change. When using <code>StrimziPodSet</code> resources, the same reason is given if the pod needs to be recreated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodHasOldRevision</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodHasOldGeneration</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>StatefulSet</code> or <code>StrimziPodSet</code> that the pod is a member of has been updated, so the pod needs to be recreated. When using <code>StrimziPodSet</code> resources, the same reason is given if a disk was added or removed from the Kafka volumes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodStuck</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodStuck</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The pod is still pending, and is not scheduled or cannot be scheduled, so the operator has restarted the pod in a final attempt to get it running.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodUnresponsive</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>PodUnresponsive</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strimzi was unable to connect to the pod, which can indicate a broker not starting correctly, so the operator restarted it in an attempt to resolve the issue.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="ref-operator-restart-events-fields-str"><a class="link" href="#ref-operator-restart-events-fields-str">14.2. Restart event filters</a></h3>
<div class="paragraph _abstract">
<p>When checking restart events from the command line, you can specify a <code>field-selector</code> to filter on Kubernetes event fields.</p>
</div>
<div class="paragraph">
<p>The following fields are available when filtering events with <code>field-selector</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>regardingObject.kind</code></dt>
<dd>
<p>The object that was restarted, and for restart events, the kind is always <code>Pod</code>.</p>
</dd>
<dt class="hdlist1"><code>regarding.namespace</code></dt>
<dd>
<p>The namespace that the pod belongs to.</p>
</dd>
<dt class="hdlist1"><code>regardingObject.name</code></dt>
<dd>
<p>The pod&#8217;s name, for example, <code>strimzi-cluster-kafka-0</code>.</p>
</dd>
<dt class="hdlist1"><code>regardingObject.uid</code></dt>
<dd>
<p>The unique ID of the pod.</p>
</dd>
<dt class="hdlist1"><code>reason</code></dt>
<dd>
<p>The reason the pod was restarted, for example, <code>JbodVolumesChanged</code>.</p>
</dd>
<dt class="hdlist1"><code>reportingController</code></dt>
<dd>
<p>The reporting component is always <code>strimzi.io/cluster-operator</code> for Strimzi restart events.</p>
</dd>
<dt class="hdlist1"><code>source</code></dt>
<dd>
<p><code>source</code> is an older version of <code>reportingController</code>. The reporting component is always <code>strimzi.io/cluster-operator</code> for Strimzi restart events.</p>
</dd>
<dt class="hdlist1"><code>type</code></dt>
<dd>
<p>The event type, which is either <code>Warning</code> or <code>Normal</code>. For Strimzi restart events, the type is <code>Normal</code>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In older versions of Kubernetes, the fields using the <code>regarding</code> prefix might use an <code>involvedObject</code> prefix instead. <code>reportingController</code> was previously called <code>reportingComponent</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="proc-operator-restart-events-str"><a class="link" href="#proc-operator-restart-events-str">14.3. Checking Kafka restarts</a></h3>
<div class="paragraph _abstract">
<p>Use a <code>kubectl</code> command to list restart events initiated by the Cluster Operator.
Filter restart events emitted by the Cluster Operator by setting the Cluster Operator as the reporting component using the <code>reportingController</code> or <code>source</code> event fields.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>The Cluster Operator is running in the Kubernetes cluster.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Get all restart events emitted by the Cluster Operator:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl -n kafka get events --field-selector reportingController=strimzi.io/cluster-operator</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example showing events returned</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">LAST SEEN   TYPE     REASON                   OBJECT                        MESSAGE
2m          Normal   CaCertRenewed            pod/strimzi-cluster-kafka-0   CA certificate renewed
58m         Normal   PodForceRestartOnError   pod/strimzi-cluster-kafka-1   Pod needs to be forcibly restarted due to an error
5m47s       Normal   ManualRollingUpdate      pod/strimzi-cluster-kafka-2   Pod was manually annotated to be rolled</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify a <code>reason</code> or other <code>field-selector</code> options to constrain the events returned.</p>
</div>
<div class="paragraph">
<p>Here, a specific reason is added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl -n kafka get events --field-selector reportingController=strimzi.io/cluster-operator,reason=PodForceRestartOnError</code></pre>
</div>
</div>
</li>
<li>
<p>Use an output format, such as YAML, to return more detailed information about one or more events.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell-session hljs" data-lang="shell-session">kubectl -n kafka get events --field-selector reportingController=strimzi.io/cluster-operator,reason=PodForceRestartOnError -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example showing detailed events output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
items:
- action: StrimziInitiatedPodRestart
  apiVersion: v1
  eventTime: "2022-05-13T00:22:34.168086Z"
  firstTimestamp: null
  involvedObject:
      kind: Pod
      name: strimzi-cluster-kafka-1
      namespace: kafka
  kind: Event
  lastTimestamp: null
  message: Pod needs to be forcibly restarted due to an error
  metadata:
      creationTimestamp: "2022-05-13T00:22:34Z"
      generateName: strimzi-event
      name: strimzi-eventwppk6
      namespace: kafka
      resourceVersion: "432961"
      uid: 29fcdb9e-f2cf-4c95-a165-a5efcd48edfc
  reason: PodForceRestartOnError
  reportingController: strimzi.io/cluster-operator
  reportingInstance: strimzi-cluster-operator-6458cfb4c6-6bpdp
  source: {}
  type: Normal
kind: List
metadata:
  resourceVersion: ""
  selfLink: ""</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following fields are deprecated, so they are not populated for these events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>firstTimestamp</code></p>
</li>
<li>
<p><code>lastTimestamp</code></p>
</li>
<li>
<p><code>source</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="assembly-uninstalling-str"><a class="link" href="#assembly-uninstalling-str">15. Uninstalling Strimzi</a></h2>
<div class="sectionbody">
<div class="paragraph _abstract">
<p>You can uninstall Strimzi using the CLI or by unsubscribing from OperatorHub.io.</p>
</div>
<div class="paragraph">
<p>Use the same approach you used to install Strimzi.</p>
</div>
<div class="paragraph">
<p>When you uninstall Strimzi, you will need to identify resources created specifically for a deployment and referenced from the Strimzi resource.</p>
</div>
<div class="paragraph">
<p>Such resources include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secrets (Custom CAs and certificates, Kafka Connect secrets, and other Kafka secrets)</p>
</li>
<li>
<p>Logging <code>ConfigMaps</code> (of type <code>external</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are resources referenced by <code>Kafka</code>, <code>KafkaConnect</code>, <code>KafkaMirrorMaker</code>, or <code>KafkaBridge</code> configuration.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Deleting <code>CustomResourceDefinitions</code> results in the garbage collection of the corresponding custom resources (<code>Kafka</code>, <code>KafkaConnect</code>, <code>KafkaMirrorMaker</code>, or <code>KafkaBridge</code>) and the resources dependent on them (Deployments, StatefulSets, and other dependent resources).
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="uninstalling-str"><a class="link" href="#uninstalling-str">15.1. Uninstalling Strimzi using the CLI</a></h3>
<div class="paragraph _abstract">
<p>This procedure describes how to use the <code>kubectl</code> command-line tool to uninstall Strimzi and remove resources related to the deployment.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to a Kubernetes cluster using an account with <code>cluster-admin</code> or <code>strimzi-admin</code> permissions.</p>
</li>
<li>
<p>You have identified the resources to be deleted.</p>
<div class="paragraph">
<p>You can use the following <code>kubectl</code> CLI command to find resources and also verify that they have been removed when you have uninstalled Strimzi.</p>
</div>
<div class="listingblock">
<div class="title">Command to find resources related to a Strimzi deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get <em>&lt;resource_type&gt;</em> --all-namespaces | grep <em>&lt;kafka_cluster_name&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;resource_type&gt;</em> with the type of the resource you are checking, such as <code>secret</code> or <code>configmap</code>.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Delete the Cluster Operator <code>Deployment</code>, related <code>CustomResourceDefinitions</code>, and <code>RBAC</code> resources.</p>
<div class="paragraph">
<p>Specify the installation files used to deploy the Cluster Operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete -f install/cluster-operator</code></pre>
</div>
</div>
</li>
<li>
<p>Delete the resources you identified in the prerequisites.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete <em>&lt;resource_type&gt;</em> <em>&lt;resource_name&gt;</em> -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;resource_type&gt;</em> with the type of resource you are deleting and <em>&lt;resource_name&gt;</em> with the name of the resource.</p>
</div>
<div class="listingblock">
<div class="title">Example to delete a secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete secret my-cluster-clients-ca -n my-project</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="uninstalling-operator-hub-str"><a class="link" href="#uninstalling-operator-hub-str">15.2. Uninstalling Strimzi from OperatorHub.io</a></h3>
<div class="paragraph _abstract">
<p>This procedure describes how to uninstall Strimzi from OperatorHub.io and remove resources related to the deployment.</p>
</div>
<div class="paragraph">
<p>You perform the steps using the <code>kubectl</code> command-line tool.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Access to a Kubernetes cluster using an account with <code>cluster-admin</code> or <code>strimzi-admin</code> permissions.</p>
</li>
<li>
<p>You have identified the resources to be deleted.</p>
<div class="paragraph">
<p>You can use the following <code>kubectl</code> CLI command to find resources and also verify that they have been removed when you have uninstalled Strimzi.</p>
</div>
<div class="listingblock">
<div class="title">Command to find resources related to a Strimzi deployment</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get <em>&lt;resource_type&gt;</em> --all-namespaces | grep <em>&lt;kafka_cluster_name&gt;</em></code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>&lt;resource_type&gt;</em> with the type of the resource you are checking, such as <code>secret</code> or <code>configmap</code>.</p>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Delete the Strimzi subscription.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete subscription strimzi-cluster-operator -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Delete the cluster service version (CSV).</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl delete csv strimzi-cluster-operator.<em>&lt;version&gt;</em>  -n <em>&lt;namespace&gt;</em></code></pre>
</div>
</div>
</li>
<li>
<p>Remove related CRDs.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl get crd -l app=strimzi -o name | xargs kubectl delete</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-02-01 12:24:00 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>